---
phase: 08-advanced-scans
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/daq-egui/src/graph/nodes.rs
  - crates/daq-egui/src/widgets/property_inspector/mod.rs
  - crates/daq-egui/src/widgets/property_inspector/nested_scan_panel.rs
autonomous: true

must_haves:
  truths:
    - "User can add NestedScan node to graph from palette/context menu"
    - "User can configure outer and inner scan parameters in property inspector"
    - "NestedScan node has body output pin for inner loop content"
  artifacts:
    - path: "crates/daq-egui/src/graph/nodes.rs"
      provides: "NestedScan node variant and NestedScanConfig"
      contains: "NestedScan"
    - path: "crates/daq-egui/src/widgets/property_inspector/nested_scan_panel.rs"
      provides: "UI panel for nested scan configuration"
      exports: ["NestedScanPanel"]
  key_links:
    - from: "crates/daq-egui/src/graph/nodes.rs"
      to: "ExperimentNode enum"
      via: "NestedScan variant"
      pattern: "ExperimentNode::NestedScan"
---

<objective>
Add NestedScan node type for outer/inner loop configurations.

Purpose: Scientists need to create nested scans (e.g., wavelength sweep at each XY position). This extends the existing Loop node with explicit outer/inner structure.

Output: NestedScan node with property inspector panel
</objective>

<execution_context>
@/Users/briansquires/.claude/get-shit-done/workflows/execute-plan.md
@/Users/briansquires/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-scans/08-CONTEXT.md
@crates/daq-egui/src/graph/nodes.rs
@crates/daq-egui/src/widgets/property_inspector/mod.rs
@crates/daq-egui/src/widgets/property_inspector/loop_panel.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NestedScan node variant and config struct</name>
  <files>crates/daq-egui/src/graph/nodes.rs</files>
  <action>
Add NestedScanConfig struct and ExperimentNode::NestedScan variant to nodes.rs:

1. **NestedScanConfig struct**:
```rust
/// Configuration for NestedScan node (outer/inner loop combination).
#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct NestedScanConfig {
    /// Outer scan configuration
    pub outer: ScanDimension,
    /// Inner scan configuration
    pub inner: ScanDimension,
    /// Warning threshold for deep nesting (default: 3)
    pub nesting_warning_depth: u32,
}

/// Single dimension of a nested scan.
#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct ScanDimension {
    /// Device ID for the actuator
    pub actuator: String,
    /// Dimension name for data labeling (e.g., "wavelength", "position_x")
    pub dimension_name: String,
    /// Start position
    pub start: f64,
    /// Stop position
    pub stop: f64,
    /// Number of points
    pub points: u32,
}
```

2. **Add Default implementations**:
```rust
impl Default for ScanDimension {
    fn default() -> Self {
        Self {
            actuator: String::new(),
            dimension_name: String::new(),
            start: 0.0,
            stop: 100.0,
            points: 10,
        }
    }
}

impl Default for NestedScanConfig {
    fn default() -> Self {
        Self {
            outer: ScanDimension {
                dimension_name: "outer".to_string(),
                ..Default::default()
            },
            inner: ScanDimension {
                dimension_name: "inner".to_string(),
                ..Default::default()
            },
            nesting_warning_depth: 3,
        }
    }
}
```

3. **Add ExperimentNode variant**:
```rust
/// Nested scan with outer/inner loop structure
NestedScan(NestedScanConfig),
```

4. **Update node_name() match arm**:
```rust
ExperimentNode::NestedScan(..) => "Nested Scan",
```

5. **Add default_nested_scan() constructor**:
```rust
pub fn default_nested_scan() -> Self {
    ExperimentNode::NestedScan(NestedScanConfig::default())
}
```
  </action>
  <verify>
Run: `cargo check -p daq-egui`
Should compile without errors.
  </verify>
  <done>NestedScan node variant with outer/inner ScanDimension configs</done>
</task>

<task type="auto">
  <name>Task 2: Create property inspector panel for NestedScan</name>
  <files>crates/daq-egui/src/widgets/property_inspector/nested_scan_panel.rs, crates/daq-egui/src/widgets/property_inspector/mod.rs</files>
  <action>
Create nested_scan_panel.rs with UI for configuring nested scans:

1. **NestedScanPanel struct**:
```rust
pub struct NestedScanPanel;

impl NestedScanPanel {
    pub fn show(
        ui: &mut egui::Ui,
        config: &mut NestedScanConfig,
        device_ids: &[String],
    ) -> bool // returns true if modified
}
```

2. **UI layout with collapsing sections**:
- "Outer Scan" collapsing header with ScanDimension fields
- "Inner Scan" collapsing header with ScanDimension fields
- Each section has:
  - Device selector (ComboBox with device_ids)
  - Dimension name text field
  - Start/Stop/Points numeric fields

3. **Helper for ScanDimension UI**:
```rust
fn show_scan_dimension(
    ui: &mut egui::Ui,
    label: &str,
    dim: &mut ScanDimension,
    device_ids: &[String],
) -> bool
```

4. **Nesting depth warning**:
Display warning label if nesting_warning_depth > 3:
```rust
if config.nesting_warning_depth > 3 {
    ui.label(egui::RichText::new("⚠ Deep nesting may slow translation")
        .color(egui::Color32::YELLOW));
}
```

5. **Point count calculations**:
Show total points: `outer.points × inner.points = N total`

6. **Export in mod.rs**:
```rust
mod nested_scan_panel;
pub use nested_scan_panel::NestedScanPanel;
```

7. **Integrate into PropertyInspector**:
In the match arm for node types, add:
```rust
ExperimentNode::NestedScan(ref mut config) => {
    modified = NestedScanPanel::show(ui, config, device_ids);
}
```

Reference loop_panel.rs for existing patterns (device selector, numeric fields).
  </action>
  <verify>
Run: `cargo check -p daq-egui`
Should compile without errors.
  </verify>
  <done>Property inspector panel for NestedScan with outer/inner configuration</done>
</task>

<task type="auto">
  <name>Task 3: Add NestedScan to palette and viewer</name>
  <files>crates/daq-egui/src/widgets/node_palette.rs, crates/daq-egui/src/graph/viewer.rs</files>
  <action>
Update node palette and viewer to support NestedScan:

1. **Add NodeType variant** in node_palette.rs:
```rust
pub enum NodeType {
    // ... existing variants
    NestedScan,
}
```

2. **Add to palette UI** in NodePalette::show():
- Add "Nested Scan" button in "Scans" section (near existing Scan)
- Use appropriate icon/color (match Scan style)

3. **Map NodeType to ExperimentNode** in palette creation code:
```rust
NodeType::NestedScan => ExperimentNode::default_nested_scan(),
```

4. **Update ExperimentViewer** in viewer.rs:
Add match arm in `node_picker()`, `title()`, `inputs()`, `outputs()` functions:

For outputs, NestedScan has TWO outputs (like Loop):
- Pin 0: "Next" (continues after nested scan completes)
- Pin 1: "Body" (inner content executed at each outer×inner point)

```rust
ExperimentNode::NestedScan(_) => {
    // outputs: ["Next", "Body"]
    // inputs: ["In"]
}
```

5. **Node color/style**:
Use a distinct color for NestedScan (e.g., purple/violet) to differentiate from simple Scan (which is typically green/teal).
  </action>
  <verify>
Run: `cargo check -p daq-egui`
Should compile without errors.
  </verify>
  <done>NestedScan available in palette with body output pin</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build: `cargo build -p daq-egui`
2. Tests: `cargo test -p daq-egui`
3. Format/lint: `cargo fmt --all && cargo clippy -p daq-egui`
4. Serialization: Verify NestedScan nodes serialize/deserialize correctly (existing serialization tests should cover this via derive macros)
</verification>

<success_criteria>
- NestedScan node can be added to graph from palette
- Property inspector shows outer/inner dimension configuration
- NestedScan has body output pin (pin 1) for inner loop content
- Total point count displayed (outer × inner)
- Warning shown for deep nesting (> 3 levels)
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-scans/08-02-SUMMARY.md`
</output>
