---
phase: 03-plan-translation-and-execution
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - crates/daq-egui/src/panels/experiment_designer.rs
  - crates/daq-egui/src/widgets/parameter_editor.rs
autonomous: true

must_haves:
  truths:
    - "User can modify device parameters when experiment is paused"
    - "Parameter changes are sent to daemon via SetParameter gRPC"
    - "Parameter editor is disabled when not paused"
  artifacts:
    - path: "crates/daq-egui/src/widgets/parameter_editor.rs"
      provides: "Inline parameter editing widget for paused state"
      exports: ["ParameterEditor"]
    - path: "crates/daq-egui/src/panels/experiment_designer.rs"
      provides: "Parameter editing integration when paused"
      contains: "edit_parameter_while_paused"
  key_links:
    - from: "crates/daq-egui/src/widgets/parameter_editor.rs"
      to: "DaqClient set_parameter"
      via: "gRPC call to modify device parameter"
      pattern: "set_parameter"
---

<objective>
Enable parameter modification during paused execution to support EXEC-05 (modify device parameters while paused).

Purpose: Scientists can adjust parameters (exposure time, position, etc.) during a paused experiment and resume with new values.

Output: Parameter editor widget, integration with pause state, gRPC parameter updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-plan-translation-and-execution/03-RESEARCH.md
@.planning/phases/03-plan-translation-and-execution/03-01-SUMMARY.md
@.planning/phases/03-plan-translation-and-execution/03-02-SUMMARY.md

# Key source files
@crates/daq-egui/src/panels/experiment_designer.rs
@crates/daq-egui/src/client.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create parameter editor widget for runtime modification</name>
  <files>crates/daq-egui/src/widgets/parameter_editor.rs, crates/daq-egui/src/widgets/mod.rs</files>
  <action>
Create `crates/daq-egui/src/widgets/parameter_editor.rs`:

```rust
//! Parameter editor widget for modifying device parameters during paused execution.

use egui::Ui;

/// A parameter that can be edited at runtime
#[derive(Clone, Debug)]
pub struct EditableParameter {
    /// Device ID this parameter belongs to
    pub device_id: String,
    /// Parameter name (e.g., "exposure_ms", "position")
    pub name: String,
    /// Display label
    pub label: String,
    /// Current value (as string for flexibility)
    pub value: String,
    /// Parameter type hint for appropriate editor
    pub param_type: ParameterType,
    /// Optional range for numeric parameters
    pub range: Option<(f64, f64)>,
}

/// Type of parameter for appropriate editor selection
#[derive(Clone, Copy, Debug, PartialEq, Eq)]
pub enum ParameterType {
    Float,
    Integer,
    String,
    Boolean,
}

/// Result of parameter editing
pub enum ParameterEditResult {
    /// No change
    NoChange,
    /// Value was modified, needs to be sent to device
    Modified { device_id: String, param_name: String, new_value: String },
}

/// Widget for editing parameters while paused
pub struct ParameterEditor;

impl ParameterEditor {
    /// Show parameter editor UI
    ///
    /// Returns Some(Modified) if user changed a value, None otherwise.
    pub fn show(ui: &mut Ui, param: &mut EditableParameter, enabled: bool) -> ParameterEditResult {
        ui.horizontal(|ui| {
            ui.label(&param.label);
            ui.label(":");

            let response = match param.param_type {
                ParameterType::Float => {
                    let mut value: f64 = param.value.parse().unwrap_or(0.0);
                    let response = if let Some((min, max)) = param.range {
                        ui.add_enabled(
                            enabled,
                            egui::Slider::new(&mut value, min..=max)
                                .text("")
                        )
                    } else {
                        ui.add_enabled(
                            enabled,
                            egui::DragValue::new(&mut value)
                                .speed(0.1)
                        )
                    };
                    if response.changed() {
                        param.value = value.to_string();
                    }
                    response
                }
                ParameterType::Integer => {
                    let mut value: i64 = param.value.parse().unwrap_or(0);
                    let response = if let Some((min, max)) = param.range {
                        ui.add_enabled(
                            enabled,
                            egui::Slider::new(&mut value, min as i64..=max as i64)
                                .text("")
                        )
                    } else {
                        ui.add_enabled(
                            enabled,
                            egui::DragValue::new(&mut value)
                        )
                    };
                    if response.changed() {
                        param.value = value.to_string();
                    }
                    response
                }
                ParameterType::String => {
                    let response = ui.add_enabled(
                        enabled,
                        egui::TextEdit::singleline(&mut param.value)
                            .desired_width(100.0)
                    );
                    response
                }
                ParameterType::Boolean => {
                    let mut value: bool = param.value.parse().unwrap_or(false);
                    let response = ui.add_enabled(enabled, egui::Checkbox::without_text(&mut value));
                    if response.changed() {
                        param.value = value.to_string();
                    }
                    response
                }
            };

            if response.changed() {
                return ParameterEditResult::Modified {
                    device_id: param.device_id.clone(),
                    param_name: param.name.clone(),
                    new_value: param.value.clone(),
                };
            }

            ParameterEditResult::NoChange
        }).inner
    }

    /// Show a group of parameters with a header
    pub fn show_group(
        ui: &mut Ui,
        title: &str,
        params: &mut [EditableParameter],
        enabled: bool,
    ) -> Vec<ParameterEditResult> {
        let mut results = Vec::new();

        ui.group(|ui| {
            ui.heading(title);
            ui.separator();

            for param in params.iter_mut() {
                let result = Self::show(ui, param, enabled);
                results.push(result);
            }
        });

        results
    }
}

/// Helper to create common parameter types
impl EditableParameter {
    pub fn float(device_id: &str, name: &str, label: &str, value: f64) -> Self {
        Self {
            device_id: device_id.to_string(),
            name: name.to_string(),
            label: label.to_string(),
            value: value.to_string(),
            param_type: ParameterType::Float,
            range: None,
        }
    }

    pub fn float_ranged(device_id: &str, name: &str, label: &str, value: f64, min: f64, max: f64) -> Self {
        Self {
            device_id: device_id.to_string(),
            name: name.to_string(),
            label: label.to_string(),
            value: value.to_string(),
            param_type: ParameterType::Float,
            range: Some((min, max)),
        }
    }

    pub fn integer(device_id: &str, name: &str, label: &str, value: i64) -> Self {
        Self {
            device_id: device_id.to_string(),
            name: name.to_string(),
            label: label.to_string(),
            value: value.to_string(),
            param_type: ParameterType::Integer,
            range: None,
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_parameter_creation() {
        let param = EditableParameter::float("cam1", "exposure_ms", "Exposure (ms)", 100.0);
        assert_eq!(param.device_id, "cam1");
        assert_eq!(param.name, "exposure_ms");
        assert_eq!(param.value, "100");
    }
}
```

Update `crates/daq-egui/src/widgets/mod.rs` to export:
```rust
mod parameter_editor;
pub use parameter_editor::{ParameterEditor, EditableParameter, ParameterType, ParameterEditResult};
```
  </action>
  <verify>
`cargo build -p daq-egui` succeeds
`cargo test -p daq-egui parameter_editor` runs tests
  </verify>
  <done>
ParameterEditor widget created with float/int/string/bool support. EditableParameter struct for runtime parameter data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate parameter editing in paused state</name>
  <files>crates/daq-egui/src/panels/experiment_designer.rs</files>
  <action>
Update ExperimentDesignerPanel to show parameter editor when paused:

1. Add field to track editable parameters:
```rust
/// Parameters available for editing while paused
editable_params: Vec<crate::widgets::EditableParameter>,
```

2. Add method to populate editable parameters from graph nodes:
```rust
fn collect_editable_parameters(&self) -> Vec<crate::widgets::EditableParameter> {
    use crate::widgets::{EditableParameter, ParameterType};

    let mut params = Vec::new();

    for (_, node) in self.snarl.node_ids() {
        match node {
            ExperimentNode::Scan { actuator, start, stop, .. } => {
                if !actuator.is_empty() {
                    params.push(EditableParameter::float(
                        actuator, "position", &format!("{} Position", actuator), *start
                    ));
                }
            }
            ExperimentNode::Acquire { detector, duration_ms } => {
                if !detector.is_empty() {
                    params.push(EditableParameter::float_ranged(
                        detector, "exposure_ms", &format!("{} Exposure (ms)", detector),
                        *duration_ms, 1.0, 10000.0
                    ));
                }
            }
            ExperimentNode::Move { device, position } => {
                if !device.is_empty() {
                    params.push(EditableParameter::float(
                        device, "position", &format!("{} Position", device), *position
                    ));
                }
            }
            ExperimentNode::Wait { duration_ms } => {
                params.push(EditableParameter::float_ranged(
                    "", "wait_duration", "Wait Duration (ms)", *duration_ms, 0.0, 60000.0
                ));
            }
            _ => {}
        }
    }

    // Deduplicate by device_id + name
    params.sort_by(|a, b| (&a.device_id, &a.name).cmp(&(&b.device_id, &b.name)));
    params.dedup_by(|a, b| a.device_id == b.device_id && a.name == b.name);

    params
}
```

3. Add method to show parameter editor panel when paused:
```rust
fn show_parameter_editor_panel(&mut self, ui: &mut egui::Ui, client: Option<&mut DaqClient>, runtime: Option<&Runtime>) {
    use crate::widgets::{ParameterEditor, ParameterEditResult};

    let is_paused = self.execution_state.is_paused();

    ui.group(|ui| {
        ui.heading("Runtime Parameters");
        if !is_paused {
            ui.label("(Pause execution to modify parameters)");
        }
        ui.separator();

        // Populate parameters if we just entered paused state
        if is_paused && self.editable_params.is_empty() {
            self.editable_params = self.collect_editable_parameters();
        }

        // Clear when not paused
        if !is_paused && !self.editable_params.is_empty() {
            self.editable_params.clear();
        }

        // Show parameter editors
        let results = ParameterEditor::show_group(
            ui,
            "Device Parameters",
            &mut self.editable_params,
            is_paused,
        );

        // Handle modifications
        for result in results {
            if let ParameterEditResult::Modified { device_id, param_name, new_value } = result {
                self.send_parameter_update(&device_id, &param_name, &new_value, client, runtime);
            }
        }
    });
}

fn send_parameter_update(
    &mut self,
    device_id: &str,
    param_name: &str,
    new_value: &str,
    client: Option<&mut DaqClient>,
    runtime: Option<&Runtime>,
) {
    if device_id.is_empty() {
        // Local parameter (like wait duration) - just update in graph
        // This would require updating the node, which we'll skip for now
        self.set_status(format!("Updated {} to {}", param_name, new_value));
        return;
    }

    let Some(client) = client else {
        self.last_error = Some("Not connected".to_string());
        return;
    };
    let Some(runtime) = runtime else {
        return;
    };

    let tx = self.action_tx.clone();
    let mut client = client.clone();
    let device_id = device_id.to_string();
    let param_name = param_name.to_string();
    let new_value = new_value.to_string();

    runtime.spawn(async move {
        match client.set_parameter(&device_id, &param_name, &new_value).await {
            Ok(_) => {
                // Success - no action needed, value already updated in UI
            }
            Err(e) => {
                let _ = tx.send(ExecutionAction::Error(format!("Failed to set {}: {}", param_name, e))).await;
            }
        }
    });

    self.set_status(format!("Set {}.{} = {}", device_id, param_name, new_value));
}
```

4. Update ui() method to show parameter editor in right panel when paused:
In the right panel section (property inspector), add:
```rust
// Show parameter editor when paused
if self.execution_state.is_paused() {
    ui.add_space(8.0);
    self.show_parameter_editor_panel(ui, client, runtime);
}
```

Note: Need to check if DaqClient has a set_parameter method. If not, use the existing set_parameter implementation or call the hardware service directly. The existing pattern uses:
- `HardwareService.SetParameter` for Parameterized devices
- Or `SetDeviceState` for legacy devices

Check client.rs for existing parameter setting methods and use appropriately.
  </action>
  <verify>
`cargo build -p daq-egui` succeeds
When paused, parameter editor appears in right panel
Parameter changes are sent to daemon (visible in status message)
  </verify>
  <done>
Parameter editor appears when experiment is paused. Users can modify device parameters. Changes sent via gRPC. Editor disabled when not paused.
  </done>
</task>

</tasks>

<verification>
Run these commands to verify the plan is complete:

```bash
# Build succeeds
cargo build -p daq-egui

# Tests pass
cargo test -p daq-egui

# Check parameter editor widget
ls crates/daq-egui/src/widgets/parameter_editor.rs

# Check integration
grep -n "parameter_editor\|show_parameter_editor" crates/daq-egui/src/panels/experiment_designer.rs
```
</verification>

<success_criteria>
1. ParameterEditor widget exists with float/int/string/bool support
2. Parameter editor shows in right panel when paused
3. Parameters are disabled when not paused
4. Parameter changes sent to daemon via gRPC
5. Status feedback shown for parameter updates
</success_criteria>

<output>
After completion, create `.planning/phases/03-plan-translation-and-execution/03-03-SUMMARY.md`
</output>
