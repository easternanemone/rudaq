---
phase: 07-code-export-and-provenance
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - crates/daq-egui/Cargo.toml
  - crates/daq-egui/src/panels/code_preview.rs
  - crates/daq-egui/src/panels/mod.rs
  - crates/daq-egui/src/panels/experiment_designer.rs
autonomous: true

must_haves:
  truths:
    - "User sees live code preview when toggle is enabled"
    - "Code updates automatically when graph is edited"
    - "Copy button copies code to clipboard"
  artifacts:
    - path: "crates/daq-egui/src/panels/code_preview.rs"
      provides: "Syntax-highlighted code preview panel"
      exports: ["CodePreviewPanel"]
  key_links:
    - from: "crates/daq-egui/src/panels/code_preview.rs"
      to: "crates/daq-egui/src/graph/codegen.rs"
      via: "imports graph_to_rhai_script"
      pattern: "graph_to_rhai_script"
    - from: "crates/daq-egui/src/panels/experiment_designer.rs"
      to: "crates/daq-egui/src/panels/code_preview.rs"
      via: "contains CodePreviewPanel"
      pattern: "CodePreviewPanel"
---

<objective>
Create a live code preview panel that shows generated Rhai script as user edits the graph.

Purpose: Satisfies CODE-01 (live code preview pane). Scientists can see exactly what their visual experiment translates to, enabling them to learn Rhai syntax and verify their workflow logic.

Output: `CodePreviewPanel` widget integrated into ExperimentDesignerPanel with toggle button.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-export-and-provenance/07-RESEARCH.md

# Prior plan output needed
@.planning/phases/07-code-export-and-provenance/07-01-SUMMARY.md

# Existing infrastructure
@crates/daq-egui/src/panels/experiment_designer.rs
@crates/daq-egui/src/graph/mod.rs
@crates/daq-egui/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add egui_code_editor dependency and create CodePreviewPanel</name>
  <files>
    crates/daq-egui/Cargo.toml
    crates/daq-egui/src/panels/code_preview.rs
    crates/daq-egui/src/panels/mod.rs
  </files>
  <action>
1. Add egui_code_editor to `crates/daq-egui/Cargo.toml`:
   ```toml
   # Code editor for preview panel
   egui_code_editor = "0.3"
   ```
   Note: Check crates.io for latest compatible version with egui 0.33.

2. Create `crates/daq-egui/src/panels/code_preview.rs`:
   ```rust
   //! Code preview panel for displaying generated Rhai scripts.

   use egui_code_editor::{CodeEditor, ColorTheme, Syntax};
   use egui_snarl::Snarl;
   use crate::graph::{graph_to_rhai_script, ExperimentNode};

   /// Panel for displaying generated Rhai code from the experiment graph.
   pub struct CodePreviewPanel {
       /// Generated Rhai code (cached)
       code: String,
       /// Whether the panel is visible
       visible: bool,
       /// Hash of graph for change detection
       last_graph_version: u64,
       /// Color theme for code display
       theme: ColorTheme,
   }

   impl Default for CodePreviewPanel {
       fn default() -> Self {
           Self {
               code: String::new(),
               visible: false,
               last_graph_version: 0,
               theme: ColorTheme::GRUVBOX_DARK,
           }
       }
   }

   impl CodePreviewPanel {
       pub fn new() -> Self {
           Self::default()
       }

       /// Toggle panel visibility
       pub fn toggle(&mut self) {
           self.visible = !self.visible;
       }

       /// Check if panel is visible
       pub fn is_visible(&self) -> bool {
           self.visible
       }

       /// Update generated code from graph if changed
       pub fn update(&mut self, graph: &Snarl<ExperimentNode>, graph_version: u64) {
           if !self.visible {
               return; // Don't regenerate when hidden
           }

           if graph_version != self.last_graph_version {
               self.code = graph_to_rhai_script(graph, None);
               self.last_graph_version = graph_version;
           }
       }

       /// Render the code preview panel as a right side panel
       pub fn ui(&mut self, ctx: &egui::Context) {
           if !self.visible {
               return;
           }

           egui::SidePanel::right("code_preview_panel")
               .resizable(true)
               .default_width(400.0)
               .min_width(250.0)
               .show(ctx, |ui| {
                   ui.heading("Generated Rhai Code");

                   ui.horizontal(|ui| {
                       if ui.button("Copy").on_hover_text("Copy to clipboard").clicked() {
                           ui.output_mut(|o| o.copied_text = self.code.clone());
                       }

                       // Theme selector
                       egui::ComboBox::from_label("Theme")
                           .selected_text(self.theme_name())
                           .show_ui(ui, |ui| {
                               ui.selectable_value(&mut self.theme, ColorTheme::GRUVBOX_DARK, "Gruvbox Dark");
                               ui.selectable_value(&mut self.theme, ColorTheme::GRUVBOX, "Gruvbox Light");
                               ui.selectable_value(&mut self.theme, ColorTheme::AURA_DARK, "Aura Dark");
                           });
                   });

                   ui.separator();

                   // Scrollable code area
                   egui::ScrollArea::vertical()
                       .auto_shrink([false, false])
                       .show(ui, |ui| {
                           // Use egui_code_editor for syntax highlighting
                           // Note: CodeEditor requires mutable string but we ignore changes (read-only)
                           let mut code_copy = self.code.clone();
                           CodeEditor::default()
                               .id_source("rhai_preview")
                               .with_rows(30)
                               .with_fontsize(12.0)
                               .with_theme(self.theme)
                               .with_syntax(Syntax::rust()) // Rhai similar to Rust
                               .with_numlines(true)
                               .show(ui, &mut code_copy);
                           // Discard any edits (read-only preview)
                       });
               });
       }

       fn theme_name(&self) -> &'static str {
           match self.theme {
               ColorTheme::GRUVBOX_DARK => "Gruvbox Dark",
               ColorTheme::GRUVBOX => "Gruvbox Light",
               ColorTheme::AURA_DARK => "Aura Dark",
               _ => "Custom",
           }
       }

       /// Get the current generated code (for export)
       pub fn code(&self) -> &str {
           &self.code
       }
   }
   ```

3. Add to `crates/daq-egui/src/panels/mod.rs`:
   ```rust
   mod code_preview;
   pub use code_preview::CodePreviewPanel;
   ```
  </action>
  <verify>
`cargo check -p daq-egui` compiles without errors.
  </verify>
  <done>
CodePreviewPanel created with egui_code_editor integration. Syntax highlighting using Rust mode (compatible with Rhai). Change detection prevents unnecessary regeneration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate CodePreviewPanel into ExperimentDesignerPanel</name>
  <files>crates/daq-egui/src/panels/experiment_designer.rs</files>
  <action>
1. Add CodePreviewPanel field to ExperimentDesignerPanel struct:
   ```rust
   /// Code preview panel (shows generated Rhai)
   code_preview: CodePreviewPanel,
   ```

2. Initialize in Default impl:
   ```rust
   code_preview: CodePreviewPanel::new(),
   ```

3. Add graph version tracking (for change detection):
   ```rust
   /// Graph version counter (incremented on each edit)
   graph_version: u64,
   ```

4. Increment graph_version in all edit operations (add_node, modify_node, delete, connect, disconnect).

5. Add "Code" toggle button in toolbar (after Save As...):
   ```rust
   ui.separator();

   let code_label = if self.code_preview.is_visible() { "Hide Code" } else { "Show Code" };
   if ui.button(code_label)
       .on_hover_text("Toggle generated Rhai code preview (CODE-01)")
       .clicked()
   {
       self.code_preview.toggle();
   }
   ```

6. Update code preview at start of ui() method:
   ```rust
   // Update code preview if visible
   self.code_preview.update(&self.snarl, self.graph_version);
   ```

7. Render code preview panel in ui() method (BEFORE main panel rendering, so it claims right side):
   ```rust
   // Render code preview panel (right side)
   self.code_preview.ui(ui.ctx());
   ```
  </action>
  <verify>
`cargo build -p daq-egui` compiles. Run GUI and verify "Show Code" button appears in Experiment Designer toolbar.
  </verify>
  <done>
CodePreviewPanel integrated into ExperimentDesignerPanel. Toggle button in toolbar. Code regenerates on graph edit when panel visible.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update graph_to_rhai_script signature and add filename support</name>
  <files>crates/daq-egui/src/graph/codegen.rs</files>
  <action>
1. Update `graph_to_rhai_script()` signature to accept optional filename:
   ```rust
   pub fn graph_to_rhai_script(
       graph: &Snarl<ExperimentNode>,
       source_file: Option<&str>,
   ) -> String
   ```

2. Use filename in header comment:
   ```rust
   let source = source_file.unwrap_or("unsaved graph");
   let timestamp = chrono::Utc::now().to_rfc3339();

   format!(
       "// Generated Rhai script from visual experiment graph\n\
        // Source: {}\n\
        // Generated: {}\n\
        // DO NOT EDIT - regenerate from visual editor to make changes\n\n",
       source, timestamp
   )
   ```

3. Add chrono to daq-egui dependencies if not present (already in Cargo.toml per earlier read).

4. Update codegen tests to pass None for source_file parameter.
  </action>
  <verify>
`cargo test -p daq-egui codegen` passes. Generated code includes timestamp and source file name.
  </verify>
  <done>
graph_to_rhai_script() accepts optional filename. Header comment includes source and timestamp.
  </done>
</task>

</tasks>

<verification>
```bash
# Check compilation
cargo build -p daq-egui

# Run codegen tests
cargo test -p daq-egui codegen

# Manual verification: Run GUI and test
# 1. Open Experiment Designer
# 2. Click "Show Code" button
# 3. Add a Scan node
# 4. Verify code appears in right panel
# 5. Verify "Copy" button works
```
</verification>

<success_criteria>
- [ ] egui_code_editor added as dependency
- [ ] CodePreviewPanel renders syntax-highlighted Rhai code
- [ ] Toggle button in toolbar shows/hides panel
- [ ] Code regenerates when graph is edited (only when visible)
- [ ] Copy button copies code to clipboard
- [ ] Theme selector works
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-export-and-provenance/07-03-SUMMARY.md`
</output>
