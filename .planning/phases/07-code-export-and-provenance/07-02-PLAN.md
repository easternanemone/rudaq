---
phase: 07-code-export-and-provenance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/common/build.rs
  - crates/common/Cargo.toml
  - crates/common/src/experiment/document.rs
  - crates/common/src/experiment/mod.rs
autonomous: true

must_haves:
  truths:
    - "ExperimentManifest captures git commit hash when available"
    - "ExperimentManifest captures graph file hash when provided"
    - "Provenance fields are optional (graceful fallback when unavailable)"
  artifacts:
    - path: "crates/common/build.rs"
      provides: "Build-time git metadata capture"
      contains: "VERGEN"
    - path: "crates/common/src/experiment/document.rs"
      provides: "Extended ExperimentManifest with provenance fields"
      contains: "git_commit"
  key_links:
    - from: "crates/common/src/experiment/document.rs"
      to: "build.rs env vars"
      via: "env! or option_env! macros"
      pattern: "option_env!"
---

<objective>
Add provenance tracking to ExperimentManifest for scientific reproducibility.

Purpose: Success criterion #5 requires "every experiment run captures complete provenance (graph version, git commit, device states)." Device states already captured; this plan adds git commit and graph version tracking.

Output: Extended ExperimentManifest with git_commit, git_dirty, graph_hash fields. Build-time git metadata embedded via vergen.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-export-and-provenance/07-RESEARCH.md

# Existing infrastructure
@crates/common/src/experiment/document.rs
@crates/common/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add vergen for build-time git metadata</name>
  <files>
    crates/common/Cargo.toml
    crates/common/build.rs
  </files>
  <action>
1. Add vergen as build dependency in `crates/common/Cargo.toml`:
   ```toml
   [build-dependencies]
   vergen-gitcl = { version = "1.0", features = ["build", "cargo", "si"] }
   ```
   Note: Use `vergen-gitcl` (v1.0 fork) which is the maintained successor to vergen 8.x.

2. Create or update `crates/common/build.rs`:
   ```rust
   use vergen_gitcl::{Emitter, GitclBuilder, BuildBuilder};

   fn main() -> Result<(), Box<dyn std::error::Error>> {
       // Emit git info - uses fallback values if not in git repo
       Emitter::default()
           .add_instructions(&BuildBuilder::default().build_timestamp(true).build()?)?
           .add_instructions(&GitclBuilder::default()
               .sha(true)
               .dirty(true)
               .commit_date(true)
               .build()?)?
           .emit()?;

       Ok(())
   }
   ```

3. The build script emits these env vars at compile time:
   - `VERGEN_GIT_SHA` - Full commit SHA
   - `VERGEN_GIT_DIRTY` - "true" or "false"
   - `VERGEN_GIT_COMMIT_DATE` - ISO 8601 date
   - `VERGEN_BUILD_TIMESTAMP` - Build time

4. If build.rs fails (not in git repo), vergen emits "VERGEN_IDEMPOTENT_OUTPUT" which we handle gracefully.
  </action>
  <verify>
`cargo build -p common` completes without errors. Run `cargo build -p common -vv 2>&1 | grep VERGEN` to see emitted env vars.
  </verify>
  <done>
vergen-gitcl configured in build.rs. Git commit SHA, dirty flag, and timestamps captured at build time.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ExperimentManifest with provenance fields</name>
  <files>crates/common/src/experiment/document.rs</files>
  <action>
1. Add new optional provenance fields to `ExperimentManifest`:
   ```rust
   /// Git commit hash at build time (if available)
   #[serde(skip_serializing_if = "Option::is_none")]
   pub git_commit: Option<String>,

   /// Whether working directory had uncommitted changes
   #[serde(skip_serializing_if = "Option::is_none")]
   pub git_dirty: Option<bool>,

   /// Hash of .expgraph file (SHA256, if from saved graph)
   #[serde(skip_serializing_if = "Option::is_none")]
   pub graph_hash: Option<String>,

   /// Path to source .expgraph file (if from saved graph)
   #[serde(skip_serializing_if = "Option::is_none")]
   pub graph_file: Option<String>,
   ```

2. Update `ExperimentManifest::new()` to capture git info:
   ```rust
   // Capture git provenance from build-time env vars
   let git_commit = option_env!("VERGEN_GIT_SHA").map(String::from);
   let git_dirty = option_env!("VERGEN_GIT_DIRTY")
       .and_then(|s| s.parse::<bool>().ok());
   ```

3. Add builder method for graph provenance:
   ```rust
   /// Add graph file provenance (call when executing from saved .expgraph)
   pub fn with_graph_provenance(mut self, graph_path: &std::path::Path) -> Self {
       self.graph_file = Some(graph_path.display().to_string());

       // Compute SHA256 hash of graph file
       if let Ok(contents) = std::fs::read(graph_path) {
           use sha2::{Sha256, Digest};
           let mut hasher = Sha256::new();
           hasher.update(&contents);
           self.graph_hash = Some(format!("{:x}", hasher.finalize()));
       }

       self
   }
   ```

4. Add sha2 to common dependencies if not present:
   ```toml
   sha2 = "0.10"
   ```

5. Ensure new fields have `#[serde(default)]` for backwards compatibility when loading old manifests.
  </action>
  <verify>
`cargo test -p common document` passes. Add test that creates manifest and verifies git_commit is Some when built in git repo.
  </verify>
  <done>
ExperimentManifest has git_commit, git_dirty, graph_hash, graph_file fields. Fields populated automatically on creation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add provenance tests and documentation</name>
  <files>crates/common/src/experiment/document.rs</files>
  <action>
1. Add test for git provenance capture:
   ```rust
   #[test]
   fn test_manifest_git_provenance() {
       let manifest = ExperimentManifest::new(
           "test-run",
           "test_plan",
           "Test Plan",
           HashMap::new(),
       );

       // Git info should be captured (when built in git repo)
       // Note: May be None in some CI environments
       if let Some(sha) = &manifest.git_commit {
           assert_eq!(sha.len(), 40, "Git SHA should be 40 hex chars");
       }
   }
   ```

2. Add test for graph provenance:
   ```rust
   #[test]
   fn test_manifest_graph_provenance() {
       use std::io::Write;

       // Create temp file with known content
       let mut temp = tempfile::NamedTempFile::new().unwrap();
       writeln!(temp, "test content").unwrap();

       let manifest = ExperimentManifest::new(
           "test-run",
           "test_plan",
           "Test Plan",
           HashMap::new(),
       ).with_graph_provenance(temp.path());

       assert!(manifest.graph_file.is_some());
       assert!(manifest.graph_hash.is_some());
       assert_eq!(manifest.graph_hash.as_ref().unwrap().len(), 64, "SHA256 is 64 hex chars");
   }
   ```

3. Add test for JSON serialization roundtrip with provenance fields:
   ```rust
   #[test]
   fn test_manifest_provenance_serialization() {
       let manifest = ExperimentManifest::new(...)
           .add_system_info("custom", "value");

       let json = manifest.to_json().unwrap();
       let parsed: ExperimentManifest = serde_json::from_str(&json).unwrap();

       assert_eq!(parsed.git_commit, manifest.git_commit);
       assert_eq!(parsed.system_info.get("custom"), Some(&"value".to_string()));
   }
   ```

4. Update module doc comment to mention provenance tracking.

5. Add tempfile to dev-dependencies if not present.
  </action>
  <verify>
`cargo test -p common document` passes all tests including new provenance tests.
  </verify>
  <done>
Provenance tests verify git capture, graph hashing, and JSON roundtrip. Documentation updated.
  </done>
</task>

</tasks>

<verification>
```bash
# Check compilation with build.rs
cargo build -p common

# Run document tests
cargo test -p common document

# Verify git env vars are set (verbose build)
cargo build -p common -vv 2>&1 | grep -E "VERGEN|cargo:rustc-env"
```
</verification>

<success_criteria>
- [ ] vergen-gitcl configured in build.rs
- [ ] ExperimentManifest has git_commit, git_dirty, graph_hash, graph_file fields
- [ ] Fields auto-populated on manifest creation
- [ ] with_graph_provenance() computes SHA256 hash
- [ ] All tests pass
- [ ] Backwards compatible (old manifests still load)
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-export-and-provenance/07-02-SUMMARY.md`
</output>
