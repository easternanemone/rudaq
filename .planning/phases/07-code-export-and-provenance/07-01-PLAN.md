---
phase: 07-code-export-and-provenance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/daq-egui/src/graph/codegen.rs
  - crates/daq-egui/src/graph/mod.rs
autonomous: true

must_haves:
  truths:
    - "ExperimentNode variants generate valid Rhai code"
    - "Loop bodies are correctly indented and nested"
    - "Generated code includes comments explaining each step"
  artifacts:
    - path: "crates/daq-egui/src/graph/codegen.rs"
      provides: "Rhai code generation from ExperimentNode AST"
      exports: ["graph_to_rhai_script"]
  key_links:
    - from: "crates/daq-egui/src/graph/codegen.rs"
      to: "crates/daq-egui/src/graph/nodes.rs"
      via: "imports ExperimentNode, MoveConfig, etc."
      pattern: "use super::nodes::"
    - from: "crates/daq-egui/src/graph/codegen.rs"
      to: "crates/daq-egui/src/graph/translation.rs"
      via: "reuses topological_sort pattern"
      pattern: "topological_sort"
---

<objective>
Create the Rhai code generation engine that translates ExperimentNode graph to readable Rhai scripts.

Purpose: This is the foundation for CODE-01 (live preview) and CODE-02 (export). The code generator must produce readable, well-commented Rhai scripts that scientists can understand and learn from.

Output: `codegen.rs` module with `graph_to_rhai_script()` function and `ExperimentNode::to_rhai()` method.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-code-export-and-provenance/07-RESEARCH.md

# Existing infrastructure
@crates/daq-egui/src/graph/nodes.rs
@crates/daq-egui/src/graph/translation.rs
@crates/daq-scripting/src/rhai_engine.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create codegen.rs module with ExperimentNode::to_rhai()</name>
  <files>
    crates/daq-egui/src/graph/codegen.rs
    crates/daq-egui/src/graph/mod.rs
  </files>
  <action>
Create `crates/daq-egui/src/graph/codegen.rs` with Rhai code generation:

1. Add module doc comment explaining one-way export (visual to code only, no round-trip)

2. Implement `ExperimentNode::to_rhai()` method for each variant:
   - `Scan`: Generate for-loop with position calculation, move, wait, yield_event
   - `Move`: Generate move_abs/move_rel + optional wait_settled
   - `Wait`: Generate sleep() for Duration, threshold/stability as comments with TODO
   - `Acquire`: Generate set_exposure (if specified), trigger, read loop
   - `Loop`: Generate for-loop wrapper (body filled by graph traversal)

3. Each generated block MUST include:
   - Comment line explaining what this step does (e.g., "// Scan stage_x from 0.0 to 100.0 in 10 steps")
   - Proper indentation (2 spaces per level)
   - Newlines between logical sections

4. Use Rhai syntax (NOT Rust):
   - Variables: `let x = value;` (no `mut`)
   - Loops: `for i in 0..n { }` (no `0..=n`)
   - Object maps: `#{ key: value }` (Rhai syntax)
   - No references, no lifetimes, no Box/Arc

5. Add `mod codegen;` to `crates/daq-egui/src/graph/mod.rs` and re-export `graph_to_rhai_script`.

Example output format for Scan node:
```rhai
// Scan stage_x from 0.0 to 100.0 in 10 steps
for i in 0..10 {
  let pos = 0.0 + (100.0 - 0.0) * i / (10 - 1);
  stage_x.move_abs(pos);
  stage_x.wait_settled();
  yield_event(#{ "stage_x": pos });
}
```
  </action>
  <verify>
`cargo check -p daq-egui` compiles without errors.
  </verify>
  <done>
ExperimentNode::to_rhai() implemented for all 5 variants (Scan, Move, Wait, Acquire, Loop). Each generates commented Rhai code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement graph_to_rhai_script() with topological traversal</name>
  <files>crates/daq-egui/src/graph/codegen.rs</files>
  <action>
Add `graph_to_rhai_script()` function that translates entire graph to Rhai:

1. Take `&Snarl<ExperimentNode>` as input, return `String`.

2. Generate header comment:
   ```rhai
   // Generated Rhai script from visual experiment graph
   // Source: {filename or "unsaved"}
   // Generated: {ISO 8601 timestamp}
   // DO NOT EDIT - regenerate from visual editor to make changes
   ```

3. Reuse topological sort pattern from translation.rs:
   - Call `build_adjacency()` to get node order
   - Use Kahn's algorithm for cycle detection
   - Return error comment if cycle detected: `// ERROR: Graph contains a cycle - cannot generate code`

4. Handle loop bodies correctly:
   - Identify loop body nodes using `find_loop_body_nodes()` pattern from translation.rs
   - Skip loop body nodes in main traversal (they're handled inside loop node generation)
   - When generating Loop node, recursively call `to_rhai()` on body nodes with +1 indent level

5. Generate code for each node in topological order:
   ```rhai
   // === Node 1: Scan ===
   {node.to_rhai(indent_level)}

   // === Node 2: Acquire ===
   {node.to_rhai(indent_level)}
   ```

6. Add helper function `indent(level: usize) -> String` that returns `"  " * level`.
  </action>
  <verify>
`cargo test -p daq-egui codegen` passes. Add basic test that creates simple graph and verifies output contains expected Rhai syntax.
  </verify>
  <done>
graph_to_rhai_script() generates complete Rhai script from graph. Loop bodies correctly nested. Cycles produce error comment instead of panic.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for code generation</name>
  <files>crates/daq-egui/src/graph/codegen.rs</files>
  <action>
Add comprehensive tests at bottom of codegen.rs:

1. `test_scan_to_rhai()`: Create Scan node, verify output contains:
   - for loop
   - move_abs call
   - yield_event call
   - Comment explaining scan range

2. `test_move_to_rhai()`: Test both absolute and relative modes:
   - Absolute: `device.move_abs(pos)`
   - Relative: `device.move_rel(dist)`
   - With wait_settled: includes wait call
   - Without wait_settled: no wait call

3. `test_wait_to_rhai()`: Test Duration variant:
   - Generates `sleep(seconds)` with correct conversion from milliseconds

4. `test_acquire_to_rhai()`: Test with/without exposure:
   - With exposure: includes `set_exposure(ms)` call
   - Multiple frames: generates loop

5. `test_loop_to_rhai()`: Test Count termination:
   - Generates for loop with correct iteration count
   - Body placeholder included

6. `test_graph_to_rhai_empty()`: Empty graph returns error comment

7. `test_graph_to_rhai_single_node()`: Single node generates valid script with header

8. `test_graph_to_rhai_cycle()`: Graph with cycle returns error comment
  </action>
  <verify>
`cargo test -p daq-egui codegen` passes all tests.
  </verify>
  <done>
8+ unit tests covering all node types and edge cases. Tests verify generated Rhai syntax is valid.
  </done>
</task>

</tasks>

<verification>
```bash
# Check compilation
cargo check -p daq-egui

# Run codegen tests
cargo test -p daq-egui codegen

# Verify module is exported
grep -r "graph_to_rhai_script" crates/daq-egui/src/graph/mod.rs
```
</verification>

<success_criteria>
- [ ] codegen.rs exists with ~200-300 lines
- [ ] ExperimentNode::to_rhai() implemented for all 5 variants
- [ ] graph_to_rhai_script() handles topological sort and loop bodies
- [ ] Generated Rhai includes comments for readability
- [ ] All codegen tests pass
- [ ] Module exported in graph/mod.rs
</success_criteria>

<output>
After completion, create `.planning/phases/07-code-export-and-provenance/07-01-SUMMARY.md`
</output>
