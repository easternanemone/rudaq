---
phase: 05-live-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/daq-egui/src/widgets/auto_scale_plot.rs
  - crates/daq-egui/src/widgets/mod.rs
autonomous: true

must_haves:
  truths:
    - "Plot Y-axis grows when new data exceeds current range"
    - "Plot Y-axis never shrinks automatically during acquisition"
    - "User can lock X-axis independently from Y-axis"
    - "User can lock Y-axis independently from X-axis"
    - "Reset button restores auto-scale for both axes"
  artifacts:
    - path: "crates/daq-egui/src/widgets/auto_scale_plot.rs"
      provides: "Grow-to-fit auto-scale plot wrapper"
      exports: ["AutoScalePlot", "AxisLockState"]
      min_lines: 100
  key_links:
    - from: "crates/daq-egui/src/widgets/auto_scale_plot.rs"
      to: "egui_plot::Plot"
      via: "wrapper that configures auto_bounds"
      pattern: "Plot::new.*auto_bounds"
---

<objective>
Create a grow-to-fit auto-scale plot wrapper that only expands axis bounds when data exceeds range, with per-axis lock controls.

Purpose: Scientists need stable plots during live acquisition - axes should grow to fit new data but never shrink automatically, which causes jarring visual jumps. Per-axis control allows locking X (scan position) while Y (signal) auto-scales.

Output: `AutoScalePlot` widget wrapper with grow-only auto-scale logic and lock/unlock UI controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-live-visualization/05-CONTEXT.md
@.planning/phases/05-live-visualization/05-RESEARCH.md

Key patterns from research:
- egui_plot provides `auto_bounds([bool, bool])` for per-axis control
- Use `include_x/include_y` to enforce manual bounds when locked
- Grow-only: expand bounds.min if data < min, expand bounds.max if data > max
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AutoScalePlot widget with grow-to-fit logic</name>
  <files>
    crates/daq-egui/src/widgets/auto_scale_plot.rs
    crates/daq-egui/src/widgets/mod.rs
  </files>
  <action>
Create `auto_scale_plot.rs` with:

1. **AxisLockState struct:**
   ```rust
   pub struct AxisLockState {
       pub x_locked: bool,
       pub y_locked: bool,
       pub x_bounds: Option<[f64; 2]>,  // None = first data sets initial
       pub y_bounds: Option<[f64; 2]>,
   }
   ```

2. **AutoScalePlot struct:**
   - Stores `AxisLockState`
   - Provides `update_bounds(&mut self, points: &[[f64; 2]])` that ONLY expands bounds:
     - If `x < x_bounds[0]`, set `x_bounds[0] = x` (grow left)
     - If `x > x_bounds[1]`, set `x_bounds[1] = x` (grow right)
     - Same for Y axis
     - Skip updates for locked axes
   - Provides `reset_bounds(&mut self)` that clears x_bounds/y_bounds to None and unlocks both

3. **show() method:**
   - Takes `ui`, `id_salt`, and a closure that adds plot contents
   - Creates `Plot::new(id_salt)` with:
     - `.auto_bounds([!self.state.x_locked, !self.state.y_locked])`
     - If X locked and x_bounds set: `.include_x(min).include_x(max)`
     - If Y locked and y_bounds set: `.include_y(min).include_y(max)`
   - Calls `.show(ui, add_contents)`

4. **show_with_controls() method:**
   - Renders horizontal toolbar with:
     - Checkbox "Lock X" bound to `state.x_locked`
     - Checkbox "Lock Y" bound to `state.y_locked`
     - Button "Reset" that calls `reset_bounds()`
   - Then calls `show()` with remaining space

Add to `widgets/mod.rs`:
```rust
pub mod auto_scale_plot;
pub use auto_scale_plot::{AutoScalePlot, AxisLockState};
```
  </action>
  <verify>
    - `cargo check -p daq-egui` compiles without errors
    - File exists at `crates/daq-egui/src/widgets/auto_scale_plot.rs`
    - Module exported in `widgets/mod.rs`
  </verify>
  <done>
    - AutoScalePlot widget compiles
    - Has update_bounds() that only expands, never shrinks
    - Has show_with_controls() that renders lock checkboxes and reset button
    - Exported from widgets module
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for grow-to-fit behavior</name>
  <files>
    crates/daq-egui/src/widgets/auto_scale_plot.rs
  </files>
  <action>
Add `#[cfg(test)] mod tests` section with:

1. **test_bounds_grow_only:**
   - Create AutoScalePlot
   - Update with points [[0, 0], [10, 100]]
   - Verify x_bounds = [0, 10], y_bounds = [0, 100]
   - Update with points [[5, 50]] (inside current bounds)
   - Verify bounds unchanged (still [0,10] and [0,100])
   - Update with points [[-5, 150]] (exceeds bounds)
   - Verify bounds grew: x_bounds = [-5, 10], y_bounds = [0, 150]

2. **test_axis_lock_prevents_update:**
   - Create AutoScalePlot with x_locked = true
   - Set initial x_bounds = [0, 10]
   - Update with points [[20, 50]]
   - Verify x_bounds still [0, 10] (locked)
   - Verify y_bounds grew to include 50

3. **test_reset_clears_bounds:**
   - Create AutoScalePlot with some bounds
   - Call reset_bounds()
   - Verify x_bounds = None, y_bounds = None
   - Verify both x_locked and y_locked are false
  </action>
  <verify>
    - `cargo test -p daq-egui auto_scale_plot` passes all tests
  </verify>
  <done>
    - 3 unit tests verify grow-only behavior
    - Tests confirm locked axes don't update
    - Tests confirm reset clears bounds and unlocks
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p daq-egui` compiles without errors
2. `cargo test -p daq-egui auto_scale_plot` passes
3. `AutoScalePlot` exported from `daq_egui::widgets`
</verification>

<success_criteria>
- AutoScalePlot widget exists with grow-to-fit logic (never shrinks)
- Per-axis lock controls (X and Y independent)
- Reset button restores auto-scale
- Unit tests verify grow-only behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05-live-visualization/05-01-SUMMARY.md`
</output>
