---
phase: 05-live-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/daq-egui/src/panels/multi_detector_grid.rs
  - crates/daq-egui/src/panels/mod.rs
autonomous: true

must_haves:
  truths:
    - "Grid layout automatically adjusts to detector count (1x1, 1x2, 2x2, etc.)"
    - "Each detector gets equal-sized panel in the grid"
    - "Grid handles mixed detector types (cameras and line plots)"
    - "Empty cells rendered when detector count doesn't fill grid perfectly"
  artifacts:
    - path: "crates/daq-egui/src/panels/multi_detector_grid.rs"
      provides: "Multi-detector grid layout panel"
      exports: ["MultiDetectorGrid", "DetectorPanel", "DetectorType"]
      min_lines: 120
  key_links:
    - from: "crates/daq-egui/src/panels/multi_detector_grid.rs"
      to: "egui_extras::StripBuilder"
      via: "nested strips for rows and columns"
      pattern: "StripBuilder::new.*vertical.*horizontal"
---

<objective>
Create a multi-detector grid layout panel using StripBuilder for automatic N-detector arrangement.

Purpose: Multi-detector experiments need simultaneous visualization. Automatic grid layout (1x1, 1x2, 2x2, 2x3) based on detector count prevents manual sizing and ensures equal panel space.

Output: `MultiDetectorGrid` panel that arranges detector visualizations in responsive grid layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-live-visualization/05-CONTEXT.md
@.planning/phases/05-live-visualization/05-RESEARCH.md

Key patterns from research:
- StripBuilder nested: outer vertical for rows, inner horizontal for columns
- Size::relative() with reciprocal for equal sizing
- Grid dimensions: cols = ceil(sqrt(n)), rows = ceil(n / cols)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MultiDetectorGrid panel with StripBuilder layout</name>
  <files>
    crates/daq-egui/src/panels/multi_detector_grid.rs
    crates/daq-egui/src/panels/mod.rs
  </files>
  <action>
Create `multi_detector_grid.rs` with:

1. **DetectorType enum:**
   ```rust
   #[derive(Debug, Clone, PartialEq)]
   pub enum DetectorType {
       Camera { device_id: String },
       LinePlot { device_id: String, label: String },
   }
   ```

2. **DetectorPanel struct:**
   ```rust
   pub struct DetectorPanel {
       pub detector_type: DetectorType,
       pub title: String,
   }
   ```

3. **Helper function `calculate_grid_dimensions(count: usize) -> (usize, usize)`:**
   - Returns (rows, cols) for optimal grid
   - 1 detector: (1, 1)
   - 2 detectors: (1, 2)
   - 3-4 detectors: (2, 2)
   - 5-6 detectors: (2, 3)
   - 7-9 detectors: (3, 3)
   - General: cols = ceil(sqrt(count)), rows = ceil(count / cols)

4. **MultiDetectorGrid struct:**
   ```rust
   pub struct MultiDetectorGrid {
       panels: Vec<DetectorPanel>,
   }
   ```

5. **MultiDetectorGrid methods:**
   - `new() -> Self` - empty grid
   - `with_panels(panels: Vec<DetectorPanel>) -> Self`
   - `add_panel(&mut self, panel: DetectorPanel)`
   - `clear(&mut self)` - remove all panels
   - `panel_count(&self) -> usize`

6. **show() method using nested StripBuilder:**
   ```rust
   pub fn show(&mut self, ui: &mut egui::Ui, mut render_panel: impl FnMut(&mut egui::Ui, &DetectorPanel)) {
       let count = self.panels.len();
       if count == 0 {
           ui.centered_and_justified(|ui| {
               ui.label("No detectors configured");
           });
           return;
       }

       let (rows, cols) = calculate_grid_dimensions(count);

       // Remove spacing for seamless grid
       ui.spacing_mut().item_spacing = egui::vec2(2.0, 2.0);

       StripBuilder::new(ui)
           .sizes(Size::relative((rows as f32).recip()), rows)
           .vertical(|mut strip| {
               for r in 0..rows {
                   strip.cell(|ui| {
                       StripBuilder::new(ui)
                           .sizes(Size::relative((cols as f32).recip()), cols)
                           .horizontal(|mut strip| {
                               for c in 0..cols {
                                   let idx = r * cols + c;
                                   strip.cell(|ui| {
                                       if idx < count {
                                           render_panel(ui, &self.panels[idx]);
                                       } else {
                                           // Empty cell - gray background
                                           ui.painter().rect_filled(
                                               ui.available_rect_before_wrap(),
                                               0.0,
                                               egui::Color32::from_gray(40),
                                           );
                                       }
                                   });
                               }
                           });
                   });
               }
           });
   }
   ```

Add imports at top:
```rust
use egui_extras::{Size, StripBuilder};
```

Add to `panels/mod.rs`:
```rust
mod multi_detector_grid;
pub use multi_detector_grid::{MultiDetectorGrid, DetectorPanel, DetectorType};
```
  </action>
  <verify>
    - `cargo check -p daq-egui` compiles without errors
    - File exists at `crates/daq-egui/src/panels/multi_detector_grid.rs`
    - Module exported in `panels/mod.rs`
  </verify>
  <done>
    - MultiDetectorGrid panel compiles
    - Uses StripBuilder for nested row/column layout
    - calculate_grid_dimensions returns sensible grid sizes
    - Empty cells rendered for incomplete grids
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for grid dimension calculation</name>
  <files>
    crates/daq-egui/src/panels/multi_detector_grid.rs
  </files>
  <action>
Add `#[cfg(test)] mod tests` section with:

1. **test_grid_dimensions:**
   - assert_eq!(calculate_grid_dimensions(1), (1, 1))
   - assert_eq!(calculate_grid_dimensions(2), (1, 2))
   - assert_eq!(calculate_grid_dimensions(3), (2, 2))
   - assert_eq!(calculate_grid_dimensions(4), (2, 2))
   - assert_eq!(calculate_grid_dimensions(5), (2, 3))
   - assert_eq!(calculate_grid_dimensions(6), (2, 3))
   - assert_eq!(calculate_grid_dimensions(7), (3, 3))
   - assert_eq!(calculate_grid_dimensions(9), (3, 3))
   - assert_eq!(calculate_grid_dimensions(10), (4, 4)) // or (3, 4)

2. **test_panel_management:**
   - Create empty grid
   - Add 3 panels
   - Verify panel_count() == 3
   - Call clear()
   - Verify panel_count() == 0
  </action>
  <verify>
    - `cargo test -p daq-egui multi_detector_grid` passes all tests
  </verify>
  <done>
    - Unit tests verify grid dimension calculation
    - Tests verify panel add/clear functionality
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p daq-egui` compiles without errors
2. `cargo test -p daq-egui multi_detector_grid` passes
3. `MultiDetectorGrid` exported from `daq_egui::panels`
</verification>

<success_criteria>
- MultiDetectorGrid panel exists with StripBuilder-based layout
- Grid dimensions calculated automatically from detector count
- Empty cells rendered for incomplete grids
- Unit tests verify dimension calculation
</success_criteria>

<output>
After completion, create `.planning/phases/05-live-visualization/05-02-SUMMARY.md`
</output>
