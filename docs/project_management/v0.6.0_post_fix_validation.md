# v0.6.0 Post-Fix Validation Results

**Date:** 2025-12-20
**Validation Method:** Codex (technical) + Gemini (strategic) review
**Scope:** P0/P1 fixes completed after v0.6.0 validation

## Fixes Reviewed

1. **bd-94p9** (P0): stream_documents Manifest/Descriptor errors
2. **bd-uvpx** (P0): Broadcast lag stream termination
3. **bd-x4zt** (P1): StreamDocumentsRequest filtering
4. **bd-r5ai** (P1): Plan parameter validation
5. **bd-t1w2** (P1): RPC error handling standardization

## Critical Findings

### P0: EventDocument run_uid Filtering Broken (bd-lpzt)

**Impact:** CRITICAL - Functional regression

**Problem:**
- EventDocument payloads contain `descriptor_uid`, not `run_uid`
- Filter logic at `run_engine_service.rs:251` returns `None` for Event `doc_run_uid`
- Filter check is skipped for all Events
- **Result:** Events from ALL runs broadcast to ALL clients, regardless of requested `run_uid` filter

**Evidence:**
```rust
// Line 251: Event has descriptor_uid, not run_uid
Some(crate::grpc::proto::document::Payload::Event(_)) => None,

// Line 255: Filter is skipped when doc_run_uid is None
if let Some(uid) = doc_run_uid {
    if uid != filter_uid {
        return None; // Only executed for Start/Stop/Descriptor
    }
}
```

**Recommendation:**
- Implement descriptor_uid → run_uid mapping from Descriptor documents
- Filter Events via lookup OR drop Events when run_uid filter active but mapping unknown

**Identified by:** Codex (HIGH), Gemini (CRITICAL)

---

### P1: Brittle Lag Detection (bd-h3ki)

**Impact:** HIGH - Reliability risk

**Problem:**
- Uses string parsing: `format!("{:?}", e).contains("Lagged")`
- Unsafe - debug format changes would break lag handling
- Inefficient compared to enum matching
- **Also:** "Closed" branch is unreachable (stream ends with None, not Err)

**Evidence:**
```rust
// Line 277: Fragile string matching
let err_str = format!("{:?}", e);
if err_str.contains("Lagged") {
    // Receiver fell behind
    None
} else {
    // This branch never executes for Closed
    Some(Err(Status::unavailable(...)))
}
```

**Recommendation:** Match on `BroadcastStreamRecvError::Lagged(_)` variant directly

**Identified by:** Codex (MEDIUM), Gemini (CRITICAL)

---

### P1: O(N×M) Conversion Bottleneck (bd-p3k0)

**Impact:** MEDIUM - Scalability concern

**Problem:**
- `domain_to_proto_document()` runs inside `filter_map` closure
- With N clients and M events: N × M conversions and allocations
- `doc_types_filter` Vec cloned on every document for every client
- **Impact:** High-rate experiments (1000s events/sec) + multiple GUIs = CPU/memory pressure

**Evidence:**
```rust
// Line 234: Conversion happens per-client
let stream = BroadcastStream::new(rx).filter_map(move |result| {
    let doc_types_filter = doc_types_filter.clone(); // Vec cloned per doc
    async move {
        match domain_to_proto_document(domain_doc) { // Runs N times for N clients
```

**Recommendation:**
1. Convert to proto once upstream of broadcast, send `Arc<ProtoDoc>`
2. Use `Arc<Vec<i32>>` or `HashSet` for filters
3. Apply filters to domain documents before conversion

**Identified by:** Codex (MEDIUM), Gemini (CRITICAL/Scalability)

---

### P2: NaN/inf Validation Gap (bd-g3ik)

**Impact:** MEDIUM - Input validation gap

**Problem:**
- Float comparisons (`< 0.0`, `==`) don't catch NaN/inf
- No upper bounds for `num_points` (DoS potential)

**Example:**
```rust
if delay < 0.0 {  // NaN < 0.0 is false - bypasses check!
    return Err("delay must be >= 0".to_string());
}
```

**Recommendation:** Add `is_finite()` checks and reasonable bounds

**Identified by:** Codex (MEDIUM)

---

### P2: Poor Observability (bd-f9hn)

**Impact:** MEDIUM - Operational concern

**Problem:**
- Only visibility: `tracing::warn!` for lag
- No metrics for active streams, dropped messages, conversion latency
- Operators cannot distinguish network issues from slow clients

**Recommendation:** Add metrics for:
- `active_stream_count`
- `documents_broadcast_total`
- `documents_dropped_per_client`
- `conversion_duration_seconds`
- `filter_match_rate`

**Identified by:** Gemini (Strategic)

---

## Strategic Concerns (Gemini)

1. **Architecture:** Event filtering requires stateful service (descriptor mapping) but current design is stateless
2. **API Gaps:** No resumability (sequence_id/time_range), `get_plan_type_info` unimplemented
3. **Migration Risk:** ScanService users expecting single-run streams will get interleaved data
4. **Production Readiness:** No resource limits on broadcast channel (potential OOM)

## Validation Summary

| Finding | Priority | Type | Status |
|---------|----------|------|--------|
| EventDocument run_uid bypass | P0 | bug | bd-lpzt (open) |
| String-based lag detection | P1 | bug | bd-h3ki (open) |
| O(N×M) conversion pattern | P1 | task | bd-p3k0 (open) |
| NaN/inf validation | P2 | bug | bd-g3ik (open) |
| Observability metrics | P2 | feature | bd-f9hn (open) |

## Recommendation

**DO NOT deploy v0.6.0 to production with current stream_documents implementation.**

Critical issues (bd-lpzt, bd-h3ki) must be fixed first. The Event filtering bug is a functional regression that breaks the core promise of run_uid filtering.

**Next Steps:**
1. Fix bd-lpzt (Event filtering) - BLOCKING
2. Fix bd-h3ki (lag detection) - BLOCKING for reliability
3. Consider bd-p3k0 (performance) for multi-client scenarios
4. Address observability (bd-f9hn) before production deployment

## Positive Findings

Despite the critical issues found, the validation confirmed:
- ✅ Descriptor and Manifest handling is correct
- ✅ Parameter validation catches most invalid inputs
- ✅ Error handling is now consistent (bd-t1w2)
- ✅ Basic filtering infrastructure is in place
- ✅ Test coverage is maintained

The fixes laid a solid foundation but exposed architectural assumptions (stateless service vs stateful filtering) that need resolution.
