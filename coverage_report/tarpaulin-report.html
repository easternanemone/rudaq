<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","app","python","benches","datapoint_bench.rs"],"content":"use std::sync::Once;\n\nuse chrono::{Duration, Utc};\nuse criterion::{black_box, criterion_group, criterion_main, BatchSize, BenchmarkId, Criterion};\nuse pyo3::prelude::*;\nuse pyo3::types::PyList;\nuse pyo3::PyCell;\nuse rust_daq::core::DataPoint;\nuse rust_daq_py::PyDataPoint;\nuse serde_json::json;\n\nstatic PY_INIT: Once = Once::new();\n\nfn ensure_python_initialized() {\n    PY_INIT.call_once(|| unsafe {\n        if pyo3::ffi::Py_IsInitialized() == 0 {\n            pyo3::ffi::Py_Initialize();\n        }\n    });\n}\n\nfn base_datapoint() -\u003e DataPoint {\n    DataPoint {\n        timestamp: Utc::now(),\n        channel: \"ch1\".to_string(),\n        value: 1.2345,\n        unit: \"V\".to_string(),\n        metadata: Some(json!({ \"source\": \"bench\", \"sequence\": 0 })),\n    }\n}\n\nfn make_data_points(count: usize) -\u003e Vec\u003cDataPoint\u003e {\n    let mut base = base_datapoint();\n    (0..count)\n        .map(|idx| {\n            base.timestamp = base.timestamp + Duration::microseconds(idx as i64);\n            let mut dp = base.clone();\n            dp.channel = format!(\"ch{}\", idx % 4);\n            dp.value = idx as f64 * 0.01;\n            if let Some(meta) = \u0026mut dp.metadata {\n                meta[\"sequence\"] = json!(idx);\n            }\n            dp\n        })\n        .collect()\n}\n\nfn benchmark_datapoint_conversion(c: \u0026mut Criterion) {\n    let template = base_datapoint();\n    c.bench_function(\"datapoint_rust_to_py_struct\", |b| {\n        b.iter(|| {\n            let py_dp = PyDataPoint::from(template.clone());\n            black_box(py_dp);\n        });\n    });\n}\n\nfn benchmark_python_roundtrip(c: \u0026mut Criterion) {\n    ensure_python_initialized();\n    let template = base_datapoint();\n    c.bench_function(\"datapoint_roundtrip_rust_python_rust\", |b| {\n        b.iter(|| {\n            Python::with_gil(|py| {\n                let py_obj = Py::new(py, PyDataPoint::from(template.clone())).expect(\"create py datapoint\");\n                let py_cell = py_obj.as_ref(py);\n                let borrowed = py_cell.borrow();\n                let dp_back = DataPoint {\n                    timestamp: borrowed.timestamp,\n                    channel: borrowed.channel.clone(),\n                    value: borrowed.value,\n                    unit: borrowed.unit.clone(),\n                    metadata: borrowed.metadata.clone(),\n                };\n                black_box(dp_back);\n            });\n        });\n    });\n}\n\nfn benchmark_batch_roundtrip(c: \u0026mut Criterion) {\n    ensure_python_initialized();\n    let mut group = c.benchmark_group(\"batch_roundtrip\");\n    for \u0026size in \u0026[1usize, 100, 1_000] {\n        group.throughput(criterion::Throughput::Elements(size as u64));\n        group.bench_with_input(BenchmarkId::from_parameter(size), \u0026size, |b, \u0026count| {\n            b.iter_batched(\n                || make_data_points(count),\n                |points| {\n                    Python::with_gil(|py| {\n                        let py_list = PyList::new(\n                            py,\n                            points\n                                .iter()\n                                .cloned()\n                                .map(PyDataPoint::from)\n                                .collect::\u003cVec\u003c_\u003e\u003e(),\n                        );\n                        let back: Vec\u003cDataPoint\u003e = py_list\n                            .iter()\n                            .map(|item| {\n                                let cell: \u0026PyCell\u003cPyDataPoint\u003e = item.downcast().expect(\"PyDataPoint downcast\");\n                                let borrow = cell.borrow();\n                                DataPoint {\n                                    timestamp: borrow.timestamp,\n                                    channel: borrow.channel.clone(),\n                                    value: borrow.value,\n                                    unit: borrow.unit.clone(),\n                                    metadata: borrow.metadata.clone(),\n                                }\n                            })\n                            .collect();\n                        black_box(back);\n                    });\n                },\n                BatchSize::SmallInput,\n            );\n        });\n    }\n    group.finish();\n}\n\nfn criterion_benchmark(c: \u0026mut Criterion) {\n    benchmark_datapoint_conversion(c);\n    benchmark_python_roundtrip(c);\n    benchmark_batch_roundtrip(c);\n}\n\ncriterion_group!(name = benches; config = Criterion::default().sample_size(50); targets = criterion_benchmark);\ncriterion_main!(benches);\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","python","src","lib.rs"],"content":"//! Python bindings for the `rust_daq` instrumentation framework.\n//!\n//! The `_rust_daq` extension module is consumed through the high-level\n//! `rust_daq` Python package. It exposes ergonomic wrappers around selected\n//! instrument drivers and shared data structures from the Rust core so that\n//! experiments can be scripted in Python while reusing the real-time runtime.\n//!\n//! # Quick Start (Python)\n//! ```python\n//! import rust_daq\n//! from datetime import datetime, timezone\n//!\n//! laser = rust_daq.MaiTai(port=\"COM3\")\n//! laser.set_wavelength(800.0)\n//!\n//! meter = rust_daq.Newport1830C(\n//!     resource_string=\"USB0::0x1234::0x5678::SN910::INSTR\",\n//! )\n//! power = meter.read_power()\n//!\n//! point = rust_daq.DataPoint(\n//!     timestamp=datetime.now(timezone.utc),\n//!     channel=\"power_reading\",\n//!     value=power,\n//!     unit=\"W\",\n//!     metadata={\"instrument\": \"Newport1830C\"},\n//! )\n//! print(point)\n//! ```\n//!\n//! Expanded API and contributor documentation is available in\n//! `python/docs/api_guide.md` and `python/docs/developer_guide.md`.\n\nuse pyo3::prelude::*;\nuse rust_daq::core::DataPoint as RustDataPoint;\n\n// Re-export chrono and serde_json types for use in PyO3 structs.\nuse chrono::{DateTime, Utc};\nuse serde_json::Value as JsonValue;\n\n/// A Python-friendly representation of [`rust_daq::core::DataPoint`].\n///\n/// Each instance carries the timestamp, channel name, measurement value, and\n/// engineering units for a single acquisition sample. Optional metadata is\n/// stored as a JSON-like value to preserve arbitrary experiment context across\n/// the FFI boundary.\n///\n/// # Examples\n/// ```rust\n/// use chrono::Utc;\n/// use rust_daq::core::DataPoint as RustDataPoint;\n/// use rust_daq_py::PyDataPoint;\n/// use serde_json::json;\n///\n/// let rust_point = RustDataPoint {\n///     timestamp: Utc::now(),\n///     channel: \"power\".to_owned(),\n///     value: 1.2,\n///     unit: \"W\".to_owned(),\n///     metadata: Some(json!({\"instrument\": \"Newport1830C\"})),\n/// };\n///\n/// let py_point = PyDataPoint::from(rust_point);\n/// assert_eq!(py_point.unit, \"W\");\n/// assert!(py_point.metadata.is_some());\n/// ```\n#[pyclass(name = \"DataPoint\", module = \"rust_daq._rust_daq\")]\n#[derive(Clone)]\npub struct PyDataPoint {\n    #[pyo3(get, set)]\n    pub timestamp: DateTime\u003cUtc\u003e,\n    #[pyo3(get, set)]\n    pub channel: String,\n    #[pyo3(get, set)]\n    pub value: f64,\n    #[pyo3(get, set)]\n    pub unit: String,\n    /// Optional metadata for this data point, represented as a JSON-like object.\n    #[pyo3(get, set)]\n    pub metadata: Option\u003cJsonValue\u003e,\n}\n\n#[pymethods]\nimpl PyDataPoint {\n    #[new]\n    #[pyo3(signature = (timestamp, channel, value, unit, metadata=None))]\n    /// Creates a new `DataPoint` instance that mirrors the tuple returned by\n    /// `rust_daq` Python APIs.\n    ///\n    /// # Arguments\n    /// * `timestamp` - A timezone-aware UTC `datetime` from Python (converted to\n    ///   [`chrono::DateTime\u003cUtc\u003e`]).\n    /// * `channel` - Name of the originating channel.\n    /// * `value` - The measured value.\n    /// * `unit` - Engineering unit string, e.g. `\"W\"`.\n    /// * `metadata` - Optional JSON-like structure captured as\n    ///   [`serde_json::Value`].\n    ///\n    /// # Examples\n    /// ```rust\n    /// use chrono::Utc;\n    /// use rust_daq_py::PyDataPoint;\n    /// use serde_json::json;\n    ///\n    /// let dp = PyDataPoint::new(\n    ///     Utc::now(),\n    ///     \"power\".into(),\n    ///     1.23,\n    ///     \"W\".into(),\n    ///     Some(json!({\"status\": \"ok\"})),\n    /// );\n    /// assert_eq!(dp.channel, \"power\");\n    /// ```\n    fn new(\n        timestamp: DateTime\u003cUtc\u003e,\n        channel: String,\n        value: f64,\n        unit: String,\n        metadata: Option\u003cJsonValue\u003e,\n    ) -\u003e Self {\n        Self {\n            timestamp,\n            channel,\n            value,\n            unit,\n            metadata,\n        }\n    }\n\n    /// Returns a concise string representation used by Python's `repr()`.\n    fn __repr__(\u0026self) -\u003e String {\n        format!(\n            \"DataPoint(timestamp={}, channel='{}', value={}, unit='{}')\",\n            self.timestamp.to_rfc3339(),\n            self.channel,\n            self.value,\n            self.unit\n        )\n    }\n}\n\n/// Converts a core Rust [`DataPoint`](rust_daq::core::DataPoint) into its Python\n/// wrapper counterpart.\nimpl From\u003cRustDataPoint\u003e for PyDataPoint {\n    fn from(dp: RustDataPoint) -\u003e Self {\n        Self {\n            timestamp: dp.timestamp,\n            channel: dp.channel,\n            value: dp.value,\n            unit: dp.unit,\n            metadata: dp.metadata,\n        }\n    }\n}\n\n/// Mock implementation of a MaiTai laser for Python bindings.\n#[pyclass(name = \"MaiTai\", module = \"rust_daq._rust_daq\")]\npub struct MaiTai {\n    port: String,\n}\n\n#[pymethods]\nimpl MaiTai {\n    #[new]\n    /// Creates a new mock MaiTai driver bound to the supplied serial `port`.\n    ///\n    /// # Examples\n    /// ```rust\n    /// use pyo3::prelude::*;\n    /// use rust_daq_py::MaiTai;\n    ///\n    /// Python::with_gil(|py| -\u003e PyResult\u003c()\u003e {\n    ///     let laser = Py::new(py, MaiTai::new(\"COM3\".into()))?;\n    ///     laser.borrow(py).set_wavelength(800.0)?;\n    ///     Ok(())\n    /// })?;\n    /// # Ok::\u003c_, PyErr\u003e(())\n    /// ```\n    fn new(port: String) -\u003e Self {\n        // In a real implementation, this would establish a connection.\n        println!(\"[Rust] MaiTai: Initializing on port {}\", port);\n        Self { port }\n    }\n\n    /// Sets the wavelength of the laser in nanometres.\n    ///\n    /// # Arguments\n    /// * `wavelength` - Target wavelength in nanometres.\n    ///\n    /// This mock implementation logs the request; real drivers would validate\n    /// bounds and forward the command to the instrument. Errors are surfaced as\n    /// [`PyErr`] values.\n    fn set_wavelength(\u0026self, wavelength: f64) -\u003e PyResult\u003c()\u003e {\n        println!(\n            \"[Rust] MaiTai on port {}: Setting wavelength to {} nm\",\n            self.port, wavelength\n        );\n        // In a real implementation, this would send a command to the device.\n        Ok(())\n    }\n}\n\n/// Mock implementation of a Newport 1830C power meter.\n#[pyclass(name = \"Newport1830C\", module = \"rust_daq._rust_daq\")]\npub struct Newport1830C {\n    resource_string: String,\n}\n\n#[pymethods]\nimpl Newport1830C {\n    #[new]\n    /// Instantiates a mock Newport 1830C driver for the provided VISA resource.\n    ///\n    /// # Examples\n    /// ```rust\n    /// use pyo3::prelude::*;\n    /// use rust_daq_py::Newport1830C;\n    ///\n    /// Python::with_gil(|py| -\u003e PyResult\u003c()\u003e {\n    ///     let meter = Py::new(py, Newport1830C::new(\"USB0::0x1234::0x5678::SN910\".into()))?;\n    ///     let reading: f64 = meter.borrow(py).read_power()?;\n    ///     assert!(reading \u003e 0.0);\n    ///     Ok(())\n    /// })?;\n    /// # Ok::\u003c_, PyErr\u003e(())\n    /// ```\n    fn new(resource_string: String) -\u003e Self {\n        println!(\n            \"[Rust] Newport1830C: Initializing with resource '{}'\",\n            resource_string\n        );\n        Self { resource_string }\n    }\n\n    /// Reads the instantaneous optical power in watts.\n    ///\n    /// In this stub the value is mocked and logged to stdout. Production\n    /// drivers would perform the actual VISA transaction and convert the raw\n    /// data into SI units.\n    ///\n    /// # Examples\n    /// ```rust\n    /// use pyo3::prelude::*;\n    /// use rust_daq_py::Newport1830C;\n    ///\n    /// Python::with_gil(|py| -\u003e PyResult\u003c()\u003e {\n    ///     let meter = Py::new(py, Newport1830C::new(\"USB0::FAKE::SN1\".into()))?;\n    ///     let reading = meter.borrow(py).read_power()?;\n    ///     assert!(reading \u003e 0.0);\n    ///     Ok(())\n    /// })?;\n    /// # Ok::\u003c_, PyErr\u003e(())\n    /// ```\n    fn read_power(\u0026self) -\u003e PyResult\u003cf64\u003e {\n        println!(\n            \"[Rust] Newport1830C at {}: Reading power\",\n            self.resource_string\n        );\n        // Return a mock value for demonstration.\n        let mock_power = 1.23e-3; // 1.23 mW\n        Ok(mock_power)\n    }\n}\n\n/// Registers the PyO3 module that backs the `rust_daq` Python package.\n///\n/// The interpreter calls this entry point during `import rust_daq`. Each\n/// exposed `pyclass` is added to the module so it becomes available as a\n/// top-level attribute on the Python side.\n#[pymodule]\nfn _rust_daq(_py: Python, m: \u0026Bound\u003c'_, PyModule\u003e) -\u003e PyResult\u003c()\u003e {\n    m.add_class::\u003cPyDataPoint\u003e()?;\n    m.add_class::\u003cMaiTai\u003e()?;\n    m.add_class::\u003cNewport1830C\u003e()?;\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use chrono::{TimeZone, Utc};\n    use pyo3::exceptions::PyTypeError;\n    use pyo3::types::PyType;\n    use pyo3::Python;\n    use rust_daq::core::DataPoint as RustDataPoint;\n    use serde_json::json;\n\n    fn rust_datapoint_with_metadata() -\u003e RustDataPoint {\n        RustDataPoint {\n            timestamp: Utc.with_ymd_and_hms(2024, 1, 15, 12, 0, 0).unwrap(),\n            channel: \"detector:signal\".to_string(),\n            value: 2.5,\n            unit: \"V\".to_string(),\n            metadata: Some(json!({\n                \"experiment\": \"integration\",\n                \"laser\": { \"wavelength_nm\": 795.0 }\n            })),\n        }\n    }\n\n    #[test]\n    fn pydata_point_from_rust_preserves_all_fields() {\n        let rust_dp = rust_datapoint_with_metadata();\n        let py_dp = PyDataPoint::from(rust_dp.clone());\n\n        assert_eq!(py_dp.timestamp, rust_dp.timestamp);\n        assert_eq!(py_dp.channel, rust_dp.channel);\n        assert_eq!(py_dp.value, rust_dp.value);\n        assert_eq!(py_dp.unit, rust_dp.unit);\n        assert_eq!(py_dp.metadata, rust_dp.metadata);\n    }\n\n    #[test]\n    fn pydata_point_from_rust_handles_none_metadata() {\n        let rust_dp = RustDataPoint {\n            metadata: None,\n            ..rust_datapoint_with_metadata()\n        };\n\n        let py_dp = PyDataPoint::from(rust_dp.clone());\n\n        assert!(py_dp.metadata.is_none());\n        assert_eq!(py_dp.timestamp, rust_dp.timestamp);\n    }\n\n    #[test]\n    fn pydata_point_repr_includes_channel_and_unit() {\n        let py_dp = PyDataPoint::from(rust_datapoint_with_metadata());\n        let repr = py_dp.__repr__();\n\n        assert!(repr.contains(\"detector:signal\"));\n        assert!(repr.contains(\"V\"));\n    }\n\n    #[test]\n    fn pydata_point_clone_retains_metadata() {\n        let original = PyDataPoint::from(rust_datapoint_with_metadata());\n        let cloned = original.clone();\n\n        assert_eq!(original.metadata, cloned.metadata);\n        assert_eq!(original.channel, cloned.channel);\n    }\n\n    #[test]\n    fn pydata_point_constructor_rejects_non_json_metadata() {\n        pyo3::prepare_freethreaded_python();\n        Python::with_gil(|py| {\n            let dp_type: \u0026PyType = py.get_type::\u003cPyDataPoint\u003e();\n            let timestamp = Utc.with_ymd_and_hms(2024, 7, 1, 8, 30, 0).unwrap();\n            let invalid_metadata = py.eval_bound(\"object()\", None, None).unwrap();\n            let result = dp_type.call1((\n                timestamp,\n                \"detector:signal\".to_string(),\n                1.0_f64,\n                \"V\".to_string(),\n                invalid_metadata,\n            ));\n\n            let err = result.expect_err(\"non-JSON metadata should raise a TypeError\");\n            assert!(err.is_instance_of::\u003cPyTypeError\u003e(py));\n        });\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","rust_daq","src","data","fft.rs"],"content":"//! An FFT (Fast Fourier Transform) data processor for frequency analysis.\n\nuse crate::core::{DataPoint, DataProcessor};\nuse chrono::{LocalResult, TimeZone, Utc};\nuse log::{debug, warn};\nuse num_complex::Complex;\nuse rustfft::{Fft, FftPlanner};\nuse std::collections::VecDeque;\nuse std::sync::Arc;\n\n/// A data processor that performs a Fast Fourier Transform (FFT) on a sliding window of data.\n///\n/// This processor collects time-domain samples into a buffer. When the buffer is full,\n/// it applies a Hann window to the samples, performs an FFT, and converts the output\n/// to a frequency spectrum.\n///\n/// The output `DataPoint`s represent the frequency spectrum:\n/// - `timestamp`: Encodes the frequency of the bin. This is a workaround to fit into the `DataPoint` struct.\n///   The frequency `f` (in Hz) is encoded as a `DateTime` representing `UNIX_EPOCH + f seconds`.\n/// - `value`: The magnitude of the frequency bin in decibels (dB).\n/// - `unit`: \"dB\".\n/// - `channel`: The channel of the input data.\n///\n/// # Example\n///\n/// ```\n/// use rust_daq::core::{DataPoint, DataProcessor};\n/// use rust_daq::data::fft::{FFTConfig, FFTProcessor};\n/// use chrono::{Utc, TimeZone};\n/// use std::collections::HashMap;\n///\n/// // This is a conceptual example. In a real application, you would get DataPoints from an instrument.\n/// fn conceptual_example() {\n///     let sample_rate = 1024.0;\n///     let config = FFTConfig {\n///         window_size: 1024,\n///         overlap: 512,\n///         sampling_rate: sample_rate,\n///     };\n///     let mut fft_processor = FFTProcessor::new(config);\n///\n///     // Generate a sine wave for testing\n///     let frequency = 50.0;\n///     let mut sine_wave = Vec::new();\n///     for i in 0..2048 {\n///         let t = i as f64 / sample_rate;\n///         let value = (2.0 * std::f64::consts::PI * frequency * t).sin();\n///         sine_wave.push(DataPoint {\n///             timestamp: Utc.timestamp_nanos((t * 1_000_000_000.0) as i64),\n///             channel: \"test\".to_string(),\n///             value,\n///             unit: \"V\".to_string(),\n///             metadata: None,\n///         });\n///     }\n///\n///     let spectrum = fft_processor.process(\u0026sine_wave);\n///     // The `spectrum` will contain `DataPoint`s representing the frequency spectrum.\n///     // There should be a peak around 50 Hz.\n/// }\n/// ```\n#[derive(Clone)]\npub struct FFTProcessor {\n    window_size: usize,\n    overlap: usize,\n    sampling_rate: f64,\n    buffer: VecDeque\u003cf64\u003e,\n    fft_planner: Arc\u003cdyn Fft\u003cf64\u003e\u003e,\n    hann_window: Vec\u003cf64\u003e,\n    channel: String,\n}\n\nimpl FFTProcessor {\n    /// Creates a new `FFTProcessor`.\n    ///\n    /// # Arguments\n    ///\n    /// * `window_size` - The number of samples to use for each FFT. This should be a power of 2 for optimal performance.\n    /// * `overlap` - The number of samples to overlap between consecutive windows. Must be less than `window_size`.\n    /// * `sampling_rate` - The sampling rate of the incoming data in Hz.\n    pub fn new(window_size: usize, overlap: usize, sampling_rate: f64) -\u003e Self {\n        assert!(\n            overlap \u003c window_size,\n            \"Overlap must be less than window size\"\n        );\n        assert!(sampling_rate \u003e 0.0, \"Sampling rate must be positive\");\n\n        let mut planner = FftPlanner::new();\n        let fft = planner.plan_fft_forward(window_size);\n\n        let mut hann_window = Vec::with_capacity(window_size);\n        if window_size \u003e 1 {\n            for i in 0..window_size {\n                // Hann window formula\n                let val = 0.5\n                    * (1.0\n                        - (2.0 * std::f64::consts::PI * i as f64 / (window_size - 1) as f64).cos());\n                hann_window.push(val);\n            }\n        }\n\n        Self {\n            window_size,\n            overlap,\n            sampling_rate,\n            buffer: VecDeque::with_capacity(window_size * 2),\n            fft_planner: fft,\n            hann_window,\n            channel: String::from(\"unknown\"),\n        }\n    }\n\n    fn frequency_to_timestamp(frequency: f64) -\u003e Option\u003cchrono::DateTime\u003cUtc\u003e\u003e {\n        let secs = frequency.trunc() as i64;\n        let nanos_fraction = (frequency.fract() * 1_000_000_000.0).round();\n        let mut secs = secs;\n        let mut nanos = nanos_fraction as i64;\n\n        if nanos \u003e= 1_000_000_000 {\n            secs += 1;\n            nanos -= 1_000_000_000;\n        }\n\n        if nanos \u003c 0 {\n            return None;\n        }\n\n        match Utc.timestamp_opt(secs, nanos as u32) {\n            LocalResult::Single(ts) | LocalResult::Ambiguous(ts, _) =\u003e Some(ts),\n            LocalResult::None =\u003e None,\n        }\n    }\n}\n\nimpl DataProcessor for FFTProcessor {\n    /// Processes a slice of `DataPoint`s, performing an FFT when enough data is available.\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        if data.is_empty() {\n            return vec![];\n        }\n\n        // Update channel from the first data point\n        if self.channel == \"unknown\" {\n            self.channel = data[0].channel.clone();\n        }\n\n        self.buffer.extend(data.iter().map(|dp| dp.value));\n        debug!(\"Buffer size: {}\", self.buffer.len());\n\n        let mut all_fft_results = Vec::new();\n        let step_size = self.window_size - self.overlap;\n\n        while self.buffer.len() \u003e= self.window_size {\n            debug!(\"Processing window. Buffer size: {}\", self.buffer.len());\n\n            let mut complex_buffer: Vec\u003cComplex\u003cf64\u003e\u003e = self.buffer\n                .iter()\n                .take(self.window_size)\n                .zip(self.hann_window.iter())\n                .map(|(\u0026val, \u0026win_val)| Complex::new(val * win_val, 0.0))\n                .collect();\n\n            self.fft_planner.process(\u0026mut complex_buffer);\n\n            let freq_resolution = self.sampling_rate / self.window_size as f64;\n            let num_bins = self.window_size / 2;\n\n            let mut fft_dps = Vec::with_capacity(num_bins);\n\n            if num_bins \u003e 0 {\n                let dc_val = \u0026complex_buffer[0];\n                let magnitude = dc_val.norm() / self.window_size as f64;\n                let magnitude_db = if magnitude \u003e 1e-6 {\n                    20.0 * magnitude.log10()\n                } else {\n                    -120.0\n                };\n\n                if let Some(timestamp) = Self::frequency_to_timestamp(0.0) {\n                    fft_dps.push(DataPoint {\n                        timestamp,\n                        channel: self.channel.clone(),\n                        value: magnitude_db,\n                        unit: \"dB\".to_string(),\n                        metadata: None,\n                    });\n                } else {\n                    warn!(\"Skipping DC component: unable to encode frequency as timestamp\");\n                }\n            }\n\n            for i in 1..num_bins {\n                let complex_val = \u0026complex_buffer[i];\n                let magnitude = (complex_val.norm() * 2.0) / self.window_size as f64;\n                let magnitude_db = if magnitude \u003e 1e-6 {\n                    20.0 * magnitude.log10()\n                } else {\n                    -120.0\n                };\n\n                let frequency = i as f64 * freq_resolution;\n\n                if let Some(timestamp) = Self::frequency_to_timestamp(frequency) {\n                    fft_dps.push(DataPoint {\n                        timestamp,\n                        channel: self.channel.clone(),\n                        value: magnitude_db,\n                        unit: \"dB\".to_string(),\n                        metadata: None,\n                    });\n                } else {\n                    warn!(\n                        \"Skipping frequency bin at {} Hz: unable to encode frequency as timestamp\",\n                        frequency\n                    );\n                }\n            }\n\n            all_fft_results.extend(fft_dps);\n            self.buffer.drain(..step_size);\n            debug!(\"Drained buffer. New size: {}\", self.buffer.len());\n        }\n\n        all_fft_results\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","rust_daq","src","data","iir_filter.rs"],"content":"//! An IIR (Infinite Impulse Response) filter data processor.\nuse crate::core::{DataPoint, DataProcessor};\nuse biquad::{Biquad, Coefficients, DirectForm1, ToHertz, Q_BUTTERWORTH_F64};\nuse serde::Deserialize;\n\n/// The type of IIR filter to apply.\n#[derive(Debug, Deserialize, Clone)]\npub enum FilterType {\n    /// A low-pass filter allows frequencies below the cutoff frequency to pass through.\n    Lowpass,\n    /// A high-pass filter allows frequencies above the cutoff frequency to pass through.\n    Highpass,\n    /// A band-pass filter allows frequencies within a certain range to pass through.\n    Bandpass,\n    /// A band-stop (or notch) filter rejects frequencies within a certain range.\n    Bandstop,\n}\n\n/// Configuration for the `IirFilter`.\n///\n/// This struct is typically deserialized from a configuration file.\n#[derive(Debug, Deserialize, Clone)]\npub struct IirFilterConfig {\n    /// The type of filter to apply.\n    pub filter_type: FilterType,\n    /// The cutoff or center frequency of the filter in Hz.\n    pub f0: f64,\n    /// The sample rate of the data in Hz.\n    pub fs: f64,\n    /// The quality factor (Q) of the filter. Determines the sharpness of the filter's transition.\n    /// If not provided, a default Butterworth Q value is used.\n    pub q: Option\u003cf64\u003e,\n}\n\n/// A data processor that applies an IIR filter to a stream of `DataPoint`s.\n///\n/// This processor uses the `biquad` crate to implement a second-order IIR filter.\n/// It supports low-pass, high-pass, band-pass, and band-stop (notch) filters.\n///\n/// # Example Configuration (`.toml`)\n///\n/// ```toml\n/// [[processors.my_instrument]]\n/// type = \"iir\"\n/// filter_type = \"Lowpass\"\n/// f0 = 50.0  # Cutoff frequency in Hz\n/// fs = 1000.0 # Sample rate in Hz\n/// q = 0.707  # Optional quality factor\n/// ```\npub struct IirFilter {\n    filter: DirectForm1\u003cf64\u003e,\n}\n\nimpl IirFilter {\n    pub fn new(config: IirFilterConfig) -\u003e Result\u003cSelf, \u0026'static str\u003e {\n        let coeffs = Self::design_filter(\u0026config)?;\n        Ok(Self {\n            filter: DirectForm1::\u003cf64\u003e::new(coeffs),\n        })\n    }\n\n    fn design_filter(config: \u0026IirFilterConfig) -\u003e Result\u003cCoefficients\u003cf64\u003e, \u0026'static str\u003e {\n        let f0 = config.f0.hz();\n        let fs = config.fs.hz();\n        let q = match config.q {\n            Some(value) =\u003e value,\n            None =\u003e Q_BUTTERWORTH_F64,\n        };\n\n        let result = match config.filter_type {\n            FilterType::Lowpass =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::LowPass, fs, f0, q)\n            }\n            FilterType::Highpass =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::HighPass, fs, f0, q)\n            }\n            FilterType::Bandpass =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::BandPass, fs, f0, q)\n            }\n            FilterType::Bandstop =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::Notch, fs, f0, q)\n            }\n        };\n        result.map_err(|_| \"Failed to create IIR filter coefficients\")\n    }\n}\n\nimpl DataProcessor for IirFilter {\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        data.iter()\n            .map(|dp| {\n                let mut new_dp = dp.clone();\n                new_dp.value = self.filter.run(dp.value);\n                new_dp.channel = format!(\"{}_filtered\", dp.channel);\n                new_dp\n            })\n            .collect()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::core::DataPoint;\n    use chrono::Utc;\n\n    fn create_test_data(len: usize) -\u003e Vec\u003cDataPoint\u003e {\n        (0..len)\n            .map(|i| DataPoint {\n                timestamp: Utc::now(),\n                channel: \"test\".to_string(),\n                value: i as f64,\n                unit: \"V\".to_string(),\n                metadata: None,\n            })\n            .collect()\n    }\n\n    #[test]\n    fn test_lowpass_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Lowpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: None,\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_highpass_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Highpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: None,\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_bandpass_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Bandpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: Some(1.0),\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_bandstop_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Bandstop,\n            f0: 100.0,\n            fs: 1000.0,\n            q: Some(1.0),\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_invalid_filter_params() {\n        // f0 \u003e fs / 2\n        let config = IirFilterConfig {\n            filter_type: FilterType::Lowpass,\n            f0: 600.0,\n            fs: 1000.0,\n            q: None,\n        };\n        assert!(IirFilter::new(config).is_err());\n    }\n\n    #[test]\n    fn test_filter_processes_data() -\u003e Result\u003c(), \u0026'static str\u003e {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Lowpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: None,\n        };\n        let mut filter = IirFilter::new(config)?;\n        let data = create_test_data(10);\n        let original_values: Vec\u003cf64\u003e = data.iter().map(|dp| dp.value).collect();\n\n        let processed_data = filter.process(\u0026data);\n        let processed_values: Vec\u003cf64\u003e = processed_data.iter().map(|dp| dp.value).collect();\n\n        assert_ne!(original_values, processed_values);\n        assert_eq!(processed_data[0].channel, \"test_filtered\");\n        Ok(())\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","rust_daq","src","data","processor.rs"],"content":"//! Example data processors.\nuse crate::core::{DataPoint, DataProcessor};\nuse std::collections::VecDeque;\n\n/// A simple moving average filter.\npub struct MovingAverage {\n    window_size: usize,\n    buffer: VecDeque\u003cf64\u003e,\n}\n\nimpl MovingAverage {\n    pub fn new(window_size: usize) -\u003e Self {\n        Self {\n            window_size,\n            buffer: VecDeque::with_capacity(window_size),\n        }\n    }\n}\n\nimpl DataProcessor for MovingAverage {\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        let mut processed_data = Vec::new();\n        for dp in data {\n            self.buffer.push_back(dp.value);\n            if self.buffer.len() \u003e self.window_size {\n                self.buffer.pop_front();\n            }\n\n            let sum: f64 = self.buffer.iter().sum();\n            let avg = sum / self.buffer.len() as f64;\n\n            processed_data.push(DataPoint {\n                value: avg,\n                metadata: dp.metadata.clone(),\n                ..dp.clone()\n            });\n        }\n        processed_data\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","src","app.rs"],"content":"//! The core application state and logic.\nuse crate::{\n    config::Settings,\n    core::{DataPoint, DataProcessor, InstrumentHandle},\n    data::registry::ProcessorRegistry,\n    instrument::InstrumentRegistry,\n    log_capture::LogBuffer,\n    metadata::Metadata,\n    session::{self, Session},\n};\nuse anyhow::{anyhow, Context, Result};\nuse log::{error, info};\nuse std::collections::HashMap;\nuse std::path::Path;\nuse std::sync::{Arc, Mutex};\nuse tokio::{runtime::Runtime, sync::broadcast, task::JoinHandle};\n\n/// The main application struct that holds all state.\n#[derive(Clone)]\npub struct DaqApp {\n    inner: Arc\u003cMutex\u003cDaqAppInner\u003e\u003e,\n}\n\n/// Inner state of the DAQ application, protected by a Mutex.\npub struct DaqAppInner {\n    pub settings: Arc\u003cSettings\u003e,\n    pub instrument_registry: Arc\u003cInstrumentRegistry\u003e,\n    pub processor_registry: Arc\u003cProcessorRegistry\u003e,\n    pub instruments: HashMap\u003cString, InstrumentHandle\u003e,\n    pub data_sender: broadcast::Sender\u003cDataPoint\u003e,\n    pub log_buffer: LogBuffer,\n    pub metadata: Metadata,\n    pub writer_task: Option\u003cJoinHandle\u003cResult\u003c()\u003e\u003e\u003e,\n    pub storage_format: String,\n    runtime: Arc\u003cRuntime\u003e,\n    shutdown_flag: bool,\n    // Keep the initial receiver alive to buffer data until GUI subscribes\n    _data_receiver_keeper: broadcast::Receiver\u003cDataPoint\u003e,\n}\n\nimpl DaqApp {\n    /// Creates a new `DaqApp`.\n    pub fn new(\n        settings: Arc\u003cSettings\u003e,\n        instrument_registry: Arc\u003cInstrumentRegistry\u003e,\n        processor_registry: Arc\u003cProcessorRegistry\u003e,\n        log_buffer: LogBuffer,\n    ) -\u003e Result\u003cSelf\u003e {\n        let runtime = Arc::new(Runtime::new().context(\"Failed to create Tokio runtime\")?);\n        let (data_sender, data_receiver_keeper) = broadcast::channel(1024);\n        let storage_format = settings.storage.default_format.clone();\n\n        let mut inner = DaqAppInner {\n            settings: settings.clone(),\n            instrument_registry,\n            processor_registry,\n            instruments: HashMap::new(),\n            data_sender,\n            log_buffer,\n            metadata: Metadata::default(),\n            writer_task: None,\n            storage_format,\n            runtime,\n            shutdown_flag: false,\n            _data_receiver_keeper: data_receiver_keeper,\n        };\n\n        for id in settings.instruments.keys() {\n            if let Err(e) = inner.spawn_instrument(id) {\n                error!(\"Failed to spawn instrument '{}': {}\", id, e);\n            }\n        }\n\n        Ok(Self {\n            inner: Arc::new(Mutex::new(inner)),\n        })\n    }\n\n    /// Provides safe access to the inner application state.\n    pub fn with_inner\u003cF, R\u003e(\u0026self, f: F) -\u003e R\n    where\n        F: FnOnce(\u0026mut DaqAppInner) -\u003e R,\n    {\n        let mut inner = self.inner.lock().unwrap();\n        f(\u0026mut inner)\n    }\n\n    /// Returns a clone of the application's Tokio runtime handle.\n    pub fn get_runtime(\u0026self) -\u003e Arc\u003cRuntime\u003e {\n        self.with_inner(|inner| inner.runtime.clone())\n    }\n\n    /// Shuts down the application, stopping all instruments and the Tokio runtime.\n    pub fn shutdown(\u0026self) {\n        self.with_inner(|inner| {\n            if inner.shutdown_flag {\n                return;\n            }\n            info!(\"Shutting down application runtime...\");\n            inner.shutdown_flag = true;\n            // Stop all instruments\n            for (id, handle) in inner.instruments.drain() {\n                info!(\"Stopping instrument: {}\", id);\n                handle.task.abort();\n            }\n        });\n    }\n\n    /// Saves the current application state to a session file.\n    pub fn save_session(\u0026self, path: \u0026Path, gui_state: session::GuiState) -\u003e Result\u003c()\u003e {\n        let session = Session::from_app(self, gui_state);\n        session::save_session(\u0026session, path)\n    }\n\n    /// Loads application state from a session file.\n    pub fn load_session(\u0026self, path: \u0026Path) -\u003e Result\u003csession::GuiState\u003e {\n        let session = session::load_session(path)?;\n        let gui_state = session.gui_state.clone();\n        session.apply_to_app(self);\n        Ok(gui_state)\n    }\n}\n\nimpl DaqAppInner {\n    /// Spawns an instrument to run on the Tokio runtime.\n    pub fn spawn_instrument(\u0026mut self, id: \u0026str) -\u003e Result\u003c()\u003e {\n        if self.instruments.contains_key(id) {\n            return Err(anyhow!(\"Instrument '{}' is already running.\", id));\n        }\n\n        let instrument_config = self\n            .settings\n            .instruments\n            .get(id)\n            .ok_or_else(|| anyhow!(\"Instrument config for '{}' not found.\", id))?;\n        let instrument_type = instrument_config\n            .get(\"type\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| anyhow!(\"Instrument type for '{}' not found in config.\", id))?;\n\n        let mut instrument = self\n            .instrument_registry\n            .create(instrument_type, id)\n            .ok_or_else(|| anyhow!(\"Instrument type '{}' not found.\", instrument_type))?;\n\n        // Create processor chain for this instrument\n        let mut processors: Vec\u003cBox\u003cdyn DataProcessor\u003e\u003e = Vec::new();\n        if let Some(processor_configs) = self.settings.processors.as_ref().and_then(|p| p.get(id)) {\n            for config in processor_configs {\n                let processor = self\n                    .processor_registry\n                    .create(\u0026config.r#type, \u0026config.config)\n                    .with_context(|| {\n                        format!(\n                            \"Failed to create processor '{}' for instrument '{}'\",\n                            config.r#type, id\n                        )\n                    })?;\n                processors.push(processor);\n            }\n        }\n\n        let data_sender = self.data_sender.clone();\n        let settings = self.settings.clone();\n        let id_clone = id.to_string();\n\n        // Create command channel\n        let (command_tx, mut command_rx) = tokio::sync::mpsc::channel(32);\n\n        let task: JoinHandle\u003cResult\u003c()\u003e\u003e = self.runtime.spawn(async move {\n            instrument\n                .connect(\u0026settings)\n                .await\n                .with_context(|| format!(\"Failed to connect to instrument '{}'\", id_clone))?;\n            info!(\"Instrument '{}' connected.\", id_clone);\n\n            let mut stream = instrument\n                .data_stream()\n                .await\n                .context(\"Failed to get data stream\")?;\n            loop {\n                tokio::select! {\n                    data_point_result = stream.recv() =\u003e {\n                        match data_point_result {\n                            Ok(dp) =\u003e {\n                                let mut data_points = vec![dp];\n                                for processor in \u0026mut processors {\n                                    data_points = processor.process(\u0026data_points);\n                                }\n\n                                for processed_dp in data_points {\n                                    if let Err(e) = data_sender.send(processed_dp) {\n                                        error!(\"Failed to broadcast data point: {}\", e);\n                                    }\n                                }\n                            }\n                            Err(e) =\u003e {\n                                error!(\"Stream receive error: {}\", e);\n                                break;\n                            }\n                        }\n                    }\n                    Some(command) = command_rx.recv() =\u003e {\n                        if let Err(e) = instrument.handle_command(command).await {\n                            error!(\"Failed to handle command for '{}': {}\", id_clone, e);\n                        }\n                    }\n                    _ = tokio::time::sleep(std::time::Duration::from_secs(1)) =\u003e {\n                        log::trace!(\"Instrument stream for {} is idle.\", id_clone);\n                    }\n                }\n            }\n            Ok(())\n        });\n\n        let handle = InstrumentHandle { task, command_tx };\n        self.instruments.insert(id.to_string(), handle);\n        Ok(())\n    }\n\n    /// Stops a running instrument.\n    pub fn stop_instrument(\u0026mut self, id: \u0026str) {\n        if let Some(handle) = self.instruments.remove(id) {\n            handle.task.abort();\n            info!(\"Instrument '{}' stopped.\", id);\n        }\n    }\n\n    /// Sends a command to a running instrument.\n    pub fn send_instrument_command(\u0026self, id: \u0026str, command: crate::core::InstrumentCommand) -\u003e Result\u003c()\u003e {\n        let handle = self.instruments.get(id)\n            .ok_or_else(|| anyhow!(\"Instrument '{}' is not running\", id))?;\n\n        handle.command_tx.try_send(command)\n            .map_err(|e| anyhow!(\"Failed to send command to instrument '{}': {}\", id, e))?;\n\n        Ok(())\n    }\n\n    /// Returns a list of available channel names.\n    pub fn get_available_channels(\u0026self) -\u003e Vec\u003cString\u003e {\n        self.instrument_registry.list().collect()\n    }\n\n    /// Starts the data recording process.\n    pub fn start_recording(\u0026mut self) -\u003e Result\u003c()\u003e {\n        if self.writer_task.is_some() {\n            return Err(anyhow!(\"Recording is already in progress.\"));\n        }\n\n        let settings = self.settings.clone();\n        let metadata = self.metadata.clone();\n        let mut rx = self.data_sender.subscribe();\n        let storage_format_for_task = self.storage_format.clone();\n\n        let task = self.runtime.spawn(async move {\n            let mut writer: Box\u003cdyn crate::core::StorageWriter\u003e =\n                match storage_format_for_task.as_str() {\n                    \"csv\" =\u003e Box::new(crate::data::storage::CsvWriter::new()),\n                    \"hdf5\" =\u003e Box::new(crate::data::storage::Hdf5Writer::new()),\n                    \"arrow\" =\u003e Box::new(crate::data::storage::ArrowWriter::new()),\n                    _ =\u003e {\n                        return Err(anyhow!(\n                            \"Unsupported storage format: {}\",\n                            storage_format_for_task\n                        ))\n                    }\n                };\n\n            writer.init(\u0026settings).await?;\n            writer.set_metadata(\u0026metadata).await?;\n\n            loop {\n                tokio::select! {\n                    data_point = rx.recv() =\u003e {\n                        match data_point {\n                            Ok(dp) =\u003e {\n                                if let Err(e) = writer.write(\u0026[dp]).await {\n                                    error!(\"Failed to write data point: {}\", e);\n                                }\n                            }\n                            Err(broadcast::error::RecvError::Lagged(n)) =\u003e {\n                                log::warn!(\"Data writer lagged by {} messages.\", n);\n                            }\n                            Err(broadcast::error::RecvError::Closed) =\u003e {\n                                break;\n                            }\n                        }\n                    }\n                }\n            }\n\n            writer.shutdown().await?;\n            Ok(())\n        });\n\n        self.writer_task = Some(task);\n        info!(\"Started recording with format: {}\", self.storage_format);\n        Ok(())\n    }\n\n    /// Stops the data recording process.\n    pub fn stop_recording(\u0026mut self) {\n        if let Some(task) = self.writer_task.take() {\n            task.abort();\n            info!(\"Stopped recording.\");\n        }\n    }\n}\n","traces":[{"line":43,"address":[31323616,31325896,31326341],"length":1,"stats":{"Line":2}},{"line":49,"address":[40502427,40502279,40504823],"length":1,"stats":{"Line":4}},{"line":50,"address":[37583025,37583097],"length":1,"stats":{"Line":4}},{"line":51,"address":[37583231,37583161],"length":1,"stats":{"Line":4}},{"line":54,"address":[37944709,37944776],"length":1,"stats":{"Line":4}},{"line":57,"address":[37518976],"length":1,"stats":{"Line":2}},{"line":60,"address":[37519087],"length":1,"stats":{"Line":2}},{"line":68,"address":[37583918,37583988],"length":1,"stats":{"Line":4}},{"line":69,"address":[37519732,37519964],"length":1,"stats":{"Line":4}},{"line":70,"address":[31325541,31325451,31325569],"length":1,"stats":{"Line":6}},{"line":74,"address":[40503952],"length":1,"stats":{"Line":2}},{"line":75,"address":[37519760],"length":1,"stats":{"Line":2}},{"line":80,"address":[33176960,33175488,33173722,33168304,33174586,33167498,33167066,33173328,33175920,33177354,33167536,33172592,33169812,33175882,33176934,33169466,33172122,33174156,33176630,33176656,33175450,33175018,33166672,33172160,33170666,33174192,33167872,33168736,33168266,33176314,33171697,33167844,33171703,33172870,33169044,33169504,33169840,33169072,33170234,33170969,33170975,33170992,33172876,33170272,33172554,33173290,33175056,33176636,33171728,33174624,33167850,33167104,33169818,33171386,33171424,33173760,33176352,33176940,33168698,33172896,33169050,33170704],"length":1,"stats":{"Line":6}},{"line":84,"address":[35735594,35729971,35735940,35737107,35732698,35733111,35729203,35731213,35734730,35737412,35736871,35731865,35730724,35730810,35733780,35733866,35734235,35735076,35735508,35736372,35736458,35736803,35729610,35731444,35727642,35728410,35731530,35727124,35733348,35728003,35727556,35728842,35728074,35731145,35731933,35732180,35734321,35735162,35736026,35733043,35737498,35729524,35733434,35732612,35729274,35727210,35728756,35730042,35730378,35732266,35737175,35728324,35730292,35734644],"length":1,"stats":{"Line":12}},{"line":85,"address":[31129943,31130952,31128490,31134391,31134594,31133103,31134620,31136295,31132728,31136905,31134904,31131928,31135495,31135895,31136695,31129352,31129143,31137767,31128396,31131317,31137176,31137367,31132119,31132519,31133129,31133400,31131738,31130345,31133212,31133800,31136104,31135095,31137576,31133991,31132328,31131143,31131344,31131644,31131431,31128096,31133591,31129752,31132919,31128655,31128370,31135304,31136504,31128764,31134200,31134714,31129543,31130743,31136988,31128175,31128069,31131618,31136879,31128681,31130552,31135704,31128952,31130175],"length":1,"stats":{"Line":6}},{"line":89,"address":[37521024],"length":1,"stats":{"Line":2}},{"line":90,"address":[33177401,33177392],"length":1,"stats":{"Line":6}},{"line":94,"address":[37946896],"length":1,"stats":{"Line":2}},{"line":95,"address":[32815984,32816951,32816945],"length":1,"stats":{"Line":4}},{"line":96,"address":[31137860],"length":1,"stats":{"Line":2}},{"line":99,"address":[33177580,33177453],"length":1,"stats":{"Line":4}},{"line":100,"address":[32751643],"length":1,"stats":{"Line":2}},{"line":102,"address":[32751940,32751869,32751650],"length":1,"stats":{"Line":6}},{"line":103,"address":[32752150,32752178,32752041],"length":1,"stats":{"Line":6}},{"line":104,"address":[32816572],"length":1,"stats":{"Line":2}},{"line":110,"address":[37946912,37947084,37947090],"length":1,"stats":{"Line":0}},{"line":111,"address":[40505212],"length":1,"stats":{"Line":0}},{"line":112,"address":[40505246],"length":1,"stats":{"Line":0}},{"line":116,"address":[37521248,37521936,37521942],"length":1,"stats":{"Line":0}},{"line":117,"address":[37585736],"length":1,"stats":{"Line":0}},{"line":118,"address":[31327027],"length":1,"stats":{"Line":0}},{"line":119,"address":[37947595],"length":1,"stats":{"Line":0}},{"line":120,"address":[37521801],"length":1,"stats":{"Line":0}},{"line":126,"address":[37589365,37588161,37586384],"length":1,"stats":{"Line":2}},{"line":127,"address":[37586423],"length":1,"stats":{"Line":2}},{"line":128,"address":[37586646],"length":1,"stats":{"Line":0}},{"line":131,"address":[37522399,37522120,37522185],"length":1,"stats":{"Line":4}},{"line":134,"address":[37522156],"length":1,"stats":{"Line":2}},{"line":135,"address":[37586581,37586799],"length":1,"stats":{"Line":2}},{"line":136,"address":[37586909,37586978],"length":1,"stats":{"Line":2}},{"line":138,"address":[32817104,32817113],"length":1,"stats":{"Line":6}},{"line":139,"address":[31138978,31138960],"length":1,"stats":{"Line":2}},{"line":141,"address":[37948579,37948648,37948500],"length":1,"stats":{"Line":6}},{"line":143,"address":[37948548],"length":1,"stats":{"Line":2}},{"line":144,"address":[31139106,31139088],"length":1,"stats":{"Line":8}},{"line":147,"address":[37948730],"length":1,"stats":{"Line":2}},{"line":148,"address":[31139251,31139216],"length":1,"stats":{"Line":8}},{"line":149,"address":[40507318,40507247,40507814],"length":1,"stats":{"Line":6}},{"line":150,"address":[31329008,31328805,31328619,31328751],"length":1,"stats":{"Line":4}},{"line":152,"address":[37523367],"length":1,"stats":{"Line":2}},{"line":153,"address":[40507528],"length":1,"stats":{"Line":2}},{"line":154,"address":[32817478],"length":1,"stats":{"Line":0}},{"line":159,"address":[40507719],"length":1,"stats":{"Line":2}},{"line":163,"address":[37949039,37949695],"length":1,"stats":{"Line":4}},{"line":164,"address":[37949711,37949780],"length":1,"stats":{"Line":4}},{"line":165,"address":[40508036,40508109],"length":1,"stats":{"Line":4}},{"line":168,"address":[31329349,31329264],"length":1,"stats":{"Line":4}},{"line":170,"address":[37588627,37588558],"length":1,"stats":{"Line":8}},{"line":171,"address":[33179865,33179947,33180484,33179507,33179208,33179259,33179780],"length":1,"stats":{"Line":10}},{"line":172,"address":[35739687,35739695],"length":1,"stats":{"Line":4}},{"line":173,"address":[32818016,32818149,32817876,32818089,32818364],"length":1,"stats":{"Line":6}},{"line":174,"address":[35740363,35748352,35748377,35740270],"length":1,"stats":{"Line":2}},{"line":175,"address":[31140425,31140324],"length":1,"stats":{"Line":4}},{"line":177,"address":[35740860,35741188,35740474,35741262,35741383,35741115],"length":1,"stats":{"Line":8}},{"line":178,"address":[31140402],"length":1,"stats":{"Line":2}},{"line":179,"address":[32819010,32819092,32819259,32817897,32818937],"length":1,"stats":{"Line":6}},{"line":180,"address":[32819277,32819374],"length":1,"stats":{"Line":2}},{"line":181,"address":[31142679],"length":1,"stats":{"Line":2}},{"line":182,"address":[35739790,35742931,35746117,35754929,35748117,35742157,35742833,35744594,35741853,35747705,35743180,35741344,35744098,35744883,35742956,35742337,35747804,35744802,35743098,35746942,35743495,35743030],"length":1,"stats":{"Line":18}},{"line":183,"address":[32821061,32822858],"length":1,"stats":{"Line":4}},{"line":184,"address":[32822880],"length":1,"stats":{"Line":2}},{"line":185,"address":[32823120],"length":1,"stats":{"Line":2}},{"line":186,"address":[32758898,32758834],"length":1,"stats":{"Line":4}},{"line":187,"address":[31145196,31145280,31146574],"length":1,"stats":{"Line":6}},{"line":188,"address":[33185198,33186256,33186291],"length":1,"stats":{"Line":4}},{"line":191,"address":[32759602,32759400],"length":1,"stats":{"Line":4}},{"line":192,"address":[32759763,32759834],"length":1,"stats":{"Line":4}},{"line":193,"address":[35746275,35746365,35746393],"length":1,"stats":{"Line":0}},{"line":197,"address":[32823040],"length":1,"stats":{"Line":0}},{"line":198,"address":[35746979,35744944,35746928],"length":1,"stats":{"Line":0}},{"line":203,"address":[33182575,33195400,33187182],"length":1,"stats":{"Line":2}},{"line":204,"address":[28588980],"length":1,"stats":{"Line":0}},{"line":205,"address":[32756186,32756158,32755996],"length":1,"stats":{"Line":0}},{"line":208,"address":[35743154,35743076],"length":1,"stats":{"Line":4}},{"line":209,"address":[32761551,32758547],"length":1,"stats":{"Line":0}},{"line":213,"address":[32825077],"length":1,"stats":{"Line":0}},{"line":216,"address":[37524463],"length":1,"stats":{"Line":2}},{"line":217,"address":[37588919,37589011],"length":1,"stats":{"Line":4}},{"line":218,"address":[37589107],"length":1,"stats":{"Line":2}},{"line":222,"address":[31330645,31330176,31330639],"length":1,"stats":{"Line":0}},{"line":223,"address":[37525017],"length":1,"stats":{"Line":0}},{"line":224,"address":[40509194],"length":1,"stats":{"Line":0}},{"line":225,"address":[40509259,40509318],"length":1,"stats":{"Line":0}},{"line":230,"address":[37951891,37951344,37951920],"length":1,"stats":{"Line":0}},{"line":231,"address":[37525518,37526015,37525714,37525649],"length":1,"stats":{"Line":0}},{"line":232,"address":[37525613,37525701],"length":1,"stats":{"Line":0}},{"line":234,"address":[37951801,37951734,37951849,37951614],"length":1,"stats":{"Line":0}},{"line":235,"address":[37525932,37525844],"length":1,"stats":{"Line":0}},{"line":237,"address":[31331119],"length":1,"stats":{"Line":0}},{"line":241,"address":[37951936],"length":1,"stats":{"Line":0}},{"line":242,"address":[40510206],"length":1,"stats":{"Line":0}},{"line":246,"address":[37952032,37953200,37953250],"length":1,"stats":{"Line":0}},{"line":247,"address":[40510292],"length":1,"stats":{"Line":0}},{"line":248,"address":[31331433],"length":1,"stats":{"Line":0}},{"line":251,"address":[37590666],"length":1,"stats":{"Line":0}},{"line":252,"address":[40510391,40510498],"length":1,"stats":{"Line":0}},{"line":253,"address":[37590826,37590907],"length":1,"stats":{"Line":0}},{"line":254,"address":[37591007,37590931],"length":1,"stats":{"Line":0}},{"line":256,"address":[31331726,31331783],"length":1,"stats":{"Line":0}},{"line":258,"address":[33188781,33189252,33188568],"length":1,"stats":{"Line":0}},{"line":259,"address":[32827444,32827945,32827363],"length":1,"stats":{"Line":0}},{"line":260,"address":[31148973,31149021,31149378,31148922],"length":1,"stats":{"Line":0}},{"line":261,"address":[35749626,35749447,35749367,35749414],"length":1,"stats":{"Line":0}},{"line":263,"address":[33188996,33189029],"length":1,"stats":{"Line":0}},{"line":270,"address":[32764317,32763792,32763659,32763426,32762768],"length":1,"stats":{"Line":0}},{"line":271,"address":[32827205,32828784,32829182,32828568],"length":1,"stats":{"Line":0}},{"line":273,"address":[35751005],"length":1,"stats":{"Line":0}},{"line":274,"address":[28587929,28587868,28587785,28587393,28587792],"length":1,"stats":{"Line":0}},{"line":275,"address":[32765640,32766525],"length":1,"stats":{"Line":0}},{"line":276,"address":[35752848],"length":1,"stats":{"Line":0}},{"line":277,"address":[32766634],"length":1,"stats":{"Line":0}},{"line":278,"address":[37132558],"length":1,"stats":{"Line":0}},{"line":279,"address":[32765181,32765331,32765306],"length":1,"stats":{"Line":0}},{"line":282,"address":[32831401],"length":1,"stats":{"Line":0}},{"line":283,"address":[35753288,35753474],"length":1,"stats":{"Line":0}},{"line":293,"address":[33193356,33188708,33192909,33194073],"length":1,"stats":{"Line":0}},{"line":294,"address":[31153570],"length":1,"stats":{"Line":0}},{"line":297,"address":[37591308,37591280],"length":1,"stats":{"Line":0}},{"line":298,"address":[40511137,40511039],"length":1,"stats":{"Line":0}},{"line":299,"address":[31332110],"length":1,"stats":{"Line":0}},{"line":303,"address":[40511536,40511922,40511928],"length":1,"stats":{"Line":0}},{"line":304,"address":[37953311],"length":1,"stats":{"Line":0}},{"line":305,"address":[37527511],"length":1,"stats":{"Line":0}},{"line":306,"address":[37527635,37527576],"length":1,"stats":{"Line":0}}],"covered":72,"coverable":134},{"path":["/","app","src","config.rs"],"content":"//! Configuration management for the DAQ application.\n//!\n//! This module defines the data structures for the application's configuration,\n//! which is loaded from TOML files. It uses the `config` crate to handle file\n//! loading and deserialization and `serde` for the data structures.\n//!\n//! ## Schema\n//!\n//! The configuration is structured as follows:\n//!\n//! - **`log_level`**: A string representing the logging verbosity (e.g., \"info\", \"debug\").\n//! - **`storage`**: A table containing storage settings.\n//!   - `default_path`: The directory where data files are saved.\n//!   - `default_format`: The default file format for saving data (e.g., \"csv\", \"hdf5\").\n//! - **`instruments`**: A map where each key is a unique instrument ID and the value is a\n//!   TOML table defining the instrument's properties. The `type` field within this table\n//!   is mandatory and determines which instrument driver is used. Other fields are\n//!   specific to the instrument type.\n//! - **`processors`**: An optional map where each key corresponds to a data channel. The value\n//!   is a list of processor configurations to be applied to the data from that channel.\n//!   Each processor has a `type` and its own specific configuration.\n//!\n//! ## Validation\n//!\n//! The `Settings::new` function loads and deserializes the configuration. After loading,\n//! it calls the `validate` method, which performs a series of checks on the configuration\n//! values to ensure they are valid. This includes:\n//!\n//! - Checking that required fields are not empty.\n//! - Validating log levels against a predefined list.\n//! - Ensuring file paths are valid.\n//! - Validating network parameters like IP addresses and port numbers.\n//! - Checking that numerical values (like sample rates) are within reasonable ranges.\n//!\n//! Validation logic is implemented in the `validation` module. If validation fails,\n//! the application will not start, preventing runtime errors due to misconfiguration.\n\nuse crate::validation::{is_in_range, is_not_empty, is_valid_ip, is_valid_path, is_valid_port};\nuse anyhow::{Context, Result};\nuse config::Config;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n#[derive(Debug, Deserialize, Clone)]\npub struct Settings {\n    pub log_level: String,\n    pub storage: StorageSettings,\n    pub instruments: HashMap\u003cString, toml::Value\u003e,\n    pub processors: Option\u003cHashMap\u003cString, Vec\u003cProcessorConfig\u003e\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct ProcessorConfig {\n    pub r#type: String,\n    #[serde(flatten)]\n    pub config: toml::Value,\n}\n\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct StorageSettings {\n    pub default_path: String,\n    pub default_format: String,\n}\n\nimpl Settings {\n    pub fn new(config_name: Option\u003c\u0026str\u003e) -\u003e Result\u003cSelf\u003e {\n        let config_path = format!(\"config/{}\", config_name.unwrap_or(\"default\"));\n        let s = Config::builder()\n            .add_source(config::File::with_name(\u0026config_path))\n            .build()\n            .with_context(|| format!(\"Failed to load configuration from '{}'\", config_path))?;\n\n        let settings: Settings = s\n            .try_deserialize()\n            .context(\"Failed to deserialize configuration\")?;\n        settings.validate()?;\n        Ok(settings)\n    }\n}\n\nimpl Settings {\n    fn validate(\u0026self) -\u003e Result\u003c()\u003e {\n        is_not_empty(\u0026self.log_level)\n            .map_err(anyhow::Error::msg)\n            .context(\"log_level cannot be empty\")?;\n        let valid_log_levels = [\"error\", \"warn\", \"info\", \"debug\", \"trace\"];\n        if !valid_log_levels.contains(\u0026self.log_level.to_lowercase().as_str()) {\n            anyhow::bail!(\"Invalid log level: {}\", self.log_level);\n        }\n\n        is_valid_path(\u0026self.storage.default_path)\n            .map_err(anyhow::Error::msg)\n            .context(\"Invalid storage default_path\")?;\n        is_not_empty(\u0026self.storage.default_format)\n            .map_err(anyhow::Error::msg)\n            .context(\"storage default_format cannot be empty\")?;\n\n        for (name, instrument) in \u0026self.instruments {\n            self.validate_instrument(name, instrument)?;\n        }\n\n        Ok(())\n    }\n\n    fn validate_instrument(\u0026self, name: \u0026str, instrument: \u0026toml::Value) -\u003e Result\u003c()\u003e {\n        if let Some(resource_string) = instrument.get(\"resource_string\").and_then(|v| v.as_str()) {\n            if resource_string.starts_with(\"TCPIP\") {\n                let parts: Vec\u003c\u0026str\u003e = resource_string.split(\"::\").collect();\n                if parts.len() \u003e= 2 {\n                    let ip_address = parts[1];\n                    is_valid_ip(ip_address)\n                        .map_err(anyhow::Error::msg)\n                        .with_context(|| {\n                            format!(\"Invalid IP address for {}: {}\", name, ip_address)\n                        })?;\n                }\n            }\n        }\n\n        if let Some(sample_rate) = instrument.get(\"sample_rate_hz\").and_then(|v| v.as_float()) {\n            is_in_range(sample_rate, 0.1..=1_000_000.0)\n                .map_err(anyhow::Error::msg)\n                .with_context(|| format!(\"Invalid sample_rate_hz for {}\", name))?;\n        }\n\n        if let Some(num_samples) = instrument.get(\"num_samples\").and_then(|v| v.as_integer()) {\n            is_in_range(num_samples, 1..=1_000_000)\n                .map_err(anyhow::Error::msg)\n                .with_context(|| format!(\"Invalid num_samples for {}\", name))?;\n        }\n\n        if let Some(address) = instrument.get(\"address\").and_then(|v| v.as_str()) {\n            is_valid_ip(address)\n                .map_err(anyhow::Error::msg)\n                .with_context(|| format!(\"Invalid IP address for {}\", name))?;\n        }\n\n        if let Some(port) = instrument.get(\"port\").and_then(|v| v.as_integer()) {\n            is_valid_port(port as u16)\n                .map_err(anyhow::Error::msg)\n                .with_context(|| format!(\"Invalid port for {}\", name))?;\n        }\n\n        Ok(())\n    }\n}\n","traces":[{"line":66,"address":[32534106,32534052,32532704],"length":1,"stats":{"Line":2}},{"line":67,"address":[35516865],"length":1,"stats":{"Line":2}},{"line":68,"address":[32533233,32532957,32533120,32533321,32534082],"length":1,"stats":{"Line":6}},{"line":69,"address":[29322412,29321388,29321520,29321421],"length":1,"stats":{"Line":4}},{"line":71,"address":[31039376,31039401],"length":1,"stats":{"Line":2}},{"line":73,"address":[32534058,32533567,32533655,32533440],"length":1,"stats":{"Line":4}},{"line":76,"address":[32959612,32959673],"length":1,"stats":{"Line":4}},{"line":77,"address":[35518015],"length":1,"stats":{"Line":2}},{"line":82,"address":[35518224,35519416,35519422],"length":1,"stats":{"Line":2}},{"line":83,"address":[32960057,32960109,32960004],"length":1,"stats":{"Line":4}},{"line":84,"address":[94499633,94498672,94499735],"length":1,"stats":{"Line":2}},{"line":86,"address":[94563118],"length":1,"stats":{"Line":2}},{"line":87,"address":[29323037,29322710],"length":1,"stats":{"Line":4}},{"line":88,"address":[35518679],"length":1,"stats":{"Line":0}},{"line":91,"address":[29323110,29323185,29323056],"length":1,"stats":{"Line":4}},{"line":92,"address":[32960624],"length":1,"stats":{"Line":2}},{"line":94,"address":[94188677],"length":1,"stats":{"Line":4}},{"line":95,"address":[35519026],"length":1,"stats":{"Line":2}},{"line":98,"address":[54273600],"length":1,"stats":{"Line":4}},{"line":99,"address":[32599607,32599697],"length":1,"stats":{"Line":2}},{"line":102,"address":[94188461,94189362,94189229],"length":1,"stats":{"Line":2}},{"line":105,"address":[32961961,32961200,32961955],"length":1,"stats":{"Line":2}},{"line":106,"address":[35519500],"length":1,"stats":{"Line":6}},{"line":107,"address":[32599936],"length":1,"stats":{"Line":2}},{"line":108,"address":[35519723],"length":1,"stats":{"Line":2}},{"line":109,"address":[32961550,32961615],"length":1,"stats":{"Line":4}},{"line":110,"address":[32961640],"length":1,"stats":{"Line":2}},{"line":111,"address":[35520049,35519944,35520129],"length":1,"stats":{"Line":4}},{"line":112,"address":[32600311],"length":1,"stats":{"Line":2}},{"line":113,"address":[32535916],"length":1,"stats":{"Line":2}},{"line":114,"address":[31039574],"length":1,"stats":{"Line":0}},{"line":120,"address":[28795673,28795664],"length":1,"stats":{"Line":8}},{"line":121,"address":[29324418,29324497,29324625],"length":1,"stats":{"Line":4}},{"line":122,"address":[35520294],"length":1,"stats":{"Line":2}},{"line":123,"address":[32962063,32962195],"length":1,"stats":{"Line":2}},{"line":126,"address":[38203008,38203017],"length":1,"stats":{"Line":8}},{"line":127,"address":[32536402,32536477,32536625],"length":1,"stats":{"Line":4}},{"line":128,"address":[29324718],"length":1,"stats":{"Line":2}},{"line":129,"address":[38203040,38203065],"length":1,"stats":{"Line":2}},{"line":132,"address":[29324794,29324912],"length":1,"stats":{"Line":8}},{"line":133,"address":[32962539,32962577,32962708],"length":1,"stats":{"Line":4}},{"line":134,"address":[94565008,94564869,94564340,94564980,94564272],"length":1,"stats":{"Line":2}},{"line":135,"address":[54273797],"length":1,"stats":{"Line":2}},{"line":138,"address":[94500650,94500556,94500624,94499875],"length":1,"stats":{"Line":8}},{"line":139,"address":[32962750,32962791,32962869],"length":1,"stats":{"Line":4}},{"line":140,"address":[35521005],"length":1,"stats":{"Line":2}},{"line":141,"address":[94566069,94566107,94565088],"length":1,"stats":{"Line":2}},{"line":144,"address":[32601396],"length":1,"stats":{"Line":2}}],"covered":46,"coverable":48},{"path":["/","app","src","core.rs"],"content":"//! Core traits and data types for the DAQ application.\nuse crate::config::Settings;\nuse crate::metadata::Metadata;\nuse async_trait::async_trait;\nuse serde::{Deserialize, Serialize};\nuse std::sync::Arc;\nuse tokio::sync::{broadcast, mpsc};\nuse tokio::task::JoinHandle;\n\n/// A single data point captured from an instrument.\n#[derive(Clone, Debug, Serialize, Deserialize)]\npub struct DataPoint {\n    pub timestamp: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub channel: String,\n    pub value: f64,\n    pub unit: String,\n    /// Optional metadata for this specific data point.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub metadata: Option\u003cserde_json::Value\u003e,\n}\n\n/// Command that can be sent to an instrument.\n#[derive(Clone, Debug)]\npub enum InstrumentCommand {\n    /// Set a parameter (key, value)\n    SetParameter(String, String),\n    /// Query a parameter (key) - response will be sent via data stream\n    QueryParameter(String),\n    /// Execute a command with optional arguments\n    Execute(String, Vec\u003cString\u003e),\n}\n\n/// A handle to a running instrument task.\npub struct InstrumentHandle {\n    pub task: JoinHandle\u003canyhow::Result\u003c()\u003e\u003e,\n    pub command_tx: mpsc::Sender\u003cInstrumentCommand\u003e,\n}\n\n/// Trait for any scientific instrument.\n///\n/// This trait defines the common interface for all instruments, allowing them\n/// to be managed and controlled in a generic way.\n#[async_trait]\npub trait Instrument: Send + Sync {\n    /// Returns the name of the instrument.\n    fn name(\u0026self) -\u003e String;\n\n    /// Connects to the instrument and prepares it for data acquisition.\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e anyhow::Result\u003c()\u003e;\n\n    /// Disconnects from the instrument.\n    async fn disconnect(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e;\n\n    /// Returns a stream of `DataPoint`s from the instrument.\n    async fn data_stream(\u0026mut self) -\u003e anyhow::Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e;\n\n    /// Handles a command sent to the instrument. Default implementation does nothing.\n    async fn handle_command(\u0026mut self, _command: InstrumentCommand) -\u003e anyhow::Result\u003c()\u003e {\n        Ok(())\n    }\n}\n\n/// Trait for a data processor.\n///\n/// Data processors can be chained to form a processing pipeline.\npub trait DataProcessor: Send + Sync {\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e;\n}\n\n/// Trait for a data storage writer.\n#[async_trait]\npub trait StorageWriter: Send + Sync {\n    /// Initializes the storage (e.g., creates a file, opens a database connection).\n    async fn init(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e anyhow::Result\u003c()\u003e;\n\n    /// Sets the experiment-level metadata for this storage session.\n    /// This should be called once after `init` and before the first `write`.\n    async fn set_metadata(\u0026mut self, metadata: \u0026Metadata) -\u003e anyhow::Result\u003c()\u003e;\n\n    /// Writes a batch of data points to the storage.\n    async fn write(\u0026mut self, data: \u0026[DataPoint]) -\u003e anyhow::Result\u003c()\u003e;\n\n    /// Finalizes the storage (e.g., closes the file).\n    async fn shutdown(\u0026mut self) -\u003e anyhow::Result\u003c()\u003e;\n}\n","traces":[{"line":58,"address":[36598656,36598128,36598365,36598254,36598512,36598533,36598729,36598345,36598749,36598638,36598149,36598210,36598594,36598272],"length":1,"stats":{"Line":0}},{"line":59,"address":[36598324,36598708],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":2},{"path":["/","app","src","data","fft.rs"],"content":"//! An FFT (Fast Fourier Transform) data processor for frequency analysis.\n\nuse crate::core::{DataPoint, DataProcessor};\nuse chrono::Utc;\nuse log::debug;\nuse num_complex::Complex;\nuse rustfft::{Fft, FftPlanner};\nuse serde::Deserialize;\nuse std::collections::VecDeque;\nuse std::sync::Arc;\n\n/// Represents a single frequency bin in an FFT spectrum.\n#[derive(Debug, Clone, PartialEq)]\npub struct FrequencyBin {\n    pub frequency: f64,\n    pub magnitude: f64,\n}\n\n/// Configuration for the FFTProcessor.\n#[derive(Clone, Debug, Deserialize)]\npub struct FFTConfig {\n    pub window_size: usize,\n    pub overlap: usize,\n    pub sampling_rate: f64,\n}\n\n/// A data processor that performs a Fast Fourier Transform (FFT) on a sliding window of data.\n///\n/// This processor collects time-domain samples into a buffer. When the buffer is full,\n/// it applies a Hann window to the samples, performs an FFT, and converts the output\n/// to a frequency spectrum.\n///\n/// The output `DataPoint`s represent the frequency spectrum:\n/// - `timestamp`: Encodes the frequency of the bin. This is a workaround to fit into the `DataPoint` struct.\n///   The frequency `f` (in Hz) is encoded as a `DateTime` representing `UNIX_EPOCH + f seconds`.\n/// - `value`: The magnitude of the frequency bin in decibels (dB).\n/// - `unit`: \"dB\".\n/// - `channel`: The channel of the input data.\n///\n/// # Example\n///\n/// ```\n/// use rust_daq::core::{DataPoint, DataProcessor};\n/// use rust_daq::data::fft::{FFTConfig, FFTProcessor};\n/// use chrono::{Utc, TimeZone};\n/// use std::collections::HashMap;\n///\n/// // This is a conceptual example. In a real application, you would get DataPoints from an instrument.\n/// fn conceptual_example() {\n///     let config = FFTConfig {\n///         window_size: 1024,\n///         overlap: 512,\n///         sampling_rate: 1024.0,\n///     };\n///     let mut fft_processor = FFTProcessor::new(config.clone());\n///\n///     // Generate a sine wave for testing\n///     let frequency = 50.0;\n///     let mut sine_wave = Vec::new();\n///     for i in 0..2048 {\n///         let t = i as f64 / config.sampling_rate;\n///         let value = (2.0 * std::f64::consts::PI * frequency * t).sin();\n///         sine_wave.push(DataPoint {\n///             timestamp: Utc.timestamp_nanos((t * 1_000_000_000.0) as i64),\n///             channel: \"test\".to_string(),\n///             value,\n///             unit: \"V\".to_string(),\n///             metadata: None,\n///         });\n///     }\n///\n///     let spectrum = fft_processor.process(\u0026sine_wave);\n///     // The `spectrum` will contain `DataPoint`s representing the frequency spectrum.\n///     // There should be a peak around 50 Hz.\n/// }\n/// ```\n#[derive(Clone)]\npub struct FFTProcessor {\n    window_size: usize,\n    overlap: usize,\n    sampling_rate: f64,\n    buffer: VecDeque\u003cf64\u003e,\n    fft_planner: Arc\u003cdyn Fft\u003cf64\u003e\u003e,\n    hann_window: Vec\u003cf64\u003e,\n    channel: String,\n}\n\nimpl FFTProcessor {\n    /// Creates a new `FFTProcessor`.\n    ///\n    /// # Arguments\n    ///\n    /// * `config` - The configuration for the FFT processor.\n    pub fn new(config: FFTConfig) -\u003e Self {\n        assert!(\n            config.overlap \u003c config.window_size,\n            \"Overlap must be less than window size\"\n        );\n        assert!(config.sampling_rate \u003e 0.0, \"Sampling rate must be positive\");\n\n        let mut planner = FftPlanner::new();\n        let fft = planner.plan_fft_forward(config.window_size);\n\n        let mut hann_window = Vec::with_capacity(config.window_size);\n        if config.window_size \u003e 1 {\n            for i in 0..config.window_size {\n                // Hann window formula\n                let val = 0.5\n                    * (1.0\n                        - (2.0 * std::f64::consts::PI * i as f64\n                            / (config.window_size - 1) as f64)\n                            .cos());\n                hann_window.push(val);\n            }\n        }\n\n        Self {\n            window_size: config.window_size,\n            overlap: config.overlap,\n            sampling_rate: config.sampling_rate,\n            buffer: VecDeque::with_capacity(config.window_size * 2),\n            fft_planner: fft,\n            hann_window,\n            channel: String::from(\"unknown\"),\n        }\n    }\n\n    /// Processes a slice of `DataPoint`s, performing an FFT when enough data is available.\n    pub fn process_fft(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cFrequencyBin\u003e {\n        if data.is_empty() {\n            return vec![];\n        }\n\n        // Update channel from the first data point\n        if self.channel == \"unknown\" {\n            self.channel = data[0].channel.clone();\n        }\n\n        self.buffer.extend(data.iter().map(|dp| dp.value));\n        debug!(\"Buffer size: {}\", self.buffer.len());\n\n        let mut all_fft_results = Vec::new();\n        let step_size = self.window_size - self.overlap;\n\n        while self.buffer.len() \u003e= self.window_size {\n            debug!(\"Processing window. Buffer size: {}\", self.buffer.len());\n\n            let mut complex_buffer: Vec\u003cComplex\u003cf64\u003e\u003e = self\n                .buffer\n                .iter()\n                .take(self.window_size)\n                .zip(self.hann_window.iter())\n                .map(|(\u0026val, \u0026win_val)| Complex::new(val * win_val, 0.0))\n                .collect();\n\n            self.fft_planner.process(\u0026mut complex_buffer);\n\n            let freq_resolution = self.sampling_rate / self.window_size as f64;\n            let num_bins = self.window_size / 2;\n\n            let mut fft_bins = Vec::with_capacity(num_bins);\n\n            if num_bins \u003e 0 {\n                let magnitude = complex_buffer[0].norm() / self.window_size as f64;\n                let magnitude_db = if magnitude \u003e 1e-6 {\n                    20.0 * magnitude.log10()\n                } else {\n                    -120.0\n                };\n                fft_bins.push(FrequencyBin {\n                    frequency: 0.0,\n                    magnitude: magnitude_db,\n                });\n            }\n\n            for (i, complex_val) in complex_buffer.iter().enumerate().take(num_bins).skip(1) {\n                let magnitude = (complex_val.norm() * 2.0) / self.window_size as f64;\n                let magnitude_db = if magnitude \u003e 1e-6 {\n                    20.0 * magnitude.log10()\n                } else {\n                    -120.0\n                };\n\n                let frequency = i as f64 * freq_resolution;\n\n                fft_bins.push(FrequencyBin {\n                    frequency,\n                    magnitude: magnitude_db,\n                });\n            }\n\n            all_fft_results.extend(fft_bins);\n            self.buffer.drain(0..step_size);\n            debug!(\"Drained buffer. New size: {}\", self.buffer.len());\n        }\n\n        all_fft_results\n    }\n}\n\nimpl DataProcessor for FFTProcessor {\n    /// Processes a slice of `DataPoint`s, performing an FFT when enough data is available.\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        let fft_bins = self.process_fft(data);\n        let timestamp = data.last().map_or_else(Utc::now, |dp| dp.timestamp);\n\n        fft_bins\n            .into_iter()\n            .map(|bin| {\n                let metadata = serde_json::json!({\n                    \"frequency_hz\": bin.frequency,\n                    \"magnitude_db\": bin.magnitude,\n                });\n\n                DataPoint {\n                    timestamp,\n                    channel: format!(\"{}_fft\", self.channel),\n                    value: bin.magnitude,\n                    unit: \"dB\".to_string(),\n                    metadata: Some(metadata),\n                }\n            })\n            .collect()\n    }\n}\n","traces":[{"line":94,"address":[39815025,39815274,39813872],"length":1,"stats":{"Line":2}},{"line":95,"address":[36647276],"length":1,"stats":{"Line":2}},{"line":99,"address":[36892100],"length":1,"stats":{"Line":2}},{"line":101,"address":[39814028],"length":1,"stats":{"Line":2}},{"line":102,"address":[39814143,39814060],"length":1,"stats":{"Line":4}},{"line":104,"address":[36892367,36892295],"length":1,"stats":{"Line":4}},{"line":105,"address":[39814247],"length":1,"stats":{"Line":2}},{"line":106,"address":[39814321,39814400],"length":1,"stats":{"Line":4}},{"line":108,"address":[37254754],"length":1,"stats":{"Line":2}},{"line":109,"address":[36828886],"length":1,"stats":{"Line":2}},{"line":110,"address":[36648457,36647858],"length":1,"stats":{"Line":4}},{"line":111,"address":[36892695,36893211,36893267],"length":1,"stats":{"Line":4}},{"line":112,"address":[39815126],"length":1,"stats":{"Line":2}},{"line":113,"address":[39815199],"length":1,"stats":{"Line":2}},{"line":118,"address":[36827970],"length":1,"stats":{"Line":2}},{"line":119,"address":[37253834],"length":1,"stats":{"Line":2}},{"line":120,"address":[39814275],"length":1,"stats":{"Line":2}},{"line":121,"address":[39814286,39814602],"length":1,"stats":{"Line":4}},{"line":124,"address":[36828440],"length":1,"stats":{"Line":2}},{"line":129,"address":[37258319,37258325,37254864],"length":1,"stats":{"Line":2}},{"line":130,"address":[37254957],"length":1,"stats":{"Line":2}},{"line":131,"address":[39815445],"length":1,"stats":{"Line":0}},{"line":135,"address":[36893543,36893898],"length":1,"stats":{"Line":4}},{"line":136,"address":[36648891,36648986],"length":1,"stats":{"Line":2}},{"line":139,"address":[37995600,37995610],"length":1,"stats":{"Line":6}},{"line":140,"address":[39815514,39815833],"length":1,"stats":{"Line":4}},{"line":142,"address":[36893903],"length":1,"stats":{"Line":2}},{"line":143,"address":[36649418,36649428,36649119],"length":1,"stats":{"Line":4}},{"line":145,"address":[36894307,36894233],"length":1,"stats":{"Line":4}},{"line":146,"address":[39816333,39816369,39816265],"length":1,"stats":{"Line":6}},{"line":151,"address":[36894832],"length":1,"stats":{"Line":2}},{"line":152,"address":[37256311],"length":1,"stats":{"Line":2}},{"line":153,"address":[40558752,40558770],"length":1,"stats":{"Line":6}},{"line":156,"address":[36830741,36830634],"length":1,"stats":{"Line":4}},{"line":158,"address":[36650389],"length":1,"stats":{"Line":2}},{"line":159,"address":[39817178],"length":1,"stats":{"Line":2}},{"line":161,"address":[36830929],"length":1,"stats":{"Line":2}},{"line":163,"address":[36895387],"length":1,"stats":{"Line":2}},{"line":164,"address":[39817390,39817303],"length":1,"stats":{"Line":4}},{"line":165,"address":[36650780,36650749,36650862],"length":1,"stats":{"Line":5}},{"line":166,"address":[39817527,39817584],"length":1,"stats":{"Line":4}},{"line":168,"address":[36831214],"length":1,"stats":{"Line":1}},{"line":170,"address":[36895735,36895677],"length":1,"stats":{"Line":4}},{"line":172,"address":[36895668],"length":1,"stats":{"Line":2}},{"line":176,"address":[36831340,36830977],"length":1,"stats":{"Line":4}},{"line":177,"address":[39817921,39818479],"length":1,"stats":{"Line":4}},{"line":178,"address":[36651926,36651752,36651783],"length":1,"stats":{"Line":6}},{"line":179,"address":[39818580,39818698],"length":1,"stats":{"Line":4}},{"line":181,"address":[37258123],"length":1,"stats":{"Line":2}},{"line":184,"address":[36651817],"length":1,"stats":{"Line":2}},{"line":186,"address":[39818667,39818724],"length":1,"stats":{"Line":4}},{"line":188,"address":[36651869],"length":1,"stats":{"Line":2}},{"line":192,"address":[39817950],"length":1,"stats":{"Line":2}},{"line":193,"address":[37257608],"length":1,"stats":{"Line":2}},{"line":194,"address":[36651377,36651299],"length":1,"stats":{"Line":4}},{"line":197,"address":[36649541],"length":1,"stats":{"Line":2}},{"line":203,"address":[36897227,36897256,36896912],"length":1,"stats":{"Line":2}},{"line":204,"address":[37258408],"length":1,"stats":{"Line":2}},{"line":205,"address":[36681128,36681120],"length":1,"stats":{"Line":8}},{"line":207,"address":[36897086],"length":1,"stats":{"Line":2}},{"line":209,"address":[36832736],"length":1,"stats":{"Line":4}},{"line":210,"address":[36681194,36682302,36681532,36681327],"length":1,"stats":{"Line":2}},{"line":215,"address":[40559841],"length":1,"stats":{"Line":2}},{"line":216,"address":[37634860],"length":1,"stats":{"Line":2}},{"line":217,"address":[36681748,36681812],"length":1,"stats":{"Line":4}},{"line":218,"address":[37996488],"length":1,"stats":{"Line":2}},{"line":219,"address":[37570643],"length":1,"stats":{"Line":2}},{"line":220,"address":[37570733],"length":1,"stats":{"Line":2}}],"covered":67,"coverable":68},{"path":["/","app","src","data","iir_filter.rs"],"content":"//! An IIR (Infinite Impulse Response) filter data processor.\nuse crate::core::{DataPoint, DataProcessor};\nuse biquad::{Biquad, Coefficients, DirectForm1, ToHertz, Q_BUTTERWORTH_F64};\nuse serde::Deserialize;\n\n/// The type of IIR filter to apply.\n#[derive(Debug, Deserialize, Clone)]\npub enum FilterType {\n    /// A low-pass filter allows frequencies below the cutoff frequency to pass through.\n    Lowpass,\n    /// A high-pass filter allows frequencies above the cutoff frequency to pass through.\n    Highpass,\n    /// A band-pass filter allows frequencies within a certain range to pass through.\n    Bandpass,\n    /// A band-stop (or notch) filter rejects frequencies within a certain range.\n    Bandstop,\n}\n\n/// Configuration for the `IirFilter`.\n///\n/// This struct is typically deserialized from a configuration file.\n#[derive(Debug, Deserialize, Clone)]\npub struct IirFilterConfig {\n    /// The type of filter to apply.\n    pub filter_type: FilterType,\n    /// The cutoff or center frequency of the filter in Hz.\n    pub f0: f64,\n    /// The sample rate of the data in Hz.\n    pub fs: f64,\n    /// The quality factor (Q) of the filter. Determines the sharpness of the filter's transition.\n    /// If not provided, a default Butterworth Q value is used.\n    pub q: Option\u003cf64\u003e,\n}\n\n/// A data processor that applies an IIR filter to a stream of `DataPoint`s.\n///\n/// This processor uses the `biquad` crate to implement a second-order IIR filter.\n/// It supports low-pass, high-pass, band-pass, and band-stop (notch) filters.\n///\n/// # Example Configuration (`.toml`)\n///\n/// ```toml\n/// [[processors.my_instrument]]\n/// type = \"iir\"\n/// filter_type = \"Lowpass\"\n/// f0 = 50.0  # Cutoff frequency in Hz\n/// fs = 1000.0 # Sample rate in Hz\n/// q = 0.707  # Optional quality factor\n/// ```\npub struct IirFilter {\n    filter: DirectForm1\u003cf64\u003e,\n}\n\nimpl IirFilter {\n    pub fn new(config: IirFilterConfig) -\u003e Result\u003cSelf, \u0026'static str\u003e {\n        let coeffs = Self::design_filter(\u0026config)?;\n        Ok(Self {\n            filter: DirectForm1::\u003cf64\u003e::new(coeffs),\n        })\n    }\n\n    fn design_filter(config: \u0026IirFilterConfig) -\u003e Result\u003cCoefficients\u003cf64\u003e, \u0026'static str\u003e {\n        let f0 = config.f0.hz();\n        let fs = config.fs.hz();\n        let q = config.q.unwrap_or(Q_BUTTERWORTH_F64);\n\n        let result = match config.filter_type {\n            FilterType::Lowpass =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::LowPass, fs, f0, q)\n            }\n            FilterType::Highpass =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::HighPass, fs, f0, q)\n            }\n            FilterType::Bandpass =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::BandPass, fs, f0, q)\n            }\n            FilterType::Bandstop =\u003e {\n                Coefficients::\u003cf64\u003e::from_params(biquad::Type::Notch, fs, f0, q)\n            }\n        };\n        result.map_err(|_| \"Failed to create IIR filter coefficients\")\n    }\n}\n\nimpl DataProcessor for IirFilter {\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        data.iter()\n            .map(|dp| {\n                let mut new_dp = dp.clone();\n                new_dp.value = self.filter.run(dp.value);\n                new_dp.channel = format!(\"{}_filtered\", dp.channel);\n                new_dp\n            })\n            .collect()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::core::DataPoint;\n    use chrono::Utc;\n\n    fn create_test_data(len: usize) -\u003e Vec\u003cDataPoint\u003e {\n        (0..len)\n            .map(|i| DataPoint {\n                timestamp: Utc::now(),\n                channel: \"test\".to_string(),\n                value: i as f64,\n                unit: \"V\".to_string(),\n                metadata: None,\n            })\n            .collect()\n    }\n\n    #[test]\n    fn test_lowpass_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Lowpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: None,\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_highpass_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Highpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: None,\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_bandpass_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Bandpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: Some(1.0),\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_bandstop_filter_creation() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Bandstop,\n            f0: 100.0,\n            fs: 1000.0,\n            q: Some(1.0),\n        };\n        assert!(IirFilter::new(config).is_ok());\n    }\n\n    #[test]\n    fn test_invalid_filter_params() {\n        // f0 \u003e fs / 2\n        let config = IirFilterConfig {\n            filter_type: FilterType::Lowpass,\n            f0: 600.0,\n            fs: 1000.0,\n            q: None,\n        };\n        assert!(IirFilter::new(config).is_err());\n    }\n\n    #[test]\n    fn test_filter_processes_data() {\n        let config = IirFilterConfig {\n            filter_type: FilterType::Lowpass,\n            f0: 100.0,\n            fs: 1000.0,\n            q: None,\n        };\n        let mut filter = IirFilter::new(config).unwrap();\n        let data = create_test_data(10);\n        let original_values: Vec\u003cf64\u003e = data.iter().map(|dp| dp.value).collect();\n\n        let processed_data = filter.process(\u0026data);\n        let processed_values: Vec\u003cf64\u003e = processed_data.iter().map(|dp| dp.value).collect();\n\n        assert_ne!(original_values, processed_values);\n        assert_eq!(processed_data[0].channel, \"test_filtered\");\n    }\n}\n","traces":[{"line":55,"address":[33478592],"length":1,"stats":{"Line":6}},{"line":56,"address":[28631505],"length":1,"stats":{"Line":6}},{"line":57,"address":[38386314],"length":1,"stats":{"Line":6}},{"line":58,"address":[38386269],"length":1,"stats":{"Line":6}},{"line":62,"address":[30559168],"length":1,"stats":{"Line":6}},{"line":63,"address":[30559198],"length":1,"stats":{"Line":6}},{"line":64,"address":[38386477],"length":1,"stats":{"Line":6}},{"line":65,"address":[28631851],"length":1,"stats":{"Line":6}},{"line":67,"address":[30920763],"length":1,"stats":{"Line":6}},{"line":69,"address":[38386605],"length":1,"stats":{"Line":3}},{"line":72,"address":[38386641],"length":1,"stats":{"Line":1}},{"line":75,"address":[28632021],"length":1,"stats":{"Line":1}},{"line":78,"address":[30920921],"length":1,"stats":{"Line":1}},{"line":81,"address":[28632073],"length":1,"stats":{"Line":8}},{"line":86,"address":[38386784],"length":1,"stats":{"Line":3}},{"line":87,"address":[33479290],"length":1,"stats":{"Line":3}},{"line":88,"address":[30921064],"length":1,"stats":{"Line":6}},{"line":89,"address":[30977831],"length":1,"stats":{"Line":3}},{"line":90,"address":[30977846,30977923],"length":1,"stats":{"Line":6}},{"line":91,"address":[28820944,28820809],"length":1,"stats":{"Line":3}},{"line":92,"address":[28821053],"length":1,"stats":{"Line":3}}],"covered":21,"coverable":21},{"path":["/","app","src","data","mod.rs"],"content":"//! Data processing and storage modules.\npub mod fft;\npub mod iir_filter;\npub mod processor;\npub mod registry;\npub mod storage;\npub mod trigger;\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","src","data","processor.rs"],"content":"//! Example data processors.\nuse crate::core::{DataPoint, DataProcessor};\nuse std::collections::VecDeque;\n\n/// A simple moving average filter.\npub struct MovingAverage {\n    window_size: usize,\n    buffer: VecDeque\u003cf64\u003e,\n}\n\nimpl MovingAverage {\n    pub fn new(window_size: usize) -\u003e Self {\n        Self {\n            window_size,\n            buffer: VecDeque::with_capacity(window_size),\n        }\n    }\n}\n\nimpl DataProcessor for MovingAverage {\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        let mut processed_data = Vec::new();\n        for dp in data {\n            self.buffer.push_back(dp.value);\n            if self.buffer.len() \u003e self.window_size {\n                self.buffer.pop_front();\n            }\n\n            let sum: f64 = self.buffer.iter().sum();\n            let avg = sum / self.buffer.len() as f64;\n\n            processed_data.push(DataPoint {\n                value: avg,\n                metadata: dp.metadata.clone(),\n                ..dp.clone()\n            });\n        }\n        processed_data\n    }\n}\n","traces":[{"line":12,"address":[28452576],"length":1,"stats":{"Line":0}},{"line":15,"address":[29094872],"length":1,"stats":{"Line":0}},{"line":21,"address":[29094960,29095837,29095831],"length":1,"stats":{"Line":0}},{"line":22,"address":[31600296],"length":1,"stats":{"Line":0}},{"line":23,"address":[28650512,28650584],"length":1,"stats":{"Line":0}},{"line":24,"address":[29095222],"length":1,"stats":{"Line":0}},{"line":25,"address":[29095297],"length":1,"stats":{"Line":0}},{"line":26,"address":[28650830],"length":1,"stats":{"Line":0}},{"line":29,"address":[28650806,28650843],"length":1,"stats":{"Line":0}},{"line":30,"address":[28650888],"length":1,"stats":{"Line":0}},{"line":32,"address":[31600879],"length":1,"stats":{"Line":0}},{"line":34,"address":[29012418],"length":1,"stats":{"Line":0}},{"line":35,"address":[29095542],"length":1,"stats":{"Line":0}},{"line":38,"address":[29095255],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":14},{"path":["/","app","src","data","registry.rs"],"content":"use crate::core::DataProcessor;\nuse crate::data::fft::{FFTConfig, FFTProcessor};\nuse crate::data::iir_filter::{IirFilter, IirFilterConfig};\nuse std::collections::HashMap;\nuse toml::Value;\n\ntype ProcessorFactory =\n    Box\u003cdyn Fn(\u0026Value) -\u003e Result\u003cBox\u003cdyn DataProcessor\u003e, anyhow::Error\u003e + Send + Sync\u003e;\n\npub struct ProcessorRegistry {\n    factories: HashMap\u003cString, ProcessorFactory\u003e,\n}\n\nimpl Default for ProcessorRegistry {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ProcessorRegistry {\n    pub fn new() -\u003e Self {\n        let mut factories: HashMap\u003cString, ProcessorFactory\u003e = HashMap::new();\n\n        // Register IIR Filter\n        factories.insert(\n            \"iir\".to_string(),\n            Box::new(|config| {\n                let iir_config: IirFilterConfig = config.clone().try_into()?;\n                let filter = IirFilter::new(iir_config).map_err(|e| anyhow::anyhow!(e))?;\n                Ok(Box::new(filter))\n            }),\n        );\n\n        // Register FFT Processor\n        factories.insert(\n            \"fft\".to_string(),\n            Box::new(|config| {\n                let fft_config: FFTConfig = config.clone().try_into()?;\n                let processor = FFTProcessor::new(fft_config);\n                Ok(Box::new(processor))\n            }),\n        );\n\n        Self { factories }\n    }\n\n    pub fn create(\n        \u0026self,\n        id: \u0026str,\n        config: \u0026Value,\n    ) -\u003e Result\u003cBox\u003cdyn DataProcessor\u003e, anyhow::Error\u003e {\n        self.factories\n            .get(id)\n            .ok_or_else(|| anyhow::anyhow!(\"Processor '{}' not found\", id))\n            .and_then(|factory| factory(config))\n    }\n}\n","traces":[{"line":15,"address":[37670912],"length":1,"stats":{"Line":0}},{"line":16,"address":[37606504],"length":1,"stats":{"Line":0}},{"line":21,"address":[37671533,37670944,37671505],"length":1,"stats":{"Line":2}},{"line":22,"address":[40595537],"length":1,"stats":{"Line":2}},{"line":25,"address":[36584078],"length":1,"stats":{"Line":2}},{"line":26,"address":[37606575,37606647],"length":1,"stats":{"Line":4}},{"line":27,"address":[37671071],"length":1,"stats":{"Line":4}},{"line":28,"address":[31063598],"length":1,"stats":{"Line":2}},{"line":29,"address":[33622208,33622222,33621998],"length":1,"stats":{"Line":2}},{"line":30,"address":[29137632],"length":1,"stats":{"Line":2}},{"line":35,"address":[37671324],"length":1,"stats":{"Line":2}},{"line":36,"address":[37606807],"length":1,"stats":{"Line":2}},{"line":37,"address":[37671262],"length":1,"stats":{"Line":4}},{"line":38,"address":[33622332],"length":1,"stats":{"Line":2}},{"line":39,"address":[30702815],"length":1,"stats":{"Line":2}},{"line":40,"address":[30702837],"length":1,"stats":{"Line":2}},{"line":47,"address":[40596128],"length":1,"stats":{"Line":2}},{"line":52,"address":[37671604],"length":1,"stats":{"Line":2}},{"line":53,"address":[36584542],"length":1,"stats":{"Line":2}},{"line":54,"address":[36584550],"length":1,"stats":{"Line":2}},{"line":55,"address":[33622704,33622739],"length":1,"stats":{"Line":6}}],"covered":19,"coverable":21},{"path":["/","app","src","data","storage.rs"],"content":"//! Example data storage writers.\nuse crate::{\n    config::Settings,\n    core::{DataPoint, StorageWriter},\n    error::DaqError,\n    metadata::Metadata,\n};\nuse anyhow::{Context, Result};\nuse async_trait::async_trait;\nuse std::fs::File;\nuse std::io::Write;\nuse std::path::PathBuf;\nuse std::sync::Arc;\n\n/// A writer for CSV files.\n#[cfg(feature = \"storage_csv\")]\npub struct CsvWriter {\n    path: PathBuf,\n    writer: Option\u003ccsv::Writer\u003cFile\u003e\u003e,\n}\n\n#[cfg(feature = \"storage_csv\")]\nimpl Default for CsvWriter {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(feature = \"storage_csv\")]\nimpl CsvWriter {\n    pub fn new() -\u003e Self {\n        Self {\n            path: PathBuf::new(),\n            writer: None,\n        }\n    }\n}\n\n#[cfg(not(feature = \"storage_csv\"))]\npub struct CsvWriter;\n\n#[cfg(not(feature = \"storage_csv\"))]\nimpl CsvWriter {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl StorageWriter for CsvWriter {\n    async fn init(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        #[cfg(not(feature = \"storage_csv\"))]\n        return Err(DaqError::FeatureNotEnabled(\"storage_csv\".to_string()).into());\n\n        #[cfg(feature = \"storage_csv\")]\n        {\n            let file_name = format!(\n                \"{}_{}.csv\",\n                \"session\",\n                chrono::Utc::now().format(\"%Y%m%d_%H%M%S\")\n            );\n            let path = PathBuf::from(\u0026settings.storage.default_path);\n            if !path.exists() {\n                std::fs::create_dir_all(\u0026path)\n                    .with_context(|| format!(\"Failed to create storage directory at {:?}\", path))?;\n            }\n            self.path = path.join(file_name);\n            log::info!(\n                \"CSV Writer will be initialized at '{}'.\",\n                self.path.display()\n            );\n            Ok(())\n        }\n    }\n\n    async fn set_metadata(\u0026mut self, metadata: \u0026Metadata) -\u003e Result\u003c()\u003e {\n        #[cfg(feature = \"storage_csv\")]\n        {\n            let mut file = File::create(\u0026self.path)\n                .with_context(|| format!(\"Failed to create CSV file at {:?}\", self.path))?;\n\n            let json_string = serde_json::to_string_pretty(metadata)\n                .context(\"Failed to serialize metadata to JSON\")?;\n\n            for line in json_string.lines() {\n                file.write_all(b\"# \")\n                    .and_then(|_| file.write_all(line.as_bytes()))\n                    .and_then(|_| file.write_all(b\"\\n\"))\n                    .context(\"Failed to write metadata to CSV file\")?;\n            }\n\n            let mut writer = csv::Writer::from_writer(file);\n            writer\n                .write_record([\"timestamp\", \"channel\", \"value\", \"unit\", \"metadata\"])\n                .context(\"Failed to write CSV header\")?;\n\n            self.writer = Some(writer);\n            Ok(())\n        }\n        #[cfg(not(feature = \"storage_csv\"))]\n        Ok(())\n    }\n\n    async fn write(\u0026mut self, data: \u0026[DataPoint]) -\u003e Result\u003c()\u003e {\n        #[cfg(feature = \"storage_csv\")]\n        {\n            if let Some(writer) = self.writer.as_mut() {\n                for dp in data {\n                    let metadata_str = dp\n                        .metadata\n                        .as_ref()\n                        .map_or(String::new(), |v| v.to_string());\n                    writer\n                        .write_record(\u0026[\n                            dp.timestamp.to_rfc3339(),\n                            dp.channel.clone(),\n                            dp.value.to_string(),\n                            dp.unit.clone(),\n                            metadata_str,\n                        ])\n                        .context(\"Failed to write data point to CSV file\")?;\n                }\n            }\n            Ok(())\n        }\n        #[cfg(not(feature = \"storage_csv\"))]\n        Ok(())\n    }\n\n    async fn shutdown(\u0026mut self) -\u003e Result\u003c()\u003e {\n        #[cfg(feature = \"storage_csv\")]\n        {\n            if let Some(mut writer) = self.writer.take() {\n                writer.flush().context(\"Failed to flush CSV writer\")?;\n            }\n            log::info!(\"CSV Writer shut down.\");\n            Ok(())\n        }\n        #[cfg(not(feature = \"storage_csv\"))]\n        Ok(())\n    }\n}\n\n// Skeletons for other writers\n#[cfg(not(feature = \"storage_hdf5\"))]\npub struct Hdf5Writer;\n\n#[cfg(not(feature = \"storage_hdf5\"))]\nimpl Default for Hdf5Writer {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(not(feature = \"storage_hdf5\"))]\nimpl Hdf5Writer {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl StorageWriter for Hdf5Writer {\n    async fn init(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_hdf5\".to_string()).into())\n    }\n    async fn set_metadata(\u0026mut self, _metadata: \u0026Metadata) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_hdf5\".to_string()).into())\n    }\n    async fn write(\u0026mut self, _data: \u0026[DataPoint]) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_hdf5\".to_string()).into())\n    }\n    async fn shutdown(\u0026mut self) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_hdf5\".to_string()).into())\n    }\n}\n\n#[cfg(not(feature = \"storage_arrow\"))]\npub struct ArrowWriter;\n\n#[cfg(not(feature = \"storage_arrow\"))]\nimpl Default for ArrowWriter {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(not(feature = \"storage_arrow\"))]\nimpl ArrowWriter {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl StorageWriter for ArrowWriter {\n    async fn init(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_arrow\".to_string()).into())\n    }\n    async fn set_metadata(\u0026mut self, _metadata: \u0026Metadata) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_arrow\".to_string()).into())\n    }\n    async fn write(\u0026mut self, _data: \u0026[DataPoint]) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_arrow\".to_string()).into())\n    }\n    async fn shutdown(\u0026mut self) -\u003e Result\u003c()\u003e {\n        Err(DaqError::FeatureNotEnabled(\"storage_arrow\".to_string()).into())\n    }\n}\n","traces":[{"line":24,"address":[37889696],"length":1,"stats":{"Line":0}},{"line":25,"address":[40447944],"length":1,"stats":{"Line":0}},{"line":31,"address":[36746096],"length":1,"stats":{"Line":0}},{"line":33,"address":[40447985],"length":1,"stats":{"Line":0}},{"line":51,"address":[37464062],"length":1,"stats":{"Line":0}},{"line":57,"address":[37767424],"length":1,"stats":{"Line":0}},{"line":60,"address":[40691857,40691961],"length":1,"stats":{"Line":0}},{"line":62,"address":[37703286,37703214],"length":1,"stats":{"Line":0}},{"line":63,"address":[40692595,40692309,40692389],"length":1,"stats":{"Line":0}},{"line":64,"address":[38129469,38129436,38129274,38129360],"length":1,"stats":{"Line":0}},{"line":65,"address":[38129331,38130297,38130272,38129420],"length":1,"stats":{"Line":0}},{"line":67,"address":[37703450,37703682,37703783],"length":1,"stats":{"Line":0}},{"line":68,"address":[37768309,37768395,37768546],"length":1,"stats":{"Line":0}},{"line":72,"address":[37703945],"length":1,"stats":{"Line":0}},{"line":76,"address":[37889982],"length":1,"stats":{"Line":0}},{"line":79,"address":[37769145,37769356,37771143,37769298],"length":1,"stats":{"Line":0}},{"line":80,"address":[31083888,31082048,31082116,31083913],"length":1,"stats":{"Line":0}},{"line":82,"address":[31082365,31082194,31083775,31082305],"length":1,"stats":{"Line":0}},{"line":85,"address":[37705381,37705290,37706612],"length":1,"stats":{"Line":0}},{"line":86,"address":[40695581,40695505,40694569,40695614],"length":1,"stats":{"Line":0}},{"line":87,"address":[37770814,37771312,37771319],"length":1,"stats":{"Line":0}},{"line":88,"address":[38132307,38132800,38132809],"length":1,"stats":{"Line":0}},{"line":92,"address":[37705685,37705616],"length":1,"stats":{"Line":0}},{"line":93,"address":[38131795,38131871,38132146],"length":1,"stats":{"Line":0}},{"line":94,"address":[38131549],"length":1,"stats":{"Line":0}},{"line":97,"address":[37770562,37770457],"length":1,"stats":{"Line":0}},{"line":98,"address":[40695213],"length":1,"stats":{"Line":0}},{"line":104,"address":[40696055,40695968,40696317,40696137,40697318,40696164,40697346,40695996,40696105],"length":1,"stats":{"Line":0}},{"line":107,"address":[40696116,40696208],"length":1,"stats":{"Line":0}},{"line":108,"address":[38134133,38133128,38133196],"length":1,"stats":{"Line":0}},{"line":109,"address":[37771861],"length":1,"stats":{"Line":0}},{"line":112,"address":[31084612,31085456,31085472],"length":1,"stats":{"Line":0}},{"line":113,"address":[38134084,38134142,38134008],"length":1,"stats":{"Line":0}},{"line":114,"address":[37772302],"length":1,"stats":{"Line":0}},{"line":115,"address":[38133416],"length":1,"stats":{"Line":0}},{"line":116,"address":[37772045],"length":1,"stats":{"Line":0}},{"line":117,"address":[31084794],"length":1,"stats":{"Line":0}},{"line":118,"address":[37707770],"length":1,"stats":{"Line":0}},{"line":119,"address":[38133702],"length":1,"stats":{"Line":0}},{"line":124,"address":[31084413],"length":1,"stats":{"Line":0}},{"line":130,"address":[37708577,37708495,37709044,37709262,37709004,37708444,37708416,37708545,37708604],"length":1,"stats":{"Line":0}},{"line":133,"address":[31085633,31085711],"length":1,"stats":{"Line":0}},{"line":134,"address":[37773121,37773231,37773390],"length":1,"stats":{"Line":0}},{"line":136,"address":[37773137,37773465,37773430],"length":1,"stats":{"Line":0}},{"line":137,"address":[38134876],"length":1,"stats":{"Line":0}},{"line":150,"address":[37463984],"length":1,"stats":{"Line":0}},{"line":151,"address":[37528401],"length":1,"stats":{"Line":0}},{"line":164,"address":[40448398],"length":1,"stats":{"Line":0}},{"line":165,"address":[37709538,37709436],"length":1,"stats":{"Line":0}},{"line":167,"address":[40698684,40698988,40698832,40698785,40698778,40698735,40698859,40698656],"length":1,"stats":{"Line":0}},{"line":168,"address":[37774220,37774322],"length":1,"stats":{"Line":0}},{"line":170,"address":[36746595],"length":1,"stats":{"Line":0}},{"line":171,"address":[37710274,37710172],"length":1,"stats":{"Line":0}},{"line":173,"address":[37710732,37710479,37710428,37710529,37710400,37710576,37710603,37710522],"length":1,"stats":{"Line":0}},{"line":174,"address":[37710642,37710540],"length":1,"stats":{"Line":0}},{"line":183,"address":[37464016],"length":1,"stats":{"Line":0}},{"line":184,"address":[37464017],"length":1,"stats":{"Line":0}},{"line":197,"address":[37775516,37775313,37775184,37775212,37775263,37775306,37775360,37775387],"length":1,"stats":{"Line":0}},{"line":198,"address":[40699900,40700002],"length":1,"stats":{"Line":0}},{"line":200,"address":[36746734],"length":1,"stats":{"Line":0}},{"line":201,"address":[37711276,37711378],"length":1,"stats":{"Line":0}},{"line":203,"address":[40448771],"length":1,"stats":{"Line":0}},{"line":204,"address":[38137500,38137602],"length":1,"stats":{"Line":0}},{"line":206,"address":[31088912,31089041,31089240,31089115,31089034,31088991,31089088,31088940],"length":1,"stats":{"Line":0}},{"line":207,"address":[37712114,37712012],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":65},{"path":["/","app","src","data","trigger.rs"],"content":"//! A data processor that implements trigger/threshold functionality.\nuse crate::core::{DataPoint, DataProcessor};\nuse chrono::{DateTime, Duration, Utc};\nuse serde::{Deserialize, Serialize};\nuse std::collections::VecDeque;\n\n/// Defines the trigger condition.\n#[derive(Clone, Debug, Serialize, Deserialize)]\npub enum TriggerMode {\n    Edge {\n        threshold: f64,\n        rising: bool,\n    },\n    Level {\n        threshold: f64,\n        above: bool,\n    },\n    Window {\n        low_threshold: f64,\n        high_threshold: f64,\n        inside: bool,\n    },\n}\n\n/// Represents the state of the trigger processor.\n#[derive(Clone, Debug, PartialEq)]\nenum TriggerState {\n    Armed,\n    Triggered,\n    Holdoff,\n}\n\n/// Statistics about the trigger.\n#[derive(Clone, Debug)]\npub struct TriggerStats {\n    pub count: u64,\n    pub rate: f64, // Triggers per second\n    pub last_trigger_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\n/// A trigger processor that captures data only when specified conditions are met.\npub struct Trigger {\n    mode: TriggerMode,\n    holdoff: Duration,\n    pre_trigger_samples: usize,\n    post_trigger_samples: usize,\n    state: TriggerState,\n    buffer: VecDeque\u003cDataPoint\u003e,\n    stats: TriggerStats,\n    last_value: f64,\n    holdoff_until: Option\u003cDateTime\u003cUtc\u003e\u003e,\n    samples_after_trigger: usize,\n    first_trigger_time: Option\u003cDateTime\u003cUtc\u003e\u003e,\n}\n\nimpl Trigger {\n    pub fn new(\n        mode: TriggerMode,\n        holdoff: Duration,\n        pre_trigger_samples: usize,\n        post_trigger_samples: usize,\n    ) -\u003e Self {\n        Self {\n            mode,\n            holdoff,\n            pre_trigger_samples,\n            post_trigger_samples,\n            state: TriggerState::Armed,\n            buffer: VecDeque::with_capacity(pre_trigger_samples),\n            stats: TriggerStats {\n                count: 0,\n                rate: 0.0,\n                last_trigger_time: None,\n            },\n            last_value: 0.0,\n            holdoff_until: None,\n            samples_after_trigger: 0,\n            first_trigger_time: None,\n        }\n    }\n\n    /// Checks if the trigger condition is met.\n    fn check_trigger_condition(\u0026self, dp: \u0026DataPoint) -\u003e bool {\n        let last_value = self.last_value;\n\n        match self.mode {\n            TriggerMode::Edge { threshold, rising } =\u003e {\n                if rising {\n                    last_value \u003c= threshold \u0026\u0026 dp.value \u003e threshold\n                } else {\n                    last_value \u003e= threshold \u0026\u0026 dp.value \u003c threshold\n                }\n            }\n            TriggerMode::Level { threshold, above } =\u003e {\n                if above {\n                    dp.value \u003e threshold\n                } else {\n                    dp.value \u003c threshold\n                }\n            }\n            TriggerMode::Window {\n                low_threshold,\n                high_threshold,\n                inside,\n            } =\u003e {\n                let is_inside = dp.value \u003e= low_threshold \u0026\u0026 dp.value \u003c= high_threshold;\n                if inside {\n                    is_inside\n                } else {\n                    !is_inside\n                }\n            }\n        }\n    }\n\n    /// Updates trigger statistics.\n    fn update_stats(\u0026mut self, timestamp: DateTime\u003cUtc\u003e) {\n        self.stats.count += 1;\n        self.stats.last_trigger_time = Some(timestamp);\n\n        if self.stats.count == 1 {\n            self.first_trigger_time = Some(timestamp);\n        } else if let Some(first_time) = self.first_trigger_time {\n            let elapsed = timestamp\n                .signed_duration_since(first_time)\n                .to_std()\n                .unwrap()\n                .as_secs_f64();\n            if elapsed \u003e 0.0 {\n                self.stats.rate = self.stats.count as f64 / elapsed;\n            }\n        }\n    }\n}\n\nimpl DataProcessor for Trigger {\n    fn process(\u0026mut self, data: \u0026[DataPoint]) -\u003e Vec\u003cDataPoint\u003e {\n        let mut output = Vec::new();\n\n        for dp in data {\n            // First, check if we should transition out of Holdoff state\n            if self.state == TriggerState::Holdoff {\n                if let Some(holdoff_end) = self.holdoff_until {\n                    if dp.timestamp \u003e= holdoff_end {\n                        self.state = TriggerState::Armed;\n                        self.holdoff_until = None;\n                    }\n                } else {\n                    self.state = TriggerState::Armed;\n                }\n            }\n\n            // Now process based on the (potentially updated) state\n            match self.state {\n                TriggerState::Armed =\u003e {\n                    if self.check_trigger_condition(dp) {\n                        self.state = TriggerState::Triggered;\n                        self.update_stats(dp.timestamp);\n\n                        if !self.holdoff.is_zero() {\n                            self.holdoff_until = Some(dp.timestamp + self.holdoff);\n                        }\n\n                        output.extend(self.buffer.iter().cloned());\n                        self.buffer.clear();\n\n                        let mut trigger_dp = dp.clone();\n                        let mut meta = trigger_dp\n                            .metadata\n                            .take()\n                            .unwrap_or_default()\n                            .as_object()\n                            .cloned()\n                            .unwrap_or_default();\n                        meta.insert(\"trigger\".to_string(), serde_json::Value::Bool(true));\n                        trigger_dp.metadata = Some(serde_json::Value::Object(meta));\n                        output.push(trigger_dp);\n\n                        if self.post_trigger_samples == 0 {\n                            self.state = TriggerState::Holdoff;\n                        }\n                    } else if self.pre_trigger_samples \u003e 0 {\n                        self.buffer.push_back(dp.clone());\n                        if self.buffer.len() \u003e self.pre_trigger_samples {\n                            self.buffer.pop_front();\n                        }\n                    }\n                }\n                TriggerState::Triggered =\u003e {\n                    self.samples_after_trigger += 1;\n                    output.push(dp.clone());\n                    if self.samples_after_trigger \u003e= self.post_trigger_samples {\n                        self.state = TriggerState::Holdoff;\n                        self.samples_after_trigger = 0;\n                    }\n                }\n                TriggerState::Holdoff =\u003e {\n                    // Do nothing - we already handled holdoff expiry above\n                }\n            }\n\n            // Update last_value for every data point to support edge triggering\n            self.last_value = dp.value;\n        }\n\n        output\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::core::DataPoint;\n    use chrono::{Duration, Utc};\n\n    fn create_datapoint(value: f64, timestamp_offset_ms: i64) -\u003e DataPoint {\n        DataPoint {\n            value,\n            timestamp: Utc::now() + Duration::milliseconds(timestamp_offset_ms),\n            channel: \"test\".to_string(),\n            unit: \"V\".to_string(),\n            metadata: None,\n        }\n    }\n\n    fn assert_is_trigger(dp: \u0026DataPoint) {\n        assert!(dp.metadata.is_some(), \"DataPoint should have metadata\");\n        let meta = dp\n            .metadata\n            .as_ref()\n            .expect(\"metadata is some\")\n            .as_object()\n            .expect(\"metadata is an object\");\n        assert_eq!(\n            meta.get(\"trigger\"),\n            Some(\u0026serde_json::Value::Bool(true)),\n            \"trigger metadata key should be true\"\n        );\n    }\n\n    #[test]\n    fn test_edge_trigger_with_post_trigger_samples() {\n        let mode = TriggerMode::Edge {\n            threshold: 5.0,\n            rising: true,\n        };\n        let mut trigger = Trigger::new(mode, Duration::zero(), 2, 3); // 2 pre, 3 post\n\n        let data = vec![\n            create_datapoint(1.0, 0),   // Buffered\n            create_datapoint(2.0, 10),  // Buffered\n            create_datapoint(4.0, 15),  // Buffered, 1.0 is dropped\n            create_datapoint(6.0, 20),  // Trigger\n            create_datapoint(7.0, 30),  // Post-trigger\n            create_datapoint(8.0, 40),  // Post-trigger\n            create_datapoint(9.0, 50),  // Post-trigger\n            create_datapoint(10.0, 60), // Not captured\n        ];\n\n        let output = trigger.process(\u0026data);\n\n        assert_eq!(output.len(), 6); // 2 pre + 1 trigger + 3 post\n        assert_eq!(output[0].value, 2.0);\n        assert_eq!(output[1].value, 4.0);\n        assert_eq!(output[2].value, 6.0);\n        assert_is_trigger(\u0026output[2]);\n        assert_eq!(output[3].value, 7.0);\n        assert_eq!(output[4].value, 8.0);\n        assert_eq!(output[5].value, 9.0);\n    }\n\n    #[test]\n    fn test_level_trigger() {\n        // Test `above: true`\n        let mode = TriggerMode::Level {\n            threshold: 5.0,\n            above: true,\n        };\n        let mut trigger = Trigger::new(mode.clone(), Duration::zero(), 1, 1);\n        let data = vec![\n            create_datapoint(4.0, -10), // Pre-trigger\n            create_datapoint(6.0, 0),   // Trigger\n            create_datapoint(7.0, 10),  // Post-trigger\n        ];\n        let output = trigger.process(\u0026data);\n        assert_eq!(output.len(), 3, \"Expected 1 pre, 1 trigger, 1 post\");\n        assert_eq!(output[1].value, 6.0);\n        assert_is_trigger(\u0026output[1]);\n\n        // Test `above: false`\n        let mode = TriggerMode::Level {\n            threshold: 5.0,\n            above: false,\n        };\n        let mut trigger = Trigger::new(mode.clone(), Duration::zero(), 1, 1);\n        let data = vec![\n            create_datapoint(6.0, -10), // Pre-trigger\n            create_datapoint(4.0, 0),   // Trigger\n            create_datapoint(3.0, 10),  // Post-trigger\n        ];\n        let output = trigger.process(\u0026data);\n        assert_eq!(output.len(), 3, \"Expected 1 pre, 1 trigger, 1 post\");\n        assert_eq!(output[1].value, 4.0);\n        assert_is_trigger(\u0026output[1]);\n\n        // Test edge case: value at threshold should not trigger\n        let mode = TriggerMode::Level {\n            threshold: 5.0,\n            above: true,\n        };\n        let mut trigger = Trigger::new(mode, Duration::zero(), 1, 1);\n        let data = vec![\n            create_datapoint(4.0, -10),\n            create_datapoint(5.0, 0), // Exactly on threshold\n        ];\n        let output = trigger.process(\u0026data);\n        assert_eq!(output.len(), 0, \"Should not trigger on threshold edge\");\n    }\n\n    #[test]\n    fn test_window_trigger() {\n        // Test `inside: true`\n        let mode = TriggerMode::Window {\n            low_threshold: 3.0,\n            high_threshold: 7.0,\n            inside: true,\n        };\n        let mut trigger = Trigger::new(mode.clone(), Duration::zero(), 1, 1);\n        let data = vec![\n            create_datapoint(2.0, -10), // Pre-trigger\n            create_datapoint(5.0, 0),   // Trigger\n            create_datapoint(8.0, 10),  // Post-trigger\n        ];\n        let output = trigger.process(\u0026data);\n        assert_eq!(output.len(), 3);\n        assert_is_trigger(\u0026output[1]);\n\n        // Test `inside: false`\n        let mode = TriggerMode::Window {\n            low_threshold: 3.0,\n            high_threshold: 7.0,\n            inside: false,\n        };\n        let mut trigger = Trigger::new(mode.clone(), Duration::zero(), 1, 1);\n        let data = vec![\n            create_datapoint(5.0, -10), // Pre-trigger\n            create_datapoint(8.0, 0),   // Trigger\n            create_datapoint(2.0, 10),  // Post-trigger\n        ];\n        let output = trigger.process(\u0026data);\n        assert_eq!(output.len(), 3);\n        assert_is_trigger(\u0026output[1]);\n\n        // Test edge cases: on boundaries should trigger\n        let mode = TriggerMode::Window {\n            low_threshold: 3.0,\n            high_threshold: 7.0,\n            inside: true,\n        };\n        let mut trigger = Trigger::new(mode, Duration::zero(), 0, 0);\n        let data = vec![create_datapoint(3.0, 0), create_datapoint(7.0, 1)];\n        let output = trigger.process(\u0026data);\n        assert_eq!(output.len(), 2, \"Should trigger on both boundaries\");\n        assert_is_trigger(\u0026output[0]);\n        assert_is_trigger(\u0026output[1]);\n    }\n\n    #[test]\n    fn test_holdoff() {\n        let mode = TriggerMode::Edge {\n            threshold: 5.0,\n            rising: true,\n        };\n        let holdoff_duration = Duration::milliseconds(50);\n        let mut trigger = Trigger::new(mode, holdoff_duration, 0, 0);\n\n        let data = vec![\n            create_datapoint(4.0, -10), // Below threshold\n            create_datapoint(6.0, 0),   // First trigger\n            create_datapoint(4.0, 10),  // Reset for edge\n            create_datapoint(6.0, 20),  // Should be ignored (in holdoff)\n            create_datapoint(4.0, 40),  // Reset for edge (still in holdoff)\n            create_datapoint(6.0, 60),  // Should trigger (holdoff elapsed)\n        ];\n\n        let output = trigger.process(\u0026data);\n\n        assert_eq!(output.len(), 2, \"Expected two triggers\");\n        assert_eq!(output[0].value, 6.0);\n        assert_eq!(\n            output[0].timestamp.timestamp_millis(),\n            data[1].timestamp.timestamp_millis()\n        );\n        assert_is_trigger(\u0026output[0]);\n\n        assert_eq!(output[1].value, 6.0);\n        assert_eq!(\n            output[1].timestamp.timestamp_millis(),\n            data[5].timestamp.timestamp_millis()\n        );\n        assert_is_trigger(\u0026output[1]);\n    }\n}\n","traces":[{"line":57,"address":[38160048],"length":1,"stats":{"Line":2}},{"line":69,"address":[38095712],"length":1,"stats":{"Line":3}},{"line":70,"address":[31089422],"length":1,"stats":{"Line":3}},{"line":83,"address":[38160464],"length":1,"stats":{"Line":1}},{"line":84,"address":[31089720],"length":1,"stats":{"Line":3}},{"line":86,"address":[38096089],"length":1,"stats":{"Line":1}},{"line":87,"address":[38160543],"length":1,"stats":{"Line":2}},{"line":88,"address":[38160572],"length":1,"stats":{"Line":1}},{"line":89,"address":[31090015,31089964],"length":1,"stats":{"Line":2}},{"line":91,"address":[41085316,41085288],"length":1,"stats":{"Line":0}},{"line":94,"address":[31089819],"length":1,"stats":{"Line":1}},{"line":95,"address":[38096461,38096200,38096430],"length":1,"stats":{"Line":3}},{"line":96,"address":[38160859],"length":1,"stats":{"Line":1}},{"line":98,"address":[31090064],"length":1,"stats":{"Line":1}},{"line":101,"address":[38096233],"length":1,"stats":{"Line":1}},{"line":106,"address":[38096264,38096463],"length":1,"stats":{"Line":2}},{"line":107,"address":[38522373,38522355,38522388],"length":1,"stats":{"Line":3}},{"line":108,"address":[41085514],"length":1,"stats":{"Line":1}},{"line":110,"address":[41085497],"length":1,"stats":{"Line":1}},{"line":117,"address":[31090192],"length":1,"stats":{"Line":1}},{"line":118,"address":[31090214,31090291],"length":1,"stats":{"Line":3}},{"line":119,"address":[38161019],"length":1,"stats":{"Line":1}},{"line":121,"address":[41085626,41085695],"length":1,"stats":{"Line":6}},{"line":122,"address":[38161082],"length":1,"stats":{"Line":1}},{"line":123,"address":[41085702,41085746],"length":1,"stats":{"Line":3}},{"line":124,"address":[38096776],"length":1,"stats":{"Line":2}},{"line":125,"address":[31090466],"length":1,"stats":{"Line":2}},{"line":129,"address":[38522837,38522765],"length":1,"stats":{"Line":4}},{"line":130,"address":[41085925],"length":1,"stats":{"Line":2}},{"line":137,"address":[41088327,41085984,41088093],"length":1,"stats":{"Line":3}},{"line":138,"address":[41086040],"length":1,"stats":{"Line":3}},{"line":140,"address":[38161515,38161596,38162104],"length":1,"stats":{"Line":7}},{"line":142,"address":[38523146,38523228],"length":1,"stats":{"Line":6}},{"line":143,"address":[38161952,38161849],"length":1,"stats":{"Line":2}},{"line":144,"address":[38161961,38162021,38161913],"length":1,"stats":{"Line":3}},{"line":145,"address":[38161975],"length":1,"stats":{"Line":1}},{"line":146,"address":[41086558],"length":1,"stats":{"Line":1}},{"line":149,"address":[41086521],"length":1,"stats":{"Line":1}},{"line":154,"address":[31091015],"length":1,"stats":{"Line":4}},{"line":156,"address":[38162113,38162038,38163490],"length":1,"stats":{"Line":8}},{"line":157,"address":[38162143],"length":1,"stats":{"Line":1}},{"line":158,"address":[38162150],"length":1,"stats":{"Line":2}},{"line":160,"address":[41087087,41086909],"length":1,"stats":{"Line":2}},{"line":161,"address":[38523808,38523893],"length":1,"stats":{"Line":2}},{"line":164,"address":[38523953,38523869],"length":1,"stats":{"Line":3}},{"line":165,"address":[38098163],"length":1,"stats":{"Line":2}},{"line":167,"address":[38098187],"length":1,"stats":{"Line":1}},{"line":168,"address":[31091799],"length":1,"stats":{"Line":2}},{"line":175,"address":[38524345],"length":1,"stats":{"Line":1}},{"line":176,"address":[38163141,38163010],"length":1,"stats":{"Line":3}},{"line":177,"address":[38098864],"length":1,"stats":{"Line":1}},{"line":179,"address":[41088023],"length":1,"stats":{"Line":3}},{"line":180,"address":[38163459],"length":1,"stats":{"Line":1}},{"line":182,"address":[38162124,38163466,38163523,38162653,38163495,38162864],"length":1,"stats":{"Line":2}},{"line":183,"address":[31091412],"length":1,"stats":{"Line":1}},{"line":184,"address":[38097830],"length":1,"stats":{"Line":1}},{"line":185,"address":[41086863],"length":1,"stats":{"Line":1}},{"line":190,"address":[31092800,31091266,31092778],"length":1,"stats":{"Line":3}},{"line":191,"address":[31092793,31092820],"length":1,"stats":{"Line":3}},{"line":192,"address":[41088322,41088282],"length":1,"stats":{"Line":3}},{"line":193,"address":[41088304],"length":1,"stats":{"Line":2}},{"line":194,"address":[38525175],"length":1,"stats":{"Line":1}},{"line":203,"address":[38097678],"length":1,"stats":{"Line":3}},{"line":206,"address":[38097325],"length":1,"stats":{"Line":1}}],"covered":63,"coverable":64},{"path":["/","app","src","error.rs"],"content":"//! Custom error types for the application.\n//!\n//! This module defines the primary error type, `DaqError`, for the entire application.\n//! Using the `thiserror` crate, it provides a centralized and consistent way to handle\n//! different kinds of errors that can occur, from I/O and configuration issues to\n//! instrument-specific problems.\n//!\n//! ## Error Hierarchy\n//!\n//! `DaqError` is an enum that consolidates various error sources:\n//!\n//! - **`Config`**: Wraps errors from the `config` crate, typically related to file parsing\n//!   or format issues in the configuration files.\n//! - **`Configuration`**: Represents semantic errors in the configuration, such as invalid\n//!   values that pass parsing but are logically incorrect (e.g., an invalid IP address format).\n//!   These are usually caught during the validation step.\n//! - **`Io`**: Wraps standard `std::io::Error`, covering all file and network I/O issues.\n//! - **`Tokio`**: Specifically for errors related to the Tokio runtime, though it also wraps\n//!   `std::io::Error` as Tokio I/O operations are a common source.\n//! - **`Instrument`**: A general category for errors originating from instrument drivers. This\n//!   could be anything from a communication failure to an invalid command sent to the hardware.\n//! - **`Processing`**: For errors that occur during data processing stages, such as filtering\n//!   or analysis.\n//! - **`FeatureNotEnabled`**: A specific error used when the code attempts to use functionality\n//!   (like a specific instrument driver or storage format) that was not included at compile\n//!   time via feature flags. This provides a clear message to the user on how to enable it.\n//!\n//! By using `#[from]`, `DaqError` can be seamlessly created from underlying error types,\n//! simplifying error handling throughout the application with the `?` operator.\n\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum DaqError {\n    #[error(\"Configuration error: {0}\")]\n    Config(#[from] config::ConfigError),\n\n    #[error(\"Configuration validation error: {0}\")]\n    Configuration(String),\n\n    #[error(\"I/O error: {0}\")]\n    Io(#[from] std::io::Error),\n\n    #[error(\"Tokio runtime error: {0}\")]\n    Tokio(std::io::Error),\n\n    #[error(\"Instrument error: {0}\")]\n    Instrument(String),\n\n    #[error(\"Data processing error: {0}\")]\n    Processing(String),\n\n    #[error(\"Feature '{0}' is not enabled. Please build with --features {0}\")]\n    FeatureNotEnabled(String),\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","src","gui","instrument_controls.rs"],"content":"//! Interactive instrument control panels.\n//!\n//! This module provides interactive GUI panels for controlling various hardware instruments.\n//! Each panel is a separate struct that manages its own state and provides a `ui` method\n//! to render the controls using `egui`. These panels are designed to be instantiated and\n//! displayed within tabs in the main `egui_dock` area.\n//!\n//! ## Design\n//!\n//! - **Stateful Panels:** Each control panel (e.g., `MaiTaiControlPanel`, `PVCAMControlPanel`)\n//!   is a struct that holds the UI state (like target values, toggles) and relevant data\n//!   received from the instrument.\n//! - **`DaqApp` Handle:** Each `ui` method takes a reference to `DaqApp`, which acts as a\n//!   bridge to the application's core logic. This allows the UI to send commands to the\n//!   instruments.\n//! - **Command-Based Interaction:** User interactions (e.g., clicking a button, changing a slider)\n//!   are translated into `InstrumentCommand` enums. These commands are sent to the corresponding\n//!   instrument task via a channel managed by the `DaqApp`.\n//! - **Error Handling:** Errors that occur when sending commands are logged to the central\n//!   log panel using the `log::error!` macro.\n//! - **Immediate Feedback (UI State):** To provide a responsive user experience, the local UI state\n//!   (e.g., a display of the current position) is often updated immediately, assuming the command\n//!   will be successful. The actual instrument state is updated asynchronously.\n\nuse crate::{app::DaqApp, core::InstrumentCommand};\nuse egui::{Ui, Color32, Slider};\nuse log::error;\n\n/// MaiTai laser control panel\npub struct MaiTaiControlPanel {\n    pub instrument_id: String,\n    pub target_wavelength: f64,\n    pub shutter_open: bool,\n    pub laser_on: bool,\n    pub current_wavelength: f64,\n    pub current_power: f64,\n}\n\nimpl MaiTaiControlPanel {\n    pub fn new(instrument_id: String) -\u003e Self {\n        Self {\n            instrument_id,\n            target_wavelength: 800.0,\n            shutter_open: false,\n            laser_on: false,\n            current_wavelength: 800.0,\n            current_power: 0.0,\n        }\n    }\n\n    pub fn ui(\u0026mut self, ui: \u0026mut Ui, app: \u0026DaqApp) {\n        ui.heading(\"MaiTai Laser Control\");\n        ui.separator();\n\n        // Wavelength control\n        ui.horizontal(|ui| {\n            ui.label(\"Set Wavelength (nm):\");\n            ui.add(egui::DragValue::new(\u0026mut self.target_wavelength)\n                .speed(1.0)\n                .range(700.0..=1000.0));\n            if ui.button(\"Set\").clicked() {\n                let cmd = InstrumentCommand::SetParameter(\n                    \"wavelength\".to_string(),\n                    self.target_wavelength.to_string()\n                );\n                if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                    error!(\"Failed to set wavelength: {}\", e);\n                } else {\n                    self.current_wavelength = self.target_wavelength;\n                }\n            }\n        });\n\n        ui.add_space(10.0);\n\n        // Current wavelength display\n        ui.horizontal(|ui| {\n            ui.label(\"Actual Wavelength:\");\n            ui.colored_label(Color32::GREEN, format!(\"{:.1} nm\", self.current_wavelength));\n        });\n\n        ui.add_space(10.0);\n\n        // Power display\n        ui.horizontal(|ui| {\n            ui.label(\"Output Power:\");\n            ui.colored_label(Color32::YELLOW, format!(\"{:.2} W\", self.current_power));\n        });\n\n        ui.add_space(10.0);\n\n        // Visual wavelength indicator\n        ui.group(|ui| {\n            ui.label(\"Tuning Range\");\n            ui.add(Slider::new(\u0026mut self.target_wavelength, 700.0..=1000.0)\n                .text(\"nm\")\n                .show_value(false));\n\n            // Show current wavelength marker\n            ui.label(format!(\" {:.0} nm\", self.current_wavelength));\n        });\n\n        ui.add_space(15.0);\n\n        // Control buttons\n        ui.horizontal(|ui| {\n            // Shutter button\n            let shutter_text = if self.shutter_open { \"Close Shutter\" } else { \"Open Shutter\" };\n            let shutter_color = if self.shutter_open { Color32::GREEN } else { Color32::GRAY };\n            if ui.button(egui::RichText::new(shutter_text).color(shutter_color)).clicked() {\n                let new_state = !self.shutter_open;\n                let cmd = InstrumentCommand::SetParameter(\n                    \"shutter\".to_string(),\n                    if new_state { \"open\" } else { \"close\" }.to_string()\n                );\n                if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                    error!(\"Failed to toggle shutter: {}\", e);\n                } else {\n                    self.shutter_open = new_state;\n                }\n            }\n\n            ui.add_space(10.0);\n\n            // Laser ON/OFF button\n            let laser_text = if self.laser_on { \"Laser ON\" } else { \"Laser OFF\" };\n            let laser_color = if self.laser_on { Color32::RED } else { Color32::DARK_GRAY };\n            if ui.button(egui::RichText::new(laser_text).color(laser_color).size(16.0)).clicked() {\n                let new_state = !self.laser_on;\n                let cmd = InstrumentCommand::SetParameter(\n                    \"laser\".to_string(),\n                    if new_state { \"on\" } else { \"off\" }.to_string()\n                );\n                if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                    error!(\"Failed to toggle laser: {}\", e);\n                } else {\n                    self.laser_on = new_state;\n                }\n            }\n        });\n\n        ui.add_space(10.0);\n\n        // System status\n        ui.separator();\n        let status_text = if self.laser_on {\n            \"System Status: ACTIVE\"\n        } else {\n            \"System Status: Ready to turn on\"\n        };\n        let status_color = if self.laser_on { Color32::RED } else { Color32::LIGHT_GREEN };\n        ui.colored_label(status_color, status_text);\n    }\n}\n\n/// Newport 1830-C power meter control panel\npub struct Newport1830CControlPanel {\n    pub instrument_id: String,\n    pub wavelength: f64,\n    pub range: i32,\n    pub units: i32,\n    pub current_power: f64,\n}\n\nimpl Newport1830CControlPanel {\n    pub fn new(instrument_id: String) -\u003e Self {\n        Self {\n            instrument_id,\n            wavelength: 1550.0,\n            range: 0, // autorange\n            units: 0, // Watts\n            current_power: 0.0,\n        }\n    }\n\n    pub fn ui(\u0026mut self, ui: \u0026mut Ui, app: \u0026DaqApp) {\n        ui.heading(\"Newport 1830-C Power Meter\");\n        ui.separator();\n\n        // Wavelength setting\n        ui.horizontal(|ui| {\n            ui.label(\"Wavelength (nm):\");\n            ui.add(egui::DragValue::new(\u0026mut self.wavelength)\n                .speed(1.0)\n                .range(400.0..=1800.0));\n            if ui.button(\"Set\").clicked() {\n                let cmd = InstrumentCommand::SetParameter(\n                    \"wavelength\".to_string(),\n                    self.wavelength.to_string()\n                );\n                if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                    error!(\"Failed to set Newport wavelength: {}\", e);\n                }\n            }\n        });\n\n        ui.add_space(10.0);\n\n        // Range selection\n        ui.horizontal(|ui| {\n            ui.label(\"Range:\");\n            let range_text = if self.range == 0 {\n                \"Auto\".to_string()\n            } else {\n                format!(\"Range {}\", self.range)\n            };\n            egui::ComboBox::from_id_salt(\"range_combo\")\n                .selected_text(range_text)\n                .show_ui(ui, |ui| {\n                    ui.selectable_value(\u0026mut self.range, 0, \"Auto\");\n                    for i in 1..=7 {\n                        ui.selectable_value(\u0026mut self.range, i, format!(\"Range {}\", i));\n                    }\n                });\n        });\n\n        ui.add_space(10.0);\n\n        // Units selection\n        ui.horizontal(|ui| {\n            ui.label(\"Units:\");\n            egui::ComboBox::from_id_salt(\"units_combo\")\n                .selected_text(match self.units {\n                    0 =\u003e \"Watts\",\n                    1 =\u003e \"dBm\",\n                    2 =\u003e \"dB\",\n                    3 =\u003e \"REL\",\n                    _ =\u003e \"Unknown\",\n                })\n                .show_ui(ui, |ui| {\n                    ui.selectable_value(\u0026mut self.units, 0, \"Watts\");\n                    ui.selectable_value(\u0026mut self.units, 1, \"dBm\");\n                    ui.selectable_value(\u0026mut self.units, 2, \"dB\");\n                    ui.selectable_value(\u0026mut self.units, 3, \"REL\");\n                });\n        });\n\n        ui.add_space(15.0);\n\n        // Power reading display\n        ui.group(|ui| {\n            ui.vertical_centered(|ui| {\n                ui.label(\"Current Reading\");\n                ui.heading(egui::RichText::new(format!(\"{:.3e}\", self.current_power))\n                    .color(Color32::LIGHT_GREEN)\n                    .size(24.0));\n                ui.label(match self.units {\n                    0 =\u003e \"W\",\n                    1 =\u003e \"dBm\",\n                    2 =\u003e \"dB\",\n                    3 =\u003e \"REL\",\n                    _ =\u003e \"\",\n                });\n            });\n        });\n\n        ui.add_space(10.0);\n\n        // Zero button\n        if ui.button(\"Zero / Dark Current\").clicked() {\n            let cmd = InstrumentCommand::Execute(\"zero\".to_string(), vec![]);\n            if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                error!(\"Failed to zero Newport 1830-C: {}\", e);\n            }\n        }\n    }\n}\n\n/// Elliptec rotation mount control panel\npub struct ElliptecControlPanel {\n    pub instrument_id: String,\n    pub device_addresses: Vec\u003cu8\u003e,\n    pub positions: Vec\u003cf64\u003e,\n    pub target_positions: Vec\u003cf64\u003e,\n}\n\nimpl ElliptecControlPanel {\n    pub fn new(instrument_id: String, device_addresses: Vec\u003cu8\u003e) -\u003e Self {\n        let num_devices = device_addresses.len();\n        Self {\n            instrument_id,\n            device_addresses,\n            positions: vec![0.0; num_devices],\n            target_positions: vec![0.0; num_devices],\n        }\n    }\n\n    pub fn ui(\u0026mut self, ui: \u0026mut Ui, app: \u0026DaqApp) {\n        ui.heading(\"Elliptec Rotation Mounts\");\n        ui.separator();\n\n        for (idx, \u0026addr) in self.device_addresses.iter().enumerate() {\n            ui.group(|ui| {\n                ui.label(format!(\"Device {} (Address {})\", idx, addr));\n\n                ui.horizontal(|ui| {\n                    ui.label(\"Position:\");\n                    ui.colored_label(Color32::GREEN, format!(\"{:.2}\", self.positions[idx]));\n                });\n\n                ui.horizontal(|ui| {\n                    ui.label(\"Target:\");\n                    ui.add(egui::DragValue::new(\u0026mut self.target_positions[idx])\n                        .speed(1.0)\n                        .range(0.0..=360.0)\n                        .suffix(\"\"));\n\n                    if ui.button(\"Move\").clicked() {\n                        let cmd = InstrumentCommand::SetParameter(\n                            format!(\"{}:position\", addr),\n                            self.target_positions[idx].to_string()\n                        );\n                        if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                            error!(\"Failed to move Elliptec device {}: {}\", addr, e);\n                        } else {\n                            self.positions[idx] = self.target_positions[idx];\n                        }\n                    }\n                });\n\n                // Angle slider\n                ui.add(Slider::new(\u0026mut self.target_positions[idx], 0.0..=360.0)\n                    .text(\"\"));\n\n                // Preset buttons\n                ui.horizontal(|ui| {\n                    if ui.button(\"0\").clicked() {\n                        self.target_positions[idx] = 0.0;\n                    }\n                    if ui.button(\"45\").clicked() {\n                        self.target_positions[idx] = 45.0;\n                    }\n                    if ui.button(\"90\").clicked() {\n                        self.target_positions[idx] = 90.0;\n                    }\n                    if ui.button(\"180\").clicked() {\n                        self.target_positions[idx] = 180.0;\n                    }\n                });\n            });\n\n            ui.add_space(10.0);\n        }\n\n        // Home all button\n        if ui.button(\"Home All Devices\").clicked() {\n            let cmd = InstrumentCommand::Execute(\"home\".to_string(), vec![]);\n            if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                error!(\"Failed to home Elliptec devices: {}\", e);\n            } else {\n                for pos in \u0026mut self.positions {\n                    *pos = 0.0;\n                }\n                for target in \u0026mut self.target_positions {\n                    *target = 0.0;\n                }\n            }\n        }\n    }\n}\n\n/// ESP300 motion controller panel\npub struct ESP300ControlPanel {\n    pub instrument_id: String,\n    pub num_axes: usize,\n    pub positions: Vec\u003cf64\u003e,\n    pub target_positions: Vec\u003cf64\u003e,\n    pub velocities: Vec\u003cf64\u003e,\n}\n\nimpl ESP300ControlPanel {\n    pub fn new(instrument_id: String, num_axes: usize) -\u003e Self {\n        Self {\n            instrument_id,\n            num_axes,\n            positions: vec![0.0; num_axes],\n            target_positions: vec![0.0; num_axes],\n            velocities: vec![5.0; num_axes],\n        }\n    }\n\n    pub fn ui(\u0026mut self, ui: \u0026mut Ui, app: \u0026DaqApp) {\n        ui.heading(\"ESP300 Motion Controller\");\n        ui.separator();\n\n        for axis in 0..self.num_axes {\n            ui.group(|ui| {\n                ui.label(format!(\"Axis {} Control\", axis + 1));\n\n                ui.horizontal(|ui| {\n                    ui.label(\"Position:\");\n                    ui.colored_label(Color32::GREEN, format!(\"{:.3} mm\", self.positions[axis]));\n                });\n\n                ui.horizontal(|ui| {\n                    ui.label(\"Target:\");\n                    ui.add(egui::DragValue::new(\u0026mut self.target_positions[axis])\n                        .speed(0.1)\n                        .suffix(\" mm\"));\n\n                    if ui.button(\"Move Abs\").clicked() {\n                        let cmd = InstrumentCommand::SetParameter(\n                            format!(\"{}:position\", axis + 1),\n                            self.target_positions[axis].to_string()\n                        );\n                        if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                            error!(\"Failed to move ESP300 axis {}: {}\", axis + 1, e);\n                        } else {\n                            self.positions[axis] = self.target_positions[axis];\n                        }\n                    }\n                });\n\n                ui.horizontal(|ui| {\n                    ui.label(\"Velocity:\");\n                    ui.add(egui::DragValue::new(\u0026mut self.velocities[axis])\n                        .speed(0.1)\n                        .range(0.1..=100.0)\n                        .suffix(\" mm/s\"));\n                });\n\n                // Jog buttons\n                ui.horizontal(|ui| {\n                    if ui.button(\" -10\").clicked() {\n                        let cmd = InstrumentCommand::Execute(\n                            \"move_relative\".to_string(),\n                            vec![(axis + 1).to_string(), \"-10\".to_string()]\n                        );\n                        let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                        self.target_positions[axis] -= 10.0;\n                    }\n                    if ui.button(\" -1\").clicked() {\n                        let cmd = InstrumentCommand::Execute(\n                            \"move_relative\".to_string(),\n                            vec![(axis + 1).to_string(), \"-1\".to_string()]\n                        );\n                        let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                        self.target_positions[axis] -= 1.0;\n                    }\n                    if ui.button(\" -0.1\").clicked() {\n                        let cmd = InstrumentCommand::Execute(\n                            \"move_relative\".to_string(),\n                            vec![(axis + 1).to_string(), \"-0.1\".to_string()]\n                        );\n                        let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                        self.target_positions[axis] -= 0.1;\n                    }\n                    if ui.button(\"+0.1 \").clicked() {\n                        let cmd = InstrumentCommand::Execute(\n                            \"move_relative\".to_string(),\n                            vec![(axis + 1).to_string(), \"0.1\".to_string()]\n                        );\n                        let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                        self.target_positions[axis] += 0.1;\n                    }\n                    if ui.button(\"+1 \").clicked() {\n                        let cmd = InstrumentCommand::Execute(\n                            \"move_relative\".to_string(),\n                            vec![(axis + 1).to_string(), \"1\".to_string()]\n                        );\n                        let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                        self.target_positions[axis] += 1.0;\n                    }\n                    if ui.button(\"+10 \").clicked() {\n                        let cmd = InstrumentCommand::Execute(\n                            \"move_relative\".to_string(),\n                            vec![(axis + 1).to_string(), \"10\".to_string()]\n                        );\n                        let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                        self.target_positions[axis] += 10.0;\n                    }\n                });\n\n                if ui.button(\"Stop\").clicked() {\n                    let cmd = InstrumentCommand::Execute(\n                        \"stop\".to_string(),\n                        vec![(axis + 1).to_string()]\n                    );\n                    let _ = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd));\n                }\n            });\n\n            ui.add_space(10.0);\n        }\n\n        // Home all axes\n        if ui.button(\"Home All Axes\").clicked() {\n            let cmd = InstrumentCommand::Execute(\"home\".to_string(), vec![]);\n            if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                error!(\"Failed to home ESP300 axes: {}\", e);\n            } else {\n                for pos in \u0026mut self.positions {\n                    *pos = 0.0;\n                }\n            }\n        }\n    }\n}\n\n/// PVCAM camera control panel\npub struct PVCAMControlPanel {\n    pub instrument_id: String,\n    pub exposure_ms: f64,\n    pub gain: i32,\n    pub binning: (i32, i32),\n    pub acquiring: bool,\n}\n\nimpl PVCAMControlPanel {\n    pub fn new(instrument_id: String) -\u003e Self {\n        Self {\n            instrument_id,\n            exposure_ms: 100.0,\n            gain: 1,\n            binning: (1, 1),\n            acquiring: false,\n        }\n    }\n\n    pub fn ui(\u0026mut self, ui: \u0026mut Ui, app: \u0026DaqApp) {\n        ui.heading(\"PVCAM Camera Control\");\n        ui.separator();\n\n        // Exposure control\n        ui.horizontal(|ui| {\n            ui.label(\"Exposure:\");\n            ui.add(egui::DragValue::new(\u0026mut self.exposure_ms)\n                .speed(1.0)\n                .range(1.0..=10000.0)\n                .suffix(\" ms\"));\n        });\n\n        // Gain control\n        ui.horizontal(|ui| {\n            ui.label(\"Gain:\");\n            ui.add(Slider::new(\u0026mut self.gain, 1..=16));\n        });\n\n        // Binning control\n        ui.horizontal(|ui| {\n            ui.label(\"Binning:\");\n            egui::ComboBox::from_id_salt(\"binning_combo\")\n                .selected_text(format!(\"{}x{}\", self.binning.0, self.binning.1))\n                .show_ui(ui, |ui| {\n                    ui.selectable_value(\u0026mut self.binning, (1, 1), \"1x1\");\n                    ui.selectable_value(\u0026mut self.binning, (2, 2), \"2x2\");\n                    ui.selectable_value(\u0026mut self.binning, (4, 4), \"4x4\");\n                });\n        });\n\n        ui.add_space(15.0);\n\n        // Acquisition controls\n        ui.horizontal(|ui| {\n            let button_text = if self.acquiring { \"Stop Acquisition\" } else { \"Start Acquisition\" };\n            let button_color = if self.acquiring { Color32::RED } else { Color32::GREEN };\n\n            if ui.button(egui::RichText::new(button_text).color(button_color)).clicked() {\n                let new_state = !self.acquiring;\n                let cmd = if new_state {\n                    InstrumentCommand::Execute(\"start_acquisition\".to_string(), vec![])\n                } else {\n                    InstrumentCommand::Execute(\"stop_acquisition\".to_string(), vec![])\n                };\n                if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                    error!(\"Failed to toggle PVCAM acquisition: {}\", e);\n                } else {\n                    self.acquiring = new_state;\n                }\n            }\n\n            if ui.button(\"Snap\").clicked() {\n                let cmd = InstrumentCommand::Execute(\"snap\".to_string(), vec![]);\n                if let Err(e) = app.with_inner(|inner| inner.send_instrument_command(\u0026self.instrument_id, cmd)) {\n                    error!(\"Failed to snap PVCAM frame: {}\", e);\n                }\n            }\n        });\n\n        ui.add_space(10.0);\n\n        // Status\n        let status_text = if self.acquiring { \"ACQUIRING\" } else { \"IDLE\" };\n        let status_color = if self.acquiring { Color32::GREEN } else { Color32::GRAY };\n        ui.colored_label(status_color, status_text);\n    }\n}\n","traces":[{"line":40,"address":[32424480],"length":1,"stats":{"Line":0}},{"line":51,"address":[32647584],"length":1,"stats":{"Line":0}},{"line":52,"address":[32647630],"length":1,"stats":{"Line":0}},{"line":53,"address":[32647668],"length":1,"stats":{"Line":0}},{"line":56,"address":[32850543],"length":1,"stats":{"Line":0}},{"line":57,"address":[37721865],"length":1,"stats":{"Line":0}},{"line":58,"address":[37721923,37722119,37722063],"length":1,"stats":{"Line":0}},{"line":59,"address":[37721954],"length":1,"stats":{"Line":0}},{"line":60,"address":[37786570,37787489,37786403,37786487],"length":1,"stats":{"Line":0}},{"line":61,"address":[38148024],"length":1,"stats":{"Line":0}},{"line":62,"address":[37722419],"length":1,"stats":{"Line":0}},{"line":63,"address":[36855313],"length":1,"stats":{"Line":0}},{"line":64,"address":[37786755],"length":1,"stats":{"Line":0}},{"line":66,"address":[36856096,36855535,36855717,36856118],"length":1,"stats":{"Line":0}},{"line":67,"address":[38148619,38148503,38148644],"length":1,"stats":{"Line":0}},{"line":69,"address":[40711686],"length":1,"stats":{"Line":0}},{"line":74,"address":[32647796],"length":1,"stats":{"Line":0}},{"line":77,"address":[35408893],"length":1,"stats":{"Line":0}},{"line":78,"address":[40712337],"length":1,"stats":{"Line":0}},{"line":79,"address":[36856376],"length":1,"stats":{"Line":0}},{"line":82,"address":[32647855],"length":1,"stats":{"Line":0}},{"line":85,"address":[32647878],"length":1,"stats":{"Line":0}},{"line":86,"address":[36856641],"length":1,"stats":{"Line":0}},{"line":87,"address":[40712680],"length":1,"stats":{"Line":0}},{"line":90,"address":[32850750],"length":1,"stats":{"Line":0}},{"line":93,"address":[32647937],"length":1,"stats":{"Line":0}},{"line":94,"address":[37788395],"length":1,"stats":{"Line":0}},{"line":95,"address":[38149869,38149988],"length":1,"stats":{"Line":0}},{"line":96,"address":[40713062],"length":1,"stats":{"Line":0}},{"line":97,"address":[38150010,38149960],"length":1,"stats":{"Line":0}},{"line":100,"address":[36857164],"length":1,"stats":{"Line":0}},{"line":103,"address":[32489377],"length":1,"stats":{"Line":0}},{"line":106,"address":[38150224,38151529],"length":1,"stats":{"Line":0}},{"line":108,"address":[37724399],"length":1,"stats":{"Line":0}},{"line":109,"address":[37724472],"length":1,"stats":{"Line":0}},{"line":110,"address":[37788925],"length":1,"stats":{"Line":0}},{"line":111,"address":[38150632],"length":1,"stats":{"Line":0}},{"line":112,"address":[40714021],"length":1,"stats":{"Line":0}},{"line":113,"address":[36857788],"length":1,"stats":{"Line":0}},{"line":114,"address":[37789249,37789302],"length":1,"stats":{"Line":0}},{"line":116,"address":[38151185,38152790,38152768,38150993],"length":1,"stats":{"Line":0}},{"line":117,"address":[38151119,38151263,38151238],"length":1,"stats":{"Line":0}},{"line":119,"address":[37725320],"length":1,"stats":{"Line":0}},{"line":123,"address":[40713839],"length":1,"stats":{"Line":0}},{"line":126,"address":[37724868,37725692],"length":1,"stats":{"Line":0}},{"line":127,"address":[37790172],"length":1,"stats":{"Line":0}},{"line":128,"address":[37790209],"length":1,"stats":{"Line":0}},{"line":129,"address":[38151923],"length":1,"stats":{"Line":0}},{"line":130,"address":[37790691],"length":1,"stats":{"Line":0}},{"line":131,"address":[37790504],"length":1,"stats":{"Line":0}},{"line":132,"address":[38151974,38151988],"length":1,"stats":{"Line":0}},{"line":134,"address":[40715375,40716112,40715558,40716134],"length":1,"stats":{"Line":0}},{"line":135,"address":[38152500,38152359,38152475],"length":1,"stats":{"Line":0}},{"line":137,"address":[38152413],"length":1,"stats":{"Line":0}},{"line":142,"address":[32425076],"length":1,"stats":{"Line":0}},{"line":145,"address":[32425094],"length":1,"stats":{"Line":0}},{"line":146,"address":[32489542,32489575],"length":1,"stats":{"Line":0}},{"line":147,"address":[32851017],"length":1,"stats":{"Line":0}},{"line":149,"address":[32648150],"length":1,"stats":{"Line":0}},{"line":151,"address":[32851049],"length":1,"stats":{"Line":0}},{"line":152,"address":[32425232],"length":1,"stats":{"Line":0}},{"line":166,"address":[35409424],"length":1,"stats":{"Line":0}},{"line":176,"address":[32425392,32426740,32426746],"length":1,"stats":{"Line":0}},{"line":177,"address":[32648449],"length":1,"stats":{"Line":0}},{"line":178,"address":[32851371],"length":1,"stats":{"Line":0}},{"line":181,"address":[32425550],"length":1,"stats":{"Line":0}},{"line":182,"address":[37727353],"length":1,"stats":{"Line":0}},{"line":183,"address":[40716403,40716599,40716543],"length":1,"stats":{"Line":0}},{"line":184,"address":[36860418],"length":1,"stats":{"Line":0}},{"line":185,"address":[40716467,40717531,40716634,40716551],"length":1,"stats":{"Line":0}},{"line":186,"address":[37727656],"length":1,"stats":{"Line":0}},{"line":187,"address":[40716899],"length":1,"stats":{"Line":0}},{"line":188,"address":[38153649],"length":1,"stats":{"Line":0}},{"line":189,"address":[36860803],"length":1,"stats":{"Line":0}},{"line":191,"address":[38153871,38154416,38154438],"length":1,"stats":{"Line":0}},{"line":192,"address":[38154110,38154085,38153995],"length":1,"stats":{"Line":0}},{"line":197,"address":[32425652],"length":1,"stats":{"Line":0}},{"line":200,"address":[35409766],"length":1,"stats":{"Line":0}},{"line":201,"address":[36861777],"length":1,"stats":{"Line":0}},{"line":202,"address":[37728848],"length":1,"stats":{"Line":0}},{"line":203,"address":[37793269],"length":1,"stats":{"Line":0}},{"line":205,"address":[37793313],"length":1,"stats":{"Line":0}},{"line":207,"address":[38154879],"length":1,"stats":{"Line":0}},{"line":208,"address":[36862071],"length":1,"stats":{"Line":0}},{"line":209,"address":[37793696,37793596],"length":1,"stats":{"Line":0}},{"line":210,"address":[36862292],"length":1,"stats":{"Line":0}},{"line":211,"address":[37729429,37729353],"length":1,"stats":{"Line":0}},{"line":212,"address":[38155346],"length":1,"stats":{"Line":0}},{"line":217,"address":[35409818],"length":1,"stats":{"Line":0}},{"line":220,"address":[38155552],"length":1,"stats":{"Line":0}},{"line":221,"address":[37729728],"length":1,"stats":{"Line":0}},{"line":222,"address":[37794189,37794400],"length":1,"stats":{"Line":0}},{"line":223,"address":[40718799,40718992],"length":1,"stats":{"Line":0}},{"line":224,"address":[37729870],"length":1,"stats":{"Line":0}},{"line":225,"address":[40718891],"length":1,"stats":{"Line":0}},{"line":226,"address":[37794344],"length":1,"stats":{"Line":0}},{"line":227,"address":[37794373],"length":1,"stats":{"Line":0}},{"line":228,"address":[37729841],"length":1,"stats":{"Line":0}},{"line":230,"address":[36862991,36863040],"length":1,"stats":{"Line":0}},{"line":231,"address":[37794532],"length":1,"stats":{"Line":0}},{"line":232,"address":[40719155],"length":1,"stats":{"Line":0}},{"line":233,"address":[36863177],"length":1,"stats":{"Line":0}},{"line":234,"address":[40719267],"length":1,"stats":{"Line":0}},{"line":238,"address":[32490215],"length":1,"stats":{"Line":0}},{"line":241,"address":[32425822],"length":1,"stats":{"Line":0}},{"line":242,"address":[38156231,38156272],"length":1,"stats":{"Line":0}},{"line":243,"address":[37730475],"length":1,"stats":{"Line":0}},{"line":244,"address":[40719525,40719794],"length":1,"stats":{"Line":0}},{"line":245,"address":[36863695],"length":1,"stats":{"Line":0}},{"line":246,"address":[38156690,38156643],"length":1,"stats":{"Line":0}},{"line":247,"address":[36863973,36863793],"length":1,"stats":{"Line":0}},{"line":248,"address":[36863854],"length":1,"stats":{"Line":0}},{"line":249,"address":[38156787],"length":1,"stats":{"Line":0}},{"line":250,"address":[37795376],"length":1,"stats":{"Line":0}},{"line":251,"address":[38156845],"length":1,"stats":{"Line":0}},{"line":252,"address":[40719867],"length":1,"stats":{"Line":0}},{"line":257,"address":[32648862],"length":1,"stats":{"Line":0}},{"line":260,"address":[32648875],"length":1,"stats":{"Line":0}},{"line":261,"address":[32426036,32426092],"length":1,"stats":{"Line":0}},{"line":262,"address":[35410345],"length":1,"stats":{"Line":0}},{"line":263,"address":[35410457,35410547,35410572],"length":1,"stats":{"Line":0}},{"line":278,"address":[32649744,32650206,32650259],"length":1,"stats":{"Line":0}},{"line":279,"address":[32649779,32649883],"length":1,"stats":{"Line":0}},{"line":283,"address":[32852821],"length":1,"stats":{"Line":0}},{"line":284,"address":[32491453],"length":1,"stats":{"Line":0}},{"line":288,"address":[32650288,32651636,32651642],"length":1,"stats":{"Line":0}},{"line":289,"address":[32427374],"length":1,"stats":{"Line":0}},{"line":290,"address":[32650372],"length":1,"stats":{"Line":0}},{"line":292,"address":[32853410,32853301],"length":1,"stats":{"Line":0}},{"line":293,"address":[40720288],"length":1,"stats":{"Line":0}},{"line":294,"address":[38157177],"length":1,"stats":{"Line":0}},{"line":296,"address":[38157417,38157792],"length":1,"stats":{"Line":0}},{"line":297,"address":[36864939],"length":1,"stats":{"Line":0}},{"line":298,"address":[37796455],"length":1,"stats":{"Line":0}},{"line":301,"address":[36865232,36864549,36866762],"length":1,"stats":{"Line":0}},{"line":302,"address":[37732313],"length":1,"stats":{"Line":0}},{"line":303,"address":[37797060,37796957,37796790],"length":1,"stats":{"Line":0}},{"line":304,"address":[37732437],"length":1,"stats":{"Line":0}},{"line":305,"address":[37796886,37798268,37796965],"length":1,"stats":{"Line":0}},{"line":306,"address":[40721584,40721663],"length":1,"stats":{"Line":0}},{"line":308,"address":[37797101],"length":1,"stats":{"Line":0}},{"line":309,"address":[37733069],"length":1,"stats":{"Line":0}},{"line":310,"address":[38158686],"length":1,"stats":{"Line":0}},{"line":311,"address":[36865981,36865894],"length":1,"stats":{"Line":0}},{"line":313,"address":[37797839,37798288,37797593,37798310],"length":1,"stats":{"Line":0}},{"line":314,"address":[37797713,37797917,37797892],"length":1,"stats":{"Line":0}},{"line":316,"address":[37797763],"length":1,"stats":{"Line":0}},{"line":322,"address":[37731837,37731718],"length":1,"stats":{"Line":0}},{"line":323,"address":[40720790,40720851],"length":1,"stats":{"Line":0}},{"line":326,"address":[40723072,40723826,40723820,40720875],"length":1,"stats":{"Line":0}},{"line":327,"address":[37798555],"length":1,"stats":{"Line":0}},{"line":328,"address":[37798687],"length":1,"stats":{"Line":0}},{"line":330,"address":[38160155],"length":1,"stats":{"Line":0}},{"line":331,"address":[40723435],"length":1,"stats":{"Line":0}},{"line":333,"address":[37798892],"length":1,"stats":{"Line":0}},{"line":334,"address":[40723612],"length":1,"stats":{"Line":0}},{"line":336,"address":[37734653],"length":1,"stats":{"Line":0}},{"line":337,"address":[37734792],"length":1,"stats":{"Line":0}},{"line":342,"address":[32650744],"length":1,"stats":{"Line":0}},{"line":346,"address":[35411905],"length":1,"stats":{"Line":0}},{"line":347,"address":[32853858,32853802],"length":1,"stats":{"Line":0}},{"line":348,"address":[35412255],"length":1,"stats":{"Line":0}},{"line":349,"address":[32854123,32854249,32854274],"length":1,"stats":{"Line":0}},{"line":351,"address":[32854635,32854170,32854559],"length":1,"stats":{"Line":0}},{"line":352,"address":[32428772],"length":1,"stats":{"Line":0}},{"line":354,"address":[32854748,32854642],"length":1,"stats":{"Line":0}},{"line":355,"address":[32493301],"length":1,"stats":{"Line":0}},{"line":372,"address":[35412992,35413391,35413397],"length":1,"stats":{"Line":0}},{"line":376,"address":[32493367],"length":1,"stats":{"Line":0}},{"line":377,"address":[32429023],"length":1,"stats":{"Line":0}},{"line":378,"address":[35413188],"length":1,"stats":{"Line":0}},{"line":382,"address":[32430570,32429328,32430576],"length":1,"stats":{"Line":0}},{"line":383,"address":[32493790],"length":1,"stats":{"Line":0}},{"line":384,"address":[32855269],"length":1,"stats":{"Line":0}},{"line":386,"address":[32855331,32855301],"length":1,"stats":{"Line":0}},{"line":387,"address":[38162273,38160912,38162262],"length":1,"stats":{"Line":0}},{"line":388,"address":[36868620,36868015],"length":1,"stats":{"Line":0}},{"line":390,"address":[36869344,36868251],"length":1,"stats":{"Line":0}},{"line":391,"address":[38162347],"length":1,"stats":{"Line":0}},{"line":392,"address":[40725527],"length":1,"stats":{"Line":0}},{"line":395,"address":[36871237,36868311,36869696],"length":1,"stats":{"Line":0}},{"line":396,"address":[37801228],"length":1,"stats":{"Line":0}},{"line":397,"address":[36869785,36869926],"length":1,"stats":{"Line":0}},{"line":398,"address":[37736930],"length":1,"stats":{"Line":0}},{"line":399,"address":[40725957,40726051],"length":1,"stats":{"Line":0}},{"line":401,"address":[37737069],"length":1,"stats":{"Line":0}},{"line":402,"address":[36870420],"length":1,"stats":{"Line":0}},{"line":403,"address":[37801846,37801636,37801676],"length":1,"stats":{"Line":0}},{"line":404,"address":[37737396,37737492],"length":1,"stats":{"Line":0}},{"line":406,"address":[40727360,40726616,40726862,40727382],"length":1,"stats":{"Line":0}},{"line":407,"address":[36870647,36870824,36870849],"length":1,"stats":{"Line":0}},{"line":409,"address":[37737794],"length":1,"stats":{"Line":0}},{"line":414,"address":[40727568,40727986,40728018,40724496],"length":1,"stats":{"Line":0}},{"line":415,"address":[40727627],"length":1,"stats":{"Line":0}},{"line":416,"address":[37803366,37803114,37803276],"length":1,"stats":{"Line":0}},{"line":417,"address":[37738747],"length":1,"stats":{"Line":0}},{"line":418,"address":[37739007,37738792,37738819,37738868],"length":1,"stats":{"Line":0}},{"line":419,"address":[38164767,38164828],"length":1,"stats":{"Line":0}},{"line":423,"address":[37735561,37739040,37744507,37744518],"length":1,"stats":{"Line":0}},{"line":424,"address":[37739071,37740052],"length":1,"stats":{"Line":0}},{"line":425,"address":[37804215],"length":1,"stats":{"Line":0}},{"line":426,"address":[36872116],"length":1,"stats":{"Line":0}},{"line":427,"address":[38170407,38165260,38165115],"length":1,"stats":{"Line":0}},{"line":429,"address":[37808976,37808998,37804323],"length":1,"stats":{"Line":0}},{"line":430,"address":[37740009],"length":1,"stats":{"Line":0}},{"line":432,"address":[38166836,38165913,38165138],"length":1,"stats":{"Line":0}},{"line":433,"address":[38166583],"length":1,"stats":{"Line":0}},{"line":434,"address":[37804563],"length":1,"stats":{"Line":0}},{"line":435,"address":[38166042,38170402,38166187],"length":1,"stats":{"Line":0}},{"line":437,"address":[40733782,40729827,40733760],"length":1,"stats":{"Line":0}},{"line":438,"address":[36873820],"length":1,"stats":{"Line":0}},{"line":440,"address":[40729977,40730900,40729201],"length":1,"stats":{"Line":0}},{"line":441,"address":[38167511],"length":1,"stats":{"Line":0}},{"line":442,"address":[40730067],"length":1,"stats":{"Line":0}},{"line":443,"address":[38170397,38166970,38167115],"length":1,"stats":{"Line":0}},{"line":445,"address":[38167619,38170832,38170854],"length":1,"stats":{"Line":0}},{"line":446,"address":[37741865],"length":1,"stats":{"Line":0}},{"line":448,"address":[37807209,37806329,37805553],"length":1,"stats":{"Line":0}},{"line":449,"address":[37742550],"length":1,"stats":{"Line":0}},{"line":450,"address":[37742003],"length":1,"stats":{"Line":0}},{"line":451,"address":[38170392,38167898,38168028],"length":1,"stats":{"Line":0}},{"line":453,"address":[37742658,37745206,37745184],"length":1,"stats":{"Line":0}},{"line":454,"address":[36875623],"length":1,"stats":{"Line":0}},{"line":456,"address":[37742062,37742798,37743675],"length":1,"stats":{"Line":0}},{"line":457,"address":[40732424],"length":1,"stats":{"Line":0}},{"line":458,"address":[37807301],"length":1,"stats":{"Line":0}},{"line":459,"address":[37807470,37807340,37808947],"length":1,"stats":{"Line":0}},{"line":461,"address":[36876404,36878256,36878278],"length":1,"stats":{"Line":0}},{"line":462,"address":[36876498],"length":1,"stats":{"Line":0}},{"line":464,"address":[37744502,37743680,37742944],"length":1,"stats":{"Line":0}},{"line":465,"address":[40733253],"length":1,"stats":{"Line":0}},{"line":466,"address":[36876628],"length":1,"stats":{"Line":0}},{"line":467,"address":[37808299,37808929,37808222],"length":1,"stats":{"Line":0}},{"line":469,"address":[38171456,38171478,38170225],"length":1,"stats":{"Line":0}},{"line":470,"address":[37744463],"length":1,"stats":{"Line":0}},{"line":474,"address":[36868570,36868633],"length":1,"stats":{"Line":0}},{"line":475,"address":[37800621],"length":1,"stats":{"Line":0}},{"line":476,"address":[37800224],"length":1,"stats":{"Line":0}},{"line":477,"address":[37736412,37735924,37735847],"length":1,"stats":{"Line":0}},{"line":479,"address":[40725305,40734800,40734822],"length":1,"stats":{"Line":0}},{"line":483,"address":[35413768],"length":1,"stats":{"Line":0}},{"line":487,"address":[32855551],"length":1,"stats":{"Line":0}},{"line":488,"address":[35413928,35413984],"length":1,"stats":{"Line":0}},{"line":489,"address":[35414141],"length":1,"stats":{"Line":0}},{"line":490,"address":[32430153,32430304,32430279],"length":1,"stats":{"Line":0}},{"line":492,"address":[32856525,32856056,32856445],"length":1,"stats":{"Line":0}},{"line":493,"address":[32430662],"length":1,"stats":{"Line":0}},{"line":510,"address":[35414768],"length":1,"stats":{"Line":0}},{"line":520,"address":[32430736],"length":1,"stats":{"Line":0}},{"line":521,"address":[35414877],"length":1,"stats":{"Line":0}},{"line":522,"address":[32653763],"length":1,"stats":{"Line":0}},{"line":525,"address":[37746224,37746619,37746587],"length":1,"stats":{"Line":0}},{"line":526,"address":[40735248],"length":1,"stats":{"Line":0}},{"line":527,"address":[38172310,38172399,38172170],"length":1,"stats":{"Line":0}},{"line":528,"address":[37746341],"length":1,"stats":{"Line":0}},{"line":529,"address":[40735405,40735454,40735592,40735378],"length":1,"stats":{"Line":0}},{"line":530,"address":[36879429,36879369],"length":1,"stats":{"Line":0}},{"line":534,"address":[32430899],"length":1,"stats":{"Line":0}},{"line":535,"address":[40735664],"length":1,"stats":{"Line":0}},{"line":536,"address":[40735698],"length":1,"stats":{"Line":0}},{"line":540,"address":[32856797],"length":1,"stats":{"Line":0}},{"line":541,"address":[37746833],"length":1,"stats":{"Line":0}},{"line":542,"address":[36880020,36879750],"length":1,"stats":{"Line":0}},{"line":543,"address":[40735920,40736156,40735967,40736266],"length":1,"stats":{"Line":0}},{"line":544,"address":[37811728,37811633],"length":1,"stats":{"Line":0}},{"line":545,"address":[36880212],"length":1,"stats":{"Line":0}},{"line":546,"address":[36880267],"length":1,"stats":{"Line":0}},{"line":547,"address":[37811882],"length":1,"stats":{"Line":0}},{"line":551,"address":[32430978],"length":1,"stats":{"Line":0}},{"line":554,"address":[37747536,37748383],"length":1,"stats":{"Line":0}},{"line":555,"address":[37747567],"length":1,"stats":{"Line":0}},{"line":556,"address":[37812056],"length":1,"stats":{"Line":0}},{"line":558,"address":[37812093],"length":1,"stats":{"Line":0}},{"line":559,"address":[40736912],"length":1,"stats":{"Line":0}},{"line":560,"address":[37748551,37747944],"length":1,"stats":{"Line":0}},{"line":561,"address":[38174258,38173915],"length":1,"stats":{"Line":0}},{"line":563,"address":[40737102,40737003],"length":1,"stats":{"Line":0}},{"line":565,"address":[37814208,37812686,37812972,37814230,37813051],"length":1,"stats":{"Line":0}},{"line":566,"address":[36881431,36881547,36881572],"length":1,"stats":{"Line":0}},{"line":568,"address":[36881485],"length":1,"stats":{"Line":0}},{"line":572,"address":[37812374,37813395],"length":1,"stats":{"Line":0}},{"line":573,"address":[36881977,36881921],"length":1,"stats":{"Line":0}},{"line":574,"address":[40739014,40738274,40738992],"length":1,"stats":{"Line":0}},{"line":575,"address":[38175352,38175377,38175262],"length":1,"stats":{"Line":0}},{"line":580,"address":[32495493],"length":1,"stats":{"Line":0}},{"line":583,"address":[32856951],"length":1,"stats":{"Line":0}},{"line":584,"address":[32431162],"length":1,"stats":{"Line":0}},{"line":585,"address":[32431201],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":288},{"path":["/","app","src","gui","log_panel.rs"],"content":"//! Renders the log panel in the GUI.\n//!\n//! This module contains the `render` function which is responsible for drawing the\n//! log panel at the bottom of the main application window. The panel provides\n//! features for viewing, filtering, and managing log messages captured from the\n//! `log` crate.\n//!\n//! ## Features\n//!\n//! - **Log Display:** Shows a time-stamped, color-coded, and scrollable list of log entries.\n//! - **Level Filtering:** A dropdown allows the user to filter logs by their severity\n//!   (e.g., Error, Warn, Info).\n//! - **Text Filtering:** A text input field allows filtering logs by their message content or target.\n//! - **Auto-Scrolling:** A toggle to automatically scroll to the latest log message.\n//! - **Clear Button:** A button to clear all captured log messages.\n//! - **Efficient Rendering:** Uses `ScrollArea::show_rows` to only render the visible portion\n//!   of the log list, ensuring good performance even with a large number of log entries.\n\nuse crate::gui::Gui;\nuse eframe::egui::{self, Color32, ScrollArea, Ui};\nuse log::LevelFilter;\n\n/// Renders the log panel.\npub fn render(ui: \u0026mut Ui, gui: \u0026mut Gui) {\n    ui.heading(\"Event Log\");\n\n    // --- Header Controls ---\n    ui.horizontal(|ui| {\n        // --- Log Level Filter ---\n        ui.label(\"Filter Level:\");\n        level_filter_combo_box(ui, \u0026mut gui.log_level_filter);\n\n        // --- Text Filter ---\n        ui.label(\"Filter Text:\");\n        let _ = ui.text_edit_singleline(\u0026mut gui.log_filter_text);\n\n        // --- Spacer and Clear Button ---\n        ui.with_layout(egui::Layout::right_to_left(egui::Align::Center), |ui| {\n            if ui.button(\"Clear\").clicked() {\n                gui.log_buffer.clear();\n            }\n            // --- Scroll to Bottom Toggle ---\n            ui.toggle_value(\u0026mut gui.scroll_to_bottom, \"Scroll to Bottom\");\n        });\n    });\n\n    ui.separator();\n\n    // --- Log Messages Area ---\n    let scroll_area = ScrollArea::vertical()\n        .auto_shrink([false; 2])\n        .stick_to_bottom(gui.scroll_to_bottom);\n    let text_style = egui::TextStyle::Monospace;\n    let logs = gui.log_buffer.read();\n    let row_height = ui.text_style_height(\u0026text_style);\n\n    let filtered_logs: Vec\u003c_\u003e = logs\n        .iter()\n        .filter(|entry| {\n            let level_match =\n                entry.level \u003c= gui.log_level_filter.to_level().unwrap_or(log::Level::Trace);\n            let text_match = gui.log_filter_text.is_empty()\n                || entry.message.contains(\u0026gui.log_filter_text)\n                || entry.target.contains(\u0026gui.log_filter_text);\n            level_match \u0026\u0026 text_match\n        })\n        .collect();\n\n    let num_rows = filtered_logs.len();\n\n    scroll_area.show_rows(ui, row_height, num_rows, |ui, row_range| {\n        for i in row_range {\n            if let Some(entry) = filtered_logs.get(i) {\n                ui.horizontal(|ui| {\n                    let level_text = format!(\"[{:\u003c5}]\", entry.level);\n                    ui.colored_label(entry.color(), level_text);\n                    ui.label(entry.timestamp.format(\"%H:%M:%S%.3f\").to_string());\n                    ui.colored_label(Color32::from_gray(150), \u0026entry.target);\n                    ui.label(\u0026entry.message);\n                });\n            }\n        }\n    });\n}\n\n/// A combo box for selecting the log level filter.\nfn level_filter_combo_box(ui: \u0026mut Ui, level_filter: \u0026mut LevelFilter) {\n    egui::ComboBox::from_id_salt(\"log_level_filter\")\n        .selected_text(format!(\"{:?}\", level_filter))\n        .show_ui(ui, |ui| {\n            ui.selectable_value(level_filter, LevelFilter::Off, \"Off\");\n            ui.selectable_value(level_filter, LevelFilter::Error, \"Error\");\n            ui.selectable_value(level_filter, LevelFilter::Warn, \"Warn\");\n            ui.selectable_value(level_filter, LevelFilter::Info, \"Info\");\n            ui.selectable_value(level_filter, LevelFilter::Debug, \"Debug\");\n            ui.selectable_value(level_filter, LevelFilter::Trace, \"Trace\");\n        });\n}\n","traces":[{"line":24,"address":[38139248,38140106,38140112],"length":1,"stats":{"Line":0}},{"line":25,"address":[37713431],"length":1,"stats":{"Line":0}},{"line":28,"address":[40702483],"length":1,"stats":{"Line":0}},{"line":30,"address":[30922089],"length":1,"stats":{"Line":0}},{"line":31,"address":[30922152],"length":1,"stats":{"Line":0}},{"line":34,"address":[36963451],"length":1,"stats":{"Line":0}},{"line":35,"address":[36963500],"length":1,"stats":{"Line":0}},{"line":38,"address":[29134464,29134719,29134295,29134713],"length":1,"stats":{"Line":0}},{"line":39,"address":[29134521],"length":1,"stats":{"Line":0}},{"line":40,"address":[36963896],"length":1,"stats":{"Line":0}},{"line":43,"address":[36963911],"length":1,"stats":{"Line":0}},{"line":47,"address":[40702615],"length":1,"stats":{"Line":0}},{"line":50,"address":[37713653,37713673],"length":1,"stats":{"Line":0}},{"line":51,"address":[38139545,38139519],"length":1,"stats":{"Line":0}},{"line":52,"address":[36904137],"length":1,"stats":{"Line":0}},{"line":53,"address":[37713754],"length":1,"stats":{"Line":0}},{"line":54,"address":[40702836,40702758],"length":1,"stats":{"Line":0}},{"line":55,"address":[37713861,37713933],"length":1,"stats":{"Line":0}},{"line":57,"address":[40702934],"length":1,"stats":{"Line":0}},{"line":59,"address":[36904387],"length":1,"stats":{"Line":0}},{"line":61,"address":[36964007],"length":1,"stats":{"Line":0}},{"line":62,"address":[33481088,33481034],"length":1,"stats":{"Line":0}},{"line":63,"address":[30922810],"length":1,"stats":{"Line":0}},{"line":64,"address":[30561419],"length":1,"stats":{"Line":0}},{"line":65,"address":[29134933],"length":1,"stats":{"Line":0}},{"line":69,"address":[40703139,40703055],"length":1,"stats":{"Line":0}},{"line":71,"address":[33481184],"length":1,"stats":{"Line":0}},{"line":72,"address":[36964315,36964299],"length":1,"stats":{"Line":0}},{"line":73,"address":[30561649,30561719],"length":1,"stats":{"Line":0}},{"line":74,"address":[36964450,36964480,36965190,36965184],"length":1,"stats":{"Line":0}},{"line":75,"address":[36964519],"length":1,"stats":{"Line":0}},{"line":76,"address":[33481646,33481711],"length":1,"stats":{"Line":0}},{"line":77,"address":[33481838],"length":1,"stats":{"Line":0}},{"line":78,"address":[30562339],"length":1,"stats":{"Line":0}},{"line":79,"address":[29135930],"length":1,"stats":{"Line":0}},{"line":87,"address":[40703264,40703628,40703596],"length":1,"stats":{"Line":0}},{"line":88,"address":[36904664,36904870],"length":1,"stats":{"Line":0}},{"line":89,"address":[36904980,36904729,36904878,36904722],"length":1,"stats":{"Line":0}},{"line":90,"address":[33482240],"length":1,"stats":{"Line":0}},{"line":91,"address":[30562596],"length":1,"stats":{"Line":0}},{"line":92,"address":[29136117],"length":1,"stats":{"Line":0}},{"line":93,"address":[30924141],"length":1,"stats":{"Line":0}},{"line":94,"address":[30924197],"length":1,"stats":{"Line":0}},{"line":95,"address":[29136285],"length":1,"stats":{"Line":0}},{"line":96,"address":[29136341],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":45},{"path":["/","app","src","gui","mod.rs"],"content":"//! The eframe/egui implementation for the GUI.\n//!\n//! This module defines the main graphical user interface for the DAQ application,\n//! built using the `eframe` and `egui` libraries. It provides a flexible, dockable\n//! interface for visualizing data, controlling instruments, and managing data storage.\n//!\n//! ## Architecture\n//!\n//! The GUI is structured around a main `Gui` struct which implements the `eframe::App` trait.\n//! The core components of the GUI are:\n//!\n//! - **Docking System (`egui_dock`):** The central area of the application is a `DockArea`\n//!   that allows users to arrange various tabs in a flexible layout. Tabs can be plots,\n\n//!   instrument control panels, or other views. The state of the dock is managed by `DockState\u003cDockTab\u003e`.\n//!\n//! - **Panels:**\n//!   - `TopBottomPanel` (Top): Contains global controls like adding new plot tabs and a menu for\n//!     opening instrument-specific control panels.\n//!   - `TopBottomPanel` (Bottom): Displays a resizable log panel for viewing application logs.\n//!   - `SidePanel` (Left): Shows a list of all configured instruments, their status (running/stopped),\n//!     and provides controls to start or stop them. Instruments can be dragged from this panel\n//!     to the central dock area to open their control tabs.\n//!   - `SidePanel` (Right): A toggleable panel for managing data storage sessions, implemented in the\n//!     `storage_manager` module.\n//!\n//! - **Data Flow:**\n//!   - The `Gui` struct receives live `DataPoint`s from the core application logic via a `tokio::sync::broadcast`\n//!     channel.\n//!   - The `update_data` method processes these points and updates the corresponding plot tabs.\n//!   - Instrument control panels interact with the `DaqApp` core to send commands to hardware.\n//!\n//! - **State Management:**\n//!   - The main `Gui` struct holds the application state, including the `DaqApp` handle, the `DockState`,\n//!     and state for various UI components like combo boxes and filters.\n//!\n//! ## Modules\n//!\n//! - `instrument_controls`: Defines the UI panels for controlling specific instruments (e.g., lasers, cameras).\n//! - `log_panel`: Implements the UI for the filterable log view at the bottom of the screen.\n//! - `storage_manager`: Provides the UI for creating, managing, and saving data acquisition sessions.\n\npub mod storage_manager;\npub mod instrument_controls;\n\nuse self::storage_manager::StorageManager;\nuse self::instrument_controls::*;\nuse crate::{\n    app::DaqApp,\n    core::DataPoint,\n    log_capture::LogBuffer,\n};\nuse eframe::egui;\nuse egui_dock::{DockArea, DockState, Style, TabViewer};\nuse egui_plot::{Line, Plot, PlotPoints};\nuse log::{error, LevelFilter};\nuse std::collections::VecDeque;\nuse tokio::sync::broadcast;\n\nmod log_panel;\n\nconst PLOT_DATA_CAPACITY: usize = 1000;\n\n/// Represents the different types of tabs that can be docked\nenum DockTab {\n    Plot(PlotTab),\n    MaiTaiControl(MaiTaiControlPanel),\n    Newport1830CControl(Newport1830CControlPanel),\n    ElliptecControl(ElliptecControlPanel),\n    ESP300Control(ESP300ControlPanel),\n    PVCAMControl(PVCAMControlPanel),\n}\n\n/// Represents the state of a single plot panel.\nstruct PlotTab {\n    channel: String,\n    plot_data: VecDeque\u003c[f64; 2]\u003e,\n    last_timestamp: f64,\n}\n\nimpl PlotTab {\n    fn new(channel: String) -\u003e Self {\n        Self {\n            channel,\n            plot_data: VecDeque::with_capacity(PLOT_DATA_CAPACITY),\n            last_timestamp: 0.0,\n        }\n    }\n}\n\n/// The main GUI struct.\npub struct Gui {\n    app: DaqApp,\n    data_receiver: broadcast::Receiver\u003cDataPoint\u003e,\n    log_buffer: LogBuffer,\n    dock_state: DockState\u003cDockTab\u003e,\n    selected_channel: String,\n    storage_manager: StorageManager,\n    show_storage: bool,\n    // Log panel state\n    log_filter_text: String,\n    log_level_filter: LevelFilter,\n    scroll_to_bottom: bool,\n}\n\nimpl Gui {\n    /// Creates a new GUI.\n    pub fn new(_cc: \u0026eframe::CreationContext\u003c'_\u003e, app: DaqApp) -\u003e Self {\n        let (data_receiver, log_buffer) =\n            app.with_inner(|inner| (inner.data_sender.subscribe(), inner.log_buffer.clone()));\n\n        let mut dock_state = DockState::new(vec![\n            DockTab::Plot(PlotTab::new(\"sine_wave\".to_string()))\n        ]);\n        dock_state.push_to_focused_leaf(DockTab::Plot(PlotTab::new(\"cosine_wave\".to_string())));\n\n        Self {\n            app,\n            data_receiver,\n            log_buffer,\n            dock_state,\n            selected_channel: \"sine_wave\".to_string(),\n            storage_manager: StorageManager::new(),\n            show_storage: false,\n            log_filter_text: String::new(),\n            log_level_filter: LevelFilter::Info,\n            scroll_to_bottom: true,\n        }\n    }\n\n    /// Fetches new data points from the broadcast channel.\n    fn update_data(\u0026mut self) {\n        while let Ok(data_point) = self.data_receiver.try_recv() {\n            for (_location, tab) in self.dock_state.iter_all_tabs_mut() {\n                if let DockTab::Plot(plot_tab) = tab {\n                    if plot_tab.channel == data_point.channel {\n                        if plot_tab.plot_data.len() \u003e= PLOT_DATA_CAPACITY {\n                            plot_tab.plot_data.pop_front();\n                        }\n                        let timestamp = data_point.timestamp.timestamp_micros() as f64 / 1_000_000.0;\n                        if plot_tab.last_timestamp == 0.0 {\n                            plot_tab.last_timestamp = timestamp;\n                        }\n                        plot_tab.plot_data\n                            .push_back([timestamp - plot_tab.last_timestamp, data_point.value]);\n                    }\n                }\n            }\n        }\n    }\n}\n\nimpl eframe::App for Gui {\n    fn update(\u0026mut self, ctx: \u0026egui::Context, _frame: \u0026mut eframe::Frame) {\n        self.update_data();\n\n        egui::TopBottomPanel::bottom(\"bottom_panel\")\n            .resizable(true)\n            .min_height(150.0)\n            .show(ctx, |ui| {\n                log_panel::render(ui, self);\n            });\n\n        // Collect instrument data first\n        let (instruments, available_channels) = self.app.with_inner(|inner| {\n            let instruments: Vec\u003c(String, toml::Value, bool)\u003e = inner\n                .settings\n                .instruments\n                .iter()\n                .map(|(k, v)| (k.clone(), v.clone(), inner.instruments.contains_key(k)))\n                .collect();\n            (instruments, inner.get_available_channels())\n        });\n\n        egui::TopBottomPanel::top(\"top_panel\").show(ctx, |ui| {\n            ui.horizontal(|ui| {\n                ui.heading(\"Rust DAQ Control Panel\");\n                ui.separator();\n\n                egui::ComboBox::from_label(\"Channel\")\n                    .selected_text(self.selected_channel.clone())\n                    .show_ui(ui, |ui| {\n                        for channel in \u0026available_channels {\n                            ui.selectable_value(\n                                \u0026mut self.selected_channel,\n                                channel.clone(),\n                                channel.clone(),\n                            );\n                        }\n                    });\n\n                if ui.button(\"Add Plot\").clicked() {\n                    self.dock_state\n                        .push_to_focused_leaf(DockTab::Plot(PlotTab::new(self.selected_channel.clone())));\n                }\n\n                ui.separator();\n\n                // Instrument control buttons\n                egui::menu::menu_button(ui, \"Instrument Controls\", |ui| {\n                    if ui.button(\" MaiTai Laser\").clicked() {\n                        self.dock_state.push_to_focused_leaf(\n                            DockTab::MaiTaiControl(MaiTaiControlPanel::new(\"maitai\".to_string()))\n                        );\n                        ui.close_menu();\n                    }\n                    if ui.button(\" Newport 1830-C\").clicked() {\n                        self.dock_state.push_to_focused_leaf(\n                            DockTab::Newport1830CControl(Newport1830CControlPanel::new(\"newport_1830c\".to_string()))\n                        );\n                        ui.close_menu();\n                    }\n                    if ui.button(\" Elliptec Rotators\").clicked() {\n                        self.dock_state.push_to_focused_leaf(\n                            DockTab::ElliptecControl(ElliptecControlPanel::new(\"elliptec\".to_string(), vec![0, 1]))\n                        );\n                        ui.close_menu();\n                    }\n                    if ui.button(\" ESP300 Motion\").clicked() {\n                        self.dock_state.push_to_focused_leaf(\n                            DockTab::ESP300Control(ESP300ControlPanel::new(\"esp300\".to_string(), 3))\n                        );\n                        ui.close_menu();\n                    }\n                    if ui.button(\" PVCAM Camera\").clicked() {\n                        self.dock_state.push_to_focused_leaf(\n                            DockTab::PVCAMControl(PVCAMControlPanel::new(\"pvcam\".to_string()))\n                        );\n                        ui.close_menu();\n                    }\n                });\n\n                ui.separator();\n                if ui\n                    .button(if self.show_storage {\n                        \"Hide Storage\"\n                    } else {\n                        \"Show Storage\"\n                    })\n                    .clicked()\n                {\n                    self.show_storage = !self.show_storage;\n                }\n            });\n        });\n\n        if self.show_storage {\n            egui::SidePanel::right(\"storage_panel\")\n                .resizable(true)\n                .min_width(300.0)\n                .show(ctx, |ui| {\n                    self.storage_manager.ui(ui, \u0026self.app);\n                });\n        }\n\n        egui::SidePanel::left(\"control_panel\")\n            .resizable(true)\n            .min_width(200.0)\n            .show(ctx, |ui| {\n                render_instrument_panel(ui, \u0026instruments, \u0026self.app, \u0026mut self.dock_state);\n            });\n\n        let mut tab_viewer = DockTabViewer {\n            available_channels,\n            app: \u0026self.app,\n        };\n\n        egui::CentralPanel::default().show(ctx, |ui| {\n            // Check for dropped instruments\n            let (_inner_response, dropped_payload) = ui.dnd_drop_zone::\u003c(String, String, toml::Value), _\u003e(\n                egui::Frame::none(),\n                |ui| {\n                    DockArea::new(\u0026mut self.dock_state)\n                        .style(Style::from_egui(ctx.style().as_ref()))\n                        .show_inside(ui, \u0026mut tab_viewer);\n                },\n            );\n\n            // If something was dropped, open its controls\n            if let Some(payload) = dropped_payload {\n                let (inst_type, id, config) = payload.as_ref();\n                open_instrument_controls(inst_type, id, config, \u0026mut self.dock_state);\n            }\n        });\n\n        // Request a repaint to ensure the GUI is continuously updated\n        ctx.request_repaint();\n    }\n}\n\nfn render_instrument_panel(\n    ui: \u0026mut egui::Ui,\n    instruments: \u0026[(String, toml::Value, bool)],\n    app: \u0026DaqApp,\n    dock_state: \u0026mut DockState\u003cDockTab\u003e,\n) {\n    ui.heading(\"Instruments\");\n\n    egui::ScrollArea::vertical().show(ui, |ui| {\n        for (id, config, is_running) in instruments {\n            let inst_type = config.get(\"type\").and_then(|v| v.as_str()).unwrap_or(\"\");\n\n            // Make the entire group draggable by wrapping it in dnd_drag_source\n            let drag_id = egui::Id::new(format!(\"drag_{}\", id));\n            let drag_payload = (inst_type.to_string(), id.clone(), config.clone());\n\n            let response = ui.dnd_drag_source(drag_id, drag_payload, |ui| {\n                egui::Frame::group(ui.style())\n                    .show(ui, |ui| {\n                        ui.horizontal(|ui| {\n                            ui.strong(id);\n                            ui.with_layout(egui::Layout::right_to_left(egui::Align::Center), |ui| {\n                                if *is_running {\n                                    ui.colored_label(egui::Color32::GREEN, \" Running\");\n                                    if ui.button(\"Stop\").clicked() {\n                                        app.with_inner(|inner| inner.stop_instrument(id));\n                                    }\n                                } else {\n                                    ui.colored_label(egui::Color32::GRAY, \" Stopped\");\n                                    if ui.button(\"Start\").clicked() {\n                                        app.with_inner(|inner| {\n                                            if let Err(e) = inner.spawn_instrument(id) {\n                                                error!(\"Failed to start instrument '{}': {}\", id, e);\n                                            }\n                                        });\n                                    }\n                                }\n                            });\n                        });\n\n                    ui.separator();\n\n                    // Display instrument type\n                    ui.label(format!(\"Type: {}\", inst_type));\n\n                    // Display instrument name\n                    if let Some(name) = config.get(\"name\").and_then(|v| v.as_str()) {\n                        ui.label(format!(\"Name: {}\", name));\n                    }\n\n                    // Display specific parameters based on instrument type\n                    match inst_type {\n                        \"mock\" =\u003e {\n                            ui.separator();\n                            if let Some(rate) = config.get(\"sample_rate_hz\").and_then(|v| v.as_float()) {\n                                ui.label(format!(\"Sample Rate: {} Hz\", rate));\n                            }\n                            if let Some(channels) = config.get(\"channels\").and_then(|v| v.as_array()) {\n                                let channel_names: Vec\u003cString\u003e = channels\n                                    .iter()\n                                    .filter_map(|c| c.as_str().map(|s| s.to_string()))\n                                    .collect();\n                                ui.label(format!(\"Channels: {}\", channel_names.join(\", \")));\n                            }\n                        }\n                        \"scpi_keithley\" =\u003e {\n                            ui.separator();\n                            if let Some(addr) = config.get(\"address\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Address: {}\", addr));\n                            }\n                            if let Some(port) = config.get(\"port\").and_then(|v| v.as_integer()) {\n                                ui.label(format!(\"Port: {}\", port));\n                            }\n                        }\n                        \"maitai\" =\u003e {\n                            ui.separator();\n                            if let Some(wl) = config.get(\"wavelength\").and_then(|v| v.as_float()) {\n                                ui.label(format!(\"Wavelength: {:.1} nm\", wl));\n                            }\n                            if let Some(port) = config.get(\"port\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Port: {}\", port));\n                            }\n                            // TODO: Display real-time power and wavelength from data stream\n                            ui.label(\" Drag to main area or double-click\");\n                        }\n                        \"newport_1830c\" =\u003e {\n                            ui.separator();\n                            if let Some(wl) = config.get(\"wavelength\").and_then(|v| v.as_float()) {\n                                ui.label(format!(\"Wavelength: {:.1} nm\", wl));\n                            }\n                            if let Some(port) = config.get(\"port\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Port: {}\", port));\n                            }\n                            // TODO: Display real-time power reading\n                            ui.label(\" Drag to main area or double-click\");\n                        }\n                        \"elliptec\" =\u003e {\n                            ui.separator();\n                            if let Some(port) = config.get(\"port\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Port: {}\", port));\n                            }\n                            if let Some(addrs) = config.get(\"device_addresses\").and_then(|v| v.as_array()) {\n                                ui.label(format!(\"Devices: {}\", addrs.len()));\n                            }\n                            // TODO: Display positions\n                            ui.label(\" Drag to main area or double-click\");\n                        }\n                        \"esp300\" =\u003e {\n                            ui.separator();\n                            if let Some(port) = config.get(\"port\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Port: {}\", port));\n                            }\n                            let num_axes = config.get(\"num_axes\").and_then(|v| v.as_integer()).unwrap_or(3) as usize;\n                            ui.label(format!(\"Axes: {}\", num_axes));\n                            // TODO: Display positions\n                            ui.label(\" Drag to main area or double-click\");\n                        }\n                        \"pvcam\" =\u003e {\n                            ui.separator();\n                            if let Some(cam) = config.get(\"camera_name\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Camera: {}\", cam));\n                            }\n                            if let Some(exp) = config.get(\"exposure_ms\").and_then(|v| v.as_float()) {\n                                ui.label(format!(\"Exposure: {} ms\", exp));\n                            }\n                            // TODO: Display acquisition status\n                            ui.label(\" Drag to main area or double-click\");\n                        }\n                        _ if inst_type.contains(\"visa\") =\u003e {\n                            ui.separator();\n                            if let Some(resource) = config.get(\"resource_string\").and_then(|v| v.as_str()) {\n                                ui.label(format!(\"Resource: {}\", resource));\n                            }\n                        }\n                        _ =\u003e {}\n                    }\n\n                    ui.add_space(5.0);\n                })\n                .response\n            }).response;\n\n            // Visual feedback when dragging starts\n            if response.drag_started() {\n                ui.ctx().set_cursor_icon(egui::CursorIcon::Grabbing);\n            }\n\n            // Double-click to open controls\n            if response.double_clicked() {\n                open_instrument_controls(inst_type, id, config, dock_state);\n            }\n\n            ui.add_space(10.0);\n        }\n    });\n}\n\n// Helper function to open instrument controls\nfn open_instrument_controls(\n    inst_type: \u0026str,\n    id: \u0026str,\n    config: \u0026toml::Value,\n    dock_state: \u0026mut DockState\u003cDockTab\u003e,\n) {\n    match inst_type {\n        \"maitai\" =\u003e {\n            dock_state.push_to_focused_leaf(\n                DockTab::MaiTaiControl(MaiTaiControlPanel::new(id.to_string()))\n            );\n        }\n        \"newport_1830c\" =\u003e {\n            dock_state.push_to_focused_leaf(\n                DockTab::Newport1830CControl(Newport1830CControlPanel::new(id.to_string()))\n            );\n        }\n        \"elliptec\" =\u003e {\n            let device_addrs = if let Some(addrs) = config.get(\"device_addresses\").and_then(|v| v.as_array()) {\n                addrs.iter().filter_map(|a| a.as_integer().map(|i| i as u8)).collect()\n            } else {\n                vec![0, 1]\n            };\n            dock_state.push_to_focused_leaf(\n                DockTab::ElliptecControl(ElliptecControlPanel::new(id.to_string(), device_addrs))\n            );\n        }\n        \"esp300\" =\u003e {\n            let num_axes = config.get(\"num_axes\").and_then(|v| v.as_integer()).unwrap_or(3) as usize;\n            dock_state.push_to_focused_leaf(\n                DockTab::ESP300Control(ESP300ControlPanel::new(id.to_string(), num_axes))\n            );\n        }\n        \"pvcam\" =\u003e {\n            dock_state.push_to_focused_leaf(\n                DockTab::PVCAMControl(PVCAMControlPanel::new(id.to_string()))\n            );\n        }\n        _ =\u003e {}\n    }\n}\n\nstruct DockTabViewer\u003c'a\u003e {\n    available_channels: Vec\u003cString\u003e,\n    app: \u0026'a DaqApp,\n}\n\nimpl\u003c'a\u003e TabViewer for DockTabViewer\u003c'a\u003e {\n    type Tab = DockTab;\n\n    fn title(\u0026mut self, tab: \u0026mut Self::Tab) -\u003e egui::WidgetText {\n        match tab {\n            DockTab::Plot(plot_tab) =\u003e plot_tab.channel.clone().into(),\n            DockTab::MaiTaiControl(_) =\u003e \"MaiTai Laser\".into(),\n            DockTab::Newport1830CControl(_) =\u003e \"Newport 1830-C\".into(),\n            DockTab::ElliptecControl(_) =\u003e \"Elliptec Rotators\".into(),\n            DockTab::ESP300Control(_) =\u003e \"ESP300 Motion\".into(),\n            DockTab::PVCAMControl(_) =\u003e \"PVCAM Camera\".into(),\n        }\n    }\n\n    fn ui(\u0026mut self, ui: \u0026mut egui::Ui, tab: \u0026mut Self::Tab) {\n        match tab {\n            DockTab::Plot(plot_tab) =\u003e {\n                egui::ComboBox::from_label(\"Channel\")\n                    .selected_text(plot_tab.channel.clone())\n                    .show_ui(ui, |ui| {\n                        for channel in \u0026self.available_channels {\n                            ui.selectable_value(\u0026mut plot_tab.channel, channel.clone(), channel.clone());\n                        }\n                    });\n\n                live_plot(ui, \u0026plot_tab.plot_data, \u0026plot_tab.channel);\n            }\n            DockTab::MaiTaiControl(panel) =\u003e {\n                panel.ui(ui, self.app);\n            }\n            DockTab::Newport1830CControl(panel) =\u003e {\n                panel.ui(ui, self.app);\n            }\n            DockTab::ElliptecControl(panel) =\u003e {\n                panel.ui(ui, self.app);\n            }\n            DockTab::ESP300Control(panel) =\u003e {\n                panel.ui(ui, self.app);\n            }\n            DockTab::PVCAMControl(panel) =\u003e {\n                panel.ui(ui, self.app);\n            }\n        }\n    }\n}\n\nfn live_plot(ui: \u0026mut egui::Ui, data: \u0026VecDeque\u003c[f64; 2]\u003e, channel: \u0026str) {\n    ui.heading(format!(\"Live Data ({})\", channel));\n    let line = Line::new(PlotPoints::from_iter(data.iter().copied()));\n    Plot::new(channel).view_aspect(2.0).show(ui, |plot_ui| {\n        plot_ui.line(line);\n    });\n}\n","traces":[{"line":82,"address":[35401630,35401456],"length":1,"stats":{"Line":0}},{"line":85,"address":[32417390],"length":1,"stats":{"Line":0}},{"line":108,"address":[32845030,32843408,32844890],"length":1,"stats":{"Line":0}},{"line":109,"address":[35401678],"length":1,"stats":{"Line":0}},{"line":112,"address":[36662449,36663679,36662344,36662402,36662552],"length":1,"stats":{"Line":0}},{"line":113,"address":[32417806,32417897],"length":1,"stats":{"Line":0}},{"line":115,"address":[36662780,36662868],"length":1,"stats":{"Line":0}},{"line":122,"address":[32844435],"length":1,"stats":{"Line":0}},{"line":123,"address":[32418654],"length":1,"stats":{"Line":0}},{"line":125,"address":[35402818],"length":1,"stats":{"Line":0}},{"line":132,"address":[36663760,36664527,36664521],"length":1,"stats":{"Line":0}},{"line":133,"address":[32419306,32419241],"length":1,"stats":{"Line":0}},{"line":134,"address":[32483819,32483882],"length":1,"stats":{"Line":0}},{"line":135,"address":[35403802,35403726],"length":1,"stats":{"Line":0}},{"line":136,"address":[32419731],"length":1,"stats":{"Line":0}},{"line":137,"address":[36664286],"length":1,"stats":{"Line":0}},{"line":138,"address":[36664344],"length":1,"stats":{"Line":0}},{"line":140,"address":[35403889,35403953],"length":1,"stats":{"Line":0}},{"line":141,"address":[35404096,35403984],"length":1,"stats":{"Line":0}},{"line":142,"address":[32419995],"length":1,"stats":{"Line":0}},{"line":144,"address":[32845858,32845772],"length":1,"stats":{"Line":0}},{"line":145,"address":[35404019],"length":1,"stats":{"Line":0}},{"line":154,"address":[32420032,32421261,32421217],"length":1,"stats":{"Line":0}},{"line":155,"address":[36664585],"length":1,"stats":{"Line":0}},{"line":157,"address":[35404182],"length":1,"stats":{"Line":0}},{"line":160,"address":[41091264],"length":1,"stats":{"Line":0}},{"line":161,"address":[38166713],"length":1,"stats":{"Line":0}},{"line":165,"address":[36664736],"length":1,"stats":{"Line":0}},{"line":166,"address":[38102358],"length":1,"stats":{"Line":0}},{"line":169,"address":[38528237],"length":1,"stats":{"Line":0}},{"line":170,"address":[41091706,41091402,41091648],"length":1,"stats":{"Line":0}},{"line":171,"address":[38166857],"length":1,"stats":{"Line":0}},{"line":172,"address":[38102460],"length":1,"stats":{"Line":0}},{"line":175,"address":[31306736],"length":1,"stats":{"Line":0}},{"line":176,"address":[38528866,38528944,38529914],"length":1,"stats":{"Line":0}},{"line":177,"address":[41092105],"length":1,"stats":{"Line":0}},{"line":178,"address":[38103189],"length":1,"stats":{"Line":0}},{"line":180,"address":[38103319,38103206],"length":1,"stats":{"Line":0}},{"line":181,"address":[38529183,38529933,38529104],"length":1,"stats":{"Line":0}},{"line":182,"address":[31307840,31307120,31308142,31308174],"length":1,"stats":{"Line":0}},{"line":183,"address":[38529993,38530017],"length":1,"stats":{"Line":0}},{"line":184,"address":[38104339],"length":1,"stats":{"Line":0}},{"line":186,"address":[41093214],"length":1,"stats":{"Line":0}},{"line":187,"address":[38530124],"length":1,"stats":{"Line":0}},{"line":192,"address":[38529293],"length":1,"stats":{"Line":0}},{"line":193,"address":[31307315],"length":1,"stats":{"Line":0}},{"line":194,"address":[38529443],"length":1,"stats":{"Line":0}},{"line":197,"address":[41092697],"length":1,"stats":{"Line":0}},{"line":200,"address":[38105982,38103742,38104448,38105988],"length":1,"stats":{"Line":0}},{"line":201,"address":[31308225],"length":1,"stats":{"Line":0}},{"line":202,"address":[41093707],"length":1,"stats":{"Line":0}},{"line":203,"address":[38104614],"length":1,"stats":{"Line":0}},{"line":205,"address":[41093726],"length":1,"stats":{"Line":0}},{"line":207,"address":[38169161],"length":1,"stats":{"Line":0}},{"line":208,"address":[38169399],"length":1,"stats":{"Line":0}},{"line":209,"address":[41093874],"length":1,"stats":{"Line":0}},{"line":211,"address":[38169418],"length":1,"stats":{"Line":0}},{"line":213,"address":[38530869],"length":1,"stats":{"Line":0}},{"line":214,"address":[31309219],"length":1,"stats":{"Line":0}},{"line":215,"address":[38531857,38531123,38531006],"length":1,"stats":{"Line":0}},{"line":217,"address":[38531358],"length":1,"stats":{"Line":0}},{"line":219,"address":[38169630,38169929],"length":1,"stats":{"Line":0}},{"line":220,"address":[38105681],"length":1,"stats":{"Line":0}},{"line":221,"address":[41094589],"length":1,"stats":{"Line":0}},{"line":223,"address":[38531556],"length":1,"stats":{"Line":0}},{"line":225,"address":[31309444],"length":1,"stats":{"Line":0}},{"line":226,"address":[41094941],"length":1,"stats":{"Line":0}},{"line":227,"address":[41094840],"length":1,"stats":{"Line":0}},{"line":229,"address":[38105968],"length":1,"stats":{"Line":0}},{"line":233,"address":[31307524],"length":1,"stats":{"Line":0}},{"line":234,"address":[38103991,38103892],"length":1,"stats":{"Line":0}},{"line":235,"address":[38529678,38529714,38529764],"length":1,"stats":{"Line":0}},{"line":236,"address":[41092852],"length":1,"stats":{"Line":0}},{"line":238,"address":[38103831],"length":1,"stats":{"Line":0}},{"line":240,"address":[31307731,31307669],"length":1,"stats":{"Line":0}},{"line":242,"address":[38104032],"length":1,"stats":{"Line":0}},{"line":247,"address":[32484941],"length":1,"stats":{"Line":0}},{"line":248,"address":[32484984],"length":1,"stats":{"Line":0}},{"line":251,"address":[41095024],"length":1,"stats":{"Line":0}},{"line":252,"address":[31309803],"length":1,"stats":{"Line":0}},{"line":256,"address":[32420534],"length":1,"stats":{"Line":0}},{"line":259,"address":[32485219],"length":1,"stats":{"Line":0}},{"line":260,"address":[38106114],"length":1,"stats":{"Line":0}},{"line":265,"address":[35405040],"length":1,"stats":{"Line":0}},{"line":268,"address":[35405094,35405155],"length":1,"stats":{"Line":0}},{"line":270,"address":[38532108,38532041],"length":1,"stats":{"Line":0}},{"line":271,"address":[31309921],"length":1,"stats":{"Line":0}},{"line":272,"address":[38171589,38170633,38171200],"length":1,"stats":{"Line":0}},{"line":273,"address":[38171429,38171225],"length":1,"stats":{"Line":0}},{"line":274,"address":[38532877,38532706,38533010],"length":1,"stats":{"Line":0}},{"line":275,"address":[38107071],"length":1,"stats":{"Line":0}},{"line":280,"address":[38106329],"length":1,"stats":{"Line":0}},{"line":281,"address":[38170800,38170900],"length":1,"stats":{"Line":0}},{"line":282,"address":[31310251],"length":1,"stats":{"Line":0}},{"line":287,"address":[32485566],"length":1,"stats":{"Line":0}},{"line":291,"address":[36665744],"length":1,"stats":{"Line":0}},{"line":297,"address":[36665805],"length":1,"stats":{"Line":0}},{"line":299,"address":[32485791],"length":1,"stats":{"Line":0}},{"line":300,"address":[38533081],"length":1,"stats":{"Line":0}},{"line":301,"address":[38107371,38108416,38108425],"length":1,"stats":{"Line":0}},{"line":304,"address":[38107442],"length":1,"stats":{"Line":0}},{"line":305,"address":[38107600,38107675],"length":1,"stats":{"Line":0}},{"line":307,"address":[38533757,38534304],"length":1,"stats":{"Line":0}},{"line":308,"address":[38108621,38108490],"length":1,"stats":{"Line":0}},{"line":309,"address":[38173072,38178943,38172946],"length":1,"stats":{"Line":0}},{"line":310,"address":[41103552,41097688],"length":1,"stats":{"Line":0}},{"line":311,"address":[38114585],"length":1,"stats":{"Line":0}},{"line":312,"address":[38179045,38179248,38179676],"length":1,"stats":{"Line":0}},{"line":313,"address":[31318473],"length":1,"stats":{"Line":0}},{"line":314,"address":[38540874],"length":1,"stats":{"Line":0}},{"line":315,"address":[38115099,38115279],"length":1,"stats":{"Line":0}},{"line":316,"address":[38179826,38179808,38179781],"length":1,"stats":{"Line":0}},{"line":319,"address":[38179290],"length":1,"stats":{"Line":0}},{"line":320,"address":[31318572,31318760],"length":1,"stats":{"Line":0}},{"line":321,"address":[38180372,38179654,38179856,38180366],"length":1,"stats":{"Line":0}},{"line":322,"address":[31319089],"length":1,"stats":{"Line":0}},{"line":323,"address":[38115538,38115646,38115627],"length":1,"stats":{"Line":0}},{"line":331,"address":[38173182],"length":1,"stats":{"Line":0}},{"line":334,"address":[31312461],"length":1,"stats":{"Line":0}},{"line":337,"address":[38173382,38180409,38180400],"length":1,"stats":{"Line":0}},{"line":338,"address":[38534936],"length":1,"stats":{"Line":0}},{"line":343,"address":[38173668],"length":1,"stats":{"Line":0}},{"line":344,"address":[41098324],"length":1,"stats":{"Line":0}},{"line":345,"address":[38535220,38541872,38539667,38541881],"length":1,"stats":{"Line":0}},{"line":346,"address":[38178245],"length":1,"stats":{"Line":0}},{"line":348,"address":[31319657,31317633,31319648],"length":1,"stats":{"Line":0}},{"line":349,"address":[41103083],"length":1,"stats":{"Line":0}},{"line":350,"address":[38178522],"length":1,"stats":{"Line":0}},{"line":351,"address":[31319680,31319744,31319766,31319715,31317747],"length":1,"stats":{"Line":0}},{"line":352,"address":[38178549],"length":1,"stats":{"Line":0}},{"line":353,"address":[38178651,38178576],"length":1,"stats":{"Line":0}},{"line":356,"address":[38173705],"length":1,"stats":{"Line":0}},{"line":357,"address":[41098475],"length":1,"stats":{"Line":0}},{"line":358,"address":[38542073,38535371,38539210,38542064],"length":1,"stats":{"Line":0}},{"line":359,"address":[38177802],"length":1,"stats":{"Line":0}},{"line":361,"address":[38177974,38180656,38180665],"length":1,"stats":{"Line":0}},{"line":362,"address":[31317271],"length":1,"stats":{"Line":0}},{"line":365,"address":[38109440],"length":1,"stats":{"Line":0}},{"line":366,"address":[38109650],"length":1,"stats":{"Line":0}},{"line":367,"address":[31313339,31316444,31319856,31319865],"length":1,"stats":{"Line":0}},{"line":368,"address":[38177242],"length":1,"stats":{"Line":0}},{"line":370,"address":[41102015,41105296,41105305],"length":1,"stats":{"Line":0}},{"line":371,"address":[41102129],"length":1,"stats":{"Line":0}},{"line":374,"address":[38177725],"length":1,"stats":{"Line":0}},{"line":376,"address":[38535463],"length":1,"stats":{"Line":0}},{"line":377,"address":[38109801],"length":1,"stats":{"Line":0}},{"line":378,"address":[38116345,38116336,38112262,38109833],"length":1,"stats":{"Line":0}},{"line":379,"address":[38176696],"length":1,"stats":{"Line":0}},{"line":381,"address":[38180793,38176893,38180784],"length":1,"stats":{"Line":0}},{"line":382,"address":[38112591],"length":1,"stats":{"Line":0}},{"line":385,"address":[38177179],"length":1,"stats":{"Line":0}},{"line":387,"address":[38109758],"length":1,"stats":{"Line":0}},{"line":388,"address":[38535808],"length":1,"stats":{"Line":0}},{"line":389,"address":[38535840,38537593,38542256,38542265],"length":1,"stats":{"Line":0}},{"line":390,"address":[41100761],"length":1,"stats":{"Line":0}},{"line":392,"address":[38542288,38537797,38542297],"length":1,"stats":{"Line":0}},{"line":393,"address":[38537887],"length":1,"stats":{"Line":0}},{"line":396,"address":[38538073],"length":1,"stats":{"Line":0}},{"line":398,"address":[38109909],"length":1,"stats":{"Line":0}},{"line":399,"address":[38535975],"length":1,"stats":{"Line":0}},{"line":400,"address":[41099143,41105465,41100252,41105456],"length":1,"stats":{"Line":0}},{"line":401,"address":[38111292],"length":1,"stats":{"Line":0}},{"line":403,"address":[38537320,38542361,38542352],"length":1,"stats":{"Line":0}},{"line":404,"address":[31315161],"length":1,"stats":{"Line":0}},{"line":406,"address":[41100684],"length":1,"stats":{"Line":0}},{"line":408,"address":[38110076],"length":1,"stats":{"Line":0}},{"line":409,"address":[38536143],"length":1,"stats":{"Line":0}},{"line":410,"address":[31320121,31320112,31314400,31313968],"length":1,"stats":{"Line":0}},{"line":411,"address":[38110787],"length":1,"stats":{"Line":0}},{"line":413,"address":[41105561,41105552,41099951],"length":1,"stats":{"Line":0}},{"line":414,"address":[41100035],"length":1,"stats":{"Line":0}},{"line":417,"address":[38175631],"length":1,"stats":{"Line":0}},{"line":419,"address":[41099235],"length":1,"stats":{"Line":0}},{"line":420,"address":[38536293],"length":1,"stats":{"Line":0}},{"line":421,"address":[38181017,38174885,38181008],"length":1,"stats":{"Line":0}},{"line":422,"address":[31314228],"length":1,"stats":{"Line":0}},{"line":428,"address":[38536267],"length":1,"stats":{"Line":0}},{"line":431,"address":[41097633,41097108],"length":1,"stats":{"Line":0}},{"line":434,"address":[31311845],"length":1,"stats":{"Line":0}},{"line":435,"address":[38108224],"length":1,"stats":{"Line":0}},{"line":439,"address":[31311874,31311929],"length":1,"stats":{"Line":0}},{"line":440,"address":[31311955],"length":1,"stats":{"Line":0}},{"line":443,"address":[41097274],"length":1,"stats":{"Line":0}},{"line":449,"address":[32422781,32421472,32422813],"length":1,"stats":{"Line":0}},{"line":455,"address":[32485973],"length":1,"stats":{"Line":0}},{"line":456,"address":[36666029],"length":1,"stats":{"Line":0}},{"line":457,"address":[32486132],"length":1,"stats":{"Line":0}},{"line":458,"address":[35405729],"length":1,"stats":{"Line":0}},{"line":461,"address":[32486012],"length":1,"stats":{"Line":0}},{"line":462,"address":[32421868],"length":1,"stats":{"Line":0}},{"line":463,"address":[35405875],"length":1,"stats":{"Line":0}},{"line":466,"address":[35405838],"length":1,"stats":{"Line":0}},{"line":467,"address":[41105625,41105616],"length":1,"stats":{"Line":0}},{"line":468,"address":[36666789],"length":1,"stats":{"Line":0}},{"line":470,"address":[35406597,35406490,35406561],"length":1,"stats":{"Line":0}},{"line":472,"address":[35406845],"length":1,"stats":{"Line":0}},{"line":473,"address":[32486857,32486971],"length":1,"stats":{"Line":0}},{"line":476,"address":[32847753],"length":1,"stats":{"Line":0}},{"line":477,"address":[32422045],"length":1,"stats":{"Line":0}},{"line":478,"address":[32422184],"length":1,"stats":{"Line":0}},{"line":479,"address":[35406208],"length":1,"stats":{"Line":0}},{"line":482,"address":[32847866],"length":1,"stats":{"Line":0}},{"line":483,"address":[35406401],"length":1,"stats":{"Line":0}},{"line":484,"address":[36666670],"length":1,"stats":{"Line":0}},{"line":499,"address":[32422832],"length":1,"stats":{"Line":0}},{"line":500,"address":[36667293],"length":1,"stats":{"Line":0}},{"line":501,"address":[32848781],"length":1,"stats":{"Line":0}},{"line":502,"address":[36667417],"length":1,"stats":{"Line":0}},{"line":503,"address":[32848873],"length":1,"stats":{"Line":0}},{"line":504,"address":[35407145],"length":1,"stats":{"Line":0}},{"line":505,"address":[32423081],"length":1,"stats":{"Line":0}},{"line":506,"address":[32423113],"length":1,"stats":{"Line":0}},{"line":510,"address":[32849008,32849647,32849615],"length":1,"stats":{"Line":0}},{"line":511,"address":[32849054],"length":1,"stats":{"Line":0}},{"line":512,"address":[35407366],"length":1,"stats":{"Line":0}},{"line":513,"address":[32423605,32423287],"length":1,"stats":{"Line":0}},{"line":514,"address":[35407868,35407425,35407660,35407709],"length":1,"stats":{"Line":0}},{"line":515,"address":[32849527],"length":1,"stats":{"Line":0}},{"line":516,"address":[38116809,38116833],"length":1,"stats":{"Line":0}},{"line":517,"address":[38181310,38181383,38181504],"length":1,"stats":{"Line":0}},{"line":521,"address":[32488122],"length":1,"stats":{"Line":0}},{"line":523,"address":[35407469],"length":1,"stats":{"Line":0}},{"line":524,"address":[32423385],"length":1,"stats":{"Line":0}},{"line":526,"address":[32423415],"length":1,"stats":{"Line":0}},{"line":527,"address":[32487843],"length":1,"stats":{"Line":0}},{"line":529,"address":[32487873],"length":1,"stats":{"Line":0}},{"line":530,"address":[32849325],"length":1,"stats":{"Line":0}},{"line":532,"address":[32423499],"length":1,"stats":{"Line":0}},{"line":533,"address":[32423507],"length":1,"stats":{"Line":0}},{"line":535,"address":[36667965],"length":1,"stats":{"Line":0}},{"line":536,"address":[32487965],"length":1,"stats":{"Line":0}},{"line":542,"address":[32488848,32488880,32488224],"length":1,"stats":{"Line":0}},{"line":543,"address":[35407947],"length":1,"stats":{"Line":0}},{"line":544,"address":[32849886],"length":1,"stats":{"Line":0}},{"line":545,"address":[32488552,32488646],"length":1,"stats":{"Line":0}},{"line":546,"address":[38117146],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":236},{"path":["/","app","src","gui","storage_manager.rs"],"content":"//! The storage manager panel for the GUI.\n//!\n//! This module provides a `StorageManager` struct and its implementation, which creates\n//! a UI panel for managing data files saved by the application. This panel can be\n//! displayed as a side panel in the main GUI.\n//!\n//! ## Features\n//!\n//! - **File Listing:** Displays a list of files from the configured storage directory.\n//!   The list includes file name, size, and last modified timestamp.\n//! - **Search/Filter:** A search box allows users to filter the list of files by name.\n//! - **File Actions:**\n//!   - **Open:** Opens the selected file using the system's default application (`opener` crate).\n//!   - **Delete:** Deletes the selected file with a confirmation dialog.\n//! - **File Preview:** When a file is selected, a preview panel shows its contents or metadata.\n//!   - Supports CSV, HDF5, and Arrow file formats (HDF5 and Arrow previews are\n//!     conditional on feature flags).\n//!   - For CSV, it displays the first few rows in a table.\n//!   - For HDF5, it lists the datasets in the root group.\n//!   - For Arrow, it displays the file's schema.\n//! - **Storage Statistics:** Shows basic statistics like the total number of files and\n//!   their combined size.\n//! - **Refresh:** A manual refresh button to reload the file list from the disk.\n//!\n//! The `StorageManager` is integrated into the main `Gui` and is rendered when toggled\n//! by the user.\n\nuse crate::app::DaqApp;\n#[cfg(feature = \"storage_arrow\")]\nuse arrow2::io::ipc::read;\nuse csv;\nuse eframe::egui;\nuse egui_extras::{Column, TableBuilder};\n#[cfg(feature = \"storage_hdf5\")]\nuse hdf5;\nuse log::{error, warn};\nuse opener;\nuse std::fs;\nuse std::path::PathBuf;\n\n#[derive(Clone)]\nstruct FileInfo {\n    path: PathBuf,\n    name: String,\n    size: u64,\n    modified: std::time::SystemTime,\n}\n\npub struct StorageManager {\n    files: Vec\u003cFileInfo\u003e,\n    search_query: String,\n    storage_path: PathBuf,\n    file_to_delete: Option\u003cFileInfo\u003e,\n    needs_refresh: bool,\n    selected_file: Option\u003cFileInfo\u003e,\n}\n\nimpl Default for StorageManager {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl StorageManager {\n    pub fn new() -\u003e Self {\n        Self {\n            files: Vec::new(),\n            search_query: String::new(),\n            storage_path: PathBuf::new(),\n            file_to_delete: None,\n            needs_refresh: false,\n            selected_file: None,\n        }\n    }\n\n    fn refresh_files(\u0026mut self) {\n        self.files.clear();\n        let entries = match fs::read_dir(\u0026self.storage_path) {\n            Ok(entries) =\u003e entries,\n            Err(e) =\u003e {\n                error!(\n                    \"Failed to read storage directory '{}': {}\",\n                    self.storage_path.display(),\n                    e\n                );\n                return;\n            }\n        };\n\n        for entry in entries {\n            let entry = match entry {\n                Ok(entry) =\u003e entry,\n                Err(e) =\u003e {\n                    warn!(\"Failed to read directory entry: {}\", e);\n                    continue;\n                }\n            };\n\n            let path = entry.path();\n            if path.is_file() {\n                let metadata = match entry.metadata() {\n                    Ok(meta) =\u003e meta,\n                    Err(e) =\u003e {\n                        warn!(\"Failed to get metadata for '{}': {}\", path.display(), e);\n                        continue;\n                    }\n                };\n\n                self.files.push(FileInfo {\n                    name: path.file_name().unwrap().to_string_lossy().to_string(),\n                    size: metadata.len(),\n                    modified: metadata.modified().unwrap(),\n                    path,\n                });\n            }\n        }\n    }\n\n    fn storage_stats_ui(\u0026self, ui: \u0026mut egui::Ui) {\n        let total_size: u64 = self.files.iter().map(|f| f.size).sum();\n        let num_files = self.files.len();\n\n        let mut largest_files = self.files.clone();\n        largest_files.sort_by(|a, b| b.size.cmp(\u0026a.size));\n        largest_files.truncate(5);\n\n        ui.group(|ui| {\n            ui.heading(\"Storage Statistics\");\n            ui.label(format!(\"Total files: {}\", num_files));\n            ui.label(format!(\"Total size: {} bytes\", total_size));\n            ui.separator();\n            ui.label(\"Largest files:\");\n            for file in largest_files {\n                ui.label(format!(\"- {} ({} bytes)\", file.name, file.size));\n            }\n        });\n    }\n\n    pub fn ui(\u0026mut self, ui: \u0026mut egui::Ui, app: \u0026DaqApp) {\n        let storage_path =\n            PathBuf::from(\u0026app.with_inner(|inner| inner.settings.storage.default_path.clone()));\n        if self.storage_path != storage_path {\n            self.storage_path = storage_path;\n            self.refresh_files();\n        }\n\n        ui.heading(\"Storage Manager\");\n\n        self.storage_stats_ui(ui);\n\n        ui.horizontal(|ui| {\n            ui.label(\"Search:\");\n            ui.text_edit_singleline(\u0026mut self.search_query);\n            if ui.button(\"Refresh\").clicked() {\n                self.refresh_files();\n            }\n        });\n\n        ui.separator();\n\n        let table = TableBuilder::new(ui)\n            .striped(true)\n            .resizable(true)\n            .cell_layout(egui::Layout::left_to_right(egui::Align::Center))\n            .column(Column::auto())\n            .column(Column::auto())\n            .column(Column::auto())\n            .column(Column::auto())\n            .min_scrolled_height(0.0);\n\n        table\n            .header(20.0, |mut header| {\n                header.col(|ui| {\n                    ui.strong(\"Filename\");\n                });\n                header.col(|ui| {\n                    ui.strong(\"Size\");\n                });\n                header.col(|ui| {\n                    ui.strong(\"Modified\");\n                });\n                header.col(|ui| {\n                    ui.strong(\"Actions\");\n                });\n            })\n            .body(|mut body| {\n                let files: Vec\u003c_\u003e = self\n                    .files\n                    .iter()\n                    .filter(|f| f.name.contains(\u0026self.search_query))\n                    .cloned()\n                    .collect();\n                for file in \u0026files {\n                    body.row(30.0, |mut row| {\n                        row.col(|ui| {\n                            if ui\n                                .selectable_label(\n                                    self.selected_file\n                                        .as_ref()\n                                        .is_some_and(|f| f.path == file.path),\n                                    \u0026file.name,\n                                )\n                                .clicked()\n                            {\n                                self.selected_file = Some(file.clone());\n                            }\n                        });\n                        row.col(|ui| {\n                            ui.label(format!(\"{} bytes\", file.size));\n                        });\n                        row.col(|ui| {\n                            let datetime: chrono::DateTime\u003cchrono::Local\u003e = file.modified.into();\n                            ui.label(datetime.format(\"%Y-%m-%d %H:%M:%S\").to_string());\n                        });\n                        row.col(|ui| {\n                            ui.horizontal(|ui| {\n                                if ui.button(\"Open\").clicked() {\n                                    if let Err(e) = opener::open(\u0026file.path) {\n                                        error!(\n                                            \"Failed to open file '{}': {}\",\n                                            file.path.display(),\n                                            e\n                                        );\n                                    }\n                                }\n                                if ui.button(\"Delete\").clicked() {\n                                    self.file_to_delete = Some(file.clone());\n                                }\n                            });\n                        });\n                    });\n                }\n            });\n\n        if let Some(file_to_delete) = \u0026self.file_to_delete.clone() {\n            let mut open = true;\n            egui::Window::new(\"Confirm Deletion\")\n                .collapsible(false)\n                .resizable(false)\n                .open(\u0026mut open)\n                .show(ui.ctx(), |ui| {\n                    ui.label(format!(\n                        \"Are you sure you want to delete '{}'?\",\n                        file_to_delete.name\n                    ));\n                    ui.horizontal(|ui| {\n                        if ui.button(\"Cancel\").clicked() {\n                            self.file_to_delete = None;\n                        }\n                        if ui.button(\"Delete\").clicked() {\n                            if let Err(e) = fs::remove_file(\u0026file_to_delete.path) {\n                                error!(\n                                    \"Failed to delete file '{}': {}\",\n                                    file_to_delete.path.display(),\n                                    e\n                                );\n                            } else {\n                                self.needs_refresh = true;\n                            }\n                            self.file_to_delete = None;\n                        }\n                    });\n                });\n            if !open {\n                self.file_to_delete = None;\n            }\n        }\n\n        if self.needs_refresh {\n            self.refresh_files();\n            self.needs_refresh = false;\n        }\n\n        ui.separator();\n\n        if let Some(selected_file) = \u0026self.selected_file {\n            ui.group(|ui| {\n                ui.heading(\"Preview\");\n                ui.label(format!(\"File: {}\", selected_file.name));\n                ui.separator();\n                self.file_preview(ui, selected_file);\n            });\n        }\n    }\n\n    fn file_preview(\u0026self, ui: \u0026mut egui::Ui, file: \u0026FileInfo) {\n        let extension = file.path.extension().and_then(|s| s.to_str());\n        match extension {\n            Some(\"csv\") =\u003e self.csv_preview(ui, file),\n            #[cfg(feature = \"storage_hdf5\")]\n            Some(\"h5\") | Some(\"hdf5\") =\u003e self.hdf5_preview(ui, file),\n            #[cfg(feature = \"storage_arrow\")]\n            Some(\"arrow\") =\u003e self.arrow_preview(ui, file),\n            _ =\u003e {\n                ui.label(\"Preview not available for this file type.\");\n            }\n        }\n    }\n\n    #[cfg(feature = \"storage_hdf5\")]\n    fn hdf5_preview(\u0026self, ui: \u0026mut egui::Ui, file: \u0026FileInfo) {\n        match hdf5::File::open(\u0026file.path) {\n            Ok(f) =\u003e {\n                ui.label(\"HDF5 File Structure:\");\n                f.group(\"/\")\n                    .unwrap()\n                    .member_names()\n                    .unwrap()\n                    .iter()\n                    .for_each(|name| {\n                        ui.label(format!(\"- {}\", name));\n                    });\n            }\n            Err(e) =\u003e {\n                error!(\"Failed to read HDF5 file '{}': {}\", file.path.display(), e);\n                ui.label(\"Error reading HDF5 file.\");\n            }\n        }\n    }\n\n    #[cfg(feature = \"storage_arrow\")]\n    fn arrow_preview(\u0026self, ui: \u0026mut egui::Ui, file: \u0026FileInfo) {\n        let mut reader = match std::fs::File::open(\u0026file.path) {\n            Ok(f) =\u003e f,\n            Err(e) =\u003e {\n                error!(\"Failed to open Arrow file '{}': {}\", file.path.display(), e);\n                ui.label(\"Error opening Arrow file.\");\n                return;\n            }\n        };\n        match read::read_file_metadata(\u0026mut reader) {\n            Ok(metadata) =\u003e {\n                ui.label(\"Arrow File Schema:\");\n                for field in metadata.schema.fields {\n                    ui.label(format!(\"- {}: {:?}\", field.name, field.data_type));\n                }\n            }\n            Err(e) =\u003e {\n                error!(\n                    \"Failed to read Arrow metadata from '{}': {}\",\n                    file.path.display(),\n                    e\n                );\n                ui.label(\"Error reading Arrow file metadata.\");\n            }\n        }\n    }\n\n    fn csv_preview(\u0026self, ui: \u0026mut egui::Ui, file: \u0026FileInfo) {\n        let mut reader = match csv::Reader::from_path(\u0026file.path) {\n            Ok(reader) =\u003e reader,\n            Err(e) =\u003e {\n                error!(\"Failed to read CSV file '{}': {}\", file.path.display(), e);\n                ui.label(\"Error reading CSV file.\");\n                return;\n            }\n        };\n\n        let headers = match reader.headers() {\n            Ok(headers) =\u003e headers.clone(),\n            Err(e) =\u003e {\n                error!(\n                    \"Failed to read CSV headers for '{}': {}\",\n                    file.path.display(),\n                    e\n                );\n                ui.label(\"Error reading CSV headers.\");\n                return;\n            }\n        };\n\n        TableBuilder::new(ui)\n            .striped(true)\n            .resizable(true)\n            .header(20.0, |mut header_row| {\n                for header in headers.iter() {\n                    header_row.col(|ui| {\n                        ui.strong(header);\n                    });\n                }\n            })\n            .body(|mut body| {\n                for (i, result) in reader.records().enumerate() {\n                    if i \u003e= 10 {\n                        break;\n                    }\n                    let record = match result {\n                        Ok(record) =\u003e record,\n                        Err(e) =\u003e {\n                            warn!(\"Error reading CSV record: {}\", e);\n                            continue;\n                        }\n                    };\n                    body.row(20.0, |mut row| {\n                        for field in record.iter() {\n                            row.col(|ui| {\n                                ui.label(field);\n                            });\n                        }\n                    });\n                }\n            });\n    }\n}\n","traces":[{"line":59,"address":[41882000],"length":1,"stats":{"Line":0}},{"line":60,"address":[38962328],"length":1,"stats":{"Line":0}},{"line":65,"address":[38962676,38962352,38962670],"length":1,"stats":{"Line":0}},{"line":67,"address":[41882048],"length":1,"stats":{"Line":0}},{"line":68,"address":[38897971],"length":1,"stats":{"Line":0}},{"line":69,"address":[29422144],"length":1,"stats":{"Line":0}},{"line":76,"address":[38965340,38964416,38962704],"length":1,"stats":{"Line":0}},{"line":77,"address":[29422423],"length":1,"stats":{"Line":0}},{"line":78,"address":[29422452],"length":1,"stats":{"Line":0}},{"line":79,"address":[29422560],"length":1,"stats":{"Line":0}},{"line":80,"address":[29422496],"length":1,"stats":{"Line":0}},{"line":81,"address":[41885133,41882498,41885100,41885289],"length":1,"stats":{"Line":0}},{"line":90,"address":[39324359,39324550,39324465],"length":1,"stats":{"Line":0}},{"line":91,"address":[39324594],"length":1,"stats":{"Line":0}},{"line":92,"address":[38963286],"length":1,"stats":{"Line":0}},{"line":93,"address":[29422912],"length":1,"stats":{"Line":0}},{"line":94,"address":[41882918,41884726,41884754],"length":1,"stats":{"Line":0}},{"line":99,"address":[29423143,29423072],"length":1,"stats":{"Line":0}},{"line":100,"address":[38963469,38963546],"length":1,"stats":{"Line":0}},{"line":101,"address":[38899180],"length":1,"stats":{"Line":0}},{"line":102,"address":[41883447],"length":1,"stats":{"Line":0}},{"line":103,"address":[41883331],"length":1,"stats":{"Line":0}},{"line":104,"address":[38900085,38900057,38899251],"length":1,"stats":{"Line":0}},{"line":109,"address":[29423914],"length":1,"stats":{"Line":0}},{"line":110,"address":[41883491],"length":1,"stats":{"Line":0}},{"line":111,"address":[38964037],"length":1,"stats":{"Line":0}},{"line":112,"address":[39325533],"length":1,"stats":{"Line":0}},{"line":113,"address":[38899776],"length":1,"stats":{"Line":0}},{"line":119,"address":[41885940,41885552,41885969],"length":1,"stats":{"Line":0}},{"line":120,"address":[38965905],"length":1,"stats":{"Line":0}},{"line":121,"address":[29425641],"length":1,"stats":{"Line":0}},{"line":123,"address":[29425656],"length":1,"stats":{"Line":0}},{"line":124,"address":[38966035,38966107],"length":1,"stats":{"Line":0}},{"line":125,"address":[29425776],"length":1,"stats":{"Line":0}},{"line":127,"address":[38966144],"length":1,"stats":{"Line":0}},{"line":128,"address":[29280233,29280318],"length":1,"stats":{"Line":0}},{"line":129,"address":[36787967],"length":1,"stats":{"Line":0}},{"line":130,"address":[36788146],"length":1,"stats":{"Line":0}},{"line":131,"address":[29280705],"length":1,"stats":{"Line":0}},{"line":132,"address":[29140976],"length":1,"stats":{"Line":0}},{"line":133,"address":[31839224,31839031],"length":1,"stats":{"Line":0}},{"line":134,"address":[31839358,31839477],"length":1,"stats":{"Line":0}},{"line":139,"address":[39327744,39329884,39330234],"length":1,"stats":{"Line":0}},{"line":140,"address":[36789088,36789118],"length":1,"stats":{"Line":0}},{"line":142,"address":[41886245],"length":1,"stats":{"Line":0}},{"line":143,"address":[41886323,41886374],"length":1,"stats":{"Line":0}},{"line":144,"address":[38966777],"length":1,"stats":{"Line":0}},{"line":147,"address":[29426228,29426409],"length":1,"stats":{"Line":0}},{"line":149,"address":[29426438],"length":1,"stats":{"Line":0}},{"line":151,"address":[31840102,31840096,31839808],"length":1,"stats":{"Line":0}},{"line":152,"address":[36789201],"length":1,"stats":{"Line":0}},{"line":153,"address":[28920224],"length":1,"stats":{"Line":0}},{"line":154,"address":[31839952],"length":1,"stats":{"Line":0}},{"line":155,"address":[36789439],"length":1,"stats":{"Line":0}},{"line":159,"address":[38966886],"length":1,"stats":{"Line":0}},{"line":161,"address":[39328829,39328357,39328714,39328944,39328554,39329059],"length":1,"stats":{"Line":0}},{"line":164,"address":[41886871,41886685,41888452,41886697],"length":1,"stats":{"Line":0}},{"line":165,"address":[38902817,38902890,38902798,38904334],"length":1,"stats":{"Line":0}},{"line":166,"address":[39330168,39328769,39328861,39328788],"length":1,"stats":{"Line":0}},{"line":167,"address":[38968706,38967463,38967536,38967444],"length":1,"stats":{"Line":0}},{"line":168,"address":[29427175,29427194,29427267,29428260],"length":1,"stats":{"Line":0}},{"line":172,"address":[39329132],"length":1,"stats":{"Line":0}},{"line":173,"address":[29282176,29281903],"length":1,"stats":{"Line":0}},{"line":174,"address":[36789740],"length":1,"stats":{"Line":0}},{"line":176,"address":[29281988,29282224],"length":1,"stats":{"Line":0}},{"line":177,"address":[36789788],"length":1,"stats":{"Line":0}},{"line":179,"address":[36789606,36789824],"length":1,"stats":{"Line":0}},{"line":180,"address":[36789836],"length":1,"stats":{"Line":0}},{"line":182,"address":[31840560,31840328],"length":1,"stats":{"Line":0}},{"line":183,"address":[29142572],"length":1,"stats":{"Line":0}},{"line":186,"address":[38903316],"length":1,"stats":{"Line":0}},{"line":187,"address":[29282385],"length":1,"stats":{"Line":0}},{"line":189,"address":[36790008],"length":1,"stats":{"Line":0}},{"line":190,"address":[29143104,29143122,29142736],"length":1,"stats":{"Line":0}},{"line":191,"address":[36790066],"length":1,"stats":{"Line":0}},{"line":192,"address":[36790083],"length":1,"stats":{"Line":0}},{"line":193,"address":[36790159,36790095],"length":1,"stats":{"Line":0}},{"line":194,"address":[28921792,28921303,28921397,28921488],"length":1,"stats":{"Line":0}},{"line":195,"address":[29143909,29143896,29143504,29143185],"length":1,"stats":{"Line":0}},{"line":196,"address":[28922214,28921992],"length":1,"stats":{"Line":0}},{"line":197,"address":[29283349],"length":1,"stats":{"Line":0}},{"line":199,"address":[36790797],"length":1,"stats":{"Line":0}},{"line":200,"address":[29143920,29143945,29143566],"length":1,"stats":{"Line":0}},{"line":201,"address":[29143585],"length":1,"stats":{"Line":0}},{"line":203,"address":[29283376,29283451,29283438],"length":1,"stats":{"Line":0}},{"line":205,"address":[31841830,31841718],"length":1,"stats":{"Line":0}},{"line":208,"address":[28922288,28921603],"length":1,"stats":{"Line":0}},{"line":209,"address":[31842002],"length":1,"stats":{"Line":0}},{"line":211,"address":[31842408,31842176,31841342,31842414],"length":1,"stats":{"Line":0}},{"line":212,"address":[36791436],"length":1,"stats":{"Line":0}},{"line":213,"address":[28922562],"length":1,"stats":{"Line":0}},{"line":215,"address":[29283161,29284192],"length":1,"stats":{"Line":0}},{"line":216,"address":[36791728,36791687,36792607,36792613],"length":1,"stats":{"Line":0}},{"line":217,"address":[36791787],"length":1,"stats":{"Line":0}},{"line":218,"address":[29284585,29284476],"length":1,"stats":{"Line":0}},{"line":219,"address":[31842873,31842963,31843137,31842988],"length":1,"stats":{"Line":0}},{"line":221,"address":[29284819],"length":1,"stats":{"Line":0}},{"line":226,"address":[29284532,29285175,29285457],"length":1,"stats":{"Line":0}},{"line":227,"address":[29145629,29145515],"length":1,"stats":{"Line":0}},{"line":235,"address":[39329267],"length":1,"stats":{"Line":0}},{"line":236,"address":[38967903],"length":1,"stats":{"Line":0}},{"line":237,"address":[38967911,38968214],"length":1,"stats":{"Line":0}},{"line":240,"address":[41887766],"length":1,"stats":{"Line":0}},{"line":241,"address":[38968222,38968106,38968169],"length":1,"stats":{"Line":0}},{"line":242,"address":[36792937],"length":1,"stats":{"Line":0}},{"line":246,"address":[29285667,29286834,29285760],"length":1,"stats":{"Line":0}},{"line":247,"address":[29146324,29146025],"length":1,"stats":{"Line":0}},{"line":248,"address":[29146165,29146250],"length":1,"stats":{"Line":0}},{"line":250,"address":[31844329,31844192,31845169],"length":1,"stats":{"Line":0}},{"line":251,"address":[36793672,36793742,36793614],"length":1,"stats":{"Line":0}},{"line":252,"address":[29286360,29286538,29286385,29286253],"length":1,"stats":{"Line":0}},{"line":254,"address":[28925016],"length":1,"stats":{"Line":0}},{"line":258,"address":[28924860],"length":1,"stats":{"Line":0}},{"line":260,"address":[28925372,28925418],"length":1,"stats":{"Line":0}},{"line":264,"address":[38968417,38968284],"length":1,"stats":{"Line":0}},{"line":265,"address":[38903925,38903897],"length":1,"stats":{"Line":0}},{"line":269,"address":[38968455,38968508],"length":1,"stats":{"Line":0}},{"line":270,"address":[38968489],"length":1,"stats":{"Line":0}},{"line":271,"address":[38904085],"length":1,"stats":{"Line":0}},{"line":274,"address":[39329917,39329950],"length":1,"stats":{"Line":0}},{"line":276,"address":[29428114],"length":1,"stats":{"Line":0}},{"line":277,"address":[36794368],"length":1,"stats":{"Line":0}},{"line":278,"address":[36794427],"length":1,"stats":{"Line":0}},{"line":279,"address":[31845282],"length":1,"stats":{"Line":0}},{"line":280,"address":[28925770],"length":1,"stats":{"Line":0}},{"line":281,"address":[36794675],"length":1,"stats":{"Line":0}},{"line":286,"address":[38968832],"length":1,"stats":{"Line":0}},{"line":287,"address":[38968891],"length":1,"stats":{"Line":0}},{"line":288,"address":[29428497],"length":1,"stats":{"Line":0}},{"line":289,"address":[39330398,39330485],"length":1,"stats":{"Line":0}},{"line":295,"address":[41888674],"length":1,"stats":{"Line":0}},{"line":349,"address":[39331253,39330512,39331823],"length":1,"stats":{"Line":0}},{"line":350,"address":[39330578],"length":1,"stats":{"Line":0}},{"line":351,"address":[41888976],"length":1,"stats":{"Line":0}},{"line":352,"address":[38969180],"length":1,"stats":{"Line":0}},{"line":353,"address":[38970492,38969196,38970444],"length":1,"stats":{"Line":0}},{"line":354,"address":[29430003,29430442],"length":1,"stats":{"Line":0}},{"line":359,"address":[29428994,29428915],"length":1,"stats":{"Line":0}},{"line":360,"address":[41889206],"length":1,"stats":{"Line":0}},{"line":361,"address":[39330905],"length":1,"stats":{"Line":0}},{"line":362,"address":[39331355,39331507,39331307,39330921],"length":1,"stats":{"Line":0}},{"line":367,"address":[38969881,38970326],"length":1,"stats":{"Line":0}},{"line":372,"address":[38905159],"length":1,"stats":{"Line":0}},{"line":375,"address":[38969694],"length":1,"stats":{"Line":0}},{"line":376,"address":[31845631,31845583],"length":1,"stats":{"Line":0}},{"line":377,"address":[29147888,29147788],"length":1,"stats":{"Line":0}},{"line":378,"address":[28926222],"length":1,"stats":{"Line":0}},{"line":382,"address":[29148956,29147936,29148536],"length":1,"stats":{"Line":0}},{"line":383,"address":[31846163,31845956,31846028],"length":1,"stats":{"Line":0}},{"line":384,"address":[28926559],"length":1,"stats":{"Line":0}},{"line":387,"address":[31846284],"length":1,"stats":{"Line":0}},{"line":388,"address":[36795529],"length":1,"stats":{"Line":0}},{"line":389,"address":[36795463],"length":1,"stats":{"Line":0}},{"line":390,"address":[29288378,29288095,29288350],"length":1,"stats":{"Line":0}},{"line":394,"address":[28926729,28927296,28927607],"length":1,"stats":{"Line":0}},{"line":395,"address":[29288815,29288767],"length":1,"stats":{"Line":0}},{"line":396,"address":[29149212,29149312],"length":1,"stats":{"Line":0}},{"line":397,"address":[29149326],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":158},{"path":["/","app","src","instrument","elliptec.rs"],"content":"//! Thorlabs Elliptec ELL14 rotation mount driver\n//!\n//! This module provides an `Instrument` implementation for Elliptec ELL14\n//! rotation mounts using RS-485 multidrop serial communication.\n//!\n//! ## Configuration\n//!\n//! ```toml\n//! [instruments.elliptec_rotators]\n//! type = \"elliptec\"\n//! port = \"/dev/ttyUSB0\"\n//! baud_rate = 9600\n//! device_addresses = [0, 1]  # Multiple devices on same bus\n//! polling_rate_hz = 2.0\n//! ```\n\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument, InstrumentCommand},\n};\nuse anyhow::{anyhow, Context, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\n\n#[cfg(feature = \"instrument_serial\")]\nuse serialport::SerialPort;\n\n/// Elliptec ELL14 instrument implementation\n#[derive(Clone)]\npub struct Elliptec {\n    id: String,\n    #[cfg(feature = \"instrument_serial\")]\n    port: Option\u003cArc\u003ctokio::sync::Mutex\u003cBox\u003cdyn SerialPort\u003e\u003e\u003e\u003e,\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n    device_addresses: Vec\u003cu8\u003e,\n}\n\nimpl Elliptec {\n    /// Creates a new Elliptec instrument\n    pub fn new(id: \u0026str) -\u003e Self {\n        Self {\n            id: id.to_string(),\n            #[cfg(feature = \"instrument_serial\")]\n            port: None,\n            sender: None,\n            device_addresses: vec![0], // Default to address 0\n        }\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn send_command(\u0026self, address: u8, command: \u0026str) -\u003e Result\u003cString\u003e {\n        use std::io::{Read, Write};\n\n        let port = self.port.as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to Elliptec '{}'\", self.id))?;\n\n        let mut port = port.blocking_lock();\n\n        // Elliptec protocol: address + command\n        let cmd = format!(\"{}{}\", address, command);\n        port.write_all(cmd.as_bytes())\n            .with_context(|| format!(\"Failed to send command to Elliptec '{}'\", self.id))?;\n\n        // Read response\n        let mut buffer = [0u8; 256];\n        let mut response = String::new();\n        let start = std::time::Instant::now();\n\n        while start.elapsed() \u003c std::time::Duration::from_millis(500) {\n            if let Ok(n) = port.read(\u0026mut buffer) {\n                response.push_str(\u0026String::from_utf8_lossy(\u0026buffer[..n]));\n                // Elliptec responses are terminated with \\r or when complete\n                if response.len() \u003e= 3 {  // Minimum response length\n                    break;\n                }\n            }\n            std::thread::sleep(std::time::Duration::from_millis(5));\n        }\n\n        Ok(response.trim().to_string())\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn get_position(\u0026self, address: u8) -\u003e Result\u003cf64\u003e {\n        // 'gp' command - get position\n        let response = self.send_command(address, \"gp\")?;\n\n        // Response format: \"0PO12345678\" where address=0, PO is response code, 12345678 is hex position\n        if response.len() \u003c 10 {\n            return Err(anyhow!(\"Invalid position response: {}\", response));\n        }\n\n        let hex_pos = \u0026response[3..]; // Skip address and \"PO\"\n        let raw_pos = u32::from_str_radix(hex_pos, 16)\n            .with_context(|| format!(\"Failed to parse hex position: {}\", hex_pos))?;\n\n        // Convert to degrees (ELL14 specific conversion)\n        // Full rotation = 143360 counts = 360 degrees\n        let degrees = (raw_pos as f64 / 143360.0) * 360.0;\n        Ok(degrees)\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn set_position(\u0026self, address: u8, degrees: f64) -\u003e Result\u003c()\u003e {\n        // Convert degrees to counts\n        let counts = ((degrees / 360.0) * 143360.0) as u32;\n        let hex_pos = format!(\"{:08X}\", counts);\n\n        // 'ma' command - move absolute\n        self.send_command(address, \u0026format!(\"ma{}\", hex_pos))?;\n        Ok(())\n    }\n}\n\n#[async_trait]\nimpl Instrument for Elliptec {\n    fn name(\u0026self) -\u003e String {\n        self.id.clone()\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to Elliptec rotators: {}\", self.id);\n\n        let instrument_config = settings\n            .instruments\n            .get(\u0026self.id)\n            .ok_or_else(|| anyhow!(\"Configuration for '{}' not found\", self.id))?;\n\n        let port_name = instrument_config\n            .get(\"port\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| anyhow!(\"'port' not found in config for '{}'\", self.id))?;\n\n        let baud_rate = instrument_config\n            .get(\"baud_rate\")\n            .and_then(|v| v.as_integer())\n            .unwrap_or(9600) as u32;\n\n        // Get device addresses\n        self.device_addresses = instrument_config\n            .get(\"device_addresses\")\n            .and_then(|v| v.as_array())\n            .map(|arr| {\n                arr.iter()\n                    .filter_map(|v| v.as_integer())\n                    .map(|i| i as u8)\n                    .collect()\n            })\n            .unwrap_or_else(|| vec![0]);\n\n        info!(\"Elliptec device addresses: {:?}\", self.device_addresses);\n\n        // Open serial port\n        let port = serialport::new(port_name, baud_rate)\n            .timeout(std::time::Duration::from_millis(100))\n            .open()\n            .with_context(|| format!(\"Failed to open serial port '{}' for Elliptec\", port_name))?;\n\n        self.port = Some(Arc::new(tokio::sync::Mutex::new(port)));\n\n        // Query device info for each address\n        for \u0026addr in \u0026self.device_addresses {\n            let response = self.send_command(addr, \"in\")?;\n            info!(\"Elliptec device {} info: {}\", addr, response);\n        }\n\n        // Create broadcast channel\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        // Spawn polling task\n        let instrument = self.clone();\n        let polling_rate = instrument_config\n            .get(\"polling_rate_hz\")\n            .and_then(|v| v.as_float())\n            .unwrap_or(2.0);\n\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(\n                std::time::Duration::from_secs_f64(1.0 / polling_rate)\n            );\n\n            loop {\n                interval.tick().await;\n\n                let timestamp = chrono::Utc::now();\n\n                // Poll each device\n                for \u0026addr in \u0026instrument.device_addresses {\n                    match instrument.get_position(addr) {\n                        Ok(position) =\u003e {\n                            let dp = DataPoint {\n                                timestamp,\n                                channel: format!(\"{}_device{}_position\", instrument.id, addr),\n                                value: position,\n                                unit: \"deg\".to_string(),\n                                metadata: Some(serde_json::json!({\"device_address\": addr})),\n                            };\n\n                            if sender.send(dp).is_err() {\n                                warn!(\"No active receivers for Elliptec data\");\n                                return;\n                            }\n                        }\n                        Err(e) =\u003e {\n                            warn!(\"Failed to read position from Elliptec device {}: {}\", addr, e);\n                        }\n                    }\n                }\n            }\n        });\n\n        info!(\"Elliptec rotators '{}' connected successfully\", self.id);\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn connect(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled. Rebuild with --features instrument_serial\"))\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from Elliptec rotators: {}\", self.id);\n        #[cfg(feature = \"instrument_serial\")]\n        {\n            self.port = None;\n        }\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to Elliptec '{}'\", self.id))\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn handle_command(\u0026mut self, command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        match command {\n            InstrumentCommand::SetParameter(key, value) =\u003e {\n                // Parse device_address:parameter format\n                let parts: Vec\u003c\u0026str\u003e = key.split(':').collect();\n                if parts.len() == 2 {\n                    let addr: u8 = parts[0].parse()\n                        .with_context(|| format!(\"Invalid device address: {}\", parts[0]))?;\n\n                    if parts[1] == \"position\" {\n                        let degrees: f64 = value.parse()\n                            .with_context(|| format!(\"Invalid position value: {}\", value))?;\n                        self.set_position(addr, degrees)?;\n                        info!(\"Set Elliptec device {} to {} degrees\", addr, degrees);\n                    }\n                } else {\n                    warn!(\"Unknown parameter '{}' for Elliptec\", key);\n                }\n            }\n            InstrumentCommand::Execute(cmd, args) =\u003e {\n                if cmd == \"home\" {\n                    if args.is_empty() {\n                        // Home all devices\n                        for \u0026addr in \u0026self.device_addresses {\n                            self.send_command(addr, \"ho\")?;\n                        }\n                        info!(\"Homed all Elliptec devices\");\n                    } else {\n                        // Home specific device\n                        let addr: u8 = args[0].parse()\n                            .with_context(|| format!(\"Invalid device address: {}\", args[0]))?;\n                        self.send_command(addr, \"ho\")?;\n                        info!(\"Homed Elliptec device {}\", addr);\n                    }\n                }\n            }\n            _ =\u003e {\n                warn!(\"Unsupported command type for Elliptec\");\n            }\n        }\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn handle_command(\u0026mut self, _command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled\"))\n    }\n}\n","traces":[{"line":42,"address":[28863705,28863667,28863408],"length":1,"stats":{"Line":0}},{"line":44,"address":[31486007],"length":1,"stats":{"Line":0}},{"line":48,"address":[29254467,29254412],"length":1,"stats":{"Line":0}},{"line":53,"address":[29256462,29256549,29254672],"length":1,"stats":{"Line":0}},{"line":56,"address":[28893307,28893340,28893400],"length":1,"stats":{"Line":0}},{"line":57,"address":[28848114,28848096],"length":1,"stats":{"Line":0}},{"line":59,"address":[29254874],"length":1,"stats":{"Line":0}},{"line":62,"address":[28864061,28863974],"length":1,"stats":{"Line":0}},{"line":63,"address":[31486859,31487058,31486968,31486780],"length":1,"stats":{"Line":0}},{"line":64,"address":[29255309,29255410],"length":1,"stats":{"Line":0}},{"line":67,"address":[28894007],"length":1,"stats":{"Line":0}},{"line":68,"address":[28894154],"length":1,"stats":{"Line":0}},{"line":69,"address":[28864657,28864742],"length":1,"stats":{"Line":0}},{"line":71,"address":[28864757],"length":1,"stats":{"Line":0}},{"line":72,"address":[29255879,29256004],"length":1,"stats":{"Line":0}},{"line":73,"address":[36898366,36898280],"length":1,"stats":{"Line":0}},{"line":75,"address":[29256258],"length":1,"stats":{"Line":0}},{"line":79,"address":[29256473],"length":1,"stats":{"Line":0}},{"line":82,"address":[29255859,29256317],"length":1,"stats":{"Line":0}},{"line":86,"address":[28895948,28895136,28895954],"length":1,"stats":{"Line":0}},{"line":88,"address":[29256610],"length":1,"stats":{"Line":0}},{"line":91,"address":[28865835,28865893],"length":1,"stats":{"Line":0}},{"line":92,"address":[36899119,36899464],"length":1,"stats":{"Line":0}},{"line":95,"address":[28895403,28895478],"length":1,"stats":{"Line":0}},{"line":96,"address":[28895670,28895494,28895607,28895783],"length":1,"stats":{"Line":0}},{"line":97,"address":[32654665,32654640],"length":1,"stats":{"Line":0}},{"line":101,"address":[28866205],"length":1,"stats":{"Line":0}},{"line":102,"address":[29257187],"length":1,"stats":{"Line":0}},{"line":106,"address":[29258204,29258198,29257408],"length":1,"stats":{"Line":0}},{"line":108,"address":[28866515],"length":1,"stats":{"Line":0}},{"line":109,"address":[31489135],"length":1,"stats":{"Line":0}},{"line":112,"address":[28866705,28866765,28867217],"length":1,"stats":{"Line":0}},{"line":113,"address":[28867179],"length":1,"stats":{"Line":0}},{"line":119,"address":[29258592],"length":1,"stats":{"Line":0}},{"line":120,"address":[28897169],"length":1,"stats":{"Line":0}},{"line":124,"address":[28897214],"length":1,"stats":{"Line":0}},{"line":125,"address":[28848810,28848681,28848850],"length":1,"stats":{"Line":0}},{"line":127,"address":[28878825,28878654,28878736,28878328,28882513],"length":1,"stats":{"Line":0}},{"line":129,"address":[28878658],"length":1,"stats":{"Line":0}},{"line":130,"address":[28849189,28853056,28853074,28849305],"length":1,"stats":{"Line":0}},{"line":132,"address":[28849483,28852988,28849557],"length":1,"stats":{"Line":0}},{"line":134,"address":[28882688,28878917,28882697],"length":1,"stats":{"Line":0}},{"line":135,"address":[29240485,29244178,29240408,29244160],"length":1,"stats":{"Line":0}},{"line":137,"address":[28879275],"length":1,"stats":{"Line":0}},{"line":138,"address":[31492202],"length":1,"stats":{"Line":0}},{"line":139,"address":[29240625,29244288,29244297],"length":1,"stats":{"Line":0}},{"line":140,"address":[29240668],"length":1,"stats":{"Line":0}},{"line":143,"address":[28879409,28879503,28879432],"length":1,"stats":{"Line":0}},{"line":144,"address":[31492338],"length":1,"stats":{"Line":0}},{"line":145,"address":[32659545,32656053,32659536],"length":1,"stats":{"Line":0}},{"line":146,"address":[29244352,29240788],"length":1,"stats":{"Line":0}},{"line":147,"address":[32659598],"length":1,"stats":{"Line":0}},{"line":148,"address":[29244406,29244473,29244448],"length":1,"stats":{"Line":0}},{"line":149,"address":[28853552,28853562,28853474],"length":1,"stats":{"Line":0}},{"line":150,"address":[29244432],"length":1,"stats":{"Line":0}},{"line":152,"address":[31492423,31496142,31496128,31492524],"length":1,"stats":{"Line":0}},{"line":154,"address":[28850126,28850023],"length":1,"stats":{"Line":0}},{"line":157,"address":[29241032,29241695,29241481,29241393,29241621,29243892],"length":1,"stats":{"Line":0}},{"line":158,"address":[31493105,31492974,31493044,31495518,31493022],"length":1,"stats":{"Line":0}},{"line":160,"address":[29244608,29241679,29241586,29244633],"length":1,"stats":{"Line":0}},{"line":162,"address":[28850927,28850993,28850836],"length":1,"stats":{"Line":0}},{"line":165,"address":[29241985],"length":1,"stats":{"Line":0}},{"line":166,"address":[28852897,28851197,28852273],"length":1,"stats":{"Line":0}},{"line":167,"address":[32658599,32658717,32658689],"length":1,"stats":{"Line":0}},{"line":171,"address":[31493796],"length":1,"stats":{"Line":0}},{"line":172,"address":[31493911,31493971],"length":1,"stats":{"Line":0}},{"line":175,"address":[32657698,32657648],"length":1,"stats":{"Line":0}},{"line":176,"address":[28851657],"length":1,"stats":{"Line":0}},{"line":178,"address":[28853792,28853801,28851593],"length":1,"stats":{"Line":0}},{"line":181,"address":[31496703,31494226,31498822,31498904,31496384,31496535,31496423],"length":1,"stats":{"Line":0}},{"line":182,"address":[31496488,31496645],"length":1,"stats":{"Line":0}},{"line":183,"address":[28853936],"length":1,"stats":{"Line":0}},{"line":187,"address":[28544721],"length":1,"stats":{"Line":0}},{"line":189,"address":[32660617],"length":1,"stats":{"Line":0}},{"line":192,"address":[31497060],"length":1,"stats":{"Line":0}},{"line":193,"address":[28884152,28884254],"length":1,"stats":{"Line":0}},{"line":194,"address":[31497393],"length":1,"stats":{"Line":0}},{"line":195,"address":[31498150],"length":1,"stats":{"Line":0}},{"line":197,"address":[31497417],"length":1,"stats":{"Line":0}},{"line":199,"address":[28884547],"length":1,"stats":{"Line":0}},{"line":200,"address":[32662450,32661418,32661314,32661352,32661266],"length":1,"stats":{"Line":0}},{"line":203,"address":[28855725],"length":1,"stats":{"Line":0}},{"line":204,"address":[28855952,28855874],"length":1,"stats":{"Line":0}},{"line":208,"address":[28854764],"length":1,"stats":{"Line":0}},{"line":209,"address":[31497340,31498980,31499008],"length":1,"stats":{"Line":0}},{"line":216,"address":[32658014,32658119],"length":1,"stats":{"Line":0}},{"line":217,"address":[32658066],"length":1,"stats":{"Line":0}},{"line":225,"address":[36900921],"length":1,"stats":{"Line":0}},{"line":226,"address":[28886605,28886465,28886576],"length":1,"stats":{"Line":0}},{"line":229,"address":[28886587,28886855],"length":1,"stats":{"Line":0}},{"line":231,"address":[31499959,31499979],"length":1,"stats":{"Line":0}},{"line":232,"address":[32663555],"length":1,"stats":{"Line":0}},{"line":235,"address":[28887078,28887204,28887425,28887255,28887303,28887129,28887040,28887197],"length":1,"stats":{"Line":0}},{"line":236,"address":[31500276],"length":1,"stats":{"Line":0}},{"line":238,"address":[28857961,28857952,28857843],"length":1,"stats":{"Line":0}},{"line":239,"address":[31500544,31500562,31500439],"length":1,"stats":{"Line":0}},{"line":243,"address":[31505414,31505026,31500672,31500782,31500961,31502752,31503216,31500703,31502799,31503268,31505048,31500841,31505143],"length":1,"stats":{"Line":0}},{"line":244,"address":[28887860],"length":1,"stats":{"Line":0}},{"line":245,"address":[28858420],"length":1,"stats":{"Line":0}},{"line":247,"address":[29249436,29249666],"length":1,"stats":{"Line":0}},{"line":248,"address":[28888277,28888356],"length":1,"stats":{"Line":0}},{"line":249,"address":[31502663,31501418,31501657,31501594,31501512],"length":1,"stats":{"Line":0}},{"line":250,"address":[32665078,32668996,32665153,32668960],"length":1,"stats":{"Line":0}},{"line":252,"address":[31501707],"length":1,"stats":{"Line":0}},{"line":253,"address":[32665435,32665472,32666133,32665330],"length":1,"stats":{"Line":0}},{"line":254,"address":[29254064,29250340,29250264,29254089],"length":1,"stats":{"Line":0}},{"line":255,"address":[31502036,31502610],"length":1,"stats":{"Line":0}},{"line":256,"address":[28859627],"length":1,"stats":{"Line":0}},{"line":259,"address":[28889802,28888400],"length":1,"stats":{"Line":0}},{"line":262,"address":[31501078],"length":1,"stats":{"Line":0}},{"line":263,"address":[28860765,28858582],"length":1,"stats":{"Line":0}},{"line":264,"address":[28890297],"length":1,"stats":{"Line":0}},{"line":266,"address":[29251822,29252699,29252802],"length":1,"stats":{"Line":0}},{"line":267,"address":[28861855,28862237,28861867],"length":1,"stats":{"Line":0}},{"line":269,"address":[29252842],"length":1,"stats":{"Line":0}},{"line":272,"address":[28891233,28890336,28890424,28890589,28890526],"length":1,"stats":{"Line":0}},{"line":273,"address":[28863284,28863248,28860986,28861069],"length":1,"stats":{"Line":0}},{"line":274,"address":[31503700,31504254],"length":1,"stats":{"Line":0}},{"line":275,"address":[29252309],"length":1,"stats":{"Line":0}},{"line":280,"address":[28862629,28858614],"length":1,"stats":{"Line":0}},{"line":283,"address":[28860632],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":121},{"path":["/","app","src","instrument","esp300.rs"],"content":"//! Newport ESP300 3-axis motion controller driver\n//!\n//! This module provides an `Instrument` implementation for the Newport ESP300\n//! motion controller using RS-232 serial communication with hardware flow control.\n//!\n//! ## Configuration\n//!\n//! ```toml\n//! [instruments.motion_controller]\n//! type = \"esp300\"\n//! port = \"/dev/ttyUSB0\"\n//! baud_rate = 19200\n//! polling_rate_hz = 5.0\n//!\n//! [instruments.motion_controller.axis1]\n//! units = 1  # millimeters\n//! velocity = 5.0  # mm/s\n//! acceleration = 10.0  # mm/s\n//! ```\n\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument, InstrumentCommand},\n};\nuse anyhow::{anyhow, Context, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\n\n#[cfg(feature = \"instrument_serial\")]\nuse serialport::SerialPort;\n\n/// Newport ESP300 instrument implementation\n#[derive(Clone)]\npub struct ESP300 {\n    id: String,\n    #[cfg(feature = \"instrument_serial\")]\n    port: Option\u003cArc\u003ctokio::sync::Mutex\u003cBox\u003cdyn SerialPort\u003e\u003e\u003e\u003e,\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n    num_axes: u8,\n}\n\nimpl ESP300 {\n    /// Creates a new ESP300 instrument\n    pub fn new(id: \u0026str) -\u003e Self {\n        Self {\n            id: id.to_string(),\n            #[cfg(feature = \"instrument_serial\")]\n            port: None,\n            sender: None,\n            num_axes: 3, // ESP300 has 3 axes\n        }\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn send_command(\u0026self, command: \u0026str) -\u003e Result\u003cString\u003e {\n        use std::io::{Read, Write};\n\n        let port = self.port.as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to ESP300 '{}'\", self.id))?;\n\n        let mut port = port.blocking_lock();\n\n        // Send command with CR-LF terminator\n        let cmd = format!(\"{}\\r\\n\", command);\n        port.write_all(cmd.as_bytes())\n            .with_context(|| format!(\"Failed to send command to ESP300 '{}'\", self.id))?;\n\n        // Read response\n        let mut buffer = [0u8; 512];\n        let mut response = String::new();\n        let start = std::time::Instant::now();\n\n        while start.elapsed() \u003c std::time::Duration::from_secs(1) {\n            if let Ok(n) = port.read(\u0026mut buffer) {\n                response.push_str(\u0026String::from_utf8_lossy(\u0026buffer[..n]));\n                if response.contains('\\r') || response.contains('\\n') {\n                    break;\n                }\n            }\n            std::thread::sleep(std::time::Duration::from_millis(10));\n        }\n\n        Ok(response.trim().to_string())\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn get_position(\u0026self, axis: u8) -\u003e Result\u003cf64\u003e {\n        let response = self.send_command(\u0026format!(\"{}TP\", axis))?;\n        response.parse::\u003cf64\u003e()\n            .with_context(|| format!(\"Failed to parse position response: {}\", response))\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn get_velocity(\u0026self, axis: u8) -\u003e Result\u003cf64\u003e {\n        let response = self.send_command(\u0026format!(\"{}TV\", axis))?;\n        response.parse::\u003cf64\u003e()\n            .with_context(|| format!(\"Failed to parse velocity response: {}\", response))\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn move_absolute(\u0026self, axis: u8, position: f64) -\u003e Result\u003c()\u003e {\n        self.send_command(\u0026format!(\"{}PA{}\", axis, position))?;\n        Ok(())\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn move_relative(\u0026self, axis: u8, distance: f64) -\u003e Result\u003c()\u003e {\n        self.send_command(\u0026format!(\"{}PR{}\", axis, distance))?;\n        Ok(())\n    }\n}\n\n#[async_trait]\nimpl Instrument for ESP300 {\n    fn name(\u0026self) -\u003e String {\n        self.id.clone()\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to ESP300 motion controller: {}\", self.id);\n\n        let instrument_config = settings\n            .instruments\n            .get(\u0026self.id)\n            .ok_or_else(|| anyhow!(\"Configuration for '{}' not found\", self.id))?;\n\n        let port_name = instrument_config\n            .get(\"port\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| anyhow!(\"'port' not found in config for '{}'\", self.id))?;\n\n        let baud_rate = instrument_config\n            .get(\"baud_rate\")\n            .and_then(|v| v.as_integer())\n            .unwrap_or(19200) as u32;\n\n        // Open serial port with hardware flow control\n        let mut port = serialport::new(port_name, baud_rate)\n            .timeout(std::time::Duration::from_millis(500))\n            .open()\n            .with_context(|| format!(\"Failed to open serial port '{}' for ESP300\", port_name))?;\n\n        // ESP300 requires hardware flow control (RTS/CTS)\n        port.write_request_to_send(true)\n            .context(\"Failed to enable RTS\")?;\n        port.write_data_terminal_ready(true)\n            .context(\"Failed to enable DTR\")?;\n\n        self.port = Some(Arc::new(tokio::sync::Mutex::new(port)));\n\n        // Query controller version\n        let version = self.send_command(\"VE?\")?;\n        info!(\"ESP300 version: {}\", version);\n\n        // Configure axes if specified\n        for axis in 1..=self.num_axes {\n            let axis_key = format!(\"axis{}\", axis);\n            if let Some(axis_config) = instrument_config.get(\u0026axis_key) {\n                // Set units\n                if let Some(units) = axis_config.get(\"units\").and_then(|v| v.as_integer()) {\n                    self.send_command(\u0026format!(\"{}SN{}\", axis, units))?;\n                    info!(\"Set axis {} units to {}\", axis, units);\n                }\n\n                // Set velocity\n                if let Some(vel) = axis_config.get(\"velocity\").and_then(|v| v.as_float()) {\n                    self.send_command(\u0026format!(\"{}VA{}\", axis, vel))?;\n                    info!(\"Set axis {} velocity to {} units/s\", axis, vel);\n                }\n\n                // Set acceleration\n                if let Some(accel) = axis_config.get(\"acceleration\").and_then(|v| v.as_float()) {\n                    self.send_command(\u0026format!(\"{}AC{}\", axis, accel))?;\n                    info!(\"Set axis {} acceleration to {} units/s\", axis, accel);\n                }\n            }\n        }\n\n        // Create broadcast channel\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        // Spawn polling task\n        let instrument = self.clone();\n        let polling_rate = instrument_config\n            .get(\"polling_rate_hz\")\n            .and_then(|v| v.as_float())\n            .unwrap_or(5.0);\n\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(\n                std::time::Duration::from_secs_f64(1.0 / polling_rate)\n            );\n\n            loop {\n                interval.tick().await;\n\n                let timestamp = chrono::Utc::now();\n\n                // Poll each axis\n                for axis in 1..=instrument.num_axes {\n                    // Get position\n                    if let Ok(position) = instrument.get_position(axis) {\n                        let dp = DataPoint {\n                            timestamp,\n                            channel: format!(\"{}_axis{}_position\", instrument.id, axis),\n                            value: position,\n                            unit: \"units\".to_string(),\n                            metadata: Some(serde_json::json!({\"axis\": axis})),\n                        };\n                        if sender.send(dp).is_err() {\n                            warn!(\"No active receivers for ESP300 data\");\n                            return;\n                        }\n                    }\n\n                    // Get velocity\n                    if let Ok(velocity) = instrument.get_velocity(axis) {\n                        let dp = DataPoint {\n                            timestamp,\n                            channel: format!(\"{}_axis{}_velocity\", instrument.id, axis),\n                            value: velocity,\n                            unit: \"units/s\".to_string(),\n                            metadata: Some(serde_json::json!({\"axis\": axis})),\n                        };\n                        let _ = sender.send(dp);\n                    }\n                }\n            }\n        });\n\n        info!(\"ESP300 motion controller '{}' connected successfully\", self.id);\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn connect(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled. Rebuild with --features instrument_serial\"))\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from ESP300 motion controller: {}\", self.id);\n        #[cfg(feature = \"instrument_serial\")]\n        {\n            self.port = None;\n        }\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to ESP300 '{}'\", self.id))\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn handle_command(\u0026mut self, command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        match command {\n            InstrumentCommand::SetParameter(key, value) =\u003e {\n                // Parse axis:parameter format (e.g., \"1:position\", \"2:velocity\")\n                let parts: Vec\u003c\u0026str\u003e = key.split(':').collect();\n                if parts.len() == 2 {\n                    let axis: u8 = parts[0].parse()\n                        .with_context(|| format!(\"Invalid axis number: {}\", parts[0]))?;\n\n                    match parts[1] {\n                        \"position\" =\u003e {\n                            let position: f64 = value.parse()\n                                .with_context(|| format!(\"Invalid position value: {}\", value))?;\n                            self.move_absolute(axis, position)?;\n                            info!(\"ESP300 axis {} move to {} mm\", axis, position);\n                        }\n                        \"velocity\" =\u003e {\n                            let velocity: f64 = value.parse()\n                                .with_context(|| format!(\"Invalid velocity value: {}\", value))?;\n                            self.send_command(\u0026format!(\"{}VA{}\", axis, velocity))?;\n                            info!(\"ESP300 axis {} velocity set to {} mm/s\", axis, velocity);\n                        }\n                        _ =\u003e {\n                            warn!(\"Unknown parameter '{}' for ESP300\", key);\n                        }\n                    }\n                } else {\n                    warn!(\"Unknown parameter '{}' for ESP300\", key);\n                }\n            }\n            InstrumentCommand::Execute(cmd, args) =\u003e {\n                match cmd.as_str() {\n                    \"move_relative\" =\u003e {\n                        if args.len() \u003e= 2 {\n                            let axis: u8 = args[0].parse()\n                                .with_context(|| format!(\"Invalid axis: {}\", args[0]))?;\n                            let distance: f64 = args[1].parse()\n                                .with_context(|| format!(\"Invalid distance: {}\", args[1]))?;\n                            self.move_relative(axis, distance)?;\n                            info!(\"ESP300 axis {} move relative {} mm\", axis, distance);\n                        }\n                    }\n                    \"stop\" =\u003e {\n                        if !args.is_empty() {\n                            let axis: u8 = args[0].parse()\n                                .with_context(|| format!(\"Invalid axis: {}\", args[0]))?;\n                            self.send_command(\u0026format!(\"{}ST\", axis))?;\n                            info!(\"ESP300 axis {} stopped\", axis);\n                        }\n                    }\n                    \"home\" =\u003e {\n                        if args.is_empty() {\n                            // Home all axes\n                            for axis in 1..=self.num_axes {\n                                self.send_command(\u0026format!(\"{}OR\", axis))?;\n                            }\n                            info!(\"Homed all ESP300 axes\");\n                        } else {\n                            let axis: u8 = args[0].parse()\n                                .with_context(|| format!(\"Invalid axis: {}\", args[0]))?;\n                            self.send_command(\u0026format!(\"{}OR\", axis))?;\n                            info!(\"ESP300 axis {} homed\", axis);\n                        }\n                    }\n                    _ =\u003e {\n                        warn!(\"Unknown command '{}' for ESP300\", cmd);\n                    }\n                }\n            }\n            _ =\u003e {\n                warn!(\"Unsupported command type for ESP300\");\n            }\n        }\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn handle_command(\u0026mut self, _command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled\"))\n    }\n}\n","traces":[{"line":46,"address":[31263120],"length":1,"stats":{"Line":0}},{"line":48,"address":[38955991],"length":1,"stats":{"Line":0}},{"line":57,"address":[38956064,38957803,38957890],"length":1,"stats":{"Line":0}},{"line":60,"address":[40544115,40544175,40544082],"length":1,"stats":{"Line":0}},{"line":61,"address":[39317591,39317647],"length":1,"stats":{"Line":0}},{"line":63,"address":[38956257],"length":1,"stats":{"Line":0}},{"line":66,"address":[39317733,39317804],"length":1,"stats":{"Line":0}},{"line":67,"address":[31263776,31263862,31263608,31263675],"length":1,"stats":{"Line":0}},{"line":68,"address":[39318166,39318065],"length":1,"stats":{"Line":0}},{"line":71,"address":[40544737],"length":1,"stats":{"Line":0}},{"line":72,"address":[38892379],"length":1,"stats":{"Line":0}},{"line":73,"address":[38892386,38892471],"length":1,"stats":{"Line":0}},{"line":75,"address":[40544854],"length":1,"stats":{"Line":0}},{"line":76,"address":[40545193,40545056],"length":1,"stats":{"Line":0}},{"line":77,"address":[39318697,39318787],"length":1,"stats":{"Line":0}},{"line":78,"address":[38893079,38893193],"length":1,"stats":{"Line":0}},{"line":82,"address":[31264921],"length":1,"stats":{"Line":0}},{"line":85,"address":[31264194,31264766],"length":1,"stats":{"Line":0}},{"line":89,"address":[31265603,31265024,31265597],"length":1,"stats":{"Line":0}},{"line":90,"address":[38894092,38893524],"length":1,"stats":{"Line":0}},{"line":91,"address":[31265502],"length":1,"stats":{"Line":0}},{"line":92,"address":[40546393],"length":1,"stats":{"Line":0}},{"line":96,"address":[39320553,39320559,39319968],"length":1,"stats":{"Line":0}},{"line":97,"address":[39320004,39320572],"length":1,"stats":{"Line":0}},{"line":98,"address":[40546966],"length":1,"stats":{"Line":0}},{"line":99,"address":[38894649],"length":1,"stats":{"Line":0}},{"line":103,"address":[39321149,39321155,39320592],"length":1,"stats":{"Line":0}},{"line":104,"address":[38959190,38959688],"length":1,"stats":{"Line":0}},{"line":105,"address":[39321101],"length":1,"stats":{"Line":0}},{"line":109,"address":[38895312,38895869,38895875],"length":1,"stats":{"Line":0}},{"line":110,"address":[38895350,38895848],"length":1,"stats":{"Line":0}},{"line":111,"address":[38960237],"length":1,"stats":{"Line":0}},{"line":117,"address":[38960576],"length":1,"stats":{"Line":0}},{"line":118,"address":[38896177],"length":1,"stats":{"Line":0}},{"line":122,"address":[41855900,41855798,41859996,41863792,41855870,41855647,41855742,41855616,41859969],"length":1,"stats":{"Line":0}},{"line":123,"address":[38866954,38866825,38866994],"length":1,"stats":{"Line":0}},{"line":125,"address":[38368131,38360900,38360985,38360504,38360826],"length":1,"stats":{"Line":0}},{"line":127,"address":[39293154],"length":1,"stats":{"Line":0}},{"line":128,"address":[38360969,38360861,38368194,38368176],"length":1,"stats":{"Line":0}},{"line":130,"address":[38867701,38874766,38867627],"length":1,"stats":{"Line":0}},{"line":132,"address":[39300825,39293413,39300816],"length":1,"stats":{"Line":0}},{"line":133,"address":[39293541,39293464,39300848,39300866],"length":1,"stats":{"Line":0}},{"line":135,"address":[39293756],"length":1,"stats":{"Line":0}},{"line":136,"address":[41856778],"length":1,"stats":{"Line":0}},{"line":137,"address":[38939545,38932241,38939536],"length":1,"stats":{"Line":0}},{"line":138,"address":[38867868],"length":1,"stats":{"Line":0}},{"line":141,"address":[38867909,38868067,38868281,38868207,38867979,38874726],"length":1,"stats":{"Line":0}},{"line":142,"address":[38939152,38932430,38932408,38932491,38932360],"length":1,"stats":{"Line":0}},{"line":144,"address":[39294121,39301033,39301008,39294028],"length":1,"stats":{"Line":0}},{"line":147,"address":[41857358,41857486,41857568,41863646],"length":1,"stats":{"Line":0}},{"line":149,"address":[38868605,38868774,38868692,38874636],"length":1,"stats":{"Line":0}},{"line":152,"address":[38868803,38868919],"length":1,"stats":{"Line":0}},{"line":155,"address":[38874618,38868970],"length":1,"stats":{"Line":0}},{"line":156,"address":[38869266,38869170,38869309],"length":1,"stats":{"Line":0}},{"line":159,"address":[41858272,41858592],"length":1,"stats":{"Line":0}},{"line":160,"address":[38871042,38869906],"length":1,"stats":{"Line":0}},{"line":161,"address":[38935645,38935566],"length":1,"stats":{"Line":0}},{"line":163,"address":[38364741,38368624,38368633,38364684],"length":1,"stats":{"Line":0}},{"line":164,"address":[39297306,39298282,39297391],"length":1,"stats":{"Line":0}},{"line":165,"address":[38872003],"length":1,"stats":{"Line":0}},{"line":169,"address":[38364885,38365855,38368665,38368656],"length":1,"stats":{"Line":0}},{"line":170,"address":[38365953,38366034,38366881],"length":1,"stats":{"Line":0}},{"line":171,"address":[41862121],"length":1,"stats":{"Line":0}},{"line":175,"address":[38873563,38872636,38875344,38875353],"length":1,"stats":{"Line":0}},{"line":176,"address":[38874549,38873657],"length":1,"stats":{"Line":0}},{"line":177,"address":[38938569],"length":1,"stats":{"Line":0}},{"line":183,"address":[38934352],"length":1,"stats":{"Line":0}},{"line":184,"address":[41859109,41859043],"length":1,"stats":{"Line":0}},{"line":187,"address":[38870173,38870223],"length":1,"stats":{"Line":0}},{"line":188,"address":[38363798],"length":1,"stats":{"Line":0}},{"line":190,"address":[39301241,39296164,39301232],"length":1,"stats":{"Line":0}},{"line":193,"address":[41864433,41864400,41859391,41864682,41864532,41866947,41867014],"length":1,"stats":{"Line":0}},{"line":194,"address":[38940051,38939907],"length":1,"stats":{"Line":0}},{"line":195,"address":[41864499],"length":1,"stats":{"Line":0}},{"line":199,"address":[38875721,38875567,38875664,38876367,38875746],"length":1,"stats":{"Line":0}},{"line":201,"address":[38369324],"length":1,"stats":{"Line":0}},{"line":204,"address":[38940436],"length":1,"stats":{"Line":0}},{"line":206,"address":[38876481,38876440,38876344],"length":1,"stats":{"Line":0}},{"line":207,"address":[38877279],"length":1,"stats":{"Line":0}},{"line":209,"address":[38369825,38369908],"length":1,"stats":{"Line":0}},{"line":211,"address":[38941151],"length":1,"stats":{"Line":0}},{"line":212,"address":[38942444,38941234,38941282,38941320,38941390],"length":1,"stats":{"Line":0}},{"line":214,"address":[38941830],"length":1,"stats":{"Line":0}},{"line":215,"address":[38877563,38877637],"length":1,"stats":{"Line":0}},{"line":221,"address":[39303911,39303975],"length":1,"stats":{"Line":0}},{"line":222,"address":[38878915],"length":1,"stats":{"Line":0}},{"line":224,"address":[41867134,41867221],"length":1,"stats":{"Line":0}},{"line":226,"address":[38878372],"length":1,"stats":{"Line":0}},{"line":227,"address":[39304959,39304359,39304397,39304311,39304467],"length":1,"stats":{"Line":0}},{"line":229,"address":[39304906],"length":1,"stats":{"Line":0}},{"line":235,"address":[41859557,41859665],"length":1,"stats":{"Line":0}},{"line":236,"address":[41859615],"length":1,"stats":{"Line":0}},{"line":244,"address":[39322137],"length":1,"stats":{"Line":0}},{"line":245,"address":[38372545,38372681,38372656],"length":1,"stats":{"Line":0}},{"line":248,"address":[38372931,38372667],"length":1,"stats":{"Line":0}},{"line":250,"address":[39305591,39305611],"length":1,"stats":{"Line":0}},{"line":251,"address":[39305659],"length":1,"stats":{"Line":0}},{"line":254,"address":[38373104,38373477,38373142,38373363,38373315,38373261,38373193,38373268],"length":1,"stats":{"Line":0}},{"line":255,"address":[39305908],"length":1,"stats":{"Line":0}},{"line":257,"address":[38944713,38944595,38944704],"length":1,"stats":{"Line":0}},{"line":258,"address":[38944736,38944754,38944631],"length":1,"stats":{"Line":0}},{"line":262,"address":[38383219,38377820,38383498,38376453,38373805,38383118,38373680,38373864,38377356,38383128,38373726,38373984,38377403],"length":1,"stats":{"Line":0}},{"line":263,"address":[39306563],"length":1,"stats":{"Line":0}},{"line":264,"address":[41869763],"length":1,"stats":{"Line":0}},{"line":266,"address":[41869835,41870067],"length":1,"stats":{"Line":0}},{"line":267,"address":[38374437,38374358],"length":1,"stats":{"Line":0}},{"line":268,"address":[38945866,38945803,38948500,38945721,38945627],"length":1,"stats":{"Line":0}},{"line":269,"address":[38954948,38945850,38954912,38945767],"length":1,"stats":{"Line":0}},{"line":271,"address":[41870492],"length":1,"stats":{"Line":0}},{"line":272,"address":[38881547],"length":1,"stats":{"Line":0}},{"line":273,"address":[38376596,38376559,38374862,38376493,38377243],"length":1,"stats":{"Line":0}},{"line":274,"address":[38376580,38383769,38376536,38383744],"length":1,"stats":{"Line":0}},{"line":275,"address":[41873034,41872460],"length":1,"stats":{"Line":0}},{"line":276,"address":[38948035],"length":1,"stats":{"Line":0}},{"line":278,"address":[39307531,39307457],"length":1,"stats":{"Line":0}},{"line":279,"address":[41871198,41872259,41871087,41871141,41870726],"length":1,"stats":{"Line":0}},{"line":280,"address":[39308046,39307970,39316640,39316665],"length":1,"stats":{"Line":0}},{"line":281,"address":[39308126,39309060],"length":1,"stats":{"Line":0}},{"line":282,"address":[38375981],"length":1,"stats":{"Line":0}},{"line":285,"address":[39307537,39307651,39307623],"length":1,"stats":{"Line":0}},{"line":289,"address":[38884282,38881249],"length":1,"stats":{"Line":0}},{"line":292,"address":[38880869],"length":1,"stats":{"Line":0}},{"line":293,"address":[38945357,38949168],"length":1,"stats":{"Line":0}},{"line":294,"address":[38377954],"length":1,"stats":{"Line":0}},{"line":295,"address":[39310711,39314689],"length":1,"stats":{"Line":0}},{"line":296,"address":[38953259,38953470,38953407,38954391],"length":1,"stats":{"Line":0}},{"line":297,"address":[38889038,38890912,38888955,38890948],"length":1,"stats":{"Line":0}},{"line":298,"address":[41878272,41878215,41878949,41878093],"length":1,"stats":{"Line":0}},{"line":299,"address":[39316928,39316964,39315044,39315120],"length":1,"stats":{"Line":0}},{"line":300,"address":[38382449,38383039],"length":1,"stats":{"Line":0}},{"line":301,"address":[38953893],"length":1,"stats":{"Line":0}},{"line":304,"address":[38949245,38949308],"length":1,"stats":{"Line":0}},{"line":305,"address":[38378120,38380835],"length":1,"stats":{"Line":0}},{"line":306,"address":[38887853,38887693,38888812,38887916],"length":1,"stats":{"Line":0}},{"line":307,"address":[38891268,38891232,38887817,38887900],"length":1,"stats":{"Line":0}},{"line":308,"address":[38952382,38953190],"length":1,"stats":{"Line":0}},{"line":309,"address":[38952834],"length":1,"stats":{"Line":0}},{"line":312,"address":[38378156,38378094],"length":1,"stats":{"Line":0}},{"line":313,"address":[41874019,41874374],"length":1,"stats":{"Line":0}},{"line":315,"address":[39312436,39311290],"length":1,"stats":{"Line":0}},{"line":316,"address":[38380373,38380046],"length":1,"stats":{"Line":0}},{"line":318,"address":[38951332],"length":1,"stats":{"Line":0}},{"line":320,"address":[38885388,38885585,38885471,38886563,38885648],"length":1,"stats":{"Line":0}},{"line":321,"address":[38384480,38384516,38378729,38378804],"length":1,"stats":{"Line":0}},{"line":322,"address":[41874690,41875498],"length":1,"stats":{"Line":0}},{"line":323,"address":[38950566],"length":1,"stats":{"Line":0}},{"line":327,"address":[39310919,39310947,39310838],"length":1,"stats":{"Line":0}},{"line":332,"address":[38880967,38890173],"length":1,"stats":{"Line":0}},{"line":335,"address":[38884616],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":149},{"path":["/","app","src","instrument","maitai.rs"],"content":"//! Spectra-Physics MaiTai tunable Ti:Sapphire laser driver\n//!\n//! This module provides an `Instrument` implementation for the MaiTai laser\n//! using RS-232 serial communication.\n//!\n//! ## Configuration\n//!\n//! ```toml\n//! [instruments.maitai_laser]\n//! type = \"maitai\"\n//! port = \"/dev/ttyUSB0\"\n//! baud_rate = 9600\n//! wavelength = 800.0  # nm\n//! polling_rate_hz = 1.0\n//! ```\n\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument, InstrumentCommand},\n};\nuse anyhow::{anyhow, Context, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\n\n#[cfg(feature = \"instrument_serial\")]\nuse serialport::SerialPort;\n\n/// MaiTai laser instrument implementation\n#[derive(Clone)]\npub struct MaiTai {\n    id: String,\n    #[cfg(feature = \"instrument_serial\")]\n    port: Option\u003cArc\u003ctokio::sync::Mutex\u003cBox\u003cdyn SerialPort\u003e\u003e\u003e\u003e,\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n}\n\nimpl MaiTai {\n    /// Creates a new MaiTai instrument\n    pub fn new(id: \u0026str) -\u003e Self {\n        Self {\n            id: id.to_string(),\n            #[cfg(feature = \"instrument_serial\")]\n            port: None,\n            sender: None,\n        }\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn send_command(\u0026self, command: \u0026str) -\u003e Result\u003cString\u003e {\n        use std::io::{Read, Write};\n\n        let port = self.port.as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to MaiTai '{}'\", self.id))?;\n\n        let mut port = port.blocking_lock();\n\n        // Send command (MaiTai uses CR as terminator)\n        let cmd = format!(\"{}\\r\", command);\n        port.write_all(cmd.as_bytes())\n            .with_context(|| format!(\"Failed to send command to MaiTai '{}'\", self.id))?;\n\n        // Read response\n        let mut buffer = [0u8; 256];\n        let mut response = String::new();\n        let start = std::time::Instant::now();\n\n        while start.elapsed() \u003c std::time::Duration::from_secs(2) {\n            if let Ok(n) = port.read(\u0026mut buffer) {\n                response.push_str(\u0026String::from_utf8_lossy(\u0026buffer[..n]));\n                if response.contains('\\r') {\n                    break;\n                }\n            }\n            std::thread::sleep(std::time::Duration::from_millis(10));\n        }\n\n        Ok(response.trim().to_string())\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn query_value(\u0026self, command: \u0026str) -\u003e Result\u003cf64\u003e {\n        let response = self.send_command(command)?;\n        // Remove command echo if present\n        let value_str = response.split(':').last().unwrap_or(\u0026response);\n        value_str.trim().parse::\u003cf64\u003e()\n            .with_context(|| format!(\"Failed to parse response '{}' as float\", response))\n    }\n}\n\n#[async_trait]\nimpl Instrument for MaiTai {\n    fn name(\u0026self) -\u003e String {\n        self.id.clone()\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to MaiTai laser: {}\", self.id);\n\n        let instrument_config = settings\n            .instruments\n            .get(\u0026self.id)\n            .ok_or_else(|| anyhow!(\"Configuration for '{}' not found\", self.id))?;\n\n        let port_name = instrument_config\n            .get(\"port\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| anyhow!(\"'port' not found in config for '{}'\", self.id))?;\n\n        let baud_rate = instrument_config\n            .get(\"baud_rate\")\n            .and_then(|v| v.as_integer())\n            .unwrap_or(9600) as u32;\n\n        // Open serial port\n        let port = serialport::new(port_name, baud_rate)\n            .timeout(std::time::Duration::from_millis(500))\n            .open()\n            .with_context(|| format!(\"Failed to open serial port '{}' for MaiTai\", port_name))?;\n\n        self.port = Some(Arc::new(tokio::sync::Mutex::new(port)));\n\n        // Verify connection with identity query\n        let id_response = self.send_command(\"*IDN?\")?;\n        info!(\"MaiTai identity: {}\", id_response);\n\n        // Set wavelength if specified\n        if let Some(wavelength) = instrument_config.get(\"wavelength\").and_then(|v| v.as_float()) {\n            self.send_command(\u0026format!(\"WAVELENGTH:{}\", wavelength))?;\n            info!(\"Set wavelength to {} nm\", wavelength);\n        }\n\n        // Create broadcast channel\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        // Spawn polling task\n        let instrument = self.clone();\n        let polling_rate = instrument_config\n            .get(\"polling_rate_hz\")\n            .and_then(|v| v.as_float())\n            .unwrap_or(1.0);\n\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(\n                std::time::Duration::from_secs_f64(1.0 / polling_rate)\n            );\n\n            loop {\n                interval.tick().await;\n\n                let timestamp = chrono::Utc::now();\n\n                // Query wavelength\n                if let Ok(wavelength) = instrument.query_value(\"WAVELENGTH?\") {\n                    let dp = DataPoint {\n                        timestamp,\n                        channel: format!(\"{}_wavelength\", instrument.id),\n                        value: wavelength,\n                        unit: \"nm\".to_string(),\n                        metadata: None,\n                    };\n                    if sender.send(dp).is_err() {\n                        warn!(\"No active receivers for MaiTai data\");\n                        break;\n                    }\n                }\n\n                // Query power\n                if let Ok(power) = instrument.query_value(\"POWER?\") {\n                    let dp = DataPoint {\n                        timestamp,\n                        channel: format!(\"{}_power\", instrument.id),\n                        value: power,\n                        unit: \"W\".to_string(),\n                        metadata: None,\n                    };\n                    let _ = sender.send(dp);\n                }\n\n                // Query shutter state\n                if let Ok(shutter) = instrument.query_value(\"SHUTTER?\") {\n                    let dp = DataPoint {\n                        timestamp,\n                        channel: format!(\"{}_shutter\", instrument.id),\n                        value: shutter,\n                        unit: \"state\".to_string(),\n                        metadata: None,\n                    };\n                    let _ = sender.send(dp);\n                }\n            }\n        });\n\n        info!(\"MaiTai laser '{}' connected successfully\", self.id);\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn connect(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled. Rebuild with --features instrument_serial\"))\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from MaiTai laser: {}\", self.id);\n        #[cfg(feature = \"instrument_serial\")]\n        {\n            self.port = None;\n        }\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to MaiTai '{}'\", self.id))\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn handle_command(\u0026mut self, command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        match command {\n            InstrumentCommand::SetParameter(key, value) =\u003e {\n                match key.as_str() {\n                    \"wavelength\" =\u003e {\n                        let wavelength: f64 = value.parse()\n                            .with_context(|| format!(\"Invalid wavelength value: {}\", value))?;\n                        self.send_command(\u0026format!(\"WAVELENGTH:{}\", wavelength))?;\n                        info!(\"Set MaiTai wavelength to {} nm\", wavelength);\n                    }\n                    \"shutter\" =\u003e {\n                        let cmd = match value.as_str() {\n                            \"open\" =\u003e \"SHUTTER:1\",\n                            \"close\" =\u003e \"SHUTTER:0\",\n                            _ =\u003e return Err(anyhow!(\"Invalid shutter value: {}\", value)),\n                        };\n                        self.send_command(cmd)?;\n                        info!(\"MaiTai shutter: {}\", value);\n                    }\n                    \"laser\" =\u003e {\n                        let cmd = match value.as_str() {\n                            \"on\" =\u003e \"ON\",\n                            \"off\" =\u003e \"OFF\",\n                            _ =\u003e return Err(anyhow!(\"Invalid laser value: {}\", value)),\n                        };\n                        self.send_command(cmd)?;\n                        info!(\"MaiTai laser: {}\", value);\n                    }\n                    _ =\u003e {\n                        warn!(\"Unknown parameter '{}' for MaiTai\", key);\n                    }\n                }\n            }\n            _ =\u003e {\n                warn!(\"Unsupported command type for MaiTai\");\n            }\n        }\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn handle_command(\u0026mut self, _command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled\"))\n    }\n}\n","traces":[{"line":41,"address":[32987632],"length":1,"stats":{"Line":0}},{"line":43,"address":[32626215],"length":1,"stats":{"Line":0}},{"line":51,"address":[32628053,32628140,32626288],"length":1,"stats":{"Line":0}},{"line":54,"address":[32626354,32626387,32626447],"length":1,"stats":{"Line":0}},{"line":55,"address":[32561959,32562015],"length":1,"stats":{"Line":0}},{"line":57,"address":[35546161],"length":1,"stats":{"Line":0}},{"line":60,"address":[35546197,35546268],"length":1,"stats":{"Line":0}},{"line":61,"address":[35546646,35546368,35546447,35546556],"length":1,"stats":{"Line":0}},{"line":62,"address":[37849657,37849632],"length":1,"stats":{"Line":0}},{"line":65,"address":[35546667],"length":1,"stats":{"Line":0}},{"line":66,"address":[35546814],"length":1,"stats":{"Line":0}},{"line":67,"address":[32627141,32627226],"length":1,"stats":{"Line":0}},{"line":69,"address":[32562825],"length":1,"stats":{"Line":0}},{"line":70,"address":[32627562,32627437],"length":1,"stats":{"Line":0}},{"line":71,"address":[32563162,32563252],"length":1,"stats":{"Line":0}},{"line":72,"address":[38183256],"length":1,"stats":{"Line":0}},{"line":76,"address":[32628064],"length":1,"stats":{"Line":0}},{"line":79,"address":[35547588,35547097],"length":1,"stats":{"Line":0}},{"line":83,"address":[38184141,38184135,38183600],"length":1,"stats":{"Line":0}},{"line":84,"address":[32989641],"length":1,"stats":{"Line":0}},{"line":86,"address":[32628378,32628446],"length":1,"stats":{"Line":0}},{"line":87,"address":[35548288],"length":1,"stats":{"Line":0}},{"line":88,"address":[37488320,37488345],"length":1,"stats":{"Line":0}},{"line":94,"address":[38184400],"length":1,"stats":{"Line":0}},{"line":95,"address":[38184417],"length":1,"stats":{"Line":0}},{"line":99,"address":[32629054],"length":1,"stats":{"Line":0}},{"line":100,"address":[40408329,40408458,40408498],"length":1,"stats":{"Line":0}},{"line":102,"address":[37850558,37850729,37854555,37850232,37850640],"length":1,"stats":{"Line":0}},{"line":104,"address":[37424706],"length":1,"stats":{"Line":0}},{"line":105,"address":[37493186,37489157,37489273,37493168],"length":1,"stats":{"Line":0}},{"line":107,"address":[37425035,37425109,37428678],"length":1,"stats":{"Line":0}},{"line":109,"address":[37489381,37493296,37493305],"length":1,"stats":{"Line":0}},{"line":110,"address":[37854786,37850872,37850949,37854768],"length":1,"stats":{"Line":0}},{"line":112,"address":[37425308],"length":1,"stats":{"Line":0}},{"line":113,"address":[37425194],"length":1,"stats":{"Line":0}},{"line":114,"address":[37046201,37042485,37046192],"length":1,"stats":{"Line":0}},{"line":115,"address":[37489692],"length":1,"stats":{"Line":0}},{"line":118,"address":[37490105,37489803,37489891,37489733,37490031,37493051],"length":1,"stats":{"Line":0}},{"line":119,"address":[37851256,37851278,37851208,37851339,37854504],"length":1,"stats":{"Line":0}},{"line":121,"address":[37046224,37042852,37046249,37042913],"length":1,"stats":{"Line":0}},{"line":123,"address":[37851787,37851630,37851721],"length":1,"stats":{"Line":0}},{"line":126,"address":[37851835,37854448],"length":1,"stats":{"Line":0}},{"line":127,"address":[37043395,37043491,37043535],"length":1,"stats":{"Line":0}},{"line":130,"address":[37855065,37855056,37852145,37852471],"length":1,"stats":{"Line":0}},{"line":131,"address":[37853371,37852626,37852565],"length":1,"stats":{"Line":0}},{"line":132,"address":[37491602],"length":1,"stats":{"Line":0}},{"line":136,"address":[40410832,40411676],"length":1,"stats":{"Line":0}},{"line":137,"address":[37427724,37427664],"length":1,"stats":{"Line":0}},{"line":140,"address":[37853683,37853633],"length":1,"stats":{"Line":0}},{"line":141,"address":[37853826],"length":1,"stats":{"Line":0}},{"line":143,"address":[37855088,37855097,37853762],"length":1,"stats":{"Line":0}},{"line":146,"address":[37427979,37429530,37429297,37430885,37430952,37429264,37429380],"length":1,"stats":{"Line":0}},{"line":147,"address":[37855331],"length":1,"stats":{"Line":0}},{"line":148,"address":[37046499],"length":1,"stats":{"Line":0}},{"line":152,"address":[37046652,37046709,37046559,37049116,37046730],"length":1,"stats":{"Line":0}},{"line":154,"address":[37494252],"length":1,"stats":{"Line":0}},{"line":157,"address":[37046996,37047060],"length":1,"stats":{"Line":0}},{"line":158,"address":[37494625],"length":1,"stats":{"Line":0}},{"line":160,"address":[37430015,37429952],"length":1,"stats":{"Line":0}},{"line":162,"address":[37047243],"length":1,"stats":{"Line":0}},{"line":163,"address":[37430201],"length":1,"stats":{"Line":0}},{"line":165,"address":[40414440],"length":1,"stats":{"Line":0}},{"line":166,"address":[37047671,37047601],"length":1,"stats":{"Line":0}},{"line":172,"address":[40415059,40415127],"length":1,"stats":{"Line":0}},{"line":173,"address":[37431312],"length":1,"stats":{"Line":0}},{"line":175,"address":[37856974,37856911],"length":1,"stats":{"Line":0}},{"line":177,"address":[37431218],"length":1,"stats":{"Line":0}},{"line":178,"address":[37857160],"length":1,"stats":{"Line":0}},{"line":180,"address":[37048531],"length":1,"stats":{"Line":0}},{"line":184,"address":[40415601,40415669],"length":1,"stats":{"Line":0}},{"line":185,"address":[37496268],"length":1,"stats":{"Line":0}},{"line":187,"address":[40415755,40415692],"length":1,"stats":{"Line":0}},{"line":189,"address":[37496175],"length":1,"stats":{"Line":0}},{"line":190,"address":[37857700],"length":1,"stats":{"Line":0}},{"line":192,"address":[37857843],"length":1,"stats":{"Line":0}},{"line":197,"address":[37853995,37854097],"length":1,"stats":{"Line":0}},{"line":198,"address":[37045363],"length":1,"stats":{"Line":0}},{"line":206,"address":[40416240,40416453,40416362,40416426,40416369,40416319,40416268,40416915],"length":1,"stats":{"Line":0}},{"line":207,"address":[37049456,37049345,37049481],"length":1,"stats":{"Line":0}},{"line":210,"address":[37496827,37497095],"length":1,"stats":{"Line":0}},{"line":212,"address":[40416843,40416823],"length":1,"stats":{"Line":0}},{"line":213,"address":[37858651],"length":1,"stats":{"Line":0}},{"line":216,"address":[37859105,37858935,37858720,37858809,37858983,37858758,37858884,37858877],"length":1,"stats":{"Line":0}},{"line":217,"address":[37050084],"length":1,"stats":{"Line":0}},{"line":219,"address":[37497705,37497587,37497696],"length":1,"stats":{"Line":0}},{"line":220,"address":[37050370,37050244,37050352],"length":1,"stats":{"Line":0}},{"line":224,"address":[40421550,40417702,40421671,40421751,40421616,40417567,40417536,40417646,40422117,40421714,40417761,40421846],"length":1,"stats":{"Line":0}},{"line":225,"address":[37859508],"length":1,"stats":{"Line":0}},{"line":226,"address":[37859540],"length":1,"stats":{"Line":0}},{"line":227,"address":[37050796,37050927],"length":1,"stats":{"Line":0}},{"line":228,"address":[37050949],"length":1,"stats":{"Line":0}},{"line":229,"address":[37436580,37437586,37433998,37436469,37436523],"length":1,"stats":{"Line":0}},{"line":230,"address":[40422249,40420584,40420660,40422224],"length":1,"stats":{"Line":0}},{"line":231,"address":[37436633,37437545],"length":1,"stats":{"Line":0}},{"line":232,"address":[37054074],"length":1,"stats":{"Line":0}},{"line":234,"address":[37051004,37051071],"length":1,"stats":{"Line":0}},{"line":235,"address":[37434087,37435528],"length":1,"stats":{"Line":0}},{"line":236,"address":[40419646,40419727],"length":1,"stats":{"Line":0}},{"line":237,"address":[37435605,37435670,37435703],"length":1,"stats":{"Line":0}},{"line":238,"address":[37500092,37500151],"length":1,"stats":{"Line":0}},{"line":240,"address":[37435891,37436440],"length":1,"stats":{"Line":0}},{"line":241,"address":[37436111],"length":1,"stats":{"Line":0}},{"line":243,"address":[37498469,37498536],"length":1,"stats":{"Line":0}},{"line":244,"address":[37051580,37051219],"length":1,"stats":{"Line":0}},{"line":245,"address":[40418658,40418739],"length":1,"stats":{"Line":0}},{"line":246,"address":[37860571,37860473,37860538],"length":1,"stats":{"Line":0}},{"line":247,"address":[37499104,37499163],"length":1,"stats":{"Line":0}},{"line":249,"address":[40419016,40419595],"length":1,"stats":{"Line":0}},{"line":250,"address":[37499559],"length":1,"stats":{"Line":0}},{"line":253,"address":[37859982,37860096,37860068],"length":1,"stats":{"Line":0}},{"line":258,"address":[37433779,37437796],"length":1,"stats":{"Line":0}},{"line":261,"address":[37437496],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":112},{"path":["/","app","src","instrument","mock.rs"],"content":"//! A mock instrument that generates synthetic data.\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument},\n};\nuse anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse log::info;\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\nuse tokio::time::{interval, Duration};\n\npub struct MockInstrument {\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n}\n\nimpl Default for MockInstrument {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl MockInstrument {\n    pub fn new() -\u003e Self {\n        Self { sender: None }\n    }\n}\n\n#[async_trait]\nimpl Instrument for MockInstrument {\n    fn name(\u0026self) -\u003e String {\n        \"Mock Instrument\".to_string()\n    }\n\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to Mock Instrument...\");\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        let settings = settings.clone();\n        // Spawn a task to generate data\n        tokio::spawn(async move {\n            let config = settings.instruments.get(\"mock\").unwrap().clone();\n            let sample_rate = config.get(\"sample_rate_hz\").unwrap().as_float().unwrap();\n            let num_samples = config.get(\"num_samples\").unwrap().as_integer().unwrap() as usize;\n            let mut interval = interval(Duration::from_secs_f64(1.0 / sample_rate));\n            let mut phase: f64 = 0.0;\n\n            for _ in 0..num_samples {\n                interval.tick().await;\n                let now = chrono::Utc::now();\n                phase += 0.1;\n\n                // Use a simple deterministic noise instead of thread_rng for Send compatibility\n                let noise = (phase * 37.0).sin() * 0.05;\n\n                let sine_dp = DataPoint {\n                    timestamp: now,\n                    channel: \"sine_wave\".to_string(),\n                    value: phase.sin() + noise,\n                    unit: \"V\".to_string(),\n                    metadata: None,\n                };\n                let cosine_dp = DataPoint {\n                    timestamp: now,\n                    channel: \"cosine_wave\".to_string(),\n                    value: phase.cos() + noise * 0.8,\n                    unit: \"V\".to_string(),\n                    metadata: None,\n                };\n\n                // Ignore errors if no receivers are active\n                if sender.send(sine_dp).is_err() || sender.send(cosine_dp).is_err() {\n                    // Stop if the receiver has been dropped\n                    break;\n                }\n            }\n            info!(\n                \"Mock instrument finished generating {} samples.\",\n                num_samples\n            );\n        });\n\n        Ok(())\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from Mock Instrument.\");\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to mock instrument\"))\n    }\n}\n","traces":[{"line":18,"address":[31517312],"length":1,"stats":{"Line":0}},{"line":19,"address":[31297889],"length":1,"stats":{"Line":0}},{"line":31,"address":[28569488],"length":1,"stats":{"Line":0}},{"line":32,"address":[28930945],"length":1,"stats":{"Line":0}},{"line":35,"address":[31297982],"length":1,"stats":{"Line":12}},{"line":36,"address":[37599977,37600088,37600128],"length":1,"stats":{"Line":6}},{"line":37,"address":[37961765,37961534],"length":1,"stats":{"Line":4}},{"line":38,"address":[29447465,29447499],"length":1,"stats":{"Line":2}},{"line":40,"address":[40520184],"length":1,"stats":{"Line":2}},{"line":42,"address":[40520432,40520571,40521403,40523390,40523860,40520217,40520471],"length":1,"stats":{"Line":6}},{"line":43,"address":[37536440,37536570],"length":1,"stats":{"Line":4}},{"line":44,"address":[29448098,29448185],"length":1,"stats":{"Line":4}},{"line":45,"address":[37536897],"length":1,"stats":{"Line":2}},{"line":46,"address":[40521176],"length":1,"stats":{"Line":2}},{"line":47,"address":[29448567],"length":1,"stats":{"Line":2}},{"line":49,"address":[37963124,37964965,37963023],"length":1,"stats":{"Line":6}},{"line":50,"address":[28545681],"length":1,"stats":{"Line":9}},{"line":51,"address":[37963445],"length":1,"stats":{"Line":2}},{"line":52,"address":[29449012],"length":1,"stats":{"Line":2}},{"line":55,"address":[37602054],"length":1,"stats":{"Line":2}},{"line":57,"address":[29449341],"length":1,"stats":{"Line":2}},{"line":59,"address":[29449097],"length":1,"stats":{"Line":2}},{"line":60,"address":[29449171,29449242],"length":1,"stats":{"Line":4}},{"line":61,"address":[37602272],"length":1,"stats":{"Line":2}},{"line":62,"address":[37537937],"length":1,"stats":{"Line":2}},{"line":64,"address":[37538366],"length":1,"stats":{"Line":2}},{"line":66,"address":[37538088],"length":1,"stats":{"Line":2}},{"line":67,"address":[37964111,37964032],"length":1,"stats":{"Line":4}},{"line":68,"address":[37602685],"length":1,"stats":{"Line":2}},{"line":69,"address":[37538358],"length":1,"stats":{"Line":2}},{"line":73,"address":[40522605,40522797],"length":1,"stats":{"Line":4}},{"line":78,"address":[37603792,37603760,37603574],"length":1,"stats":{"Line":3}},{"line":84,"address":[37962080],"length":1,"stats":{"Line":2}},{"line":87,"address":[37604336,37604549,37604465,37604522,37604889,37604458,37604415,37604364],"length":1,"stats":{"Line":0}},{"line":88,"address":[37540176,37540201,37540065],"length":1,"stats":{"Line":0}},{"line":89,"address":[37540403,37540187],"length":1,"stats":{"Line":0}},{"line":90,"address":[37604865],"length":1,"stats":{"Line":0}},{"line":93,"address":[29452078,29452036,29451929,29451840,29451878,29451991,29451998,29452179],"length":1,"stats":{"Line":12}},{"line":96,"address":[37540896,37540798,37540905],"length":1,"stats":{"Line":6}},{"line":97,"address":[37540928,37540932,37540827],"length":1,"stats":{"Line":2}}],"covered":32,"coverable":40},{"path":["/","app","src","instrument","mod.rs"],"content":"//! Instrument trait, registry, and implementations.\nuse crate::core::Instrument;\nuse std::collections::HashMap;\n\npub mod mock;\npub mod scpi;\n#[cfg(feature = \"instrument_visa\")]\npub mod visa;\n\n#[cfg(feature = \"instrument_serial\")]\npub mod newport_1830c;\n\n#[cfg(feature = \"instrument_serial\")]\npub mod maitai;\n\n#[cfg(feature = \"instrument_serial\")]\npub mod elliptec;\n\n#[cfg(feature = \"instrument_serial\")]\npub mod esp300;\n\npub mod pvcam;\n\ntype InstrumentFactory = Box\u003cdyn Fn(\u0026str) -\u003e Box\u003cdyn Instrument\u003e + Send + Sync\u003e;\n\n/// A registry for available instrument types.\npub struct InstrumentRegistry {\n    factories: HashMap\u003cString, InstrumentFactory\u003e,\n}\n\nimpl Default for InstrumentRegistry {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl InstrumentRegistry {\n    pub fn new() -\u003e Self {\n        Self {\n            factories: HashMap::new(),\n        }\n    }\n\n    /// Registers a new instrument type.\n    pub fn register\u003cF\u003e(\u0026mut self, instrument_type: \u0026str, factory: F)\n    where\n        F: Fn(\u0026str) -\u003e Box\u003cdyn Instrument\u003e + Send + Sync + 'static,\n    {\n        self.factories\n            .insert(instrument_type.to_string(), Box::new(factory));\n    }\n\n    /// Creates an instance of an instrument by its ID.\n    pub fn create(\u0026self, instrument_type: \u0026str, id: \u0026str) -\u003e Option\u003cBox\u003cdyn Instrument\u003e\u003e {\n        self.factories\n            .get(instrument_type)\n            .map(|factory| factory(id))\n    }\n\n    /// Lists the IDs of all registered instruments.\n    pub fn list(\u0026self) -\u003e impl Iterator\u003cItem = String\u003e + '_ {\n        self.factories.keys().cloned()\n    }\n}\n","traces":[{"line":32,"address":[37229456],"length":1,"stats":{"Line":0}},{"line":33,"address":[39789896],"length":1,"stats":{"Line":0}},{"line":38,"address":[29289632],"length":1,"stats":{"Line":2}},{"line":40,"address":[36868062],"length":1,"stats":{"Line":2}},{"line":45,"address":[28262059,28261808,28262065],"length":1,"stats":{"Line":2}},{"line":49,"address":[28261961,28261835,28262005],"length":1,"stats":{"Line":6}},{"line":50,"address":[29069982,29070461,29070303,29069710,29069917,29070682,29071027,29069487,29069322,29071144,29070189,29070755,29070211,29070526,29070847,29071005,29069512,29069594,29070798,29070410,29070600,29070872,29070138,29071119,29070575,29069395,29069759,29070031,29070483,29069438,29069645,29069866,29070328,29069373,29070733,29071070,29070254,29069784,29070056,29069667,29069939,29070954],"length":1,"stats":{"Line":8}},{"line":54,"address":[36868112],"length":1,"stats":{"Line":2}},{"line":56,"address":[39790022],"length":1,"stats":{"Line":2}},{"line":57,"address":[36887408,36887443],"length":1,"stats":{"Line":6}},{"line":61,"address":[36803776],"length":1,"stats":{"Line":0}},{"line":62,"address":[36803795],"length":1,"stats":{"Line":0}}],"covered":8,"coverable":12},{"path":["/","app","src","instrument","newport_1830c.rs"],"content":"//! Newport 1830-C Optical Power Meter driver\n//!\n//! This module provides an `Instrument` implementation for the Newport 1830-C\n//! optical power meter using RS-232 serial communication.\n//!\n//! ## Configuration\n//!\n//! The Newport 1830-C is configured in the `config/default.toml` file:\n//!\n//! ```toml\n//! [instruments.power_meter_1]\n//! type = \"newport_1830c\"\n//! port = \"/dev/ttyUSB0\"\n//! baud_rate = 9600\n//! wavelength = 1550.0  # nm\n//! range = 0  # 0=autorange\n//! units = 0  # 0=Watts, 1=dBm, 2=dB, 3=REL\n//! ```\n\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument, InstrumentCommand},\n};\nuse anyhow::{anyhow, Context, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\n\n#[cfg(feature = \"instrument_serial\")]\nuse serialport::SerialPort;\n\n/// Newport 1830-C instrument implementation\n#[derive(Clone)]\npub struct Newport1830C {\n    id: String,\n    #[cfg(feature = \"instrument_serial\")]\n    port: Option\u003cArc\u003ctokio::sync::Mutex\u003cBox\u003cdyn SerialPort\u003e\u003e\u003e\u003e,\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n}\n\nimpl Newport1830C {\n    /// Creates a new Newport1830C instrument\n    pub fn new(id: \u0026str) -\u003e Self {\n        Self {\n            id: id.to_string(),\n            #[cfg(feature = \"instrument_serial\")]\n            port: None,\n            sender: None,\n        }\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    fn send_command(\u0026self, command: \u0026str) -\u003e Result\u003cString\u003e {\n        use std::io::{Read, Write};\n\n        let port = self.port.as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to Newport 1830-C '{}'\", self.id))?;\n\n        let mut port = port.blocking_lock();\n\n        // Send command\n        let cmd = format!(\"{}\\r\\n\", command);\n        port.write_all(cmd.as_bytes())\n            .with_context(|| format!(\"Failed to send command to Newport 1830-C '{}'\", self.id))?;\n\n        // Read response\n        let mut buffer = [0u8; 256];\n        let mut response = String::new();\n        let start = std::time::Instant::now();\n\n        while start.elapsed() \u003c std::time::Duration::from_secs(1) {\n            if let Ok(n) = port.read(\u0026mut buffer) {\n                response.push_str(\u0026String::from_utf8_lossy(\u0026buffer[..n]));\n                if response.contains('\\r') || response.contains('\\n') {\n                    break;\n                }\n            }\n            std::thread::sleep(std::time::Duration::from_millis(10));\n        }\n\n        Ok(response.trim().to_string())\n    }\n}\n\n#[async_trait]\nimpl Instrument for Newport1830C {\n    fn name(\u0026self) -\u003e String {\n        self.id.clone()\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to Newport 1830-C: {}\", self.id);\n\n        let instrument_config = settings\n            .instruments\n            .get(\u0026self.id)\n            .ok_or_else(|| anyhow!(\"Configuration for '{}' not found\", self.id))?;\n\n        let port_name = instrument_config\n            .get(\"port\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| anyhow!(\"'port' not found in config for '{}'\", self.id))?;\n\n        let baud_rate = instrument_config\n            .get(\"baud_rate\")\n            .and_then(|v| v.as_integer())\n            .unwrap_or(9600) as u32;\n\n        // Open serial port\n        let port = serialport::new(port_name, baud_rate)\n            .timeout(std::time::Duration::from_millis(100))\n            .open()\n            .with_context(|| format!(\"Failed to open serial port '{}' for Newport 1830-C\", port_name))?;\n\n        self.port = Some(Arc::new(tokio::sync::Mutex::new(port)));\n\n        // Configure wavelength if specified\n        if let Some(wavelength) = instrument_config.get(\"wavelength\").and_then(|v| v.as_float()) {\n            self.send_command(\u0026format!(\"PM:Lambda {}\", wavelength))?;\n            info!(\"Set wavelength to {} nm\", wavelength);\n        }\n\n        // Configure range if specified\n        if let Some(range) = instrument_config.get(\"range\").and_then(|v| v.as_integer()) {\n            self.send_command(\u0026format!(\"PM:Range {}\", range))?;\n            info!(\"Set range to {}\", range);\n        }\n\n        // Configure units if specified\n        if let Some(units) = instrument_config.get(\"units\").and_then(|v| v.as_integer()) {\n            self.send_command(\u0026format!(\"PM:Units {}\", units))?;\n            let unit_str = match units {\n                0 =\u003e \"Watts\",\n                1 =\u003e \"dBm\",\n                2 =\u003e \"dB\",\n                3 =\u003e \"REL\",\n                _ =\u003e \"Unknown\",\n            };\n            info!(\"Set units to {}\", unit_str);\n        }\n\n        // Create broadcast channel\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        // Spawn polling task\n        let instrument = self.clone();\n        let polling_rate = instrument_config\n            .get(\"polling_rate_hz\")\n            .and_then(|v| v.as_float())\n            .unwrap_or(10.0);\n\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(\n                std::time::Duration::from_secs_f64(1.0 / polling_rate)\n            );\n\n            loop {\n                interval.tick().await;\n\n                // Query power measurement\n                match instrument.send_command(\"PM:Power?\") {\n                    Ok(response) =\u003e {\n                        if let Ok(value) = response.parse::\u003cf64\u003e() {\n                            let dp = DataPoint {\n                                timestamp: chrono::Utc::now(),\n                                channel: format!(\"{}_power\", instrument.id),\n                                value,\n                                unit: \"W\".to_string(),\n                                metadata: None,\n                            };\n\n                            if sender.send(dp).is_err() {\n                                warn!(\"No active receivers for Newport 1830-C data\");\n                                break;\n                            }\n                        }\n                    }\n                    Err(e) =\u003e {\n                        warn!(\"Failed to read from Newport 1830-C: {}\", e);\n                    }\n                }\n            }\n        });\n\n        info!(\"Newport 1830-C '{}' connected successfully\", self.id);\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn connect(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled. Rebuild with --features instrument_serial\"))\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from Newport 1830-C: {}\", self.id);\n        #[cfg(feature = \"instrument_serial\")]\n        {\n            self.port = None;\n        }\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to Newport 1830-C '{}'\", self.id))\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    async fn handle_command(\u0026mut self, command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        match command {\n            InstrumentCommand::SetParameter(key, value) =\u003e {\n                match key.as_str() {\n                    \"wavelength\" =\u003e {\n                        let wavelength: f64 = value.parse()\n                            .with_context(|| format!(\"Invalid wavelength value: {}\", value))?;\n                        self.send_command(\u0026format!(\"PM:Lambda {}\", wavelength))?;\n                        info!(\"Set Newport 1830-C wavelength to {} nm\", wavelength);\n                    }\n                    \"range\" =\u003e {\n                        let range: i32 = value.parse()\n                            .with_context(|| format!(\"Invalid range value: {}\", value))?;\n                        self.send_command(\u0026format!(\"PM:Range {}\", range))?;\n                        info!(\"Set Newport 1830-C range to {}\", range);\n                    }\n                    \"units\" =\u003e {\n                        let units: i32 = value.parse()\n                            .with_context(|| format!(\"Invalid units value: {}\", value))?;\n                        self.send_command(\u0026format!(\"PM:Units {}\", units))?;\n                        info!(\"Set Newport 1830-C units to {}\", units);\n                    }\n                    _ =\u003e {\n                        warn!(\"Unknown parameter '{}' for Newport 1830-C\", key);\n                    }\n                }\n            }\n            InstrumentCommand::Execute(cmd, _) =\u003e {\n                if cmd == \"zero\" {\n                    self.send_command(\"PM:DS:Clear\")?;\n                    info!(\"Newport 1830-C zeroed\");\n                }\n            }\n            _ =\u003e {\n                warn!(\"Unsupported command type for Newport 1830-C\");\n            }\n        }\n        Ok(())\n    }\n\n    #[cfg(not(feature = \"instrument_serial\"))]\n    async fn handle_command(\u0026mut self, _command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        Err(anyhow!(\"Serial support not enabled\"))\n    }\n}\n","traces":[{"line":44,"address":[37726544],"length":1,"stats":{"Line":0}},{"line":46,"address":[40286999],"length":1,"stats":{"Line":0}},{"line":54,"address":[37365200,37367054,37367141],"length":1,"stats":{"Line":0}},{"line":57,"address":[40287138,40287231,40287171],"length":1,"stats":{"Line":0}},{"line":58,"address":[38071968,38071986],"length":1,"stats":{"Line":0}},{"line":60,"address":[29285853],"length":1,"stats":{"Line":0}},{"line":63,"address":[37365429,37365500],"length":1,"stats":{"Line":0}},{"line":64,"address":[37365878,37365679,37365788,37365600],"length":1,"stats":{"Line":0}},{"line":65,"address":[29486601,29486576],"length":1,"stats":{"Line":0}},{"line":68,"address":[37727339],"length":1,"stats":{"Line":0}},{"line":69,"address":[40287918],"length":1,"stats":{"Line":0}},{"line":70,"address":[37366053,37366138],"length":1,"stats":{"Line":0}},{"line":72,"address":[37727593],"length":1,"stats":{"Line":0}},{"line":73,"address":[37366355,37366492],"length":1,"stats":{"Line":0}},{"line":74,"address":[37302092,37302182],"length":1,"stats":{"Line":0}},{"line":75,"address":[40288618,40288732],"length":1,"stats":{"Line":0}},{"line":79,"address":[29287480],"length":1,"stats":{"Line":0}},{"line":82,"address":[37302493,37301913],"length":1,"stats":{"Line":0}},{"line":88,"address":[37303008],"length":1,"stats":{"Line":0}},{"line":89,"address":[37367441],"length":1,"stats":{"Line":0}},{"line":93,"address":[37367486],"length":1,"stats":{"Line":0}},{"line":94,"address":[38136970,38136841,38137010],"length":1,"stats":{"Line":0}},{"line":96,"address":[29487048,29487444,29487370,29487529,29492707],"length":1,"stats":{"Line":0}},{"line":98,"address":[38498754],"length":1,"stats":{"Line":0}},{"line":99,"address":[38072933,38078450,38073049,38078432],"length":1,"stats":{"Line":0}},{"line":101,"address":[38499157,38504218,38499083],"length":1,"stats":{"Line":0}},{"line":103,"address":[38078560,38073157,38078569],"length":1,"stats":{"Line":0}},{"line":104,"address":[41067584,41062200,41062277,41067602],"length":1,"stats":{"Line":0}},{"line":106,"address":[38073500],"length":1,"stats":{"Line":0}},{"line":107,"address":[41062378],"length":1,"stats":{"Line":0}},{"line":108,"address":[41062417,41067712,41067721],"length":1,"stats":{"Line":0}},{"line":109,"address":[29487900],"length":1,"stats":{"Line":0}},{"line":112,"address":[38138083,38137995,38138297,38142735,38137925,38138223],"length":1,"stats":{"Line":0}},{"line":113,"address":[29488046,29492656,29488024,29487976,29488107],"length":1,"stats":{"Line":0}},{"line":115,"address":[29488289,29488228,29493072,29493097],"length":1,"stats":{"Line":0}},{"line":117,"address":[38499913,38499822,38499979],"length":1,"stats":{"Line":0}},{"line":120,"address":[38138595,38143296,38143305],"length":1,"stats":{"Line":0}},{"line":121,"address":[41063373,41064154,41063304],"length":1,"stats":{"Line":0}},{"line":122,"address":[29489194],"length":1,"stats":{"Line":0}},{"line":126,"address":[41064208,41063339,41067904,41067913],"length":1,"stats":{"Line":0}},{"line":127,"address":[41064297,41065147,41064366],"length":1,"stats":{"Line":0}},{"line":128,"address":[29490171],"length":1,"stats":{"Line":0}},{"line":132,"address":[38078953,38078944,38075340,38076193],"length":1,"stats":{"Line":0}},{"line":133,"address":[29490650,29490707,29491633],"length":1,"stats":{"Line":0}},{"line":134,"address":[38076765],"length":1,"stats":{"Line":0}},{"line":135,"address":[41065826],"length":1,"stats":{"Line":0}},{"line":136,"address":[38076863],"length":1,"stats":{"Line":0}},{"line":137,"address":[38502748],"length":1,"stats":{"Line":0}},{"line":138,"address":[38141337],"length":1,"stats":{"Line":0}},{"line":139,"address":[29491161],"length":1,"stats":{"Line":0}},{"line":141,"address":[38502804],"length":1,"stats":{"Line":0}},{"line":145,"address":[38140725,38141723],"length":1,"stats":{"Line":0}},{"line":146,"address":[38077451,38077391],"length":1,"stats":{"Line":0}},{"line":149,"address":[38141920,38141970],"length":1,"stats":{"Line":0}},{"line":150,"address":[41066689],"length":1,"stats":{"Line":0}},{"line":152,"address":[41067968,41066625,41067977],"length":1,"stats":{"Line":0}},{"line":155,"address":[38080840,38079289,38080913,38079044,38077706,38079008,38079136],"length":1,"stats":{"Line":0}},{"line":156,"address":[41068226],"length":1,"stats":{"Line":0}},{"line":157,"address":[41068095],"length":1,"stats":{"Line":0}},{"line":161,"address":[28546750],"length":1,"stats":{"Line":0}},{"line":164,"address":[38079606],"length":1,"stats":{"Line":0}},{"line":165,"address":[38505587],"length":1,"stats":{"Line":0}},{"line":166,"address":[29494075,29494146,29494207],"length":1,"stats":{"Line":0}},{"line":167,"address":[29494468],"length":1,"stats":{"Line":0}},{"line":168,"address":[29494231],"length":1,"stats":{"Line":0}},{"line":169,"address":[38505807],"length":1,"stats":{"Line":0}},{"line":171,"address":[38505926],"length":1,"stats":{"Line":0}},{"line":172,"address":[29494460],"length":1,"stats":{"Line":0}},{"line":175,"address":[38144715],"length":1,"stats":{"Line":0}},{"line":176,"address":[38080448,38080522],"length":1,"stats":{"Line":0}},{"line":181,"address":[41068662],"length":1,"stats":{"Line":0}},{"line":182,"address":[41069959,41069987,41068678],"length":1,"stats":{"Line":0}},{"line":188,"address":[38142282,38142387],"length":1,"stats":{"Line":0}},{"line":189,"address":[29492250],"length":1,"stats":{"Line":0}},{"line":197,"address":[38507891,38507216,38507244,38507295,38507338,38507402,38507345,38507429],"length":1,"stats":{"Line":0}},{"line":198,"address":[38146032,38145921,38146061],"length":1,"stats":{"Line":0}},{"line":201,"address":[38081895,38081627],"length":1,"stats":{"Line":0}},{"line":203,"address":[38146379,38146359],"length":1,"stats":{"Line":0}},{"line":204,"address":[38082011],"length":1,"stats":{"Line":0}},{"line":207,"address":[37729033],"length":1,"stats":{"Line":0}},{"line":208,"address":[38146676],"length":1,"stats":{"Line":0}},{"line":210,"address":[29496736,29496745,29496623],"length":1,"stats":{"Line":0}},{"line":211,"address":[29496786,29496660,29496768],"length":1,"stats":{"Line":0}},{"line":215,"address":[38152773,38147361,38152502,38147241,38147182,38151495,38149370,38151585,38152363,38151706,38147103,38147072,38152407],"length":1,"stats":{"Line":0}},{"line":216,"address":[29497140],"length":1,"stats":{"Line":0}},{"line":217,"address":[41071956],"length":1,"stats":{"Line":0}},{"line":218,"address":[41072028,41072226],"length":1,"stats":{"Line":0}},{"line":219,"address":[41072248],"length":1,"stats":{"Line":0}},{"line":220,"address":[41075125,41075071,41075182,41072337,41076250],"length":1,"stats":{"Line":0}},{"line":221,"address":[38514352,38511954,38512030,38514377],"length":1,"stats":{"Line":0}},{"line":222,"address":[38151636,38150662],"length":1,"stats":{"Line":0}},{"line":223,"address":[41075687],"length":1,"stats":{"Line":0}},{"line":225,"address":[41072370,41072303],"length":1,"stats":{"Line":0}},{"line":226,"address":[38147850,38149410,38150466,38149512,38149570],"length":1,"stats":{"Line":0}},{"line":227,"address":[38153040,38149554,38153065,38149485],"length":1,"stats":{"Line":0}},{"line":228,"address":[38149620,38150428],"length":1,"stats":{"Line":0}},{"line":229,"address":[38085656],"length":1,"stats":{"Line":0}},{"line":231,"address":[29497707,29497640],"length":1,"stats":{"Line":0}},{"line":232,"address":[38148303,38148463,38147942,38148405,38149384],"length":1,"stats":{"Line":0}},{"line":233,"address":[29498263,29502937,29498218,29502912],"length":1,"stats":{"Line":0}},{"line":234,"address":[41073089,41073897],"length":1,"stats":{"Line":0}},{"line":235,"address":[29498769],"length":1,"stats":{"Line":0}},{"line":238,"address":[41072465,41072551,41072579],"length":1,"stats":{"Line":0}},{"line":242,"address":[41072054],"length":1,"stats":{"Line":0}},{"line":243,"address":[29497334,29501567],"length":1,"stats":{"Line":0}},{"line":244,"address":[41076415,41076909],"length":1,"stats":{"Line":0}},{"line":245,"address":[38513495],"length":1,"stats":{"Line":0}},{"line":249,"address":[38083126,38088132],"length":1,"stats":{"Line":0}},{"line":252,"address":[38087145],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":109},{"path":["/","app","src","instrument","pvcam.rs"],"content":"//! Photometrics PVCAM camera driver (PrimeBSI)\n//!\n//! This module provides an `Instrument` implementation for Photometrics cameras\n//! using the PVCAM SDK.\n//!\n//! ## Configuration\n//!\n//! ```toml\n//! [instruments.prime_bsi]\n//! type = \"pvcam\"\n//! camera_name = \"PrimeBSI\"\n//! exposure_ms = 100.0\n//! roi = [0, 0, 2048, 2048]  # [x, y, width, height]\n//! binning = [1, 1]  # [x_bin, y_bin]\n//! polling_rate_hz = 10.0\n//! ```\n//!\n//! Note: This driver requires the PVCAM SDK to be installed and linked.\n\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument, InstrumentCommand},\n};\nuse anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\n\n/// PVCAM camera instrument implementation\n#[derive(Clone)]\npub struct PVCAMCamera {\n    id: String,\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n    camera_name: String,\n    exposure_ms: f64,\n}\n\nimpl PVCAMCamera {\n    /// Creates a new PVCAM camera instrument\n    pub fn new(id: \u0026str) -\u003e Self {\n        Self {\n            id: id.to_string(),\n            sender: None,\n            camera_name: \"PrimeBSI\".to_string(),\n            exposure_ms: 100.0,\n        }\n    }\n\n    // Note: Actual PVCAM SDK calls would go here\n    // This is a placeholder implementation that generates synthetic data\n    fn simulate_frame_data(\u0026self) -\u003e Vec\u003cu16\u003e {\n        // Generate a 512x512 synthetic image\n        let width = 512;\n        let height = 512;\n        let mut frame = vec![0u16; width * height];\n\n        // Simple pattern for testing\n        for y in 0..height {\n            for x in 0..width {\n                let value = ((x + y) % 256) as u16 * 256;\n                frame[y * width + x] = value;\n            }\n        }\n\n        frame\n    }\n\n    fn calculate_frame_stats(\u0026self, frame: \u0026[u16]) -\u003e (f64, f64, f64) {\n        if frame.is_empty() {\n            return (0.0, 0.0, 0.0);\n        }\n\n        let sum: u64 = frame.iter().map(|\u0026v| v as u64).sum();\n        let mean = sum as f64 / frame.len() as f64;\n\n        let min = *frame.iter().min().unwrap_or(\u00260) as f64;\n        let max = *frame.iter().max().unwrap_or(\u00260) as f64;\n\n        (mean, min, max)\n    }\n}\n\n#[async_trait]\nimpl Instrument for PVCAMCamera {\n    fn name(\u0026self) -\u003e String {\n        self.id.clone()\n    }\n\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to PVCAM camera: {}\", self.id);\n\n        let instrument_config = settings\n            .instruments\n            .get(\u0026self.id)\n            .ok_or_else(|| anyhow!(\"Configuration for '{}' not found\", self.id))?;\n\n        self.camera_name = instrument_config\n            .get(\"camera_name\")\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"PrimeBSI\")\n            .to_string();\n\n        self.exposure_ms = instrument_config\n            .get(\"exposure_ms\")\n            .and_then(|v| v.as_float())\n            .unwrap_or(100.0);\n\n        info!(\"Camera: {}, Exposure: {} ms\", self.camera_name, self.exposure_ms);\n\n        // TODO: Initialize PVCAM SDK\n        // pl_pvcam_init()\n        // pl_cam_open()\n        // Configure ROI, binning, exposure time, etc.\n\n        warn!(\"PVCAM SDK integration not yet implemented - using simulated data\");\n\n        // Create broadcast channel\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        // Spawn acquisition task\n        let instrument = self.clone();\n        let polling_rate = instrument_config\n            .get(\"polling_rate_hz\")\n            .and_then(|v| v.as_float())\n            .unwrap_or(10.0);\n\n        tokio::spawn(async move {\n            let mut interval = tokio::time::interval(\n                std::time::Duration::from_secs_f64(1.0 / polling_rate)\n            );\n\n            let mut frame_count = 0u64;\n\n            loop {\n                interval.tick().await;\n\n                let timestamp = chrono::Utc::now();\n\n                // TODO: Acquire actual frame from PVCAM\n                // pl_exp_start_seq()\n                // pl_exp_check_status()\n                // pl_exp_get_latest_frame()\n\n                // For now, simulate frame acquisition\n                let frame_data = instrument.simulate_frame_data();\n                let (mean, min, max) = instrument.calculate_frame_stats(\u0026frame_data);\n\n                frame_count += 1;\n\n                // Send frame statistics as data points\n                let dp_mean = DataPoint {\n                    timestamp,\n                    channel: format!(\"{}_mean_intensity\", instrument.id),\n                    value: mean,\n                    unit: \"counts\".to_string(),\n                    metadata: Some(serde_json::json!({\"frame\": frame_count})),\n                };\n\n                let dp_min = DataPoint {\n                    timestamp,\n                    channel: format!(\"{}_min_intensity\", instrument.id),\n                    value: min,\n                    unit: \"counts\".to_string(),\n                    metadata: Some(serde_json::json!({\"frame\": frame_count})),\n                };\n\n                let dp_max = DataPoint {\n                    timestamp,\n                    channel: format!(\"{}_max_intensity\", instrument.id),\n                    value: max,\n                    unit: \"counts\".to_string(),\n                    metadata: Some(serde_json::json!({\"frame\": frame_count})),\n                };\n\n                if sender.send(dp_mean).is_err()\n                    || sender.send(dp_min).is_err()\n                    || sender.send(dp_max).is_err() {\n                    warn!(\"No active receivers for PVCAM camera data\");\n                    break;\n                }\n            }\n        });\n\n        info!(\"PVCAM camera '{}' connected successfully\", self.id);\n        Ok(())\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from PVCAM camera: {}\", self.id);\n\n        // TODO: Cleanup PVCAM SDK\n        // pl_cam_close()\n        // pl_pvcam_uninit()\n\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to PVCAM camera '{}'\", self.id))\n    }\n\n    async fn handle_command(\u0026mut self, command: InstrumentCommand) -\u003e Result\u003c()\u003e {\n        match command {\n            InstrumentCommand::SetParameter(key, value) =\u003e {\n                match key.as_str() {\n                    \"exposure_ms\" =\u003e {\n                        self.exposure_ms = value.parse()\n                            .unwrap_or(self.exposure_ms);\n                        info!(\"PVCAM exposure set to {} ms\", self.exposure_ms);\n                        // TODO: Apply to camera hardware\n                    }\n                    \"gain\" =\u003e {\n                        // TODO: Set camera gain\n                        info!(\"PVCAM gain set to {}\", value);\n                    }\n                    \"binning\" =\u003e {\n                        // TODO: Set camera binning\n                        info!(\"PVCAM binning set to {}\", value);\n                    }\n                    _ =\u003e {\n                        warn!(\"Unknown parameter '{}' for PVCAM\", key);\n                    }\n                }\n            }\n            InstrumentCommand::Execute(cmd, _) =\u003e {\n                match cmd.as_str() {\n                    \"start_acquisition\" =\u003e {\n                        info!(\"PVCAM starting continuous acquisition\");\n                        // TODO: Start continuous acquisition\n                    }\n                    \"stop_acquisition\" =\u003e {\n                        info!(\"PVCAM stopping acquisition\");\n                        // TODO: Stop acquisition\n                    }\n                    \"snap\" =\u003e {\n                        info!(\"PVCAM snap single frame\");\n                        // TODO: Acquire single frame\n                    }\n                    _ =\u003e {\n                        warn!(\"Unknown command '{}' for PVCAM\", cmd);\n                    }\n                }\n            }\n            _ =\u003e {\n                warn!(\"Unsupported command type for PVCAM\");\n            }\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":41,"address":[37783566,37783344,37783544],"length":1,"stats":{"Line":0}},{"line":43,"address":[38144808],"length":1,"stats":{"Line":0}},{"line":45,"address":[38186505],"length":1,"stats":{"Line":0}},{"line":52,"address":[38187478,38187472,38186688],"length":1,"stats":{"Line":0}},{"line":54,"address":[38145055],"length":1,"stats":{"Line":0}},{"line":55,"address":[38186731],"length":1,"stats":{"Line":0}},{"line":56,"address":[40708215,40708312],"length":1,"stats":{"Line":0}},{"line":59,"address":[38145246,38145145],"length":1,"stats":{"Line":0}},{"line":60,"address":[37719496,37719595,37719947],"length":1,"stats":{"Line":0}},{"line":61,"address":[38187333,38187230],"length":1,"stats":{"Line":0}},{"line":62,"address":[40708785,40708833],"length":1,"stats":{"Line":0}},{"line":66,"address":[37719542],"length":1,"stats":{"Line":0}},{"line":69,"address":[37784400],"length":1,"stats":{"Line":0}},{"line":70,"address":[40709034],"length":1,"stats":{"Line":0}},{"line":71,"address":[38146240],"length":1,"stats":{"Line":0}},{"line":74,"address":[38167568,38167578],"length":1,"stats":{"Line":0}},{"line":75,"address":[40709125],"length":1,"stats":{"Line":0}},{"line":77,"address":[38187719],"length":1,"stats":{"Line":0}},{"line":78,"address":[40709287],"length":1,"stats":{"Line":0}},{"line":80,"address":[37784779],"length":1,"stats":{"Line":0}},{"line":86,"address":[37720720],"length":1,"stats":{"Line":0}},{"line":87,"address":[38188513],"length":1,"stats":{"Line":0}},{"line":90,"address":[37974476,37974535,37971535,37971504,37974185,37971670,37971742,37971772,37971614],"length":1,"stats":{"Line":0}},{"line":91,"address":[37545962,37546002,37545833],"length":1,"stats":{"Line":0}},{"line":93,"address":[38167928,38170546,38168250,38168409,38168324],"length":1,"stats":{"Line":0}},{"line":95,"address":[37972162],"length":1,"stats":{"Line":0}},{"line":96,"address":[37972197,37972313,37974576,37974594],"length":1,"stats":{"Line":0}},{"line":98,"address":[37611129,37611208,37611106],"length":1,"stats":{"Line":0}},{"line":99,"address":[38168458],"length":1,"stats":{"Line":0}},{"line":100,"address":[40532953,40530661,40532944],"length":1,"stats":{"Line":0}},{"line":101,"address":[37611024],"length":1,"stats":{"Line":0}},{"line":102,"address":[37546663,37546749],"length":1,"stats":{"Line":0}},{"line":104,"address":[37546945],"length":1,"stats":{"Line":0}},{"line":105,"address":[38168740],"length":1,"stats":{"Line":0}},{"line":106,"address":[40532985,40530951,40532976],"length":1,"stats":{"Line":0}},{"line":107,"address":[37546900],"length":1,"stats":{"Line":0}},{"line":109,"address":[37972806,37972912],"length":1,"stats":{"Line":0}},{"line":116,"address":[37611424,37611823,37611863],"length":1,"stats":{"Line":0}},{"line":119,"address":[37547413,37547662],"length":1,"stats":{"Line":0}},{"line":120,"address":[37612162,37612222],"length":1,"stats":{"Line":0}},{"line":123,"address":[38169809,38169759],"length":1,"stats":{"Line":0}},{"line":124,"address":[40532148],"length":1,"stats":{"Line":0}},{"line":126,"address":[37973844,37974777,37974768],"length":1,"stats":{"Line":0}},{"line":129,"address":[40532157,40533401,40537617,40538078,40533225,40533079,40533040],"length":1,"stats":{"Line":0}},{"line":130,"address":[37975089,37974904],"length":1,"stats":{"Line":0}},{"line":131,"address":[38170968],"length":1,"stats":{"Line":0}},{"line":134,"address":[40533359],"length":1,"stats":{"Line":0}},{"line":137,"address":[29058833],"length":1,"stats":{"Line":0}},{"line":139,"address":[38171491],"length":1,"stats":{"Line":0}},{"line":147,"address":[37975526],"length":1,"stats":{"Line":0}},{"line":148,"address":[37549677,37549776],"length":1,"stats":{"Line":0}},{"line":150,"address":[38171719,38171773],"length":1,"stats":{"Line":0}},{"line":153,"address":[40534719],"length":1,"stats":{"Line":0}},{"line":155,"address":[37614314,37614388],"length":1,"stats":{"Line":0}},{"line":157,"address":[38171928],"length":1,"stats":{"Line":0}},{"line":158,"address":[37618590,37614619,37614657,37614571,37614731],"length":1,"stats":{"Line":0}},{"line":161,"address":[40535581],"length":1,"stats":{"Line":0}},{"line":163,"address":[38172682,38172614],"length":1,"stats":{"Line":0}},{"line":165,"address":[37615350],"length":1,"stats":{"Line":0}},{"line":166,"address":[37615519,37615593,37615481,37615433,37618546],"length":1,"stats":{"Line":0}},{"line":169,"address":[37552347],"length":1,"stats":{"Line":0}},{"line":171,"address":[37551696,37551628],"length":1,"stats":{"Line":0}},{"line":173,"address":[40535892],"length":1,"stats":{"Line":0}},{"line":174,"address":[37616343,37616381,37616455,37618502,37616295],"length":1,"stats":{"Line":0}},{"line":177,"address":[37616906,37617098],"length":1,"stats":{"Line":0}},{"line":178,"address":[38174617],"length":1,"stats":{"Line":0}},{"line":179,"address":[37978938],"length":1,"stats":{"Line":0}},{"line":180,"address":[40537627,40537575,40537652],"length":1,"stats":{"Line":0}},{"line":186,"address":[37548237,37548334],"length":1,"stats":{"Line":0}},{"line":187,"address":[37548289],"length":1,"stats":{"Line":0}},{"line":190,"address":[37618769,37618640,37618668,37619247,37618853,37618719,37618762,37618826],"length":1,"stats":{"Line":0}},{"line":191,"address":[40538465,40538605,40538576],"length":1,"stats":{"Line":0}},{"line":197,"address":[37618907,37619175],"length":1,"stats":{"Line":0}},{"line":198,"address":[37980663],"length":1,"stats":{"Line":0}},{"line":201,"address":[37720889],"length":1,"stats":{"Line":0}},{"line":202,"address":[37619460],"length":1,"stats":{"Line":0}},{"line":204,"address":[38177017,38177008,38176895],"length":1,"stats":{"Line":0}},{"line":205,"address":[37619728,37619746,37619623],"length":1,"stats":{"Line":0}},{"line":208,"address":[38146793],"length":1,"stats":{"Line":0}},{"line":209,"address":[38177425],"length":1,"stats":{"Line":0}},{"line":210,"address":[37555826],"length":1,"stats":{"Line":0}},{"line":211,"address":[40539994,40540194],"length":1,"stats":{"Line":0}},{"line":212,"address":[37981976],"length":1,"stats":{"Line":0}},{"line":213,"address":[38179109,38179186,38177933],"length":1,"stats":{"Line":0}},{"line":214,"address":[37557412],"length":1,"stats":{"Line":0}},{"line":215,"address":[37983323],"length":1,"stats":{"Line":0}},{"line":218,"address":[38177899,38177966],"length":1,"stats":{"Line":0}},{"line":220,"address":[38178014,38178797],"length":1,"stats":{"Line":0}},{"line":222,"address":[37556345,37556264],"length":1,"stats":{"Line":0}},{"line":224,"address":[38178120,38178494],"length":1,"stats":{"Line":0}},{"line":227,"address":[37620767,37620867,37620895],"length":1,"stats":{"Line":0}},{"line":231,"address":[38177648],"length":1,"stats":{"Line":0}},{"line":232,"address":[37558093,37555964],"length":1,"stats":{"Line":0}},{"line":233,"address":[38179839],"length":1,"stats":{"Line":0}},{"line":234,"address":[37622609,37623609],"length":1,"stats":{"Line":0}},{"line":237,"address":[38179966,38179894],"length":1,"stats":{"Line":0}},{"line":238,"address":[37622703,37623378],"length":1,"stats":{"Line":0}},{"line":241,"address":[40542360,40542432],"length":1,"stats":{"Line":0}},{"line":242,"address":[37984587,37984240],"length":1,"stats":{"Line":0}},{"line":246,"address":[37984198,37984289,37984317],"length":1,"stats":{"Line":0}},{"line":251,"address":[37559427,37555990],"length":1,"stats":{"Line":0}},{"line":254,"address":[37557951],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":102},{"path":["/","app","src","instrument","scpi.rs"],"content":"//! A basic skeleton for an SCPI-based instrument.\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument},\n};\nuse anyhow::Result;\nuse async_trait::async_trait;\nuse log::info;\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\n\npub struct ScpiInstrument;\n\nimpl Default for ScpiInstrument {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl ScpiInstrument {\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait]\nimpl Instrument for ScpiInstrument {\n    fn name(\u0026self) -\u003e String {\n        \"SCPI Instrument\".to_string()\n    }\n\n    async fn connect(\u0026mut self, _settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to SCPI Instrument...\");\n        // TODO: Implement connection logic (e.g., open serial port)\n        // let config = settings.instruments.get(\"scpi_keithley\").unwrap();\n        // let port = config.get(\"port\").unwrap().as_str().unwrap();\n        // let baud_rate = config.get(\"baud_rate\").unwrap().as_integer().unwrap() as u32;\n        // let port = serialport::new(port, baud_rate).open()...\n        info!(\"SCPI connection is a placeholder.\");\n        Ok(())\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from SCPI Instrument.\");\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        // This is a placeholder. A real implementation would spawn a task\n        // that repeatedly queries the instrument and sends data points.\n        let (sender, receiver) = broadcast::channel(1);\n        let _ = sender.send(DataPoint {\n            timestamp: chrono::Utc::now(),\n            channel: \"scpi_placeholder\".to_string(),\n            value: 0.0,\n            unit: \"N/A\".to_string(),\n            metadata: None,\n        });\n        Ok(receiver)\n    }\n}\n","traces":[{"line":15,"address":[40407376],"length":1,"stats":{"Line":0}},{"line":16,"address":[37421089],"length":1,"stats":{"Line":0}},{"line":28,"address":[37485536],"length":1,"stats":{"Line":0}},{"line":29,"address":[37421137],"length":1,"stats":{"Line":0}},{"line":32,"address":[37847264,37847797,37847445,37847393,37847292,37847343,37848015,37847472,37847386],"length":1,"stats":{"Line":0}},{"line":33,"address":[37501678,37501516,37501627],"length":1,"stats":{"Line":0}},{"line":39,"address":[37421911,37421946,37421665],"length":1,"stats":{"Line":0}},{"line":40,"address":[37486333],"length":1,"stats":{"Line":0}},{"line":43,"address":[37502341,37502441,37502638,37502282,37502368,37502160,37502289,37502239,37502188],"length":1,"stats":{"Line":0}},{"line":44,"address":[37848299,37848331,37848188],"length":1,"stats":{"Line":0}},{"line":45,"address":[37502417],"length":1,"stats":{"Line":0}},{"line":48,"address":[37849346,37848822,37848775,37848560,37849321,37848648,37848722,37848597,37848716,37849316],"length":1,"stats":{"Line":0}},{"line":51,"address":[37423005,37422877],"length":1,"stats":{"Line":0}},{"line":52,"address":[37487625],"length":1,"stats":{"Line":0}},{"line":53,"address":[37503002],"length":1,"stats":{"Line":0}},{"line":54,"address":[37848954],"length":1,"stats":{"Line":0}},{"line":56,"address":[37848985],"length":1,"stats":{"Line":0}},{"line":57,"address":[37423201],"length":1,"stats":{"Line":0}},{"line":59,"address":[37423398],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":19},{"path":["/","app","src","instrument","visa.rs"],"content":"//! VISA instrument implementation.\n//!\n//! This module provides an `Instrument` implementation for devices that support\n//! the VISA (Virtual Instrument Software Architecture) standard. It uses the\n//! `visa-rs` crate to communicate with the VISA library.\n//!\n//! ## Configuration\n//!\n//! VISA instruments are configured in the `config/default.toml` file. Here is\n//! an example configuration for a Rigol DS1054Z oscilloscope:\n//!\n//! ```toml\n//! [instruments.visa_rigol]\n//! name = \"Rigol DS1054Z (VISA)\"\n//! resource_string = \"TCPIP0::192.168.1.101::INSTR\"\n//! polling_rate_hz = 10.0\n//! queries = { \"voltage\" = \":MEAS:VPP? CHAN1\", \"frequency\" = \":MEAS:FREQ? CHAN1\" }\n//! ```\n//!\n//! - `resource_string`: The VISA resource string for the instrument.\n//! - `polling_rate_hz`: The rate at which the instrument is polled for data.\n//! - `queries`: A map of SCPI queries to be executed at each poll. The key is\n//!   the channel name, and the value is the SCPI command.\n\nuse crate::{\n    config::Settings,\n    core::{DataPoint, Instrument},\n};\nuse anyhow::{anyhow, Context, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse std::sync::Arc;\nuse tokio::sync::broadcast;\nuse visa_rs::{prelude::*, session::Session};\n\n/// An `Instrument` implementation for VISA devices.\n#[derive(Clone)]\npub struct VisaInstrument {\n    id: String,\n    session: Option\u003cArc\u003cSession\u003e\u003e,\n    sender: Option\u003cbroadcast::Sender\u003cDataPoint\u003e\u003e,\n    // Add a default resource manager to handle the VISA session\n    rm: Arc\u003cDefaultRM\u003e,\n}\n\nuse std::io::{BufRead, BufReader, Write};\n\nimpl VisaInstrument {\n    /// Creates a new `VisaInstrument` with the given resource name.\n    pub fn new(id: \u0026str) -\u003e Result\u003cSelf\u003e {\n        let rm = DefaultRM::new().context(\"Failed to create VISA a new resource manager\")?;\n        Ok(Self {\n            id: id.to_string(),\n            session: None,\n            sender: None,\n            rm: Arc::new(rm),\n        })\n    }\n\n    /// Writes a SCPI command to the instrument.\n    pub fn write(\u0026self, command: \u0026str) -\u003e Result\u003c()\u003e {\n        self.session\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to instrument '{}'\", self.id))?\n            .write_all(command.as_bytes())\n            .with_context(|| format!(\"Failed to write command to instrument '{}'\", self.id))?;\n        Ok(())\n    }\n\n    /// Writes a SCPI query to the instrument and returns the response.\n    pub fn query(\u0026self, command: \u0026str) -\u003e Result\u003cString\u003e {\n        self.write(command)\n            .with_context(|| format!(\"Failed to write query to instrument '{}'\", self.id))?;\n        let session = self\n            .session\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to instrument '{}'\", self.id))?;\n        let mut reader = BufReader::new(session.as_ref());\n        let mut buf = String::new();\n        reader.read_line(\u0026mut buf).with_context(|| {\n            format!(\n                \"Failed to read query response from instrument '{}'\",\n                self.id\n            )\n        })?;\n        Ok(buf)\n    }\n\n    /// Reads a fixed number of bytes from the instrument.\n    pub fn read_binary(\u0026self, length: usize) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        let session = self\n            .session\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to instrument '{}'\", self.id))?;\n        let mut reader = BufReader::new(session.as_ref());\n        let mut buf = vec![0; length];\n        reader\n            .read_exact(\u0026mut buf)\n            .with_context(|| format!(\"Failed to read binary data from instrument '{}'\", self.id))?;\n        Ok(buf)\n    }\n\n    /// Reads from the instrument until the buffer is empty.\n    pub fn read_until_end(\u0026self) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        let session = self\n            .session\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"Not connected to instrument '{}'\", self.id))?;\n        let mut reader = BufReader::new(session.as_ref());\n        let mut buf = Vec::new();\n        reader\n            .read_to_end(\u0026mut buf)\n            .with_context(|| format!(\"Failed to read data from instrument '{}'\", self.id))?;\n        Ok(buf)\n    }\n}\n\n#[async_trait]\nimpl Instrument for VisaInstrument {\n    fn name(\u0026self) -\u003e String {\n        self.id.clone()\n    }\n\n    async fn connect(\u0026mut self, settings: \u0026Arc\u003cSettings\u003e) -\u003e Result\u003c()\u003e {\n        info!(\"Connecting to VISA instrument: {}\", self.id);\n\n        let instrument_config = settings\n            .instruments\n            .get(\u0026self.id)\n            .ok_or_else(|| anyhow!(\"Configuration for '{}' not found\", self.id))?;\n\n        let resource_string = instrument_config\n            .get(\"resource_string\")\n            .and_then(|v| v.as_str())\n            .ok_or_else(|| anyhow!(\"'resource_string' not found in config for '{}'\", self.id))?;\n\n        let res = self\n            .rm\n            .open(\n                \u0026resource_string.try_into()?,\n                AccessMode::NO_LOCK,\n                TIMEOUT_IMMEDIATE,\n            )\n            .with_context(|| format!(\"Failed to open VISA session for '{}'\", self.id))?;\n\n        self.session = Some(Arc::new(res));\n        let (sender, _) = broadcast::channel(1024);\n        self.sender = Some(sender.clone());\n\n        let polling_rate_hz = instrument_config\n            .get(\"polling_rate_hz\")\n            .and_then(|v| v.as_float())\n            .ok_or_else(|| anyhow!(\"'polling_rate_hz' not found in config for '{}'\", self.id))?;\n\n        let queries = instrument_config\n            .get(\"queries\")\n            .and_then(|v| {\n                v.clone()\n                    .try_into::\u003cstd::collections::HashMap\u003cString, String\u003e\u003e()\n                    .ok()\n            })\n            .ok_or_else(|| anyhow!(\"'queries' not found in config for '{}'\", self.id))?;\n\n        let instrument = self.clone();\n\n        tokio::spawn(async move {\n            let mut interval =\n                tokio::time::interval(std::time::Duration::from_secs_f64(1.0 / polling_rate_hz));\n            loop {\n                interval.tick().await;\n                for (channel, query_str) in \u0026queries {\n                    match instrument.query(query_str) {\n                        Ok(response) =\u003e {\n                            let value = response.trim().parse::\u003cf64\u003e().unwrap_or(0.0);\n                            let dp = DataPoint {\n                                timestamp: chrono::Utc::now(),\n                                channel: channel.clone(),\n                                value,\n                                unit: \"V\".to_string(), // a default unit\n                                metadata: None,\n                            };\n                            if sender.send(dp).is_err() {\n                                warn!(\"No active receivers for VISA instrument data.\");\n                                break;\n                            }\n                        }\n                        Err(e) =\u003e {\n                            warn!(\"Failed to query instrument: {}\", e);\n                        }\n                    }\n                }\n            }\n        });\n\n        Ok(())\n    }\n\n    async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Disconnecting from VISA instrument.\");\n        if let Some(session) = self.session.take() {\n            drop(session);\n        }\n        self.sender = None;\n        Ok(())\n    }\n\n    async fn data_stream(\u0026mut self) -\u003e Result\u003cbroadcast::Receiver\u003cDataPoint\u003e\u003e {\n        self.sender\n            .as_ref()\n            .map(|s| s.subscribe())\n            .ok_or_else(|| anyhow!(\"Not connected to instrument '{}'\", self.id))\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","src","lib.rs"],"content":"//! # Rust DAQ Core Library\n//!\n//! This crate serves as the core library for the `rust_daq` application. It encapsulates all the\n//! fundamental components required for data acquisition, instrument control, data processing,\n//! and the graphical user interface. By organizing the project as a library, we can share\n//! core logic between different frontends, such as the native GUI application (`main.rs`)\n//! and potential future integrations like Python bindings.\n//!\n//! ## Crate Structure\n//!\n//! The library is organized into several modules, each with a distinct responsibility:\n//!\n//! - **`app`**: Contains the main `DaqApp` struct, which acts as the central hub of the\n//!   application, managing state, instruments, and data flow.\n//! - **`config`**: Defines the structures for loading and validating application configuration\n//!   from TOML files. See `config::Settings`.\n//! - **`core`**: Provides the fundamental traits and enums for the DAQ system, such as `Instrument`,\n//!   `DataPoint`, and `InstrumentCommand`. This module defines the essential abstractions.\n//! - **`data`**: Includes components for data handling, such as storage writers (e.g., CSV, HDF5)\n//!   and data processors.\n//! - **`error`**: Defines the custom `DaqError` enum for centralized error handling across the\n//!   application.\n//! - **`gui`**: Implements the native graphical user interface using `eframe` and `egui`. It contains\n//!   all the UI components, panels, and docking logic.\n//! - **`instrument`**: Contains the concrete implementations of the `Instrument` trait for various\n//!   hardware devices (e.g., mock instruments, VISA-based devices, cameras).\n//! - **`log_capture`**: Provides a custom `log::Log` implementation to capture log messages for\n//!   display within the GUI.\n//! - **`metadata`**: Defines structures for capturing and storing experimental metadata.\n//! - **`session`**: Implements session management for saving and loading the application state.\n//! - **`validation`**: A collection of utility functions for validating configuration parameters.\n\npub mod app;\npub mod config;\npub mod core;\npub mod data;\npub mod error;\npub mod gui;\npub mod instrument;\npub mod log_capture;\npub mod metadata;\npub mod session;\npub mod validation;\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","src","log_capture.rs"],"content":"//! A custom log collector for capturing application logs for display in the GUI.\n//!\n//! This module provides the necessary components to capture logs generated by the `log`\n//! crate and store them in a memory buffer. This buffer can then be accessed by the\n//! GUI to display the logs to the user. This is a common pattern for integrating\n//! standard logging into an egui application.\n//!\n//! ## Components\n//!\n//! - **`LogEntry`**: A struct that represents a single log message, capturing its timestamp,\n//!   level, target, and the formatted message. It also provides a helper method to\n//!   determine the color for displaying the log level in the GUI.\n//!\n//! - **`LogBuffer`**: A thread-safe, fixed-capacity, circular buffer that stores `LogEntry`\n//!   instances. It is wrapped in an `Arc\u003cMutex\u003c...\u003e\u003e` to allow it to be shared safely\n//!   between the logging thread and the GUI thread. When the buffer is full, the oldest\n//!   log entry is discarded.\n//!\n//! - **`LogCollector`**: An implementation of the `log::Log` trait. Its role is to intercept\n//!   log records from the `log` crate, create `LogEntry` instances from them, and push\n//!   them into the shared `LogBuffer`.\n//!\n//! ## Usage\n//!\n//! In the application's setup, an instance of `LogCollector` is created with a `LogBuffer`.\n//! The collector is then registered with the `log` crate as the global logger. The\n//! `LogBuffer` is also passed to the `Gui` struct, which can then read from it to\n//! render the log panel.\n\nuse chrono::{DateTime, Local};\nuse egui::Color32;\nuse log::{Level, Log, Metadata, Record};\nuse std::collections::VecDeque;\nuse std::sync::{Arc, Mutex};\n\nconst MAX_LOG_ENTRIES: usize = 1000;\n\n/// Represents a single log entry.\n#[derive(Clone)]\npub struct LogEntry {\n    pub timestamp: DateTime\u003cLocal\u003e,\n    pub level: Level,\n    pub target: String,\n    pub message: String,\n}\n\nimpl LogEntry {\n    /// Returns a color corresponding to the log level for GUI display.\n    pub fn color(\u0026self) -\u003e Color32 {\n        match self.level {\n            Level::Error =\u003e Color32::from_rgb(255, 100, 100), // Light Red\n            Level::Warn =\u003e Color32::from_rgb(255, 255, 100),  // Yellow\n            Level::Info =\u003e Color32::from_rgb(100, 200, 255),  // Light Blue\n            Level::Debug =\u003e Color32::from_rgb(150, 150, 150), // Gray\n            Level::Trace =\u003e Color32::from_rgb(200, 150, 255), // Light Purple\n        }\n    }\n}\n\n/// A thread-safe, fixed-capacity log buffer.\n#[derive(Clone)]\npub struct LogBuffer(Arc\u003cMutex\u003cVecDeque\u003cLogEntry\u003e\u003e\u003e);\n\nimpl Default for LogBuffer {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\nimpl LogBuffer {\n    pub fn new() -\u003e Self {\n        Self(Arc::new(Mutex::new(VecDeque::with_capacity(\n            MAX_LOG_ENTRIES,\n        ))))\n    }\n\n    pub fn read(\u0026self) -\u003e std::sync::MutexGuard\u003c'_, VecDeque\u003cLogEntry\u003e\u003e {\n        self.0.lock().unwrap()\n    }\n\n    pub fn clear(\u0026self) {\n        self.0.lock().unwrap().clear();\n    }\n}\n\n/// A simple logger that captures logs into a `LogBuffer`.\npub struct LogCollector {\n    buffer: LogBuffer,\n}\n\nimpl LogCollector {\n    pub fn new(buffer: LogBuffer) -\u003e Self {\n        Self { buffer }\n    }\n\n    /// Returns a reference to the internal log buffer.\n    pub fn buffer(\u0026self) -\u003e \u0026LogBuffer {\n        \u0026self.buffer\n    }\n}\n\nimpl Log for LogCollector {\n    fn enabled(\u0026self, _metadata: \u0026Metadata) -\u003e bool {\n        true // Capture all levels, filtering will be done in the GUI\n    }\n\n    fn log(\u0026self, record: \u0026Record) {\n        if !self.enabled(record.metadata()) {\n            return;\n        }\n\n        let mut buffer = self.buffer.0.lock().unwrap();\n\n        if buffer.len() \u003e= MAX_LOG_ENTRIES {\n            buffer.pop_front();\n        }\n\n        buffer.push_back(LogEntry {\n            timestamp: Local::now(),\n            level: record.level(),\n            target: record.target().to_string(),\n            message: format!(\"{}\", record.args()),\n        });\n    }\n\n    fn flush(\u0026self) {}\n}\n","traces":[{"line":49,"address":[37721504],"length":1,"stats":{"Line":0}},{"line":50,"address":[37295657],"length":1,"stats":{"Line":0}},{"line":51,"address":[37360107],"length":1,"stats":{"Line":0}},{"line":52,"address":[37360138],"length":1,"stats":{"Line":0}},{"line":53,"address":[37721609],"length":1,"stats":{"Line":0}},{"line":54,"address":[37721643],"length":1,"stats":{"Line":0}},{"line":55,"address":[37360231],"length":1,"stats":{"Line":0}},{"line":65,"address":[37721712],"length":1,"stats":{"Line":0}},{"line":66,"address":[37360273],"length":1,"stats":{"Line":0}},{"line":71,"address":[40282160],"length":1,"stats":{"Line":2}},{"line":72,"address":[37295876],"length":1,"stats":{"Line":2}},{"line":77,"address":[32679552],"length":1,"stats":{"Line":0}},{"line":78,"address":[32679561],"length":1,"stats":{"Line":0}},{"line":81,"address":[40282288,40282452,40282446],"length":1,"stats":{"Line":0}},{"line":82,"address":[37360425],"length":1,"stats":{"Line":0}},{"line":92,"address":[32679776],"length":1,"stats":{"Line":0}},{"line":97,"address":[37722048],"length":1,"stats":{"Line":0}},{"line":103,"address":[37722064],"length":1,"stats":{"Line":0}},{"line":107,"address":[37361393,37360640,37361399],"length":1,"stats":{"Line":0}},{"line":108,"address":[37296270],"length":1,"stats":{"Line":0}},{"line":112,"address":[37296306],"length":1,"stats":{"Line":0}},{"line":114,"address":[37722226,37722293],"length":1,"stats":{"Line":0}},{"line":115,"address":[37360903],"length":1,"stats":{"Line":0}},{"line":118,"address":[40283135,40282754],"length":1,"stats":{"Line":0}},{"line":119,"address":[40282839],"length":1,"stats":{"Line":0}},{"line":120,"address":[32680134],"length":1,"stats":{"Line":0}},{"line":121,"address":[37722448],"length":1,"stats":{"Line":0}},{"line":122,"address":[37296643,37296702],"length":1,"stats":{"Line":0}},{"line":126,"address":[37297013,37297008],"length":1,"stats":{"Line":0}}],"covered":2,"coverable":29},{"path":["/","app","src","main.rs"],"content":"//! Application entry point for the native GUI.\n//!\n//! This file is the executable entry point for the `rust_daq` application. Its primary\n//! responsibilities are:\n//!\n//! 1.  **Initialization**: It sets up the application's core components, including:\n//!     -   **Logging**: Configures a multi-backend logger (`multi_log`) that directs log\n//!         messages to both the standard console (via `env_logger`) and a custom in-memory\n//!         buffer for display in the GUI (`log_capture::LogCollector`). This provides\n//!         both persistent and interactive logging.\n//!     -   **Configuration**: Loads the `settings.toml` file into the `Settings` struct.\n//!     -   **Instrument Registry**: Creates an `InstrumentRegistry` and registers all the\n//!         available instrument drivers. This acts as a simple \"plugin\" system where\n//!         instrument types are mapped to their constructor functions. Feature flags\n//!         are used to conditionally compile and register drivers that have specific\n//!         dependencies.\n//!     -   **Processor Registry**: Creates a `ProcessorRegistry` for data processing modules.\n//!     -   **Core Application (`DaqApp`)**: Instantiates the central `DaqApp` which manages\n//!         the application's state and logic.\n//!\n//! 2.  **GUI Launch**: It configures and runs the native GUI using the `eframe` crate.\n//!     It passes the `DaqApp` instance to the `gui::Gui` struct, which then takes control\n//!     of the main event loop.\n//!\n//! 3.  **Shutdown**: After the `eframe` event loop exits (i.e., the user closes the window),\n//!     it calls the `app.shutdown()` method to ensure a graceful termination of all\n//!     background tasks, such as instrument communication threads.\n\nuse anyhow::Result;\nuse eframe::NativeOptions;\nuse log::{info, LevelFilter};\nuse rust_daq::{\n    app::DaqApp,\n    config::Settings,\n    data::registry::ProcessorRegistry,\n    gui::Gui,\n    instrument::{mock::MockInstrument, scpi::ScpiInstrument, InstrumentRegistry},\n    log_capture::{LogBuffer, LogCollector},\n};\nuse std::sync::Arc;\n\nfn main() -\u003e Result\u003c()\u003e {\n    // --- Custom Log Initialization ---\n    // Create a shared buffer for log messages\n    let log_buffer = LogBuffer::new();\n\n    // Create a logger that collects messages for the GUI\n    let gui_logger = LogCollector::new(log_buffer.clone());\n\n    // Get the desired log level from the environment or default to \"info\"\n    let log_level_filter = std::env::var(\"RUST_LOG\").map_or(LevelFilter::Info, |s| {\n        s.parse().unwrap_or(LevelFilter::Info)\n    });\n\n    // Create a logger that prints to the console\n    let console_logger = env_logger::Builder::new()\n        .filter_level(log_level_filter)\n        .build();\n\n    // Combine the loggers. All log messages will be sent to both the\n    // console and our GUI log collector.\n    log::set_max_level(log_level_filter);\n    multi_log::MultiLogger::init(\n        vec![Box::new(console_logger), Box::new(gui_logger)],\n        log_level_filter.to_level().unwrap_or(log::Level::Info),\n    )\n    .map_err(|e| anyhow::anyhow!(\"Failed to initialize logger: {}\", e))?;\n    // --- End of Log Initialization ---\n\n    // Load configuration\n    let settings = Arc::new(Settings::new(None)?);\n    info!(\"Configuration loaded successfully.\");\n\n    // Create a registry and register available instruments.\n    // This is our static \"plugin\" system.\n    let mut instrument_registry = InstrumentRegistry::new();\n    instrument_registry.register(\"mock\", |_id| Box::new(MockInstrument::new()));\n    instrument_registry.register(\"scpi_keithley\", |_id| Box::new(ScpiInstrument::new()));\n\n    #[cfg(feature = \"instrument_visa\")]\n    {\n        use rust_daq::instrument::visa::VisaInstrument;\n        instrument_registry.register(\"visa_instrument\", |id| {\n            Box::new(VisaInstrument::new(id).unwrap())\n        });\n    }\n\n    #[cfg(feature = \"instrument_serial\")]\n    {\n        use rust_daq::instrument::{newport_1830c::Newport1830C, maitai::MaiTai, elliptec::Elliptec, esp300::ESP300};\n        instrument_registry.register(\"newport_1830c\", |id| Box::new(Newport1830C::new(id)));\n        instrument_registry.register(\"maitai\", |id| Box::new(MaiTai::new(id)));\n        instrument_registry.register(\"elliptec\", |id| Box::new(Elliptec::new(id)));\n        instrument_registry.register(\"esp300\", |id| Box::new(ESP300::new(id)));\n    }\n\n    // Register PVCAM camera (no feature gate for now)\n    use rust_daq::instrument::pvcam::PVCAMCamera;\n    instrument_registry.register(\"pvcam\", |id| Box::new(PVCAMCamera::new(id)));\n\n    let instrument_registry = Arc::new(instrument_registry);\n\n    // Create the processor registry\n    let processor_registry = Arc::new(ProcessorRegistry::new());\n\n    // Create the core application state\n    let app = DaqApp::new(\n        settings.clone(),\n        instrument_registry,\n        processor_registry,\n        log_buffer,\n    )?;\n    let app_clone = app.clone();\n\n    // Set up and run the GUI\n    let options = NativeOptions::default();\n    info!(\"Starting GUI...\");\n\n    eframe::run_native(\n        \"Rust DAQ\",\n        options,\n        Box::new(move |cc| {\n            // The `eframe` crate provides the `egui` context `cc`\n            // which we can use to style the GUI.\n            // Here we are just passing it to our `Gui` struct.\n            Ok(Box::new(Gui::new(cc, app_clone)))\n        }),\n    )\n    .map_err(|e| anyhow::anyhow!(\"Eframe run error: {}\", e))?;\n\n    // The GUI event loop has finished.\n    // We can now gracefully shut down the application.\n    info!(\"GUI closed. Shutting down.\");\n    app.shutdown();\n\n    Ok(())\n}\n","traces":[{"line":42,"address":[29058864,29062831,29063132],"length":1,"stats":{"Line":0}},{"line":45,"address":[29058871],"length":1,"stats":{"Line":0}},{"line":48,"address":[29059048,29058984],"length":1,"stats":{"Line":0}},{"line":51,"address":[29059176,29059091],"length":1,"stats":{"Line":0}},{"line":52,"address":[29067257,29067316],"length":1,"stats":{"Line":0}},{"line":56,"address":[29059207],"length":1,"stats":{"Line":0}},{"line":57,"address":[29059234],"length":1,"stats":{"Line":0}},{"line":62,"address":[29059400],"length":1,"stats":{"Line":0}},{"line":64,"address":[29063083,29059425],"length":1,"stats":{"Line":0}},{"line":65,"address":[29059998,29059934],"length":1,"stats":{"Line":0}},{"line":67,"address":[29060079,29060174],"length":1,"stats":{"Line":0}},{"line":71,"address":[29060219,29063001],"length":1,"stats":{"Line":0}},{"line":72,"address":[29060524,29060552,29060428],"length":1,"stats":{"Line":0}},{"line":76,"address":[29060530],"length":1,"stats":{"Line":0}},{"line":77,"address":[29060785],"length":1,"stats":{"Line":0}},{"line":78,"address":[29060861],"length":1,"stats":{"Line":0}},{"line":91,"address":[29060888],"length":1,"stats":{"Line":0}},{"line":92,"address":[29060915],"length":1,"stats":{"Line":0}},{"line":93,"address":[29060942],"length":1,"stats":{"Line":0}},{"line":94,"address":[29060969],"length":1,"stats":{"Line":0}},{"line":99,"address":[29060996],"length":1,"stats":{"Line":0}},{"line":101,"address":[29061023],"length":1,"stats":{"Line":0}},{"line":104,"address":[29061194,29061126],"length":1,"stats":{"Line":0}},{"line":108,"address":[29061233],"length":1,"stats":{"Line":0}},{"line":109,"address":[29061309],"length":1,"stats":{"Line":0}},{"line":110,"address":[29061325],"length":1,"stats":{"Line":0}},{"line":111,"address":[29061341],"length":1,"stats":{"Line":0}},{"line":113,"address":[29061598,29061537],"length":1,"stats":{"Line":0}},{"line":116,"address":[29061614],"length":1,"stats":{"Line":0}},{"line":117,"address":[29061763,29061846,29061671],"length":1,"stats":{"Line":0}},{"line":121,"address":[29061769],"length":1,"stats":{"Line":0}},{"line":122,"address":[29061815],"length":1,"stats":{"Line":0}},{"line":126,"address":[29067980],"length":1,"stats":{"Line":0}},{"line":129,"address":[29062180,29062257],"length":1,"stats":{"Line":0}},{"line":133,"address":[29062373,29062299],"length":1,"stats":{"Line":0}},{"line":134,"address":[29062351],"length":1,"stats":{"Line":0}},{"line":136,"address":[29062588],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":37},{"path":["/","app","src","metadata.rs"],"content":"//! Experimental metadata structures and handling.\n//!\n//! This module defines the `Metadata` struct, which is designed to capture a comprehensive\n//! set of information about a data acquisition session. Storing rich metadata alongside\n//! the primary data is crucial for reproducibility, analysis, and long-term understanding\n//! of the experimental context.\n//!\n//! ## `Metadata` Struct\n//!\n//! The `Metadata` struct includes the following fields:\n//!\n//! - **`experiment_name`**: A descriptive name for the experiment.\n//! - **`description`**: A more detailed, free-text description of the experiment's purpose.\n//! - **`instrument_config`**: A map capturing the configuration of the instruments used,\n//!   allowing for a snapshot of the hardware setup.\n//! - **`parameters`**: A flexible map for user-defined key-value parameters that are relevant\n//!   to the experiment (e.g., sample ID, specific experimental conditions). It uses\n//!   `serde_json::Value` to allow for varied data types.\n//! - **`annotations`**: A field for notes or observations made during the experiment.\n//! - **`environment`**: A map to store environmental data like temperature or humidity.\n//! - **`software_version`**: Automatically captures the version of the DAQ software that\n//!   was used, which is critical for ensuring that data can be re-analyzed correctly in the future.\n//!\n//! ## `MetadataBuilder`\n//!\n//! A `MetadataBuilder` is provided to facilitate the ergonomic construction of a `Metadata`\n//! object using the builder pattern. This allows for a clean and readable way to assemble\n//! the metadata step-by-step.\n//!\n//! ## Usage\n//!\n//! The `Metadata` object is intended to be created and populated at the beginning of a\n//! data acquisition \"session\" (see the `session` module). It is then saved alongside the\n//! acquired data, typically as a separate file (e.g., `metadata.json`) or embedded within\n//! a self-describing file format like HDF5.\n\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashMap;\n\n/// Captures comprehensive metadata for an experiment.\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]\npub struct Metadata {\n    /// The name of the experiment.\n    pub experiment_name: String,\n    /// A detailed description of the experiment.\n    pub description: String,\n    /// Configuration of the instruments used.\n    pub instrument_config: HashMap\u003cString, String\u003e,\n    /// User-defined experimental parameters.\n    pub parameters: HashMap\u003cString, serde_json::Value\u003e,\n    /// User annotations or notes.\n    pub annotations: String,\n    /// Environmental conditions (e.g., temperature, humidity).\n    pub environment: HashMap\u003cString, f64\u003e,\n    /// Version of the data acquisition software.\n    pub software_version: String,\n}\n\nimpl Default for Metadata {\n    fn default() -\u003e Self {\n        Self {\n            experiment_name: \"Default Experiment\".to_string(),\n            description: \"\".to_string(),\n            instrument_config: HashMap::new(),\n            parameters: HashMap::new(),\n            annotations: \"\".to_string(),\n            environment: HashMap::new(),\n            software_version: env!(\"CARGO_PKG_VERSION\").to_string(),\n        }\n    }\n}\n\n/// A builder for constructing `Metadata` instances.\n#[derive(Default)]\npub struct MetadataBuilder {\n    inner: Metadata,\n}\n\nimpl MetadataBuilder {\n    pub fn new() -\u003e Self {\n        Self::default()\n    }\n\n    pub fn experiment_name(mut self, name: \u0026str) -\u003e Self {\n        self.inner.experiment_name = name.to_string();\n        self\n    }\n\n    pub fn description(mut self, description: \u0026str) -\u003e Self {\n        self.inner.description = description.to_string();\n        self\n    }\n\n    pub fn instrument_config(mut self, key: \u0026str, value: \u0026str) -\u003e Self {\n        self.inner\n            .instrument_config\n            .insert(key.to_string(), value.to_string());\n        self\n    }\n\n    pub fn parameter(mut self, key: \u0026str, value: serde_json::Value) -\u003e Self {\n        self.inner.parameters.insert(key.to_string(), value);\n        self\n    }\n\n    pub fn annotations(mut self, annotations: \u0026str) -\u003e Self {\n        self.inner.annotations = annotations.to_string();\n        self\n    }\n\n    pub fn environment(mut self, key: \u0026str, value: f64) -\u003e Self {\n        self.inner.environment.insert(key.to_string(), value);\n        self\n    }\n\n    pub fn build(self) -\u003e Metadata {\n        self.inner\n    }\n}\n\nimpl Metadata {\n    /// Validates the metadata.\n    pub fn validate(\u0026self) -\u003e Result\u003c(), String\u003e {\n        if self.experiment_name.is_empty() {\n            return Err(\"Experiment name cannot be empty.\".to_string());\n        }\n        Ok(())\n    }\n}\n","traces":[{"line":59,"address":[47132416],"length":1,"stats":{"Line":0}},{"line":60,"address":[47068007],"length":1,"stats":{"Line":2}},{"line":62,"address":[46757746],"length":1,"stats":{"Line":2}},{"line":63,"address":[40782882],"length":1,"stats":{"Line":2}},{"line":64,"address":[38219791],"length":1,"stats":{"Line":2}},{"line":65,"address":[47068080],"length":1,"stats":{"Line":2}},{"line":66,"address":[46757725],"length":1,"stats":{"Line":2}},{"line":67,"address":[46757767],"length":1,"stats":{"Line":2}},{"line":68,"address":[46757739],"length":1,"stats":{"Line":2}},{"line":80,"address":[37794480],"length":1,"stats":{"Line":0}},{"line":81,"address":[47132528],"length":1,"stats":{"Line":0}},{"line":84,"address":[38220368,38220595],"length":1,"stats":{"Line":0}},{"line":85,"address":[40783615,40783559],"length":1,"stats":{"Line":0}},{"line":86,"address":[38220575],"length":1,"stats":{"Line":0}},{"line":89,"address":[37859417,37859184],"length":1,"stats":{"Line":0}},{"line":90,"address":[86387813,86387850],"length":1,"stats":{"Line":0}},{"line":91,"address":[40783973],"length":1,"stats":{"Line":0}},{"line":94,"address":[46758072,46757889],"length":1,"stats":{"Line":0}},{"line":95,"address":[40784253,40784106],"length":1,"stats":{"Line":0}},{"line":96,"address":[47068317],"length":1,"stats":{"Line":0}},{"line":97,"address":[38220987,38221208,38221125,38221054],"length":1,"stats":{"Line":0}},{"line":98,"address":[37721357],"length":1,"stats":{"Line":0}},{"line":101,"address":[38221248,38221543],"length":1,"stats":{"Line":0}},{"line":102,"address":[46758150],"length":1,"stats":{"Line":0}},{"line":103,"address":[38221489],"length":1,"stats":{"Line":0}},{"line":106,"address":[37721973,37721744],"length":1,"stats":{"Line":0}},{"line":107,"address":[37795767,37795823],"length":1,"stats":{"Line":0}},{"line":108,"address":[37860341],"length":1,"stats":{"Line":0}},{"line":111,"address":[47132936],"length":1,"stats":{"Line":0}},{"line":112,"address":[37722066,37722136],"length":1,"stats":{"Line":0}},{"line":113,"address":[47494387],"length":1,"stats":{"Line":0}},{"line":116,"address":[46758400,46758299,46758334],"length":1,"stats":{"Line":0}},{"line":117,"address":[37722200],"length":1,"stats":{"Line":0}},{"line":123,"address":[37796208],"length":1,"stats":{"Line":0}},{"line":124,"address":[37860654],"length":1,"stats":{"Line":0}},{"line":125,"address":[37860683],"length":1,"stats":{"Line":0}},{"line":127,"address":[40785244],"length":1,"stats":{"Line":0}}],"covered":8,"coverable":37},{"path":["/","app","src","session.rs"],"content":"//! Session management for the DAQ application.\n//!\n//! This module provides functionality for saving and loading the application's state.\n//! A \"session\" captures the key aspects of the current setup, allowing a user to\n//! restore it later. This is useful for quickly returning to a specific configuration\n//! of instruments and settings.\n//!\n//! ## Session State\n//!\n//! The `Session` struct encapsulates the state that is saved, which includes:\n//!\n//! - **`active_instruments`**: A set of IDs for the instruments that are currently running.\n//! - **`storage_settings`**: The current configuration for data storage, such as the\n//!   default path and file format.\n//! - **`gui_state`**: Information about the state of the GUI, such as the data currently\n//!   displayed in plots. This allows the visual state to be restored as well.\n//!\n//! ## Functionality\n//!\n//! - **`save_session`**: Serializes a `Session` object into a JSON file at a specified path.\n//! - **`load_session`**: Deserializes a `Session` object from a JSON file.\n//! - **`Session::from_app`**: A constructor that creates a `Session` object from the current\n//!   state of the `DaqApp`.\n//! - **`Session::apply_to_app`**: A method that applies a loaded session's state back to the\n//!   `DaqApp`, which involves stopping any currently running instruments, starting the ones\n//!   defined in the session, and updating the relevant settings.\n//!\n//! This feature allows for greater experiment consistency and convenience, as complex\n//! setups do not need to be manually reconfigured each time the application is started.\n\nuse crate::config::StorageSettings;\nuse anyhow::Result;\nuse serde::{Deserialize, Serialize};\nuse std::collections::HashSet;\nuse std::fs;\nuse std::path::Path;\nuse std::sync::Arc;\n\nuse crate::app::DaqApp;\n\nuse std::collections::VecDeque;\n\n/// Represents the state of the application to be saved in a session.\n#[derive(Debug, Serialize, Deserialize)]\npub struct Session {\n    pub active_instruments: HashSet\u003cString\u003e,\n    pub storage_settings: StorageSettings,\n    pub gui_state: GuiState,\n}\n\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct GuiState {\n    pub plot_data: VecDeque\u003c[f64; 2]\u003e,\n}\n\nimpl Session {\n    /// Creates a new `Session` from the current application state.\n    pub fn from_app(app: \u0026DaqApp, gui_state: GuiState) -\u003e Self {\n        app.with_inner(|inner| {\n            let active_instruments = inner.instruments.keys().cloned().collect();\n            let storage_settings = inner.settings.storage.clone();\n            Self {\n                active_instruments,\n                storage_settings,\n                gui_state,\n            }\n        })\n    }\n\n    /// Applies the session state to the application.\n    pub fn apply_to_app(\u0026self, app: \u0026DaqApp) {\n        app.with_inner(|inner| {\n            // Stop all current instruments\n            let current_instruments: Vec\u003cString\u003e = inner.instruments.keys().cloned().collect();\n            for id in current_instruments {\n                inner.stop_instrument(\u0026id);\n            }\n\n            // Start instruments from the session\n            for id in \u0026self.active_instruments {\n                if let Err(e) = inner.spawn_instrument(id) {\n                    log::error!(\"Failed to start instrument from session '{}': {}\", id, e);\n                }\n            }\n\n            // Apply storage settings\n            let settings = Arc::make_mut(\u0026mut inner.settings);\n            settings.storage = self.storage_settings.clone();\n        });\n    }\n}\n\n/// Saves the current session to a file.\npub fn save_session(session: \u0026Session, path: \u0026Path) -\u003e Result\u003c()\u003e {\n    let json = serde_json::to_string_pretty(session)?;\n    fs::write(path, json)?;\n    Ok(())\n}\n\n/// Loads a session from a file.\npub fn load_session(path: \u0026Path) -\u003e Result\u003cSession\u003e {\n    let json = fs::read_to_string(path)?;\n    let session = serde_json::from_str(\u0026json)?;\n    Ok(session)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::tempdir;\n\n    #[test]\n    fn test_save_and_load_session() {\n        let dir = tempdir().unwrap();\n        let file_path = dir.path().join(\"test_session.json\");\n\n        let mut active_instruments = HashSet::new();\n        active_instruments.insert(\"mock_instrument\".to_string());\n        active_instruments.insert(\"another_instrument\".to_string());\n\n        let storage_settings = StorageSettings {\n            default_path: \"test/path\".to_string(),\n            default_format: \"json\".to_string(),\n        };\n\n        let gui_state = GuiState {\n            plot_data: vec![[0.0, 1.0], [1.0, 2.0]].into(),\n        };\n\n        let session_to_save = Session {\n            active_instruments: active_instruments.clone(),\n            storage_settings: storage_settings.clone(),\n            gui_state: gui_state.clone(),\n        };\n\n        // Save the session\n        let save_result = save_session(\u0026session_to_save, \u0026file_path);\n        assert!(save_result.is_ok());\n\n        // Load the session\n        let loaded_session = load_session(\u0026file_path).unwrap();\n\n        // Verify the contents\n        assert_eq!(\n            session_to_save.active_instruments,\n            loaded_session.active_instruments\n        );\n        assert_eq!(\n            session_to_save.storage_settings.default_path,\n            loaded_session.storage_settings.default_path\n        );\n        assert_eq!(\n            session_to_save.storage_settings.default_format,\n            loaded_session.storage_settings.default_format\n        );\n        assert_eq!(\n            session_to_save.gui_state.plot_data,\n            loaded_session.gui_state.plot_data\n        );\n    }\n}\n","traces":[{"line":58,"address":[35697392],"length":1,"stats":{"Line":0}},{"line":59,"address":[30652736,30653175],"length":1,"stats":{"Line":0}},{"line":60,"address":[33572459,33572526],"length":1,"stats":{"Line":0}},{"line":61,"address":[30652896,30652965],"length":1,"stats":{"Line":0}},{"line":62,"address":[28695864],"length":1,"stats":{"Line":0}},{"line":63,"address":[28695784],"length":1,"stats":{"Line":0}},{"line":65,"address":[36734258],"length":1,"stats":{"Line":0}},{"line":71,"address":[33139232],"length":1,"stats":{"Line":0}},{"line":72,"address":[30653200,30653913,30654385],"length":1,"stats":{"Line":0}},{"line":74,"address":[30653233],"length":1,"stats":{"Line":0}},{"line":75,"address":[30653289,30653443],"length":1,"stats":{"Line":0}},{"line":76,"address":[28697250,28696320],"length":1,"stats":{"Line":0}},{"line":80,"address":[33573239,33573283],"length":1,"stats":{"Line":0}},{"line":81,"address":[31015112,31015366],"length":1,"stats":{"Line":0}},{"line":82,"address":[28696854,28696829,28696742],"length":1,"stats":{"Line":0}},{"line":87,"address":[30653752],"length":1,"stats":{"Line":0}},{"line":88,"address":[28696632,28696602],"length":1,"stats":{"Line":0}},{"line":94,"address":[33139280,33139753,33139782],"length":1,"stats":{"Line":1}},{"line":95,"address":[32777887],"length":1,"stats":{"Line":1}},{"line":96,"address":[32713646,32713882,32713750],"length":1,"stats":{"Line":2}},{"line":97,"address":[33139704],"length":1,"stats":{"Line":1}},{"line":101,"address":[29463930,29463488,29463936],"length":1,"stats":{"Line":1}},{"line":102,"address":[33139825],"length":1,"stats":{"Line":1}},{"line":103,"address":[32714117,32714183],"length":1,"stats":{"Line":2}},{"line":104,"address":[32714336],"length":1,"stats":{"Line":1}}],"covered":8,"coverable":25},{"path":["/","app","src","validation.rs"],"content":"//! Provides a set of validation functions used throughout the application,\n//! particularly for checking the configuration settings loaded from files.\n//!\n//! This module centralizes common validation logic, making it reusable and\n//! ensuring that checks are consistent. These functions are designed to be simple\n//! predicates that return a `Result\u003c(), \u0026'static str\u003e`, making them easy to\n//! integrate with the `anyhow` error handling in the `config` module.\n//!\n//! ## Validators\n//!\n//! The module includes functions to validate:\n//!\n//! - **`is_valid_port`**: Checks if a `u16` is a valid, non-zero network port.\n//! - **`is_valid_ip`**: Checks if a string can be parsed as a valid IP address (both IPv4 and IPv6).\n//! - **`is_valid_path`**: Performs basic checks on a file path string, ensuring it's not empty\n//!   and doesn't contain null bytes.\n//! - **`is_in_range`**: A generic function to check if a value falls within a given `RangeInclusive`.\n//!   This is useful for settings like sample rates or other numerical parameters.\n//! - **`is_not_empty`**: A simple check to ensure that a string setting is not empty.\n//!\n//! These functions are called from the `Settings::validate` method to ensure that the\n//! application doesn't start with a configuration that could lead to runtime errors.\n\nuse std::net::IpAddr;\nuse std::ops::RangeInclusive;\n\n/// Validates if a given `u16` value is a valid port number.\n/// By type, the port is already within the 0-65535 range.\n/// This function checks that the port is not 0, which is reserved.\n///\n/// # Arguments\n///\n/// * `port` - The `u16` value to validate.\n///\n/// # Returns\n///\n/// * `Ok(())` if the port is valid.\n/// * `Err(\u0026'static str)` if the port is invalid.\npub fn is_valid_port(port: u16) -\u003e Result\u003c(), \u0026'static str\u003e {\n    if port \u003e 0 {\n        Ok(())\n    } else {\n        Err(\"Port number must be greater than 0\")\n    }\n}\n\n/// Validates if a given string is a valid IP address.\n///\n/// # Arguments\n///\n/// * `ip` - The string to validate.\n///\n/// # Returns\n///\n/// * `Ok(())` if the IP address is valid.\n/// * `Err(\u0026'static str)` if the IP address is invalid.\npub fn is_valid_ip(ip: \u0026str) -\u003e Result\u003c(), \u0026'static str\u003e {\n    ip.parse::\u003cIpAddr\u003e()\n        .map(|_| ())\n        .map_err(|_| \"Invalid IP address\")\n}\n\n/// Validates if a given string is a valid file path.\n///\n/// # Arguments\n///\n/// * `path` - The string to validate.\n///\n/// # Returns\n///\n/// * `Ok(())` if the file path is valid.\n/// * `Err(\u0026'static str)` if the file path is invalid.\npub fn is_valid_path(path: \u0026str) -\u003e Result\u003c(), \u0026'static str\u003e {\n    if path.is_empty() {\n        return Err(\"File path cannot be empty\");\n    }\n    if path.contains('\\0') {\n        return Err(\"File path cannot contain null bytes\");\n    }\n    Ok(())\n}\n\n/// Validates if a given value is within a specified numeric range.\n///\n/// # Arguments\n///\n/// * `value` - The value to validate.\n/// * `range` - The inclusive range to validate against.\n///\n/// # Returns\n///\n/// * `Ok(())` if the value is within the range.\n/// * `Err(\u0026'static str)` if the value is outside the range.\npub fn is_in_range\u003cT: PartialOrd\u003e(value: T, range: RangeInclusive\u003cT\u003e) -\u003e Result\u003c(), \u0026'static str\u003e {\n    if range.contains(\u0026value) {\n        Ok(())\n    } else {\n        Err(\"Value is outside the specified range\")\n    }\n}\n\n/// Validates if a given string is not empty.\n///\n/// # Arguments\n///\n/// * `value` - The string to validate.\n///\n/// # Returns\n///\n/// * `Ok(())` if the string is not empty.\n/// * `Err(\u0026'static str)` if the string is empty.\npub fn is_not_empty(value: \u0026str) -\u003e Result\u003c(), \u0026'static str\u003e {\n    if !value.is_empty() {\n        Ok(())\n    } else {\n        Err(\"Value cannot be empty\")\n    }\n}\n","traces":[{"line":39,"address":[30809600],"length":1,"stats":{"Line":3}},{"line":40,"address":[28503331,28503304],"length":1,"stats":{"Line":4}},{"line":41,"address":[28503333],"length":1,"stats":{"Line":3}},{"line":43,"address":[30809614],"length":1,"stats":{"Line":1}},{"line":57,"address":[30809664],"length":1,"stats":{"Line":3}},{"line":58,"address":[37037646],"length":1,"stats":{"Line":3}},{"line":59,"address":[37037656],"length":1,"stats":{"Line":6}},{"line":60,"address":[37037661],"length":1,"stats":{"Line":5}},{"line":73,"address":[28503440],"length":1,"stats":{"Line":3}},{"line":74,"address":[37037704],"length":1,"stats":{"Line":3}},{"line":75,"address":[28503497],"length":1,"stats":{"Line":1}},{"line":77,"address":[33729467],"length":1,"stats":{"Line":3}},{"line":78,"address":[33729515],"length":1,"stats":{"Line":1}},{"line":80,"address":[37037760],"length":1,"stats":{"Line":3}},{"line":94,"address":[28847696,28847824,28847931,28847813],"length":1,"stats":{"Line":5}},{"line":95,"address":[28204580,28204649,28204622],"length":1,"stats":{"Line":11}},{"line":96,"address":[38188171,38188033],"length":1,"stats":{"Line":5}},{"line":98,"address":[28847882,28847764],"length":1,"stats":{"Line":1}},{"line":112,"address":[37037808],"length":1,"stats":{"Line":3}},{"line":113,"address":[28503582,28503600],"length":1,"stats":{"Line":6}},{"line":114,"address":[28503591],"length":1,"stats":{"Line":3}},{"line":116,"address":[28503602],"length":1,"stats":{"Line":1}}],"covered":22,"coverable":22},{"path":["/","app","tests","fft_processor_integration_test.rs"],"content":"use chrono::{TimeZone, Utc};\nuse rust_daq::{\n    app::DaqApp,\n    config::Settings,\n    core::{DataPoint, DataProcessor},\n    data::{\n        fft::{FFTConfig, FFTProcessor},\n        registry::ProcessorRegistry,\n    },\n    instrument::{mock::MockInstrument, InstrumentRegistry},\n    log_capture::LogBuffer,\n};\nuse serial_test::serial;\nuse std::sync::Arc;\n\n#[test]\n#[serial]\nfn test_fft_processor_in_pipeline() {\n    // --- Setup ---\n    let settings = Arc::new(Settings::new(None).unwrap());\n    let mut instrument_registry = InstrumentRegistry::new();\n    instrument_registry.register(\"mock\", |_id| Box::new(MockInstrument::new()));\n    let instrument_registry = Arc::new(instrument_registry);\n    let processor_registry = Arc::new(ProcessorRegistry::new());\n    let log_buffer = LogBuffer::new();\n\n    let app = DaqApp::new(\n        settings.clone(),\n        instrument_registry,\n        processor_registry,\n        log_buffer,\n    )\n    .unwrap();\n    let runtime = app.get_runtime();\n\n    runtime.block_on(async {\n        let mut data_rx = app.with_inner(|inner| inner.data_sender.subscribe());\n\n        // Create a new pipeline with the FFTProcessor\n        let sampling_rate = 1024.0;\n        let window_size = 1024;\n        let config = FFTConfig {\n            window_size,\n            overlap: window_size / 2,\n            sampling_rate,\n        };\n        let mut fft_processor = FFTProcessor::new(config);\n\n        // Collect some data points\n        let mut collected_data = Vec::new();\n        for _ in 0..window_size {\n            if let Ok(dp) = data_rx.recv().await {\n                collected_data.push(dp);\n            }\n        }\n\n        // Process the data\n        let spectrum = fft_processor.process(\u0026collected_data);\n        assert!(\n            !spectrum.is_empty(),\n            \"FFT processor did not produce any output.\"\n        );\n    });\n\n    // Teardown\n    app.shutdown();\n}\n\n#[test]\n#[serial]\nfn test_fft_processor_sine_wave() {\n    let sample_rate = 1024.0;\n    let window_size = 1024;\n    let frequency = 50.0;\n    let config = FFTConfig {\n        window_size,\n        overlap: window_size / 2,\n        sampling_rate: sample_rate,\n    };\n    let mut fft_processor = FFTProcessor::new(config);\n\n    // Generate a sine wave\n    let mut sine_wave = Vec::new();\n    for i in 0..window_size {\n        let t = i as f64 / sample_rate;\n        let value = (2.0 * std::f64::consts::PI * frequency * t).sin();\n        sine_wave.push(DataPoint {\n            timestamp: Utc.timestamp_nanos((t * 1_000_000_000.0) as i64),\n            channel: \"test\".to_string(),\n            value,\n            unit: \"V\".to_string(),\n            metadata: None,\n        });\n    }\n\n    let spectrum = fft_processor.process_fft(\u0026sine_wave);\n    assert!(\n        !spectrum.is_empty(),\n        \"FFT processor did not produce any output.\"\n    );\n\n    let peak_freq = spectrum\n        .iter()\n        .max_by(|a, b| a.magnitude.partial_cmp(\u0026b.magnitude).unwrap())\n        .map(|bin| bin.frequency)\n        .unwrap();\n\n    let freq_resolution = sample_rate / window_size as f64;\n    assert!(\n        (peak_freq - frequency).abs() \u003c= freq_resolution,\n        \"Peak frequency {:.2} Hz is not close to the expected frequency {:.2} Hz. Resolution: {:.2} Hz\",\n        peak_freq,\n        frequency,\n        freq_resolution\n    );\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","tests","integration_test.rs"],"content":"use rust_daq::{\n    app::DaqApp,\n    config::Settings,\n    data::registry::ProcessorRegistry,\n    instrument::{mock::MockInstrument, InstrumentRegistry},\n    log_capture::LogBuffer,\n};\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::time::timeout;\n\n#[test]\nfn test_mock_instrument_spawns_and_produces_data() {\n    // Setup\n    let settings = Arc::new(Settings::new(None).unwrap());\n    let mut instrument_registry = InstrumentRegistry::new();\n    instrument_registry.register(\"mock\", |_id| Box::new(MockInstrument::new()));\n    let instrument_registry = Arc::new(instrument_registry);\n    let processor_registry = Arc::new(ProcessorRegistry::new());\n    let log_buffer = LogBuffer::new();\n\n    let app = DaqApp::new(\n        settings.clone(),\n        instrument_registry,\n        processor_registry,\n        log_buffer,\n    )\n    .unwrap();\n    let runtime = app.get_runtime();\n\n    runtime.block_on(async {\n        let mut data_rx = app.with_inner(|inner| inner.data_sender.subscribe());\n\n        // Instrument is automatically started in DaqApp::new()\n\n        // Act: Check for data\n        let recv_result = timeout(Duration::from_secs(5), data_rx.recv()).await;\n\n        // Assert\n        assert!(recv_result.is_ok(), \"Did not receive data point in time\");\n        let data_point = recv_result.unwrap().unwrap();\n        assert!(\n            matches!(\n                data_point.channel.as_str(),\n                \"sine_wave\" | \"cosine_wave\" | \"sine_wave_filtered\" | \"cosine_wave_filtered\"\n            ) || data_point.channel.ends_with(\"_fft\"),\n            \"Unexpected channel name\"\n        );\n    });\n\n    // Teardown\n    app.shutdown();\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","app","tests","validation_test.rs"],"content":"use rust_daq::validation::*;\n\n#[test]\nfn test_is_valid_port() {\n    assert!(is_valid_port(8080).is_ok());\n    assert!(is_valid_port(0).is_err());\n}\n\n#[test]\nfn test_is_valid_ip() {\n    assert!(is_valid_ip(\"127.0.0.1\").is_ok());\n    assert!(is_valid_ip(\"256.0.0.1\").is_err());\n    assert!(is_valid_ip(\"not an ip\").is_err());\n}\n\n#[test]\nfn test_is_valid_path() {\n    assert!(is_valid_path(\"/some/path\").is_ok());\n    assert!(is_valid_path(\"\").is_err());\n    assert!(is_valid_path(\"path/with\\0/null.txt\").is_err());\n}\n\n#[test]\nfn test_is_in_range() {\n    assert!(is_in_range(5, 1..=10).is_ok());\n    assert!(is_in_range(11, 1..=10).is_err());\n}\n\n#[test]\nfn test_is_not_empty() {\n    assert!(is_not_empty(\"hello\").is_ok());\n    assert!(is_not_empty(\"\").is_err());\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, ''),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e(
        'code',
        {
          className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        },
        line,
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '';
    }
  });
})();
</script>
</body>
</html>